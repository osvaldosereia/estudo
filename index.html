<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestor de Rotas</title>
    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega Fonte Padrão (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Carrega o Banco de Dados de Clientes -->
    <script src="clientes.js"></script>
    
    <style>
        /* Define a fonte padrão */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
        }
        
        /* --- Nova Barra Superior Fixa --- */
        #top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 40;
            background-color: #ffffff;
            border-bottom: 1px solid #e5e7eb; /* gray-200 */
        }
        /* Botão de modo ativo */
        .btn-modo-ativo {
            background-color: #2563eb; /* blue-600 */
            color: #ffffff !important;
        }

        /* --- Novo Modal de Formulário --- */
        #modal-form {
            position: fixed;
            inset: 0;
            z-index: 50;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; /* Oculto por padrão */
            overflow-y: auto; /* Permite scroll no modal */
        }
        .modal-form-content {
            height: 100%;
            width: 100%;
            background-color: #f3f4f6; /* gray-100 */
        }
        @media (min-width: 768px) {
            /* Em telas maiores, não é tela cheia */
            .modal-form-content {
                height: auto;
                max-height: 90vh;
                max-width: 60rem; /* 960px */
                margin: 2.5rem auto;
                border-radius: 0.5rem; /* rounded-lg */
                overflow-y: auto;
            }
            #modal-form {
                padding: 2.5rem; /* Adiciona padding em volta */
            }
        }
        
        /* --- Novo Botão Flutuante (FAB) --- */
        #btn-abrir-form-modal {
            position: fixed;
            bottom: 2rem; /* 32px */
            right: 1.5rem; /* 24px */
            z-index: 40;
            background-color: #2563eb; /* blue-600 */
            color: #ffffff;
            width: 4rem; /* 64px */
            height: 4rem; /* 64px */
            border-radius: 9999px; /* rounded-full */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease-out;
        }
        #btn-abrir-form-modal:hover {
            transform: scale(1.05);
        }

        /* Classes de Status (Entregue, Cancelada, Montado) */
        .entregue { background-color: #f0fdf4 !important; border-left-color: #22c55e !important; }
        .cancelada { background-color: #f3f4f6 !important; border-left-color: #6b7280 !important; opacity: 0.7; }
        .montado { background-color: #f0f9ff !important; border-left-color: #3b82f6 !important; }
        
        /* Cores de Rota */
        .rota-CUIABÁ { background-color: #e0f2fe; border-left-color: #0284c7; }
        .rota-VG { background-color: #fef3c7; border-left-color: #d97706; }
        .rota-CPA { background-color: #fce7f3; border-left-color: #db2777; }
        .rota-COXIPÓ { background-color: #dcfce7; border-left-color: #16a34a; }

        /* Lógica de Visibilidade por Modo */
        .entregador-view, .montador-view { display: none; }
        .modo-entregador .entregador-view { display: block; }
        .modo-entregador .admin-view, .modo-entregador .montador-view { display: none; }
        .modo-montador .montador-view { display: block; }
        .modo-montador .admin-view, .modo-montador .entregador-view { display: none; }
        .modo-entregador #secao-despesas.entregador-view { display: block; }
        /* O FAB de Adicionar só aparece para Admin */
        .modo-entregador #btn-abrir-form-modal,
        .modo-montador #btn-abrir-form-modal {
            display: none;
        }

        /* Estilo para botão de filtro de rota ativo */
        .btn-filtro-ativo {
            background-color: #1d4ed8 !important;
            color: #ffffff !important;
            border-color: #1d4ed8;
        }
        
        /* Estilos de Texto e Textarea */
        textarea { min-height: 100px; white-space: pre-wrap; }
        .pre-wrap-texto {
            white-space: pre-wrap;
            word-break: break-word;
            font-family: inherit;
            font-size: 0.875rem;
            line-height: 1.25rem;
        }

        /* Lógica de visibilidade para Modo Montador */
        /* CORRIGIDO: A sintaxe aninhada (SASS) foi convertida para CSS puro */
        .modo-montador .montador-hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 antialiased">
    
    <!-- =================================================================== -->
    <!-- NOVA BARRA SUPERIOR FIXA -->
    <!-- =================================================================== -->
    <nav id="top-bar" class="p-2 sm:p-4">
        <div class="container mx-auto max-w-5xl flex flex-col sm:flex-row justify-between items-center gap-2">
            <h1 class="text-xl sm:text-2xl font-bold text-gray-900 flex-shrink-0">
                Gestor de Rotas
            </h1>
            <!-- Botões de Modo -->
            <div class="flex bg-gray-200 rounded-lg p-1 w-full sm:w-auto">
                <button id="btn-top-admin" class="btn-modo-ativo text-gray-800 font-semibold py-2 px-3 sm:px-4 rounded-md text-xs sm:text-sm w-1/3 sm:w-auto">
                    ADMIN
                </button>
                <button id="btn-top-entregador" class="text-gray-600 font-semibold py-2 px-3 sm:px-4 rounded-md text-xs sm:text-sm w-1/3 sm:w-auto hover:bg-gray-300">
                    ENTREGADOR
                </button>
                <button id="btn-top-montador" class="text-gray-600 font-semibold py-2 px-3 sm:px-4 rounded-md text-xs sm:text-sm w-1/3 sm:w-auto hover:bg-gray-300">
                    MONTADOR
                </button>
            </div>
        </div>
    </nav>
    
    <!-- =================================================================== -->
    <!-- PÁGINA PRINCIPAL (ÚNICA) -->
    <!-- =================================================================== -->
    <main class="container mx-auto max-w-5xl p-4 mt-24 sm:mt-20">
        
        <!-- MODIFICADO: Header do Admin não é mais sticky -->
        <header id="page-rota-header" class="admin-view bg-gray-100 pt-4 pb-2 px-4 -mt-4 -mx-4 mb-4">
            <div class="container mx-auto max-w-5xl">
                <!-- MODIFICADO: Botão de toggle removido -->
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-2xl font-semibold text-gray-900">Gerenciar Rota</h2>
                </div>
                
                <!-- MODIFICADO: Conteúdo não é mais colapsável, ID removido -->
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label for="select-rota-ativa" class="block text-sm font-medium text-gray-700">Rota Ativa</label>
                            <select id="select-rota-ativa" class="mt-1 block w-full rounded-md border-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base">
                                <!-- Rotas preenchidas pelo JS -->
                            </select>
                        </div>
                        <div class="md:col-span-1">
                            <button id="btn-nova-rota" class="w-full flex justify-center items-center rounded-md border border-transparent bg-green-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-green-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                Nova
                            </button>
                        </div>
                        <div class="md:col-span-1">
                             <button id="btn-excluir-rota" class="w-full flex justify-center items-center rounded-md border border-gray-400 bg-red-100 px-4 py-3 text-sm font-medium text-red-700 shadow-sm hover:bg-red-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm2 3a1 1 0 100 2h2a1 1 0 100-2H9z" clip-rule="evenodd" /></svg>
                                Excluir
                            </button>
                        </div>
                        <div class="md:col-span-2">
                            <label for="input-nome-rota" class="block text-sm font-medium text-gray-700">Nome da Rota</label>
                            <input type="text" id="input-nome-rota" class="mt-1 block w-full rounded-md border-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Ex: Entregas Manhã">
                        </div>
                        <div class="md:col-span-2">
                            <label for="input-data-rota" class="block text-sm font-medium text-gray-700">Data da Rota</label>
                            <div class="flex items-center">
                                <input type="date" id="input-data-rota" class="mt-1 block w-full rounded-l-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base">
                                <span id="display-dia-semana" class="mt-1 inline-flex items-center px-3 py-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm sm:text-base min-w-[100px] sm:min-w-[120px] justify-center">-</span>
                            </div>
                        </div>
                    </div>
                    <!-- MODIFICADO: Botões de Importar/Exportar movidos para fora do header -->
                </div>
            </div>
        </header>

        <!-- MODIFICADO: Botões de Import/Export agora são visíveis para todos -->
        <div class="flex flex-wrap gap-2 mb-4">
            <button id="btn-importar-card" class="rounded-md bg-blue-100 text-blue-700 px-4 py-3 text-sm font-medium shadow-sm hover:bg-blue-200">Importar Card</button>
            <button id="btn-exportar" class="rounded-md bg-green-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-green-700">Exportar Rota</button>
            <button id="btn-carregar" class="rounded-md bg-gray-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-gray-700">Carregar Rota</button>
        </div>

        <!-- Seção de Despesas (Entregador) -->
        <section id="secao-despesas" class="bg-white p-6 rounded-lg shadow-md mb-6 entregador-view">
            <h2 class="text-lg font-semibold text-gray-900 mb-4 border-b pb-2">Despesas da Rota</h2>
            <div class="grid grid-cols-1 gap-4 items-end">
                <div>
                    <label for="input-despesa-abastecimento" class="block text-sm font-medium text-gray-700">Abastecimento (R$)</label>
                    <input type="number" id="input-despesa-abastecimento" step="0.01" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="0.00">
                </div>
                <div>
                    <label for="input-despesa-alimentacao" class="block text-sm font-medium text-gray-700">Alimentação (R$)</label>
                    <input type="number" id="input-despesa-alimentacao" step="0.01" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="0.00">
                </div>
                <div>
                    <label for="input-despesa-extra" class="block text-sm font-medium text-gray-700">Extras (R$)</label>
                    <input type="number" id="input-despesa-extra" step="0.01" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="0.00">
                </div>
            </div>
        </section>

        <!-- Painel de Resumo (Montador) -->
        <section id="secao-resumo" class="montador-view bg-white p-4 rounded-lg shadow-md mb-4 space-y-2">
            <h2 class="text-xl font-semibold text-gray-900 mb-2 border-b pb-2">Resumo da Montagem</h2>
            <!-- MODIFICADO: Layout de colunas para Desktop -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <!-- Coluna 1: Totais -->
                <div class="space-y-2">
                    <div>
                        <span class="block font-medium text-gray-600">Total Pedidos (Não Cancelados):</span>
                        <span id="summary-total-pedidos" class="text-lg font-bold text-gray-900">0</span>
                    </div>
                    <div>
                        <span class="block font-medium text-gray-600">Total Cestas (Não Canceladas):</span>
                        <span id="summary-total-cestas" class="text-lg font-bold text-gray-900">0</span>
                    </div>
                </div>
                <!-- Coluna 2: Breakdowns -->
                <div class="space-y-2">
                    <div>
                        <span class="block font-medium text-gray-600">Cestas por Tipo:</span>
                        <!-- MODIFICADO: text-sm e ID -->
                        <span id="summary-cestas-breakdown" class="text-sm text-gray-700 leading-relaxed">...</span>
                    </div>
                    <div>
                        <span class="block font-medium text-gray-600">Cestas por Rota:</span>
                        <!-- MODIFICADO: text-sm e ID -->
                        <span id="summary-rotas-breakdown" class="text-sm text-gray-700 leading-relaxed">...</span>
                    </div>
                </div>
                <!-- REMOVIDO: Pedidos por Rota -->
            </div>
        </section>

        <!-- MODIFICADO: Filtros de Rota agora são STICKY e roláveis no mobile -->
        <div id="filtros-rota" class="sticky top-24 sm:top-20 z-20 bg-gray-100 py-2 flex flex-nowrap overflow-x-auto gap-2 mb-4">
            <button data-filtro="TODAS" class="btn-filtro-rota btn-filtro-ativo text-sm font-medium py-2 px-4 rounded-full border border-gray-400 bg-white shadow-sm flex-shrink-0">
                TODAS
            </button>
            <button data-filtro="CUIABÁ" class="btn-filtro-rota text-sm font-medium py-2 px-4 rounded-full border border-gray-400 bg-white shadow-sm rota-CUIABÁ flex-shrink-0">
                CUIABÁ
            </button>
            <button data-filtro="VG" class="btn-filtro-rota text-sm font-medium py-2 px-4 rounded-full border border-gray-400 bg-white shadow-sm rota-VG flex-shrink-0">
                VG
            </button>
            <button data-filtro="CPA" class="btn-filtro-rota text-sm font-medium py-2 px-4 rounded-full border border-gray-400 bg-white shadow-sm rota-CPA flex-shrink-0">
                CPA
            </button>
            <button data-filtro="COXIPÓ" class="btn-filtro-rota text-sm font-medium py-2 px-4 rounded-full border border-gray-400 bg-white shadow-sm rota-COXIPÓ flex-shrink-0">
                COXIPÓ
            </button>
        </div>
        
        <!-- Lista de Cards de Entrega -->
        <div id="lista-entregas" class="space-y-4">
            <!-- Cards serão injetados aqui pelo JavaScript -->
        </div>
        <p id="lista-vazia" class="text-center text-gray-700 py-10">Nenhuma entrega na rota.</p>

        <!-- Espaçador para o FAB não cobrir o último card -->
        <div class="h-24"></div> 
    </main>
    
    <!-- =================================================================== -->
    <!-- NOVO BOTÃO FLUTUANTE (FAB) -->
    <!-- =================================================================== -->
    <button id="btn-abrir-form-modal" class="admin-view">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
        </svg>
    </button>
    

    <!-- =================================================================== -->
    <!-- NOVO MODAL DO FORMULÁRIO -->
    <!-- =================================================================== -->
    <div id="modal-form">
        <div class="modal-form-content">
            <!-- Cabeçalho Fixo do Formulário -->
            <header class="sticky top-0 z-30 bg-white shadow-sm p-4 flex justify-between items-center">
                <h2 id="form-entrega-title" class="text-xl font-semibold text-gray-900">Lançar Nova Entrega</h2>
                <button id="btn-fechar-form-modal" class="text-sm font-medium text-blue-600 hover:text-blue-800">
                    Cancelar
                </button>
            </header>

            <!-- Container do Formulário (com scroll) -->
            <div class="p-4">
                <form id="form-entrega" class="container mx-auto max-w-5xl space-y-6">
                    <!-- Seção 1: Dados do Cliente -->
                    <fieldset class="bg-white p-4 rounded-lg shadow-md">
                        <legend class="text-lg font-medium text-gray-900 mb-2">1. Dados do Cliente</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="input-cliente" class="block text-sm font-medium text-gray-700">Cliente</label>
                                <input type="text" id="input-cliente" list="lista-clientes" required class="mt-1 block w-full rounded-md border-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Digite ou selecione...">
                                <datalist id="lista-clientes">
                                    <!-- Clientes carregados via JS -->
                                </datalist>
                            </div>
                            <div>
                                <label for="input-rota-entrega" class="block text-sm font-medium text-gray-700">Rota do Pedido</label>
                                <select id="input-rota-entrega" class="mt-1 block w-full rounded-md border-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base">
                                    <option value="CUIABÁ">CUIABÁ</option>
                                    <option value="VG">VG</option>
                                    <option value="CPA">CPA</option>
                                    <option value="COXIPÓ">COXIPÓ</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label for="obs-cliente" class="block text-sm font-medium text-gray-700">Observação (Opcional)</label>
                                <textarea id="obs-cliente" class="mt-1 block w-full rounded-md border-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Ex: Casa azul, portão branco..."></textarea>
                            </div>
                            <div id="info-cliente-selecionado" class="hidden md:col-span-2 space-y-2 text-sm text-gray-700 border-l-4 border-blue-300 pl-3 py-2 bg-blue-50 rounded-r-md">
                                <p><strong>Endereço:</strong> <span id="display-cliente-endereco">-</span></p>
                                <p><strong>Complemento:</strong> <span id="display-cliente-complemento">-</span></p>
                                <p><strong>Celular:</strong> <span id="display-cliente-celular">-</span></p>
                            </div>
                        </div>
                    </fieldset>
                    
                    <!-- Seção 2: Adicionar Cestas ao Pedido (Sub-Formulário) -->
                    <fieldset id="form-add-cesta" class="bg-white border border-gray-300 rounded-lg p-4">
                        <legend class="text-lg font-medium text-gray-900 mb-4 px-2">2. Adicionar Cesta</legend>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="md:col-span-1 space-y-4">
                                <div>
                                    <label for="sub-select-cesta" class="block text-sm font-medium text-gray-700">Cesta Básica</label>
                                    <select id="sub-select-cesta" class="mt-1 block w-full rounded-md border-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base">
                                        <option value="Mini Bonini" data-valor="165.00">Mini Bonini</option>
                                        <option value="Mini Koblenz" data-valor="170.00">Mini Koblenz</option>
                                        <option value="Pequena Bonini" data-valor="215.00">Pequena Bonini</option>
                                        <option value="Pequena Koblenz" data-valor="220.00">Pequena kolenz</option>
                                        <option value="mÉDIA Bonini" data-valor="320.00">Média Bonini</option>
                                        <option value="Média Koblenz" data-valor="325.00">Média Koblenz</option>
                                        <option value="Grande Bonini" data-valor="380.00">Grande Bonini</option>
                                        <option value="Grande Koblenz" data-valor="390.00">Grande koblenz</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="sub-input-quantidade" class="block text-sm font-medium text-gray-700">Quantidade</label>
                                    <input type="number" id="sub-input-quantidade" value="1" min="1" step="1" class="mt-1 block w-full rounded-md border-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base">
                                </div>
                            </div>
                            <div class="md:col-span-1 space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Tipo da Cesta</label>
                                    <div class="mt-2 flex space-x-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="sub-tipo-cesta" value="Normal" checked class="h-4 w-4 border-gray-400 text-blue-600 focus:ring-blue-500">
                                            <span class="ml-2 text-sm text-gray-700">Normal</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="sub-tipo-cesta" value="Alterada" class="h-4 w-4 border-gray-400 text-blue-600 focus:ring-blue-500">
                                            <span class="ml-2 text-sm text-gray-700">Alterada</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Brinde?</label>
                                    <div class="mt-2 flex space-x-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="sub-brinde" value="Não" checked class="h-4 w-4 border-gray-400 text-blue-600 focus:ring-blue-500">
                                            <span class="ml-2 text-sm text-gray-700">Não</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="sub-brinde" value="Sim" class="h-4 w-4 border-gray-400 text-blue-600 focus:ring-blue-500">
                                            <span class="ml-2 text-sm text-gray-700">Sim</span>
                                        </label>
                                    </div>
                                </div>
                                <div id="sub-campo-brinde-descricao" class="hidden">
                                    <label for="sub-input-brinde-descricao" class="block text-sm font-medium text-gray-700">Qual o brinde?</label>
                                    <input type="text" id="sub-input-brinde-descricao" class="mt-1 block w-full rounded-md border-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Ex: Panetone">
                                </div>
                            </div>
                            <div class="md:col-span-1 space-y-4">
                                <div id="sub-campo-alterada" class="hidden space-y-4">
                                    <!-- NOVO: Campo Código Final -->
                                    <div>
                                        <label for="sub-codigo-final" class="block text-sm font-medium text-gray-700">Código Final (Opcional)</label>
                                        <input type="text" id="sub-codigo-final" class="mt-1 block w-full rounded-md border-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Ex: 1020-A">
                                    </div>
                                    <div>
                                        <label for="sub-codigo-alterada" class="block text-sm font-medium text-gray-700">Detalhe (Cesta Alterada)</label>
                                        <textarea id="sub-codigo-alterada" class="mt-1 block w-full rounded-md border-gray-400 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Ex: Sem arroz, +1 feijão..."></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Partes Alteradas</label>
                                        <div class="mt-2 space-y-2">
                                            <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-300 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                                                <input type="checkbox" name="sub-partes_alteradas" value="Arroz" class="h-4 w-4 border-gray-400 text-blue-600 focus:ring-blue-500 rounded">
                                                <span class="ml-3 text-sm font-medium text-gray-900">Arroz</span>
                                            </label>
                                            <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-300 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                                                <input type="checkbox" name="sub-partes_alteradas" value="Alimento" class="h-4 w-4 border-gray-400 text-blue-600 focus:ring-blue-500 rounded">
                                                <span class="ml-3 text-sm font-medium text-gray-900">Alimento</span>
                                            </label>
                                            <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-300 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                                                <input type="checkbox" name="sub-partes_alteradas" value="Limpeza" class="h-4 w-4 border-gray-400 text-blue-600 focus:ring-blue-500 rounded">
                                                <span class="ml-3 text-sm font-medium text-gray-900">Limpeza</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button type="button" id="btn-add-cesta" class="flex justify-center items-center rounded-md border border-transparent bg-green-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-green-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                Adicionar Cesta
                            </button>
                        </div>
                    </fieldset>
                    
                    <!-- Seção 3: Resumo do Pedido -->
                    <fieldset class="bg-white border border-gray-300 rounded-lg p-4">
                        <legend class="text-lg font-medium text-gray-900 mb-4 px-2">3. Resumo do Pedido</legend>
                        <div id="lista-cestas-no-pedido" class="space-y-2 mb-4">
                            <p id="lista-cestas-vazia" class="text-center text-gray-700 py-2">Nenhuma cesta adicionada.</p>
                        </div>
                        <div class="flex flex-col md:flex-row justify-between items-center gap-4 pt-4 border-t">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Valor Total do Pedido</label>
                                <div id="display-valor" class="mt-1 text-2xl font-bold text-gray-900">
                                    R$ 0,00
                                </div>
                            </div>
                            <button id="btn-submit-form" type="submit" class="w-full md:w-auto flex justify-center items-center rounded-md border border-transparent bg-blue-600 px-6 py-4 text-base font-medium text-white shadow-sm hover:bg-blue-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                <span id="btn-submit-form-text">Lançar Entrega</span>
                            </button>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>
    </div>
    

    <!-- =================================================================== -->
    <!-- MODAIS (Permanecem os mesmos) -->
    <!-- =================================================================== -->
    
    <!-- Modal de Pagamento -->
    <div id="modal-pagamento" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <form id="form-pagamento">
                <div class="p-6">
                    <h3 class="text-xl font-semibold text-gray-900 mb-4">Confirmar Entrega e Pagamento</h3>
                    <p class="text-sm text-gray-700 mb-1">Cliente: <strong id="modal-cliente-nome"></strong></p>
                    <p class="text-sm text-gray-700 mb-4">Valor: <strong id="modal-cliente-valor"></strong></p>
                    
                    <label class="block text-sm font-medium text-gray-700 mb-2">Forma(s) de Pagamento:</label>
                    <div id="modal-error-pagamento" class="text-red-600 text-sm mb-2 hidden">É obrigatório selecionar ao menos uma forma de pagamento.</div>
                    <div class="space-y-2">
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-300 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                            <input type="checkbox" name="forma_pagamento" value="Dinheiro" class="h-4 w-4 border-gray-400 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-900">Dinheiro</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-300 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                            <input type="checkbox" name="forma_pagamento" value="Pix" class="h-4 w-4 border-gray-400 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-900">Pix</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-300 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                            <input type="checkbox" name="forma_pagamento" value="Cartão" class="h-4 w-4 border-gray-400 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-900">Cartão</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-300 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                            <input type="checkbox" name="forma_pagamento" value="Fiado" class="h-4 w-4 border-gray-400 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-900">Fiado</span>
                        </label>
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3 rounded-b-lg">
                    <button type="button" id="btn-cancelar-pagamento" class="rounded-md border border-gray-400 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Cancelar</button>
                    <button type="submit" id="btn-confirmar-pagamento" class="rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700">Confirmar Entrega</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Exportar -->
    <div id="modal-exportar" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl m-4 overflow-hidden">
            <div class="p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Exportar Rota</h3>
                
                <label class="block text-sm font-medium text-gray-700 mb-2">Backup da Rota (Arquivo)</label>
                <button type="button" id="btn-baixar-json" class="w-full flex justify-center items-center rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Baixar/Compartilhar Arquivo da Rota (.json)
                </button>

                <h4 class="text-lg font-semibold text-gray-900 mt-6 mb-2">Relatório de Entregas Concluídas</h4>
                <div id="export-relatorio" class="w-full max-h-48 overflow-y-auto p-2 border border-gray-400 rounded-md bg-gray-50">
                    <pre class="text-xs text-gray-700">Nenhuma entrega concluída.</pre>
                </div>

                <div id="export-whatsapp-link" class="mt-4">
                    <!-- Link do WhatsApp será gerado aqui -->
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end rounded-b-lg">
                <button type="button" id="btn-fechar-exportar" class="rounded-md border border-gray-400 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de WhatsApp -->
    <div id="modal-whatsapp" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm m-4">
            <div class="p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-2">Ação WhatsApp</h3>
                <p class="text-sm text-gray-700 mb-6">Para: <strong id="modal-whatsapp-cliente" class="text-gray-900">Nome do Cliente</strong></p>
                <div class="space-y-3">
                    <a id="btn-whatsapp-avisar" href="#" target="_blank" rel="noopener noreferrer" class="flex justify-center items-center w-full rounded-md border border-transparent bg-green-500 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-green-600">
                        Avisar Cliente (Chegando)
                    </a>
                    <a id="btn-whatsapp-chegou" href="#" target="_blank" rel="noopener noreferrer" class="flex justify-center items-center w-full rounded-md border border-transparent bg-yellow-500 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-yellow-600">
                        Avisar (Cheguei na Porta)
                    </a>
                    <a id="btn-whatsapp-agradecer" href="#" target="_blank" rel="noopener noreferrer" class="flex justify-center items-center w-full rounded-md border border-transparent bg-blue-500 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-600">
                        Agradecer (Pós-Venda)
                    </a>
                    <a id="btn-whatsapp-pix" href="#" target="_blank" rel="noopener noreferrer" class="flex justify-center items-center w-full rounded-md border border-transparent bg-gray-700 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-gray-800">
                        Enviar Chave Pix
                    </a>
                    <a id="btn-whatsapp-compartilhar" href="#" target="_blank" rel="noopener noreferrer" class="flex justify-center items-center w-full rounded-md border border-transparent bg-purple-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-purple-700">
                        Compartilhar Pedido (Admin)
                    </a>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end rounded-b-lg">
                <button type="button" id="btn-fechar-whatsapp" class="rounded-md border border-gray-400 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Aviso -->
    <div id="modal-aviso" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm m-4">
            <div class="p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Atenção</h3>
                <p id="modal-aviso-texto" class="text-gray-700 mb-6">Mensagem de aviso.</p>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end rounded-b-lg">
                <button type="button" id="btn-fechar-aviso" class="rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700">OK</button>
            </div>
        </div>
    </div>

    <!-- Inputs de Arquivo Ocultos -->
    <input type="file" id="input-carregar-arquivo" class="hidden" accept=".json,application/json">
    <input type="file" id="input-carregar-card" class="hidden" accept=".json,application/json">


    <!-- =================================================================== -->
    <!-- SCRIPT (Contém toda a lógica) -->
    <!-- =================================================================== -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Constantes ---
            const CHAVE_PIX_PADRAO = "seu-email@provedor.com"; // <-- MUDE AQUI SUA CHAVE PIX

            // --- Seletores de Elementos ---
            
            // Lógica de Página e Navegação
            const bodyEl = document.body;
            
            // Nova Barra Superior
            const btnTopAdmin = document.getElementById('btn-top-admin');
            const btnTopEntregador = document.getElementById('btn-top-entregador');
            const btnTopMontador = document.getElementById('btn-top-montador');
            
            <!-- MODIFICADO: Seletores do Header Admin removidos (agora não é colapsável)
            -->
            
            // Gerenciamento de Rotas (Dentro do Header)
            const btnNovaRota = document.getElementById('btn-nova-rota');
            const selectRotaAtiva = document.getElementById('select-rota-ativa');
            const inputNomeRota = document.getElementById('input-nome-rota');
            const inputDataRota = document.getElementById('input-data-rota');
            const displayDiaSemana = document.getElementById('display-dia-semana');
            const btnExcluirRota = document.getElementById('btn-excluir-rota');

            // Seção Despesas (Entregador)
            const inputDespesaAbastecimento = document.getElementById('input-despesa-abastecimento');
            const inputDespesaAlimentacao = document.getElementById('input-despesa-alimentacao');
            const inputDespesaExtra = document.getElementById('input-despesa-extra');

            // Novo Modal de Formulário
            const modalForm = document.getElementById('modal-form');
            const btnAbrirFormModal = document.getElementById('btn-abrir-form-modal'); // FAB
            const btnFecharFormModal = document.getElementById('btn-fechar-form-modal'); // Botão "Cancelar" no header do modal
            
            // Formulário (Dentro do Modal)
            const formEntrega = document.getElementById('form-entrega');
            const formEntregaTitle = document.getElementById('form-entrega-title');
            const btnSubmitForm = document.getElementById('btn-submit-form');
            const btnSubmitFormText = document.getElementById('btn-submit-form-text');
            const inputCliente = document.getElementById('input-cliente');
            const datalistClientes = document.getElementById('lista-clientes');
            const infoClienteSelecionado = document.getElementById('info-cliente-selecionado');
            const displayClienteEndereco = document.getElementById('display-cliente-endereco');
            const displayClienteComplemento = document.getElementById('display-cliente-complemento');
            const displayClienteCelular = document.getElementById('display-cliente-celular');
            const obsClienteInput = document.getElementById('obs-cliente');
            const displayValor = document.getElementById('display-valor');
            const inputRotaEntrega = document.getElementById('input-rota-entrega');

            // Sub-Formulário de Adicionar Cesta
            const formAddCesta = document.getElementById('form-add-cesta');
            const btnAddCesta = document.getElementById('btn-add-cesta');
            const subSelectCesta = document.getElementById('sub-select-cesta');
            const subInputQuantidade = document.getElementById('sub-input-quantidade');
            const subCampoBrindeDescricao = document.getElementById('sub-campo-brinde-descricao');
            const subInputBrindeDescricao = document.getElementById('sub-input-brinde-descricao');
            const subCampoAlterada = document.getElementById('sub-campo-alterada');
            const subCodigoAlterada = document.getElementById('sub-codigo-alterada');
            const subCodigoFinal = document.getElementById('sub-codigo-final'); // NOVO SELETOR

            // Lista de Cestas no Pedido (Formulário)
            const listaCestasNoPedidoEl = document.getElementById('lista-cestas-no-pedido');
            const listaCestasVaziaEl = document.getElementById('lista-cestas-vazia');
            
            // Lista de Entregas (Página Rota)
            const listaEntregasEl = document.getElementById('lista-entregas');
            const listaVaziaEl = document.getElementById('lista-vazia');
            
            // Modais
            const modalPagamento = document.getElementById('modal-pagamento');
            const formPagamento = document.getElementById('form-pagamento');
            const btnCancelarPagamento = document.getElementById('btn-cancelar-pagamento');
            const modalClienteNome = document.getElementById('modal-cliente-nome');
            const modalClienteValor = document.getElementById('modal-cliente-valor');
            const modalErrorPagamento = document.getElementById('modal-error-pagamento');

            const btnExportar = document.getElementById('btn-exportar');
            const btnCarregar = document.getElementById('btn-carregar');
            const btnImportarCard = document.getElementById('btn-importar-card');
            
            const modalExportar = document.getElementById('modal-exportar');
            const exportRelatorioEl = document.getElementById('export-relatorio');
            const exportWhatsappLinkEl = document.getElementById('export-whatsapp-link');
            const btnFecharExportar = document.getElementById('btn-fechar-exportar');
            const btnBaixarJson = document.getElementById('btn-baixar-json');

            const modalWhatsApp = document.getElementById('modal-whatsapp');
            const modalWhatsAppCliente = document.getElementById('modal-whatsapp-cliente');
            const btnFecharWhatsApp = document.getElementById('btn-fechar-whatsapp');

            const modalAviso = document.getElementById('modal-aviso');
            const modalAvisoTexto = document.getElementById('modal-aviso-texto');
            const btnFecharAviso = document.getElementById('btn-fechar-aviso');
            
            const inputCarregarArquivo = document.getElementById('input-carregar-arquivo');
            const inputCarregarCard = document.getElementById('input-carregar-card');
            
            const summaryTotalPedidos = document.getElementById('summary-total-pedidos');
            const summaryTotalCestas = document.getElementById('summary-total-cestas');
            const summaryCestasBreakdown = document.getElementById('summary-cestas-breakdown');
            const summaryRotasBreakdown = document.getElementById('summary-rotas-breakdown');
            
            const filtrosRotaContainer = document.getElementById('filtros-rota');

            // --- Estado da Aplicação ---
            let todasAsRotas = {};
            let rotaAtivaId = null;
            const MAX_ROTAS = 30;
            let CLIENTES_CACHE = {};

            let entregaParaPagarId = null;
            let whatsAppEntregaId = null;
            let editingEntregaId = null;
            
            let cestasDoPedidoAtual = []; // "Carrinho" do formulário
            let filtroRotaAtiva = 'TODOS';
            let modoAtual = 'admin'; // 'admin', 'entregador', 'montador'

            // --- Funções ---

            // --- Funções de Navegação e UI ---
            
            /**
             * Abre o modal do formulário
             */
            function abrirFormModal() {
                modalForm.style.display = 'block';
                bodyEl.classList.add('overflow-hidden'); // Impede scroll do body
            }

            /**
             * Fecha o modal do formulário
             */
            function fecharFormModal() {
                modalForm.style.display = 'none';
                bodyEl.classList.remove('overflow-hidden');
            }

            /**
             * Alterna entre os modos Admin, Entregador e Montador
             */
            function setModoVisualizacao(modo) {
                modoAtual = modo;
                bodyEl.classList.remove('modo-admin', 'modo-entregador', 'modo-montador');
                
                // Atualiza botões na barra SUPERIOR
                btnTopAdmin.classList.remove('btn-modo-ativo');
                btnTopEntregador.classList.remove('btn-modo-ativo');
                btnTopMontador.classList.remove('btn-modo-ativo');

                if (modo === 'admin') {
                    bodyEl.classList.add('modo-admin');
                    btnTopAdmin.classList.add('btn-modo-ativo');
                } else if (modo === 'entregador') {
                    bodyEl.classList.add('modo-entregador');
                    btnTopEntregador.classList.add('btn-modo-ativo');
                } else if (modo === 'montador') {
                    bodyEl.classList.add('modo-montador');
                    btnTopMontador.classList.add('btn-modo-ativo');
                }
            }
            
            function mostrarAviso(mensagem) {
                modalAvisoTexto.textContent = mensagem;
                modalAviso.classList.remove('hidden');
            }

            function fecharAviso() {
                modalAviso.classList.add('hidden');
            }

            // --- Funções de Formatação ---
            
            function formatarMoeda(valor) {
                return parseFloat(valor).toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
            }
            
            function formatarData(isoString) {
                if (!isoString) return '';
                const data = new Date(isoString);
                return data.toLocaleString('pt-BR', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
            }

            function getDiaDaSemana(dataString) {
                if (!dataString) return '-';
                const data = new Date(dataString + 'T12:00:00');
                const dia = data.toLocaleDateString('pt-BR', { weekday: 'long' });
                return dia.charAt(0).toUpperCase() + dia.slice(1);
            }

            // --- Funções de Dados (Rotas) ---

            function salvarLocalStorage() {
                if (rotaAtivaId && todasAsRotas[rotaAtivaId]) {
                    salvarTodasAsRotas();
                }
            }

            function salvarTodasAsRotas() {
                const chavesRotas = Object.keys(todasAsRotas);
                if (chavesRotas.length > MAX_ROTAS) {
                    const chavesOrdenadas = chavesRotas.sort((a, b) => a - b);
                    const chavesParaRemover = chavesOrdenadas.slice(0, chavesOrdenadas.length - MAX_ROTAS);
                    chavesParaRemover.forEach(chave => delete todasAsRotas[chave]);
                }
                localStorage.setItem('gerenciadorDeRotas', JSON.stringify(todasAsRotas));
                if (rotaAtivaId) {
                    localStorage.setItem('rotaAtivaId', rotaAtivaId);
                }
            }

            function iniciarAplicativo() {
                // Carregar Clientes
                try {
                    if (typeof CLIENTES_DB !== 'undefined' && Array.isArray(CLIENTES_DB)) {
                        datalistClientes.innerHTML = '';
                        CLIENTES_DB.forEach(cliente => {
                            const option = document.createElement('option');
                            option.value = cliente.nome;
                            datalistClientes.appendChild(option);
                            CLIENTES_CACHE[cliente.nome.toLowerCase()] = cliente;
                        });
                    } else {
                        console.error("CLIENTES_DB não encontrado.");
                        mostrarAviso("Erro ao carregar banco de dados de clientes.");
                    }
                } catch (e) {
                     console.error("Erro ao processar clientes:", e);
                     mostrarAviso("Erro ao processar o arquivo 'clientes.js'.");
                }

                // Carregar Rotas
                const dadosSalvos = localStorage.getItem('gerenciadorDeRotas');
                if (dadosSalvos) {
                    todasAsRotas = JSON.parse(dadosSalvos);
                }

                rotaAtivaId = localStorage.getItem('rotaAtivaId');

                if (!rotaAtivaId || !todasAsRotas[rotaAtivaId]) {
                    if (Object.keys(todasAsRotas).length === 0) {
                        criarNovaRota(false);
                    } else {
                        rotaAtivaId = Object.keys(todasAsRotas).sort((a, b) => b - a)[0];
                        localStorage.setItem('rotaAtivaId', rotaAtivaId);
                    }
                }

                popularSelectRotas();
                carregarRotaAtiva();
                
                setModoVisualizacao('admin'); // Padrão
                
                toggleSubCampoAlterada();
                toggleSubCampoBrinde();
            }

            function getEntregasAtivas() {
                if (rotaAtivaId && todasAsRotas[rotaAtivaId]) {
                    return todasAsRotas[rotaAtivaId].entregas;
                }
                return [];
            }

            function popularSelectRotas() {
                selectRotaAtiva.innerHTML = '';
                const chavesOrdenadas = Object.keys(todasAsRotas).sort((a, b) => b - a);
                chavesOrdenadas.forEach(id => {
                    const rota = todasAsRotas[id];
                    const option = document.createElement('option');
                    option.value = id;
                    const dataFormatada = rota.data ? new Date(rota.data + 'T12:00:00').toLocaleDateString('pt-BR') : 'Sem Data';
                    option.textContent = `${rota.nome} (${dataFormatada})`;
                    if (id === rotaAtivaId) {
                        option.selected = true;
                    }
                    selectRotaAtiva.appendChild(option);
                });
            }

            function carregarRotaAtiva() {
                const rota = todasAsRotas[rotaAtivaId];
                if (!rota) {
                    console.error("Erro: Tentando carregar rota ativa, mas ID não encontrado.");
                    if (Object.keys(todasAsRotas).length === 0) criarNovaRota(false);
                    else rotaAtivaId = Object.keys(todasAsRotas).sort((a, b) => b - a)[0];
                    localStorage.setItem('rotaAtivaId', rotaAtivaId);
                    
                    popularSelectRotas();
                    carregarRotaAtiva(); // Tenta novamente
                    return;
                }

                inputNomeRota.value = rota.nome;
                inputDataRota.value = rota.data;
                displayDiaSemana.textContent = getDiaDaSemana(rota.data);

                rota.despesas = rota.despesas || { abastecimento: 0, alimentacao: 0, extra: 0 };
                inputDespesaAbastecimento.value = rota.despesas.abastecimento || 0;
                inputDespesaAlimentacao.value = rota.despesas.alimentacao || 0;
                inputDespesaExtra.value = rota.despesas.extra || 0;

                selectRotaAtiva.value = rotaAtivaId;
                
                renderizarEntregas();
                renderizarResumo();
            }

            function criarNovaRota(atualizarTela = true) {
                const novoId = Date.now().toString();
                const hoje = new Date().toISOString().split('T')[0];

                const novaRota = {
                    id: novoId, nome: "Nova Rota", data: hoje,
                    entregas: [],
                    despesas: { abastecimento: 0, alimentacao: 0, extra: 0 }
                };

                todasAsRotas[novoId] = novaRota;
                rotaAtivaId = novoId;
                salvarTodasAsRotas();
                
                if (atualizarTela) {
                    popularSelectRotas();
                    carregarRotaAtiva();
                }
            }

            function atualizarInfoRota() {
                const rota = todasAsRotas[rotaAtivaId];
                if (!rota) return;
                rota.nome = inputNomeRota.value || "Rota Sem Nome";
                rota.data = inputDataRota.value;
                displayDiaSemana.textContent = getDiaDaSemana(rota.data);
                salvarTodasAsRotas();
                popularSelectRotas();
            }

            function salvarDespesas() {
                const rota = todasAsRotas[rotaAtivaId];
                if (!rota) return;
                rota.despesas = {
                    abastecimento: parseFloat(inputDespesaAbastecimento.value) || 0,
                    alimentacao: parseFloat(inputDespesaAlimentacao.value) || 0,
                    extra: parseFloat(inputDespesaExtra.value) || 0
                };
                salvarTodasAsRotas();
            }

            function excluirRotaAtiva() {
                 if (Object.keys(todasAsRotas).length <= 1) {
                    mostrarAviso("Você não pode excluir a última rota.");
                    return;
                }
                delete todasAsRotas[rotaAtivaId];
                const chavesOrdenadas = Object.keys(todasAsRotas).sort((a, b) => b - a);
                rotaAtivaId = chavesOrdenadas[0];
                salvarTodasAsRotas();
                popularSelectRotas();
                carregarRotaAtiva();
            }
            
            // --- Funções de Renderização (Cards e Resumo) ---

            function renderizarEntregas() {
                listaEntregasEl.innerHTML = '';
                const entregas = getEntregasAtivas();

                const entregasFiltradas = entregas.filter(e => {
                    const rotaPedido = e.rotaEntrega || 'N/A';
                    if (filtroRotaAtiva === 'TODOS') return true;
                    return rotaPedido === filtroRotaAtiva;
                });
                
                const entregasOrdenadas = entregasFiltradas.sort((a, b) => {
                    const rotaA = a.rotaEntrega || 'N/A';
                    const rotaB = b.rotaEntrega || 'N/A';
                    return rotaA.localeCompare(rotaB);
                });

                if (entregasOrdenadas.length === 0) {
                    listaVaziaEl.classList.remove('hidden');
                    return;
                }
                
                listaVaziaEl.classList.add('hidden');

                entregasOrdenadas.forEach((entrega, index) => {
                    const card = document.createElement('div');
                    card.dataset.id = entrega.id;
                    
                    let statusClass = '';
                    if (entrega.status === 'Entregue') statusClass = 'entregue';
                    if (entrega.status === 'Cancelada') statusClass = 'cancelada';
                    if (entrega.status === 'Montado') statusClass = 'montado';
                    
                    const rotaClass = `rota-${(entrega.rotaEntrega || 'N/A').replace('/', '\\/')}`;
                    const isFinalizada = entrega.status === 'Entregue' || entrega.status === 'Cancelada';
                    
                    card.className = `bg-white p-4 rounded-lg shadow-sm border border-gray-200 border-l-4 flex flex-col w-full overflow-hidden ${rotaClass} ${statusClass}`;
                    
                    let obsInfo = '';
                    if (entrega.observacao) {
                        obsInfo = `
                            <div class="mt-2 p-2 bg-red-50 border border-red-200 rounded-md">
                                <span class="text-xs font-bold text-red-700">OBSERVAÇÃO:</span>
                                <p class="pre-wrap-texto text-red-700">${entrega.observacao}</p>
                            </div>
                        `;
                    }
                    
                    let detalhesInfo = '';
                    const cestasParaRenderizar = migrarFormatoCestas(entrega);
                    
                    cestasParaRenderizar.forEach(cesta => {
                        if (cesta.tipo === 'Alterada' && cesta.codigoAlterada) {
                             detalhesInfo += `
                                <div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded-md">
                                    <span class="text-xs font-bold text-yellow-700">DETALHES (${cesta.nome}):</span>
                                    <p class="pre-wrap-texto text-yellow-700">${cesta.codigoAlterada}</p>
                                </div>
                            `;
                        }
                    });


                    let statusInfo = '';
                    if (entrega.status === 'Entregue') {
                        statusInfo = `<div class="text-xs text-green-700 mt-2"><span class="font-semibold">Pagamento:</span> ${entrega.formaPagamento.join(', ')} | <span class="font-semibold">Horário:</span> ${formatarData(entrega.horarioEntrega)}</div>`;
                    } else if (entrega.status === 'Cancelada') {
                        statusInfo = `<div class="text-xs text-red-700 mt-2"><span class="font-semibold">Status:</span> CANCELADA | <span class="font-semibold">Horário:</span> ${formatarData(entrega.horarioEntrega)}</div>`;
                    } else if (entrega.status === 'Montado') {
                         statusInfo = `<div class="text-xs text-blue-700 mt-2"><span class="font-semibold">Status:</span> MONTADO | <span class="font-semibold">Horário:</span> ${formatarData(entrega.horarioMontagem)}</div>`;
                    }
                    
                    const clienteId = entrega.cliente.id || entrega.cliente.Id || entrega.cliente.ID || null;
                    let idInfo = clienteId ? `<p class="text-xs text-gray-500 font-mono truncate" title="ID: ${clienteId}">ID: ${clienteId}</p>` : '';

                    let infoClienteHtml = `
                        <div class="flex-1 min-w-0">
                            ${idInfo}
                            <p class="text-xl font-semibold text-gray-900 truncate" title="${entrega.cliente.nome}">${entrega.cliente.nome}</p>
                            <p class="text-sm text-gray-700 truncate montador-hidden" title="${entrega.cliente.endereco || ''}">${entrega.cliente.endereco || 'Sem endereço'}</p>
                            <p class="text-sm text-gray-700 truncate montador-hidden" title="${entrega.cliente.complemento || ''}">${entrega.cliente.complemento || 'Sem complemento'}</p>
                            <p class="text-sm text-gray-700 truncate montador-hidden" title="${entrega.cliente.celular || ''}">Cel: ${entrega.cliente.celular || 'Sem celular'}</p>
                        </div>
                        <div class="flex flex-col items-center justify-center admin-view ml-2">
                            <button class="btn-mover-cima p-2 text-gray-500 ${index === 0 || isFinalizada ? 'opacity-25' : 'hover:text-blue-600'}" data-id="${entrega.id}" ${index === 0 || isFinalizada ? 'disabled' : ''}>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg>
                            </button>
                            <button class="btn-mover-baixo p-2 text-gray-500 ${index === entregasOrdenadas.length - 1 || isFinalizada ? 'opacity-25' : 'hover:text-blue-600'}" data-id="${entrega.id}" ${index === entregasOrdenadas.length - 1 || isFinalizada ? 'disabled' : ''}>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                            </button>
                        </div>
                    `;
                    
                    let infoCestasHtml = '<div class="mt-2 space-y-2">';
                    let valorTotalEntrega = 0;
                    
                    cestasParaRenderizar.forEach(cesta => {
                        const valorCestaTotal = cesta.valor * cesta.quantidade;
                        valorTotalEntrega += valorCestaTotal;
                        
                        let tagsCesta = '';
                        // MODIFICADO: Lógica da tag Brinde
                        if (cesta.brinde === 'Sim') tagsCesta += `<span class="text-xs font-semibold bg-pink-100 text-pink-800 px-2 py-0.5 rounded-full">Brinde: ${cesta.brindeDescricao || 'Sim'}</span>`;
                        // MODIFICADO: Lógica da tag Alterada
                        if (cesta.tipo === 'Alterada') tagsCesta += `<span class="text-xs font-semibold bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">Cesta: Alterada</span>`;
                        if (cesta.codigoFinal) tagsCesta += `<span class="text-xs font-semibold bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">Final: ${cesta.codigoFinal}</span>`;
                        if (cesta.partesAlteradas && cesta.partesAlteradas.length > 0) tagsCesta += `<span class="text-xs font-semibold bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">Partes: ${cesta.partesAlteradas.join(', ')}</span>`;
                        
                        infoCestasHtml += `
                            <div class="p-2 bg-gray-50 rounded-md border border-gray-300">
                                <div class="flex justify-between items-center">
                                    <span class="block text-base font-semibold text-gray-900">${cesta.quantidade}x ${cesta.nome}</span>
                                    <span class="block text-lg font-bold text-blue-600 montador-hidden">${formatarMoeda(valorCestaTotal)}</span>
                                </div>
                                <div class="mt-1 flex flex-wrap gap-1">
                                    ${tagsCesta}
                                </div>
                            </div>
                        `;
                    });
                    infoCestasHtml += `</div>`;
                    
                    if (cestasParaRenderizar.length > 1) {
                         infoCestasHtml += `
                            <div class="mt-2 text-right montador-hidden">
                                <span class="text-sm font-medium text-gray-700">Valor Total do Pedido:</span>
                                <span class="block text-xl font-bold text-blue-700">${formatarMoeda(valorTotalEntrega)}</span>
                            </div>
                         `;
                    }
                    
                    let botoesAcaoHtml = '';
                    if (entrega.status === 'Pendente') {
                        botoesAcaoHtml = `
                            <button class="btn-editar-entrega admin-view w-full rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-yellow-100 text-yellow-700 border border-yellow-300 hover:bg-yellow-200 flex justify-center items-center col-span-1" data-id="${entrega.id}" title="Editar Pedido">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                                Editar
                            </button>
                            <button class="btn-cancelar-entrega admin-view w-full rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-red-100 text-red-700 border border-red-300 hover:bg-red-200 col-span-1" data-id="${entrega.id}">
                                Cancelar
                            </button>
                            <!-- MODIFICADO: col-span-2 para Entregador -->
                            <button class="btn-entregue entregador-view w-full rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-white text-gray-700 border border-gray-400 hover:bg-gray-50 col-span-2" data-id="${entrega.id}">
                                Marcar Entrega
                            </button>
                            <!-- MODIFICADO: col-span-2 para Montador -->
                            <button class="btn-montado montador-view w-full rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-white text-blue-700 border border-gray-400 hover:bg-gray-50 col-span-2" data-id="${entrega.id}">
                                Marcar como Montado
                            </button>
                        `;
                    } else if (entrega.status === 'Montado') {
                         botoesAcaoHtml = `
                            <button class="btn-editar-entrega admin-view w-full rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-yellow-100 text-yellow-700 border border-yellow-300 hover:bg-yellow-200 flex justify-center items-center col-span-1" data-id="${entrega.id}" title="Editar Pedido">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                                Editar
                            </button>
                            <button class="btn-cancelar-entrega admin-view w-full rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-red-100 text-red-700 border border-red-300 hover:bg-red-200 col-span-1" data-id="${entrega.id}">
                                Cancelar
                            </button>
                            <!-- MODIFICADO: col-span-2 para Entregador -->
                            <button class="btn-entregue entregador-view w-full rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-white text-gray-700 border border-gray-400 hover:bg-gray-50 col-span-2" data-id="${entrega.id}">
                                Marcar Entrega
                            </button>
                            <!-- MODIFICADO: col-span-2 para Montador -->
                            <button class="btn-montado montador-view w-full rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-blue-600 text-white cursor-not-allowed col-span-2" data-id="${entrega.id}" disabled>
                                Montado
                            </button>
                         `;
                    } else if (entrega.status === 'Entregue') {
                        botoesAcaoHtml = `<button class="btn-entregue w-full rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-green-600 text-white cursor-not-allowed col-span-2" disabled>Entregue</button>`;
                    } else {
                        botoesAcaoHtml = `<button class="btn-entregue w-full rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-gray-500 text-white cursor-not-allowed col-span-2" disabled>Cancelada</button>`;
                    }

                    card.innerHTML = `
                        <!-- Seção Principal de Informações -->
                        <div class="flex justify-between items-start">
                            ${infoClienteHtml}
                        </div>
                        
                        <!-- Cestas -->
                        ${infoCestasHtml}

                        <!-- Blocos de Info (Obs, Detalhes, Status) -->
                        <div class="mt-2 space-y-2 overflow-hidden">
                            ${obsInfo}
                            ${detalhesInfo}
                            ${statusInfo}
                        </div>
                        
                        <!-- Barra de Ações (Ícones) -->
                        <div class="mt-4 pt-4 border-t border-gray-200 montador-hidden">
                            <div class="grid grid-cols-4 gap-2">
                                <button class="btn-card-maps flex flex-col items-center justify-center p-2 rounded-lg ${isFinalizada ? 'opacity-50' : 'hover:bg-gray-100'}" title="Abrir no Google Maps" ${isFinalizada ? 'disabled' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                                    <span class="text-xs font-medium text-gray-700 mt-1">Mapa</span>
                                </button>
                                <button class="btn-card-whatsapp flex flex-col items-center justify-center p-2 rounded-lg ${isFinalizada ? 'opacity-50' : 'hover:bg-gray-100'}" title="Abrir WhatsApp" data-id="${entrega.id}" ${isFinalizada ? 'disabled' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" viewBox="0 0 20 20" fill="currentColor"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM5.5 8.5A1.5 1.5 0 017 7h6a1.5 1.5 0 011.5 1.5v3A1.5 1.5 0 0113 13H7a1.5 1.5 0 01-1.5-1.5v-3z" /></svg>
                                    <span class="text-xs font-medium text-gray-700 mt-1">Chat</span>
                                </button>
                                <button class="btn-card-ligar flex flex-col items-center justify-center p-2 rounded-lg ${isFinalizada ? 'opacity-50' : 'hover:bg-gray-100'}" title="Ligar para Cliente" data-id="${entrega.id}" ${isFinalizada ? 'disabled' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C6.477 18 2 13.523 2 8V3z" /></svg>
                                    <span class="text-xs font-medium text-gray-700 mt-1">Ligar</span>
                                </button>
                                <button class="btn-card-json admin-view flex flex-col items-center justify-center p-2 rounded-lg hover:bg-gray-100" title="Exportar Card (.json)" data-id="${entrega.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                    <span class="text-xs font-medium text-gray-700 mt-1">JSON</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Botões de Ação (Entregar, Cancelar, etc) -->
                        <div class="mt-4 grid grid-cols-2 gap-2">
                            ${botoesAcaoHtml}
                        </div>
                    `;
                    listaEntregasEl.appendChild(card);
                });
            }
            
            function renderizarResumo() {
                const entregas = getEntregasAtivas();
                
                const totalPedidos = entregas.length;
                let totalCestas = 0;
                let cestasBreakdown = {};
                let rotasBreakdown = {};
                let pedidosRotaBreakdown = {};

                entregas.forEach(entrega => {
                    // MODIFICADO: Pedidos cancelados são ignorados do resumo
                    if (entrega.status === 'Cancelada') return;

                    const rotaPedido = entrega.rotaEntrega || 'N/A';
                    pedidosRotaBreakdown[rotaPedido] = (pedidosRotaBreakdown[rotaPedido] || 0) + 1;
                    
                    const cestas = migrarFormatoCestas(entrega);
                    cestas.forEach(cesta => {
                        totalCestas += cesta.quantidade;
                        cestasBreakdown[cesta.nome] = (cestasBreakdown[cesta.nome] || 0) + cesta.quantidade;
                        rotasBreakdown[rotaPedido] = (rotasBreakdown[rotaPedido] || 0) + cesta.quantidade;
                    });
                });

                summaryTotalPedidos.textContent = entregas.filter(e => e.status !== 'Cancelada').length; // MODIFICADO
                summaryTotalCestas.textContent = totalCestas;
                // MODIFICADO: Formato de lista (com <br>)
                summaryCestasBreakdown.innerHTML = Object.entries(cestasBreakdown).map(([n, q]) => `${n}: <strong>${q}</strong>`).join('<br>') || 'N/A';
                summaryRotasBreakdown.innerHTML = Object.entries(rotasBreakdown).map(([r, q]) => `${r}: <strong>${q}</strong>`).join('<br>') || 'N/A';
                // REMOVIDO: summaryPedidosRotaBreakdown.textContent = Object.entries(pedidosRotaBreakdown).map(([r, q]) => `${r}: ${q}`).join(' | ') || 'N/A';
            }
            
            // --- Funções de Lógica do Formulário (Adicionar/Editar) ---

            function toggleSubCampoAlterada() {
                const tipo = document.querySelector('input[name="sub-tipo-cesta"]:checked').value;
                if (tipo === 'Alterada') subCampoAlterada.classList.remove('hidden');
                else subCampoAlterada.classList.add('hidden');
            }
            
            function toggleSubCampoBrinde() {
                const tipo = document.querySelector('input[name="sub-brinde"]:checked').value;
                if (tipo === 'Sim') subCampoBrindeDescricao.classList.remove('hidden');
                else subCampoBrindeDescricao.classList.add('hidden');
            }

            function adicionarCestaAoPedido() {
                const selectedOption = subSelectCesta.options[subSelectCesta.selectedIndex];
                const partesAlteradas = Array.from(formAddCesta.querySelectorAll('input[name="sub-partes_alteradas"]:checked')).map(input => input.value);
                
                const novaCesta = {
                    nome: selectedOption.value,
                    valor: parseFloat(selectedOption.dataset.valor),
                    quantidade: parseInt(subInputQuantidade.value) || 1,
                    tipo: document.querySelector('input[name="sub-tipo-cesta"]:checked').value,
                    brinde: document.querySelector('input[name="sub-brinde"]:checked').value,
                    brindeDescricao: subInputBrindeDescricao.value || '',
                    codigoAlterada: subCodigoAlterada.value || '',
                    codigoFinal: subCodigoFinal.value || '', // NOVO
                    partesAlteradas: partesAlteradas
                };
                
                cestasDoPedidoAtual.push(novaCesta);
                renderCestasNoPedido();
                atualizarValorCesta();
                resetarSubFormCesta();
            }
            
            function resetarSubFormCesta() {
                subSelectCesta.selectedIndex = 0;
                subInputQuantidade.value = 1;
                document.querySelector('input[name="sub-tipo-cesta"][value="Normal"]').checked = true;
                document.querySelector('input[name="sub-brinde"][value="Não"]').checked = true;
                subInputBrindeDescricao.value = '';
                subCodigoAlterada.value = '';
                subCodigoFinal.value = ''; // NOVO
                document.querySelectorAll('input[name="sub-partes_alteradas"]:checked').forEach(cb => cb.checked = false);
                toggleSubCampoAlterada();
                toggleSubCampoBrinde();
            }
            
            function renderCestasNoPedido() {
                listaCestasNoPedidoEl.innerHTML = '';
                if (cestasDoPedidoAtual.length === 0) {
                    listaCestasNoPedidoEl.appendChild(listaCestasVaziaEl);
                    return;
                }
                
                if (listaCestasVaziaEl.parentNode === listaCestasNoPedidoEl) {
                     listaCestasNoPedidoEl.removeChild(listaCestasVaziaEl);
                }
                
                cestasDoPedidoAtual.forEach((cesta, index) => {
                    const item = document.createElement('div');
                    item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-md border border-gray-300';
                    const valorTotalItem = cesta.valor * cesta.quantidade;
                    let detalhes = `${cesta.tipo}`;
                    if (cesta.brinde === 'Sim') detalhes += `, ${cesta.brindeDescricao || 'Brinde'}`;
                    
                    item.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-900">${cesta.quantidade}x ${cesta.nome}</p>
                            <p class="text-sm text-gray-700">${detalhes} - ${formatarMoeda(valorTotalItem)}</p>
                        </div>
                        <button type="button" data-index="${index}" class="btn-remover-cesta text-red-500 hover:text-red-700 p-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm2 3a1 1 0 100 2h2a1 1 0 100-2H9z" clip-rule="evenodd" /></svg>
                        </button>
                    `;
                    listaCestasNoPedidoEl.appendChild(item);
                });
            }
            
            function handleRemoverCesta(e) {
                const btn = e.target.closest('.btn-remover-cesta');
                if (!btn) return;
                const index = parseInt(btn.dataset.index);
                if (isNaN(index) || index < 0 || index >= cestasDoPedidoAtual.length) return;
                cestasDoPedidoAtual.splice(index, 1);
                renderCestasNoPedido();
                atualizarValorCesta();
            }
            
            function atualizarValorCesta() {
                let valorTotal = 0;
                cestasDoPedidoAtual.forEach(cesta => {
                    valorTotal += cesta.valor * cesta.quantidade;
                });
                displayValor.textContent = formatarMoeda(valorTotal);
            }

            function adicionarOuAtualizarEntrega(e) {
                e.preventDefault();
                const rotaAtiva = todasAsRotas[rotaAtivaId];
                if (!rotaAtiva) {
                    mostrarAviso("Nenhuma rota ativa selecionada.");
                    return;
                }
                const entregas = rotaAtiva.entregas;

                const nomeClienteSelecionado = inputCliente.value;
                const clienteSelecionado = CLIENTES_CACHE[nomeClienteSelecionado.toLowerCase()];
                let clienteData;

                if (clienteSelecionado) clienteData = clienteSelecionado;
                else clienteData = { nome: nomeClienteSelecionado, celular: '', endereco: nomeClienteSelecionado, complemento: '' };

                if (!clienteData.nome) {
                    mostrarAviso('Por favor, selecione ou digite um nome de cliente.');
                    return;
                }
                
                if (cestasDoPedidoAtual.length === 0) {
                    mostrarAviso('Você deve adicionar ao menos uma cesta ao pedido.');
                    return;
                }

                const cestasParaSalvar = cestasDoPedidoAtual.map(c => ({...c}));
                
                const dadosDoForm = {
                    cliente: clienteData,
                    observacao: obsClienteInput.value,
                    rotaEntrega: inputRotaEntrega.value,
                    cestas: cestasParaSalvar
                };

                if (editingEntregaId) {
                    // MODO EDIÇÃO
                    const index = entregas.findIndex(e => e.id.toString() === editingEntregaId);
                    if (index !== -1) {
                        const entregaOriginal = entregas[index];
                        entregas[index] = { ...entregaOriginal, ...dadosDoForm };
                        // Limpa campos antigos legados
                        delete entregas[index].cesta; delete entregas[index].quantidade;
                        delete entregas[index].tipo; delete entregas[index].brinde;
                        delete entregas[index].brindeDescricao; delete entregas[index].codigoAlterada;
                        delete entregas[index].partesAlteradas;
                        delete entregas[index].codigoFinal; // Limpa o legado (embora seja novo, é melhor limpar se existir solto)
                        
                        mostrarAviso("Entrega atualizada com sucesso!");
                    } else {
                        mostrarAviso("Erro: Não foi possível encontrar a entrega para atualizar.");
                    }
                    sairModoEdicao(); // Também fecha o modal
                } else {
                    // MODO NOVA ENTREGA
                    const novaEntrega = {
                        ...dadosDoForm,
                        id: Date.now(), status: "Pendente",
                        formaPagamento: [], horarioEntrega: null, horarioMontagem: null
                    };
                    entregas.push(novaEntrega);
                    // Limpa o formulário principal
                    formEntrega.reset();
                    inputCliente.value = '';
                    infoClienteSelecionado.classList.add('hidden');
                    inputRotaEntrega.value = 'CUIABÁ';
                    // Limpa o estado do "carrinho"
                    cestasDoPedidoAtual = [];
                    renderCestasNoPedido();
                    atualizarValorCesta();
                    resetarSubFormCesta();
                    // Fecha o modal
                    fecharFormModal();
                }
                
                salvarLocalStorage();
                
                // CORREÇÃO: Reseta o filtro para "TODAS" para garantir que o novo pedido apareça
                resetarFiltroParaTodas();
                
                renderizarEntregas();
                renderizarResumo();
            }

            function entrarModoEdicao(id) {
                const entrega = getEntregasAtivas().find(e => e.id.toString() === id);
                if (!entrega) return;

                editingEntregaId = id;

                // 1. Preenche dados do cliente
                inputCliente.value = entrega.cliente.nome;
                inputCliente.dispatchEvent(new Event('input', { bubbles: true }));
                obsClienteInput.value = entrega.observacao || '';
                inputRotaEntrega.value = entrega.rotaEntrega || 'CUIABÁ';

                // 2. Preenche o "carrinho"
                cestasDoPedidoAtual = migrarFormatoCestas(entrega).map(c => ({...c}));
                
                // 3. Renderiza lista de cestas e valor
                renderCestasNoPedido();
                atualizarValorCesta();
                
                // 4. Reseta o sub-form
                resetarSubFormCesta();

                // 5. Muda UI do formulário para "Modo Edição"
                formEntregaTitle.textContent = 'Editar Entrega';
                btnSubmitFormText.textContent = 'Atualizar Entrega';

                // 6. Abre o modal do formulário
                abrirFormModal();
            }

            function sairModoEdicao() {
                editingEntregaId = null;
                formEntrega.reset();

                inputCliente.value = '';
                infoClienteSelecionado.classList.add('hidden');
                inputRotaEntrega.value = 'CUIABÁ';
                
                cestasDoPedidoAtual = [];
                renderCestasNoPedido();
                atualizarValorCesta();
                resetarSubFormCesta();

                formEntregaTitle.textContent = 'Lançar Nova Entrega';
                btnSubmitFormText.textContent = 'Lançar Entrega';
                
                // Fecha o modal (se estiver aberto)
                fecharFormModal();
            }

            // --- Funções de Lógica dos Cards (Ações) ---
            
            function migrarFormatoCestas(entrega) {
                if (entrega.cestas && Array.isArray(entrega.cestas)) {
                    return entrega.cestas.map(c => {
                        const cestaLimpa = { ...c };
                        delete cestaLimpa.rotaEntrega;
                        // Garante que o campo 'codigoFinal' exista
                        cestaLimpa.codigoFinal = cestaLimpa.codigoFinal || '';
                        return cestaLimpa;
                    });
                }
                if (entrega.cesta) { // Formato antigo
                    return [{
                        nome: entrega.cesta.nome, valor: entrega.cesta.valor,
                        quantidade: entrega.quantidade || 1, tipo: entrega.tipo || 'Normal',
                        brinde: entrega.brinde || 'Não', brindeDescricao: entrega.brindeDescricao || '',
                        codigoAlterada: entrega.codigoAlterada || '', partesAlteradas: entrega.partesAlteradas || [],
                        codigoFinal: entrega.codigoFinal || ''
                    }];
                }
                return [];
            }
            
            function abrirGoogleMaps(query) {
                if (!query) {
                    mostrarAviso('Cliente não possui endereço para abrir no mapa.');
                    return;
                }
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank');
            }

            function abrirModalPagamento(id) {
                const entrega = getEntregasAtivas().find(e => e.id.toString() === id);
                if (!entrega) return;
                entregaParaPagarId = id;
                
                const cestas = migrarFormatoCestas(entrega);
                const valorTotal = cestas.reduce((total, c) => total + (c.valor * c.quantidade), 0);

                modalClienteNome.textContent = entrega.cliente.nome;
                modalClienteValor.textContent = formatarMoeda(valorTotal);
                formPagamento.reset();
                modalErrorPagamento.classList.add('hidden');
                modalPagamento.classList.remove('hidden');
            }

            function fecharModalPagamento() {
                modalPagamento.classList.add('hidden');
                entregaParaPagarId = null;
            }

            function cancelarEntrega(id) {
                const entregas = getEntregasAtivas();
                const index = entregas.findIndex(e => e.id.toString() === id);
                if (index !== -1) {
                    entregas[index].status = "Cancelada";
                    entregas[index].formaPagamento = [];
                    entregas[index].horarioEntrega = new Date().toISOString();
                }
                salvarLocalStorage();
                renderizarEntregas();
                renderizarResumo();
            }
            
            function montarEntrega(id) {
                const entregas = getEntregasAtivas();
                const index = entregas.findIndex(e => e.id.toString() === id);
                if (index !== -1 && entregas[index].status === 'Pendente') {
                    entregas[index].status = "Montado";
                    entregas[index].horarioMontagem = new Date().toISOString();
                }
                salvarLocalStorage();
                renderizarEntregas();
                renderizarResumo();
            }

            function moverEntrega(id, direcao) {
                const entregas = getEntregasAtivas();
                const index = entregas.findIndex(e => e.id.toString() === id);
                if (index === -1) return;

                if (direcao === 'cima' && index > 0) {
                    [entregas[index - 1], entregas[index]] = [entregas[index], entregas[index - 1]];
                } else if (direcao === 'baixo' && index < entregas.length - 1) {
                    [entregas[index + 1], entregas[index]] = [entregas[index], entregas[index + 1]];
                } else {
                    return;
                }
                salvarLocalStorage();
                renderizarEntregas();
            }

            function handleCardClick(e) {
                const id = e.target.closest('[data-id]')?.dataset.id;
                if (!id) return;

                // Ações de Mover
                if (e.target.closest('.btn-mover-cima')) { moverEntrega(id, 'cima'); return; }
                if (e.target.closest('.btn-mover-baixo')) { moverEntrega(id, 'baixo'); return; }
                // Ação de Cancelar
                if (e.target.closest('.btn-cancelar-entrega')) { cancelarEntrega(id); return; }
                // Ação de Editar
                if (e.target.closest('.btn-editar-entrega')) { entrarModoEdicao(id); return; }
                // Ação de Marcar Montado
                if (e.target.closest('.btn-montado')) { montarEntrega(id); return; }
                // Ação de Marcar Entregue
                if (e.target.closest('.btn-entregue')) { abrirModalPagamento(id); return; }
                // Ação do Mapa
                if (e.target.closest('.btn-card-maps')) {
                    const entrega = getEntregasAtivas().find(e => e.id.toString() === id);
                    if (entrega) abrirGoogleMaps(entrega.cliente.endereco);
                    return;
                }
                // Ação do WhatsApp
                if (e.target.closest('.btn-card-whatsapp')) { abrirModalWhatsApp(id); return; }
                // Ação de Ligar
                if (e.target.closest('.btn-card-ligar')) {
                    const entrega = getEntregasAtivas().find(e => e.id.toString() === id);
                    if (entrega && entrega.cliente.celular) {
                        window.open(`tel:${entrega.cliente.celular.replace(/\D/g, '')}`, '_self');
                    } else mostrarAviso('Cliente não possui celular cadastrado.');
                    return;
                }
                // Ação de Exportar JSON do Card
                if (e.target.closest('.btn-card-json')) {
                    const entrega = getEntregasAtivas().find(e => e.id.toString() === id);
                    if (entrega) {
                        const jsonDados = JSON.stringify(entrega, null, 2);
                        const nomeArquivo = `card_${entrega.cliente.nome.replace(/[^a-z0-9]/gi, '_')}.json`;
                        compartilharOuBaixarArquivo(jsonDados, nomeArquivo, 'application/json');
                    }
                    return;
                }
            }

            function salvarPagamento(e) {
                e.preventDefault();
                const formasPagamento = Array.from(formPagamento.querySelectorAll('input[name="forma_pagamento"]:checked')).map(input => input.value);
                if (formasPagamento.length === 0) {
                    modalErrorPagamento.classList.remove('hidden');
                    return;
                }
                
                const index = getEntregasAtivas().findIndex(e => e.id.toString() === entregaParaPagarId);
                if (index !== -1) {
                    getEntregasAtivas()[index].status = "Entregue";
                    getEntregasAtivas()[index].formaPagamento = formasPagamento;
                    getEntregasAtivas()[index].horarioEntrega = new Date().toISOString();
                }
                
                salvarLocalStorage();
                renderizarEntregas();
                renderizarResumo();
                fecharModalPagamento();
            }

            // --- Funções de Lógica dos Modais (Wpp, Exportar, etc) ---

            function gerarTextoPedidoCompleto(entrega) {
                const cestas = migrarFormatoCestas(entrega);
                const valorTotal = cestas.reduce((total, c) => total + (c.valor * c.quantidade), 0);

                let texto = `*PEDIDO COMPARTILHADO*\n\n`;
                texto += `*ID Cliente:* ${entrega.cliente.id || entrega.cliente.Id || entrega.cliente.ID || 'N/A'}\n`;
                texto += `*Cliente:* ${entrega.cliente.nome}\n`;
                texto += `*Rota:* ${entrega.rotaEntrega || 'N/A'}\n`;
                texto += `*Celular:* ${entrega.cliente.celular || 'N/A'}\n`;
                texto += `*Endereço:* ${entrega.cliente.endereco || 'N/A'}\n\n`;
                
                texto += `*Cestas no Pedido:*\n`;
                cestas.forEach((cesta, index) => {
                    texto += `  *Item ${index + 1}: ${cesta.quantidade}x ${cesta.nome}*\n`;
                    if (cesta.tipo === 'Alterada') {
                        if (cesta.codigoFinal) texto += `    Final: ${cesta.codigoFinal}\n`;
                        if (cesta.codigoAlterada) texto += `    Detalhes: ${cesta.codigoAlterada}\n`;
                    }
                });
                texto += `\n*Valor Total:* ${formatarMoeda(valorTotal)}\n`;
                if (entrega.observacao) texto += `\n*Observação:*\n${entrega.observacao}\n`;
                return texto;
            }
            
            function abrirModalWhatsApp(id) {
                const entrega = getEntregasAtivas().find(e => e.id.toString() === id);
                if (!entrega) return;
                whatsAppEntregaId = id;
                modalWhatsAppCliente.textContent = entrega.cliente.nome;

                const telefoneLimpo = entrega.cliente.celular ? entrega.cliente.celular.replace(/\D/g, '') : null;
                const semTelefone = !telefoneLimpo;

                const toggleWhatsAppButton = (btn, disabled) => {
                    if (disabled) btn.classList.add('opacity-50', 'cursor-not-allowed');
                    else btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.href = disabled ? '#' : btn.href;
                };

                const msgAvisar = "Olá! Sou o entregador da sua Cesta Básica. Estou chegando ao seu endereço em alguns minutos. Por favor, confirme que há alguém no local para receber. Obrigado";
                const btnAvisar = document.getElementById('btn-whatsapp-avisar');
                btnAvisar.href = `https://api.whatsapp.com/send?phone=${telefoneLimpo}&text=${encodeURIComponent(msgAvisar)}`;
                toggleWhatsAppButton(btnAvisar, semTelefone);

                const msgChegou = "Olá! Cheguei com a sua Cesta Básica e já estou aqui na porta aguardando. Obrigado!";
                const btnChegou = document.getElementById('btn-whatsapp-chegou');
                btnChegou.href = `https://api.whatsapp.com/send?phone=${telefoneLimpo}&text=${encodeURIComponent(msgChegou)}`;
                toggleWhatsAppButton(btnChegou, semTelefone);

                const msgAgradecer = "Obrigado pela compra. Esperamos voce no proximo mês";
                const btnAgradecer = document.getElementById('btn-whatsapp-agradecer');
                btnAgradecer.href = `https://api.whatsapp.com/send?phone=${telefoneLimpo}&text=${encodeURIComponent(msgAgradecer)}`;
                toggleWhatsAppButton(btnAgradecer, semTelefone);

                const numeroAdmin = "65984491018";
                const msgCompartilhar = gerarTextoPedidoCompleto(entrega);
                const btnCompartilhar = document.getElementById('btn-whatsapp-compartilhar');
                btnCompartilhar.href = `https://api.whatsapp.com/send?phone=${numeroAdmin}&text=${encodeURIComponent(msgCompartilhar)}`;
                toggleWhatsAppButton(btnCompartilhar, false); 

                const cestasPix = migrarFormatoCestas(entrega);
                const valorTotalPix = cestasPix.reduce((total, c) => total + (c.valor * c.quantidade), 0);
                const msgPix = `Olá ${entrega.cliente.nome}! O valor total do seu pedido é ${formatarMoeda(valorTotalPix)}. Nossa chave Pix é: ${CHAVE_PIX_PADRAO}`;
                const btnPix = document.getElementById('btn-whatsapp-pix');
                btnPix.href = `https://api.whatsapp.com/send?phone=${telefoneLimpo}&text=${encodeURIComponent(msgPix)}`;
                toggleWhatsAppButton(btnPix, semTelefone);
                
                modalWhatsApp.classList.remove('hidden');
            }

            async function compartilharOuBaixarArquivo(data, filename, mimeType) {
                const file = new File([data], filename, { type: mimeType });
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({ title: 'Exportar Rota', text: `Arquivo: ${filename}`, files: [file] });
                    } catch (error) {
                        if (error.name !== 'AbortError') downloadArquivo(data, filename, mimeType);
                    }
                } else {
                    downloadArquivo(data, filename, mimeType);
                }
            }
            
            function downloadArquivo(data, filename, mimeType) { // Fallback
                const blob = new Blob([data], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = filename;
                document.body.appendChild(a); a.click();
                document.body.removeChild(a); URL.revokeObjectURL(url);
            }
            
            function exportarDados() {
                const rotaAtiva = todasAsRotas[rotaAtivaId];
                if (!rotaAtiva) {
                    mostrarAviso("Nenhuma rota ativa para exportar.");
                    return;
                }
                const entregas = rotaAtiva.entregas;
                salvarLocalStorage(); 

                const entregasConcluidas = entregas.filter(e => e.status === 'Entregue');
                const entregasCanceladas = entregas.filter(e => e.status === 'Cancelada');
                
                let relatorioTexto = "Nenhuma entrega finalizada.\n";
                let whatsappTexto = `*Resumo da Rota: ${rotaAtiva.nome}* (${new Date(rotaAtiva.data + 'T12:00:00').toLocaleDateString('pt-BR')})\n\n`;

                if (entregasConcluidas.length > 0 || entregasCanceladas.length > 0) relatorioTexto = "";

                if (entregasConcluidas.length > 0) {
                    relatorioTexto += "--- RELATÓRIO DE ENTREGAS ---\n\n";
                    entregasConcluidas.forEach(e => {
                        const cestas = migrarFormatoCestas(e);
                        const valorTotal = cestas.reduce((total, c) => total + (c.valor * c.quantidade), 0);
                        const totalItens = cestas.reduce((total, c) => total + c.quantidade, 0);
                        relatorioTexto += `Cliente: ${e.cliente.nome}\n`;
                        relatorioTexto += `Valor: ${formatarMoeda(valorTotal)} (${totalItens} ${totalItens > 1 ? 'itens' : 'item'})\n`;
                        relatorioTexto += `Pagamento: ${e.formaPagamento.join(', ')}\n`;
                        relatorioTexto += `Horário: ${formatarData(e.horarioEntrega)}\n-----------------------------\n`;
                    });
                }
                if (entregasCanceladas.length > 0) {
                    relatorioTexto += "\n--- ENTREGAS CANCELADAS ---\n\n";
                    entregasCanceladas.forEach(e => {
                        relatorioTexto += `Cliente: ${e.cliente.nome}\nHorário: ${formatarData(e.horarioEntrega)}\n-----------------------------\n`;
                    });
                }
                
                const entregasPendentes = entregas.filter(e => e.status === 'Pendente' || e.status === 'Montado');
                whatsappTexto += `*Entregas Pendentes (${entregasPendentes.length})*:\n`;
                if(entregasPendentes.length > 0) {
                    entregasPendentes.forEach((e, index) => {
                        const cestas = migrarFormatoCestas(e);
                        const valorTotalPendente = cestas.reduce((total, c) => total + (c.valor * c.quantidade), 0);
                        const statusTexto = e.status === 'Montado' ? ' (MONTADO)' : '';
                        whatsappTexto += `${index + 1}. *${e.cliente.nome}* [${e.rotaEntrega || 'N/A'}]${statusTexto}\n`;
                        if (e.cliente.endereco) whatsappTexto += `   End: ${e.cliente.endereco}\n`;
                        cestas.forEach(cesta => {
                             whatsappTexto += `   - ${cesta.quantidade}x ${cesta.nome} ${cesta.tipo === 'Alterada' ? '(Alterada)' : ''}\n`;
                        });
                        whatsappTexto += `   *Total: ${formatarMoeda(valorTotalPendente)}*\n`;
                        if (e.observacao) whatsappTexto += `   OBS: ${e.observacao}\n`;
                    });
                } else whatsappTexto += `Nenhuma entrega pendente.\n`;
                
                whatsappTexto += `\n\n--- RELATÓRIO FINANCEIRO ---\n`;
                
                let totalVendido = 0, totalPorCesta = {}, totalPorPagamento = {};
                entregasConcluidas.forEach(e => {
                    const cestas = migrarFormatoCestas(e);
                    const valor = cestas.reduce((total, c) => total + (c.valor * c.quantidade), 0);
                    totalVendido += valor;
                    cestas.forEach(cesta => {
                        totalPorCesta[cesta.nome] = (totalPorCesta[cesta.nome] || 0) + (cesta.valor * cesta.quantidade);
                    });
                    if (e.formaPagamento.length === 0) totalPorPagamento['N/A'] = (totalPorPagamento['N/A'] || 0) + valor;
                    else {
                        const valorDividido = valor / e.formaPagamento.length;
                        e.formaPagamento.forEach(forma => totalPorPagamento[forma] = (totalPorPagamento[forma] || 0) + valorDividido);
                    }
                });

                whatsappTexto += `\n*Vendas Concluídas:*\nTotal Vendido: *${formatarMoeda(totalVendido)}*\n`;
                whatsappTexto += `\n*Detalhado por Cesta:*\n`;
                if (Object.keys(totalPorCesta).length > 0) Object.keys(totalPorCesta).forEach(n => whatsappTexto += `   ${n}: ${formatarMoeda(totalPorCesta[n])}\n`);
                else whatsappTexto += `   Nenhuma.\n`;
                whatsappTexto += `\n*Recebimentos por Forma:*\n`;
                if (Object.keys(totalPorPagamento).length > 0) Object.keys(totalPorPagamento).forEach(f => whatsappTexto += `   ${f}: ${formatarMoeda(totalPorPagamento[f])}\n`);
                else whatsappTexto += `   Nenhum.\n`;

                const despesas = rotaAtiva.despesas;
                const totalDespesas = (despesas.abastecimento || 0) + (despesas.alimentacao || 0) + (despesas.extra || 0);
                whatsappTexto += `\n*Despesas da Rota:*\n`;
                whatsappTexto += `   Abastecimento: ${formatarMoeda(despesas.abastecimento || 0)}\n`;
                whatsappTexto += `   Alimentação: ${formatarMoeda(despesas.alimentacao || 0)}\n`;
                whatsappTexto += `   Extras: ${formatarMoeda(despesas.extra || 0)}\nTotal Despesas: *${formatarMoeda(totalDespesas)}*\n`;
                whatsappTexto += `\n*BALANÇO FINAL (Vendido - Despesas):*\n*${formatarMoeda(totalVendido - totalDespesas)}*\n`;
                whatsappTexto += `\n${relatorioTexto}`;

                exportRelatorioEl.querySelector('pre').textContent = relatorioTexto;
                
                const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(whatsappTexto)}`;
                exportWhatsappLinkEl.innerHTML = `<a href="${whatsappUrl}" target="_blank" class="inline-flex items-center justify-center w-full rounded-md border border-transparent bg-green-500 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-green-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM5.5 8.5A1.5 1.5 0 017 7h6a1.5 1.5 0 011.5 1.5v3A1.5 1.5 0 0113 13H7a1.5 1.5 0 01-1.5-1.5v-3z" /></svg> Enviar Resumo no WhatsApp</a>`;

                modalExportar.classList.remove('hidden');
            }

            // --- Funções de Importação/Exportação de Arquivos ---

            function carregarDados(jsonDados) {
                if (!jsonDados) {
                    mostrarAviso("O arquivo está vazio.");
                    return;
                }
                try {
                    const dadosCarregados = JSON.parse(jsonDados);
                    let rotaParaCarregar;

                    if (typeof dadosCarregados === 'object' && !Array.isArray(dadosCarregados) && dadosCarregados.entregas) {
                        // Caso 1: É o formato NOVO (Objeto Rota)
                        if (!dadosCarregados.id || !dadosCarregados.nome || !dadosCarregados.data) throw new Error('Objeto de rota inválido.');
                        rotaParaCarregar = dadosCarregados;
                        let novoId = rotaParaCarregar.id;
                        if (todasAsRotas[novoId]) novoId = `import-${Date.now()}`;
                        rotaParaCarregar.id = novoId;
                    } 
                    else if (Array.isArray(dadosCarregados)) {
                        // Caso 2: É o formato ANTIGO (Array de Entregas) - Adiciona na rota ativa
                        const rotaAtiva = todasAsRotas[rotaAtivaId];
                        if (!rotaAtiva) throw new Error("Nenhuma rota ativa para carregar dados antigos.");
                        if (dadosCarregados.length > 0 && !dadosCarregados[0].id) throw new Error('Estrutura de dados antiga incompatível.');
                        rotaAtiva.entregas = dadosCarregados;
                        rotaParaCarregar = rotaAtiva; // Processa a rota ativa
                    } else {
                        throw new Error('Formato de arquivo JSON desconhecido.');
                    }

                    // Migra todas as entregas dentro da rotaParaCarregar
                    rotaParaCarregar.despesas = rotaParaCarregar.despesas || { abastecimento: 0, alimentacao: 0, extra: 0 };
                    rotaParaCarregar.entregas = rotaParaCarregar.entregas.map(e => {
                        const entregaMigrada = { ...e };
                        if (!entregaMigrada.rotaEntrega) entregaMigrada.rotaEntrega = 'CUIABÁ';
                        entregaMigrada.cestas = migrarFormatoCestas(entregaMigrada);
                        entregaMigrada.horarioMontagem = entregaMigrada.horarioMontagem || null;
                        // Limpa campos legados
                        delete entregaMigrada.cesta; delete entregaMigrada.quantidade;
                        delete entregaMigrada.tipo; delete entregaMigrada.brinde;
                        delete entregaMigrada.brindeDescricao; delete entregaMigrada.codigoAlterada;
                        delete entregaMigrada.partesAlteradas;
                        delete entregaMigrada.codigoFinal;
                        return entregaMigrada;
                    });

                    // Salva a rota processada
                    todasAsRotas[rotaParaCarregar.id] = rotaParaCarregar;
                    rotaAtivaId = rotaParaCarregar.id;
                    
                    salvarTodasAsRotas();
                    popularSelectRotas();
                    carregarRotaAtiva();

                } catch (error) {
                    console.error("Erro ao carregar JSON:", error);
                    mostrarAviso(`Dados inválidos. (Erro: ${error.message})`);
                }
            }

            function handleArquivoCarregado(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => carregarDados(event.target.result);
                reader.onerror = () => mostrarAviso('Não foi possível ler o arquivo.');
                reader.readAsText(file);
                e.target.value = null;
            }
            
            function carregarCardNaRota(cardJson) {
                try {
                    let novaEntrega = JSON.parse(cardJson);
                    if (!novaEntrega.id || !novaEntrega.cliente) throw new Error("Arquivo do card é inválido.");
                    
                    novaEntrega.rotaEntrega = novaEntrega.rotaEntrega || 'CUIABÁ';
                    novaEntrega.cestas = migrarFormatoCestas(novaEntrega);
                    novaEntrega.horarioMontagem = novaEntrega.horarioMontagem || null;
                    // Limpa legados
                    delete novaEntrega.cesta; delete novaEntrega.quantidade;
                    // ... (etc)
                    
                    const rotaAtiva = todasAsRotas[rotaAtivaId];
                    if (!rotaAtiva) {
                         mostrarAviso("Nenhuma rota ativa para adicionar o card.");
                         return;
                    }
                    if (rotaAtiva.entregas.find(e => e.id === novaEntrega.id)) novaEntrega.id = Date.now(); // Evita ID duplicado

                    rotaAtiva.entregas.push(novaEntrega);
                    salvarLocalStorage();
                    
                    // CORREÇÃO: Reseta o filtro para "TODAS" para garantir que o card importado apareça
                    resetarFiltroParaTodas();
                    
                    renderizarEntregas();
                    renderizarResumo();
                    mostrarAviso("Card importado com sucesso!");

                } catch (error) {
                    console.error("Erro ao carregar Card JSON:", error);
                    mostrarAviso(`Card inválido. (Erro: ${error.message})`);
                }
            }

            function handleCardImportado(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => carregarCardNaRota(event.target.result);
                reader.onerror = () => mostrarAviso('Não foi possível ler o arquivo.');
                reader.readAsText(file);
                e.target.value = null;
            }
            
            // CORREÇÃO: Nova função para resetar o filtro
            function resetarFiltroParaTodas() {
                filtroRotaAtiva = 'TODOS';
                document.querySelectorAll('.btn-filtro-rota').forEach(btn => btn.classList.remove('btn-filtro-ativo'));
                document.querySelector('.btn-filtro-rota[data-filtro="TODAS"]').classList.add('btn-filtro-ativo');
            }
            
            function atualizarFiltroRota(e) {
                const filtroBtn = e.target.closest('.btn-filtro-rota');
                if (!filtroBtn) return;
                filtroRotaAtiva = filtroBtn.dataset.filtro;
                document.querySelectorAll('.btn-filtro-rota').forEach(btn => btn.classList.remove('btn-filtro-ativo'));
                filtroBtn.classList.add('btn-filtro-ativo');
                renderizarEntregas();
            }
            
            // --- Inicialização e Event Listeners ---
            
            // Navegação (Nova Lógica de Modal e Top Bar)
            btnAbrirFormModal.addEventListener('click', () => {
                sairModoEdicao(); // Garante que é um formulário novo
                abrirFormModal();
            });
            btnFecharFormModal.addEventListener('click', sairModoEdicao);

            <!-- MODIFICADO: Listener do Header Admin removido
            -->
            selectRotaAtiva.addEventListener('change', (e) => {
                rotaAtivaId = e.target.value;
                localStorage.setItem('rotaAtivaId', rotaAtivaId);
                carregarRotaAtiva();
            });
            btnNovaRota.addEventListener('click', () => criarNovaRota(true));
            inputNomeRota.addEventListener('change', atualizarInfoRota);
            inputDataRota.addEventListener('change', atualizarInfoRota);
            btnExcluirRota.addEventListener('click', excluirRotaAtiva);
            
            // Página Rota (Lista e Filtros)
            listaEntregasEl.addEventListener('click', handleCardClick);
            filtrosRotaContainer.addEventListener('click', atualizarFiltroRota);

            // Página Modo (Agora na Top Bar)
            btnTopAdmin.addEventListener('click', () => setModoVisualizacao('admin'));
            btnTopEntregador.addEventListener('click', () => setModoVisualizacao('entregador'));
            btnTopMontador.addEventListener('click', () => setModoVisualizacao('montador'));
            
            // Seção Despesas (Listeners)
            inputDespesaAbastecimento.addEventListener('change', salvarDespesas);
            inputDespesaAlimentacao.addEventListener('change', salvarDespesas);
            inputDespesaExtra.addEventListener('change', salvarDespesas);

            // Página Formulário (Dentro do Modal)
            formEntrega.addEventListener('submit', adicionarOuAtualizarEntrega);
            inputCliente.addEventListener('input', (e) => {
                const cliente = CLIENTES_CACHE[e.target.value.toLowerCase()];
                if (cliente) {
                    displayClienteEndereco.textContent = cliente.endereco || '-';
                    displayClienteComplemento.textContent = cliente.complemento || '-';
                    displayClienteCelular.textContent = cliente.celular || '-';
                    infoClienteSelecionado.classList.remove('hidden');
                } else {
                    infoClienteSelecionado.classList.add('hidden');
                }
            });
            
            // Página Formulário (Sub-form Cestas)
            btnAddCesta.addEventListener('click', adicionarCestaAoPedido);
            document.querySelectorAll('input[name="sub-tipo-cesta"]').forEach(r => r.addEventListener('change', toggleSubCampoAlterada));
            document.querySelectorAll('input[name="sub-brinde"]').forEach(r => r.addEventListener('change', toggleSubCampoBrinde));
            listaCestasNoPedidoEl.addEventListener('click', handleRemoverCesta);
            
            // Modais
            btnCancelarPagamento.addEventListener('click', fecharModalPagamento);
            formPagamento.addEventListener('submit', salvarPagamento);
            btnFecharWhatsApp.addEventListener('click', () => modalWhatsApp.classList.add('hidden'));
            btnExportar.addEventListener('click', exportarDados);
            btnFecharExportar.addEventListener('click', () => modalExportar.classList.add('hidden'));
            btnBaixarJson.addEventListener('click', () => {
                const rotaAtiva = todasAsRotas[rotaAtivaId];
                if (!rotaAtiva) return;
                salvarLocalStorage();
                const jsonDados = JSON.stringify(rotaAtiva, null, 2);
                const nomeArquivo = `rota_${rotaAtiva.nome.replace(/[^a-z0-Nenhum]/gi, '_')}_${rotaAtiva.data}.json`;
                compartilharOuBaixarArquivo(jsonDados, nomeArquivo, 'application/json');
            });
            btnFecharAviso.addEventListener('click', fecharAviso);

            // Importação/Exportação de Arquivos
            btnCarregar.addEventListener('click', () => inputCarregarArquivo.click());
            inputCarregarArquivo.addEventListener('change', handleArquivoCarregado);
            btnImportarCard.addEventListener('click', () => inputCarregarCard.click());
            inputCarregarCard.addEventListener('change', handleCardImportado);
            
            // Inicialização
            iniciarAplicativo();
        });
    </script>
</body>
</html>

