<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rota de Entrega</title>
    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- NOVO: Carrega o Banco de Dados de Clientes -->
    <!-- Este arquivo DEVE estar na mesma pasta que este HTML -->
    <script src="clientes.js"></script>
    
    <style>
        /* Classe para item entregue */
        .entregue {
            background-color: #f0fdf4; /* green-50 */
            border-left-width: 4px;
            border-left-color: #22c55e; /* green-500 */
        }
        .entregue .btn-entregue {
            background-color: #22c55e; /* green-500 */
            color: white;
        }

        /* Classe para item cancelado */
        .cancelada {
            background-color: #f3f4f6; /* gray-100 */
            border-left-width: 4px;
            border-left-color: #6b7280; /* gray-500 */
            opacity: 0.7;
        }
        .cancelada .btn-entregue,
        .cancelada .btn-card-maps,
        .cancelada .btn-card-whatsapp,
        .cancelada .btn-card-ligar,
        .cancelada .btn-card-json,
        .cancelada .btn-editar-entrega, /* NOVO */
        .cancelada .btn-mover-cima,
        .cancelada .btn-mover-baixo,
        .cancelada .btn-cancelar-entrega {
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        /* NOVO: Barra superior fixa */
        #top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 40; /* Abaixo dos modais (z-50) */
        }
        /* Adiciona padding ao body para a top-bar não cobrir o conteúdo */
        body {
            padding-top: 80px; 
        }

        /* NOVO: Esconde seções no modo Entregador */
        .modo-entregador .admin-view {
            display: none;
        }
        
        /* NOVO: Mostra seções apenas no modo Entregador */
        .entregador-view {
            display: none; /* Oculto por padrão */
        }
        .modo-entregador .entregador-view {
            display: grid; /* ou 'block', 'flex' dependendo do elemento */
        }
        
        /* Força o grid de despesas a aparecer */
         .modo-entregador #secao-despesas.entregador-view {
            display: block;
        }

        /* Botão de modo ativo */
        .btn-modo-ativo {
            background-color: #ffffff;
            color: #1d4ed8;
        }
        
        /* NOVO: Estilo para Textarea (para detalhes e obs) */
        textarea {
            min-height: 100px;
            white-space: pre-wrap; /* Garante que a quebra de linha seja mantida */
        }
        
        /* NOVO: Estilo para exibir texto pré-formatado no card */
        .pre-wrap-texto {
            white-space: pre-wrap; /* Mantém quebras de linha e espaços */
            word-break: break-word; /* Quebra palavras longas */
            font-family: inherit; /* Usa a fonte padrão */
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
        }
        
        /* NOVO: Setas de mover maiores */
        .btn-mover-container {
            padding: 8px; /* Aumenta a área de clique */
        }
        .btn-mover-container svg {
            width: 1.5rem; /* 24px */
            height: 1.5rem; /* 24px */
        }
        
        /* MODIFICADO: Remove aparência customizada dos selects (para dropdown nativo) */
        #select-rota-ativa, #select-cesta {
            -webkit-appearance: menulist;
            -moz-appearance: menulist;
            appearance: menulist;
            background-image: none;
            background-position: 0 0;
            background-repeat: no-repeat;
            background-size: 0 0;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">
    
    <!-- NOVO: Barra Superior Fixa (Admin/Entregador) -->
    <nav id="top-bar" class="bg-blue-700 p-4 shadow-lg w-full">
        <div class="container mx-auto max-w-5xl flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white">Gestor de Rotas</h1>
            <div class="flex bg-blue-900 rounded-lg p-1">
                <button id="btn-modo-admin" class="btn-modo-ativo text-white font-semibold py-2 px-4 rounded-md text-sm">
                    ADMIN
                </button>
                <button id="btn-modo-entregador" class="text-blue-300 font-semibold py-2 px-4 rounded-md text-sm hover:bg-blue-800">
                    ENTREGADOR
                </button>
            </div>
        </div>
    </nav>
    <!-- FIM BARRA SUPERIOR -->

    <!-- Container Principal -->
    <div class="container mx-auto max-w-5xl p-4 sm:p-6 lg:p-8">

        <!-- Seção de Gerenciamento de Rotas (ADMIN) -->
        <section class="bg-white p-6 rounded-lg shadow-md mb-8 admin-view">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Gerenciar Rota</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <!-- Seletor de Rota Ativa -->
                <div class="md:col-span-2">
                    <label for="select-rota-ativa" class="block text-sm font-medium text-gray-700">Rota Ativa</label>
                    <select id="select-rota-ativa" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base">
                        <!-- Rotas serão preenchidas pelo JS -->
                    </select>
                </div>
                <!-- Botão Nova Rota -->
                <div class="md:col-span-1">
                    <button id="btn-nova-rota" class="w-full flex justify-center items-center rounded-md border border-transparent bg-green-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-green-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        Nova Rota
                    </button>
                </div>
                <!-- Botão Excluir Rota -->
                <div class="md:col-span-1">
                     <button id="btn-excluir-rota" class="w-full flex justify-center items-center rounded-md border border-gray-300 bg-red-100 px-4 py-3 text-sm font-medium text-red-700 shadow-sm hover:bg-red-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm2 3a1 1 0 100 2h2a1 1 0 100-2H9z" clip-rule="evenodd" /></svg>
                        Excluir Rota
                    </button>
                </div>

                <!-- Nome da Rota -->
                <div class="md:col-span-2">
                    <label for="input-nome-rota" class="block text-sm font-medium text-gray-700">Nome da Rota</label>
                    <input type="text" id="input-nome-rota" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Ex: Entregas Manhã">
                </div>
                <!-- Data da Rota -->
                <div class="md:col-span-2">
                    <label for="input-data-rota" class="block text-sm font-medium text-gray-700">Data da Rota</label>
                    <div class="flex items-center">
                        <input type="date" id="input-data-rota" class="mt-1 block w-full rounded-l-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base">
                        <span id="display-dia-semana" class="mt-1 inline-flex items-center px-3 py-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-base min-w-[120px] justify-center">-</span>
                    </div>
                </div>
            </div>
        </section>
        <!-- FIM SEÇÃO ADMIN -->

        <!-- Seção de Despesas da Rota (ENTREGADOR) -->
        <section id="secao-despesas" class="bg-white p-6 rounded-lg shadow-md mb-8 entregador-view"> <!-- MODIFICADO -->
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Despesas da Rota</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label for="input-despesa-abastecimento" class="block text-sm font-medium text-gray-700">Abastecimento (R$)</label>
                    <input type="number" id="input-despesa-abastecimento" step="0.01" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="0.00">
                </div>
                <div>
                    <label for="input-despesa-alimentacao" class="block text-sm font-medium text-gray-700">Alimentação (R$)</label>
                    <input type="number" id="input-despesa-alimentacao" step="0.01" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="0.00">
                </div>
                <div>
                    <label for="input-despesa-extra" class="block text-sm font-medium text-gray-700">Extras (R$)</label>
                    <input type="number" id="input-despesa-extra" step="0.01" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="0.00">
                </div>
            </div>
        </section>
        <!-- FIM SEÇÃO DESPESAS (ENTREGADOR) -->

        <!-- Seção de Lançamento (ADMIN) -->
        <section class="bg-white p-6 rounded-lg shadow-md mb-8 admin-view">
            <!-- MODIFICADO: ID Adicionado ao Título -->
            <h2 id="form-entrega-title" class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Lançar Nova Entrega</h2>
            <form id="form-entrega" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                
                <!-- Coluna 1: Cliente e Cesta -->
                <div class="md:col-span-1 space-y-4">
                    <!-- Campo de Cliente (Input com Datalist) -->
                    <div>
                        <label for="input-cliente" class="block text-sm font-medium text-gray-700">Cliente</label>
                        <input type="text" id="input-cliente" list="lista-clientes" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Digite ou selecione um cliente...">
                        <datalist id="lista-clientes">
                            <!-- Clientes carregados via JS -->
                        </datalist>
                    </div>

                    <!-- Display de Infos do Cliente -->
                    <div id="info-cliente-selecionado" class="hidden space-y-2 text-sm text-gray-600 border-l-4 border-blue-200 pl-3 py-2 bg-blue-50 rounded-r-md">
                        <p><strong>Endereço:</strong> <span id="display-cliente-endereco">-</span></p>
                        <p><strong>Complemento:</strong> <span id="display-cliente-complemento">-</span></p>
                        <p><strong>Celular:</strong> <span id="display-cliente-celular">-</span></p>
                    </div>

                    <!-- MODIFICADO: Campo de Observação (Textarea) -->
                    <div>
                        <label for="obs-cliente" class="block text-sm font-medium text-gray-700">Observação (Opcional)</label>
                        <textarea id="obs-cliente" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Ex: Casa azul, portão branco, entregar para Fulano..."></textarea>
                    </div>
                    <!-- FIM MODIFICAÇÃO -->
                    
                    <div>
                        <label for="select-cesta" class="block text-sm font-medium text-gray-700">Cesta Básica</label>
                        <select id="select-cesta" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base">
                            <option value="Mini Bonini" data-valor="165.00">Mini Bonini</option>
                            <option value="Mini Koblenz" data-valor="170.00">Mini Koblenz</option>
                            <option value="Pequena Bonini" data-valor="215.00">Pequena Bonini</option>
                            <option value="Pequena Koblenz" data-valor="220.00">Pequena kolenz</option>
                            <option value="mÉDIA Bonini" data-valor="320.00">Média Bonini</option>
                            <option value="Média Koblenz" data-valor="325.00">Média Koblenz</option>
                            <option value="Grande Bonini" data-valor="380.00">Grande Bonini</option>
                            <option value="Grande Koblenz" data-valor="390.00">Grande koblenz</option>
                        </select>
                    </div>
                </div>

                <!-- Coluna 2: Tipo e Valor -->
                <div class="md:col-span-1 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tipo da Cesta</label>
                        <div class="mt-2 flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="tipo-cesta" value="Normal" checked class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Normal</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="tipo-cesta" value="Alterada" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Alterada</span>
                            </label>
                        </div>
                    </div>
                    <!-- Campo: Brinde -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Brinde?</label>
                        <div class="mt-2 flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="brinde" value="Não" checked class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Não</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="brinde" value="Sim" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Sim</span>
                            </label>
                        </div>
                    </div>
                    <!-- MODIFICADO: Campo Descrição Brinde -->
                    <div id="campo-brinde-descricao" class="hidden">
                        <label for="input-brinde-descricao" class="block text-sm font-medium text-gray-700">Qual o brinde?</label>
                        <input type="text" id="input-brinde-descricao" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Ex: Panetone">
                    </div>
                    <!-- FIM CAMPO: Brinde -->
                    
                    <!-- Grid para Quantidade e Valor -->
                    <div class="grid grid-cols-2 gap-4">
                         <div>
                            <!-- CAMPO QUANTIDADE -->
                            <label for="input-quantidade" class="block text-sm font-medium text-gray-700">Quantidade</label>
                            <input type="number" id="input-quantidade" value="1" min="1" step="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Valor Total (R$)</label>
                            <div id="display-valor" class="mt-1 p-2 h-auto flex items-center bg-gray-100 rounded-md border border-gray-300 text-gray-800 font-semibold py-3 px-4 text-base">
                                0.00
                            </div>
                        </div>
                    </div>
                    <!-- FIM Grid -->

                </div>
                
                <!-- Coluna 3: Campo Alterada e Botões -->
                <div class="md:col-span-1 space-y-4">
                    <div id="campo-alterada" class="hidden space-y-4">
                        <div>
                            <!-- MODIFICADO: Campo Detalhe (Textarea) -->
                            <label for="codigo-alterada" class="block text-sm font-medium text-gray-700">Detalhe (Cesta Alterada)</label>
                            <textarea id="codigo-alterada" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Ex: Sem arroz, +1 feijão&#10;Trocar óleo por..."></textarea>
                        </div>

                        <!-- Campo Partes Alteradas -->
                        <div id="campo-partes-alteradas">
                            <label class="block text-sm font-medium text-gray-700">Partes Alteradas (Múltiplo)</label>
                            <div class="mt-2 space-y-2">
                                <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                                    <input type="checkbox" name="partes_alteradas" value="Arroz" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                                    <span class="ml-3 text-sm font-medium text-gray-700">Arroz</span>
                                </label>
                                <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                                    <input type="checkbox" name="partes_alteradas" value="Alimento" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                                    <span class="ml-3 text-sm font-medium text-gray-700">Alimento</span>
                                </label>
                                <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                                    <input type="checkbox" name="partes_alteradas" value="Limpeza" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                                    <span class="ml-3 text-sm font-medium text-gray-700">Limpeza</span>
                                </label>
                            </div>
                        </div>
                        <!-- FIM CAMPO -->
                    </div>
                    
                    <!-- MODIFICADO: Container de botões -->
                    <div class="pt-6 flex flex-col sm:flex-row gap-2">
                        <!-- NOVO: Botão Cancelar Edição (Oculto por padrão) -->
                        <button type="button" id="btn-cancelar-edicao" class="hidden w-full flex justify-center items-center rounded-md border border-gray-300 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">
                            Cancelar Edição
                        </button>
                        <!-- MODIFICADO: IDs adicionados ao botão e ao texto -->
                        <button id="btn-submit-form" type="submit" class="w-full flex justify-center items-center rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            <span id="btn-submit-form-text">Lançar Entrega</span>
                        </button>
                    </div>
                </div>
            </form>
        </section>
        <!-- FIM SEÇÃO LANÇAMENTO (ADMIN) -->

        <!-- Seção da Lista de Entregas (ADMIN E ENTREGADOR) -->
        <section>
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-700">Entregas na Rota</h2>
                <div class="flex space-x-2 mt-4 sm:mt-0">
                    <!-- NOVO: Botão Importar Card (ADMIN) -->
                    <button id="btn-importar-card" class="admin-view rounded-md bg-blue-100 text-blue-700 px-4 py-3 text-sm font-medium shadow-sm hover:bg-blue-200">Importar Card</button>
                    <!-- MODIFICADO: Botão Exportar (ADMIN) -->
                    <button id="btn-exportar" class="admin-view rounded-md bg-green-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-green-700">Exportar Rota</button>
                    <button id="btn-carregar" class="admin-view rounded-md bg-gray-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-gray-700">Carregar Rota</button>
                </div>
            </div>
            
            <!-- Lista de Cards de Entrega -->
            <div id="lista-entregas" class="space-y-3 min-h-[100px]">
                <!-- Cards serão injetados aqui pelo JavaScript -->
            </div>
            <p id="lista-vazia" class="text-center text-gray-500 py-6">Nenhuma entrega na rota.</p>
        </section>
    </div>

    <!-- Modal de Pagamento (Oculto por padrão) -->
    <div id="modal-pagamento" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <form id="form-pagamento">
                <div class="p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Confirmar Entrega e Pagamento</h3>
                    <p class="text-sm text-gray-600 mb-1">Cliente: <strong id="modal-cliente-nome"></strong></p>
                    <p class="text-sm text-gray-600 mb-4">Valor: <strong id="modal-cliente-valor"></strong></p>
                    
                    <label class="block text-sm font-medium text-gray-700 mb-2">Forma(s) de Pagamento (Selecione ao menos uma):</label>
                    <div id="modal-error-pagamento" class="text-red-600 text-sm mb-2 hidden">É obrigatório selecionar ao menos uma forma de pagamento.</div>
                    <div class="space-y-2">
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                            <input type="checkbox" name="forma_pagamento" value="Dinheiro" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">Dinheiro</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                            <input type="checkbox" name="forma_pagamento" value="Pix" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">Pix</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                            <input type="checkbox" name="forma_pagamento" value="Cartão" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">Cartão</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                            <input type="checkbox" name="forma_pagamento" value="Fiado" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">Fiado</span>
                        </label>
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3 rounded-b-lg">
                    <button type="button" id="btn-cancelar-pagamento" class="rounded-md border border-gray-300 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Cancelar</button>
                    <button type="submit" id="btn-confirmar-pagamento" class="rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700">Confirmar Entrega</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Exportar (Oculto por padrão) -->
    <div id="modal-exportar" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl m-4 overflow-hidden">
            <div class="p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Exportar Rota</h3>
                
                <label class="block text-sm font-medium text-gray-700 mb-2">Backup da Rota (Arquivo)</label>
                <button type="button" id="btn-baixar-json" class="w-full flex justify-center items-center rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Baixar/Compartilhar Arquivo da Rota (.json)
                </button>

                <h4 class="text-lg font-semibold text-gray-700 mt-6 mb-2">Relatório de Entregas Concluídas</h4>
                <div id="export-relatorio" class="w-full max-h-48 overflow-y-auto p-2 border border-gray-300 rounded-md bg-gray-50">
                    <pre class="text-xs text-gray-700">Nenhuma entrega concluída.</pre>
                </div>

                <div id="export-whatsapp-link" class="mt-4">
                    <!-- Link do WhatsApp será gerado aqui -->
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end rounded-b-lg">
                <button type="button" id="btn-fechar-exportar" class="rounded-md border border-gray-300 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Fechar</button>
            </div>
        </div>
    </div>

    <!-- NOVO: Modal de WhatsApp (Oculto por padrão) -->
    <div id="modal-whatsapp" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm m-4">
            <div class="p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Ação WhatsApp</h3>
                <p class="text-sm text-gray-600 mb-6">Para: <strong id="modal-whatsapp-cliente">Nome do Cliente</strong></p>
                <div class="space-y-3">
                    <a id="btn-whatsapp-avisar" href="#" target="_blank" rel="noopener noreferrer" class="flex justify-center items-center w-full rounded-md border border-transparent bg-green-500 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-green-600">
                        Avisar Cliente (Chegando)
                    </a>
                    <!-- NOVO BOTAO -->
                    <a id="btn-whatsapp-chegou" href="#" target="_blank" rel="noopener noreferrer" class="flex justify-center items-center w-full rounded-md border border-transparent bg-yellow-500 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-yellow-600">
                        Avisar (Cheguei na Porta)
                    </a>
                    <!-- FIM NOVO BOTAO -->
                    <a id="btn-whatsapp-agradecer" href="#" target="_blank" rel="noopener noreferrer" class="flex justify-center items-center w-full rounded-md border border-transparent bg-blue-500 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-600">
                        Agradecer (Pós-Venda)
                    </a>
                    <a id="btn-whatsapp-pix" href="#" target="_blank" rel="noopener noreferrer" class="flex justify-center items-center w-full rounded-md border border-transparent bg-gray-700 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-gray-800">
                        Enviar Chave Pix
                    </a>
                    <a id="btn-whatsapp-compartilhar" href="#" target="_blank" rel="noopener noreferrer" class="flex justify-center items-center w-full rounded-md border border-transparent bg-purple-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-purple-700">
                        Compartilhar Pedido (Admin)
                    </a>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end rounded-b-lg">
                <button type="button" id="btn-fechar-whatsapp" class="rounded-md border border-gray-300 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Aviso (Oculto por padrão) -->
    <div id="modal-aviso" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm m-4">
            <div class="p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Atenção</h3>
                <p id="modal-aviso-texto" class="text-gray-600 mb-6">Mensagem de aviso.</p>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end rounded-b-lg">
                <button type="button" id="btn-fechar-aviso" class="rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700">OK</button>
            </div>
        </div>
    </div>

    <!-- Input de Arquivo (Oculto) -->
    <input type="file" id="input-carregar-arquivo" class="hidden" accept=".json,application/json">
    <!-- NOVO: Input de Arquivo para Card (Oculto) -->
    <input type="file" id="input-carregar-card" class="hidden" accept=".json,application/json">


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Constantes ---
            const CHAVE_PIX_PADRAO = "65984422103 - Pix Celular - Lucas Ataide de Oliveira"; // <-- MUDE AQUI SUA CHAVE PIX

            // --- Seletores de Elementos ---
            // NOVO: Modos Admin/Entregador
            const bodyEl = document.body;
            const btnModoAdmin = document.getElementById('btn-modo-admin');
            const btnModoEntregador = document.getElementById('btn-modo-entregador');

            // Gerenciamento de Rotas
            const btnNovaRota = document.getElementById('btn-nova-rota');
            const selectRotaAtiva = document.getElementById('select-rota-ativa');
            const inputNomeRota = document.getElementById('input-nome-rota');
            const inputDataRota = document.getElementById('input-data-rota');
            const displayDiaSemana = document.getElementById('display-dia-semana');
            const btnExcluirRota = document.getElementById('btn-excluir-rota');

            // Seletores de Despesas
            const inputDespesaAbastecimento = document.getElementById('input-despesa-abastecimento');
            const inputDespesaAlimentacao = document.getElementById('input-despesa-alimentacao');
            const inputDespesaExtra = document.getElementById('input-despesa-extra');

            // Formulário de Entrega
            const formEntrega = document.getElementById('form-entrega');
            // NOVO: Seletores do Formulário
            const formEntregaTitle = document.getElementById('form-entrega-title');
            const btnSubmitForm = document.getElementById('btn-submit-form');
            const btnSubmitFormText = document.getElementById('btn-submit-form-text');
            const btnCancelarEdicao = document.getElementById('btn-cancelar-edicao');

            const inputCliente = document.getElementById('input-cliente');
            const datalistClientes = document.getElementById('lista-clientes');
            const infoClienteSelecionado = document.getElementById('info-cliente-selecionado');
            const displayClienteEndereco = document.getElementById('display-cliente-endereco');
            const displayClienteComplemento = document.getElementById('display-cliente-complemento');
            const displayClienteCelular = document.getElementById('display-cliente-celular');
            
            const obsClienteInput = document.getElementById('obs-cliente'); // Agora é um TEXTAREA
            const selectCesta = document.getElementById('select-cesta');
            const inputQuantidade = document.getElementById('input-quantidade');
            const displayValor = document.getElementById('display-valor');
            const campoAlterada = document.getElementById('campo-alterada');
            const codigoAlteradaInput = document.getElementById('codigo-alterada'); // Agora é um TEXTAREA
            const campoBrindeDescricao = document.getElementById('campo-brinde-descricao'); // NOVO
            const inputBrindeDescricao = document.getElementById('input-brinde-descricao'); // NOVO

            const listaEntregasEl = document.getElementById('lista-entregas');
            const listaVaziaEl = document.getElementById('lista-vazia');
            
            // Modais
            const modalPagamento = document.getElementById('modal-pagamento');
            const formPagamento = document.getElementById('form-pagamento');
            const btnCancelarPagamento = document.getElementById('btn-cancelar-pagamento');
            const modalClienteNome = document.getElementById('modal-cliente-nome');
            const modalClienteValor = document.getElementById('modal-cliente-valor');
            const modalErrorPagamento = document.getElementById('modal-error-pagamento');

            const btnExportar = document.getElementById('btn-exportar');
            const btnCarregar = document.getElementById('btn-carregar');
            const btnImportarCard = document.getElementById('btn-importar-card'); // NOVO
            
            const modalExportar = document.getElementById('modal-exportar');
            const exportRelatorioEl = document.getElementById('export-relatorio');
            const exportWhatsappLinkEl = document.getElementById('export-whatsapp-link');
            const btnFecharExportar = document.getElementById('btn-fechar-exportar');
            const btnBaixarJson = document.getElementById('btn-baixar-json'); // NOVO

            // NOVO: Modal WhatsApp
            const modalWhatsApp = document.getElementById('modal-whatsapp');
            const modalWhatsAppCliente = document.getElementById('modal-whatsapp-cliente');
            const btnFecharWhatsApp = document.getElementById('btn-fechar-whatsapp');

            // Modal de Aviso
            const modalAviso = document.getElementById('modal-aviso');
            const modalAvisoTexto = document.getElementById('modal-aviso-texto');
            const btnFecharAviso = document.getElementById('btn-fechar-aviso');
            
            // Inputs de Arquivo
            const inputCarregarArquivo = document.getElementById('input-carregar-arquivo');
            const inputCarregarCard = document.getElementById('input-carregar-card'); // NOVO


            // --- Estado da Aplicação ---
            let todasAsRotas = {}; // Objeto para guardar todas as rotas
            let rotaAtivaId = null; // ID da rota sendo visualizada
            const MAX_ROTAS = 30; // Limite de rotas salvas
            let CLIENTES_CACHE = {}; // Cache para busca rápida de clientes por nome

            let entregaParaPagarId = null; // ID da entrega no modal de pagamento
            let whatsAppEntregaId = null; // ID da entrega no modal de WhatsApp
            let editingEntregaId = null; // NOVO: ID da entrega sendo editada

            // --- Funções ---

            /**
             * Exibe o modal de aviso com uma mensagem
             */
            function mostrarAviso(mensagem) {
                modalAvisoTexto.textContent = mensagem;
                modalAviso.classList.remove('hidden');
            }

            /**
             * Fecha o modal de aviso
             */
            function fecharAviso() {
                modalAviso.classList.add('hidden');
            }

            /**
             * Formata um valor numérico para o formato de moeda BRL (R$ 123,45)
             */
            function formatarMoeda(valor) {
                return parseFloat(valor).toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
            }
            
            /**
             * Formata um ISO Date String (ou Date obj) para um formato legível (dd/mm/aaaa hh:mm)
             */
            function formatarData(isoString) {
                if (!isoString) return '';
                const data = new Date(isoString);
                return data.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            /**
             * Pega o dia da semana de uma data (yyyy-mm-dd)
             */
            function getDiaDaSemana(dataString) {
                if (!dataString) return '-';
                // Adiciona T12:00:00 para evitar problemas de fuso horário com new Date()
                const data = new Date(dataString + 'T12:00:00');
                const dia = data.toLocaleDateString('pt-BR', { weekday: 'long' });
                // Capitaliza a primeira letra
                return dia.charAt(0).toUpperCase() + dia.slice(1);
            }

            /**
             * Atualiza o display de valor quando a cesta ou quantidade é selecionada
             */
            function atualizarValorCesta() {
                const selectedOption = selectCesta.options[selectCesta.selectedIndex];
                const valorUnitario = parseFloat(selectedOption.dataset.valor || "165.00");
                let quantidade = parseInt(inputQuantidade.value) || 1; // Pega a quantidade, padrão 1
                
                if (quantidade < 1) {
                    inputQuantidade.value = 1; // Corrige se for inválido
                    quantidade = 1;
                }

                const valorTotal = valorUnitario * quantidade;
                displayValor.textContent = formatarMoeda(valorTotal);
            }

            /**
             * Mostra/oculta o campo de "cesta alterada"
             */
            function toggleCampoAlterada() {
                const tipo = document.querySelector('input[name="tipo-cesta"]:checked').value;
                if (tipo === 'Alterada') {
                    campoAlterada.classList.remove('hidden');
                    // codigoAlteradaInput.required = true; // Textarea não precisa de required
                } else {
                    campoAlterada.classList.add('hidden');
                    // codigoAlteradaInput.required = false;
                    codigoAlteradaInput.value = '';
                    // Reseta checkboxes
                    document.querySelectorAll('input[name="partes_alteradas"]:checked').forEach(cb => {
                        cb.checked = false;
                    });
                }
            }
            
            /**
             * NOVO: Mostra/oculta o campo de "descrição do brinde"
             */
            function toggleCampoBrinde() {
                const tipo = document.querySelector('input[name="brinde"]:checked').value;
                if (tipo === 'Sim') {
                    campoBrindeDescricao.classList.remove('hidden');
                    inputBrindeDescricao.required = true;
                } else {
                    campoBrindeDescricao.classList.add('hidden');
                    inputBrindeDescricao.required = false;
                    inputBrindeDescricao.value = '';
                }
            }

            /**
             * Salva o estado atual das entregas na ROTA ATIVA
             */
            function salvarLocalStorage() {
                if (rotaAtivaId && todasAsRotas[rotaAtivaId]) {
                    salvarTodasAsRotas();
                }
            }

            /**
             * Salva o objeto 'todasAsRotas' no LocalStorage
             */
            function salvarTodasAsRotas() {
                // Gerenciamento de limite (MAX_ROTAS)
                const chavesRotas = Object.keys(todasAsRotas);
                if (chavesRotas.length > MAX_ROTAS) {
                    const chavesOrdenadas = chavesRotas.sort((a, b) => a - b);
                    const chavesParaRemover = chavesOrdenadas.slice(0, chavesOrdenadas.length - MAX_ROTAS);
                    
                    chavesParaRemover.forEach(chave => {
                        delete todasAsRotas[chave];
                    });
                }
                
                localStorage.setItem('gerenciadorDeRotas', JSON.stringify(todasAsRotas));
                
                if (rotaAtivaId) {
                    localStorage.setItem('rotaAtivaId', rotaAtivaId);
                }
            }

            /**
             * Carrega todas as rotas do LocalStorage e inicia o app
             */
            function iniciarAplicativo() {
                // 1. Carregar Clientes (do clientes.js)
                try {
                    if (typeof CLIENTES_DB !== 'undefined' && Array.isArray(CLIENTES_DB)) {
                        datalistClientes.innerHTML = ''; // Limpa
                        CLIENTES_DB.forEach(cliente => {
                            const option = document.createElement('option');
                            option.value = cliente.nome;
                            datalistClientes.appendChild(option);
                            // Cria um cache para busca rápida (usa nome minúsculo como chave)
                            CLIENTES_CACHE[cliente.nome.toLowerCase()] = cliente;
                        });
                    } else {
                        console.error("CLIENTES_DB não encontrado ou em formato inválido. Verifique o 'clientes.js'.");
                        mostrarAviso("Erro ao carregar banco de dados de clientes. Verifique o arquivo 'clientes.js'.");
                    }
                } catch (e) {
                     console.error("Erro ao processar clientes:", e);
                     mostrarAviso("Erro ao processar o arquivo 'clientes.js'.");
                }


                // 2. Carregar Rotas
                const dadosSalvos = localStorage.getItem('gerenciadorDeRotas');
                if (dadosSalvos) {
                    todasAsRotas = JSON.parse(dadosSalvos);
                }

                // 3. Descobrir qual rota está ativa
                rotaAtivaId = localStorage.getItem('rotaAtivaId');

                // 4. Se não houver rotas, ou a rota ativa não existir, cria uma nova
                if (!rotaAtivaId || !todasAsRotas[rotaAtivaId]) {
                    if (Object.keys(todasAsRotas).length === 0) {
                        criarNovaRota(false); // Cria a primeira rota
                    } else {
                        // Pega a primeira da lista (mais recente)
                        rotaAtivaId = Object.keys(todasAsRotas).sort((a, b) => b - a)[0];
                        localStorage.setItem('rotaAtivaId', rotaAtivaId);
                    }
                }

                // 5. Popular o <select> e carregar a rota ativa na tela
                popularSelectRotas();
                carregarRotaAtiva();
                
                // 6. Define o modo de visualização padrão
                // (O padrão é Admin, então não precisa fazer nada, a classe 'modo-entregador' não está no body)
            }

            /**
             * Pega o array de entregas da rota ativa
             */
            function getEntregasAtivas() {
                if (rotaAtivaId && todasAsRotas[rotaAtivaId]) {
                    return todasAsRotas[rotaAtivaId].entregas;
                }
                return []; // Retorna array vazio se não houver rota
            }

            /**
             * Atualiza o <select> com as rotas salvas
             */
            function popularSelectRotas() {
                selectRotaAtiva.innerHTML = ''; // Limpa
                
                const chavesOrdenadas = Object.keys(todasAsRotas).sort((a, b) => b - a); // Mais novas primeiro

                chavesOrdenadas.forEach(id => {
                    const rota = todasAsRotas[id];
                    const option = document.createElement('option');
                    option.value = id;
                    const dataFormatada = rota.data ? new Date(rota.data + 'T12:00:00').toLocaleDateString('pt-BR') : 'Sem Data';
                    option.textContent = `${rota.nome} (${dataFormatada})`;
                    
                    if (id === rotaAtivaId) {
                        option.selected = true;
                    }
                    selectRotaAtiva.appendChild(option);
                });
            }

            /**
             * Carrega os dados da rota ativa (ID salvo em rotaAtivaId) na tela
             */
            function carregarRotaAtiva() {
                const rota = todasAsRotas[rotaAtivaId];
                if (!rota) {
                    console.error("Erro: Tentando carregar rota ativa, mas ID não encontrado.");
                    if (Object.keys(todasAsRotas).length === 0) {
                        criarNovaRota(false);
                    } else {
                        rotaAtivaId = Object.keys(todasAsRotas).sort((a, b) => b - a)[0];
                        localStorage.setItem('rotaAtivaId', rotaAtivaId);
                    }
                    popularSelectRotas();
                    carregarRotaAtiva();
                    return;
                }

                // Atualiza os inputs de gerenciamento
                inputNomeRota.value = rota.nome;
                inputDataRota.value = rota.data;
                displayDiaSemana.textContent = getDiaDaSemana(rota.data);

                // Atualiza os inputs de despesa
                rota.despesas = rota.despesas || { abastecimento: 0, alimentacao: 0, extra: 0 };
                inputDespesaAbastecimento.value = rota.despesas.abastecimento || 0;
                inputDespesaAlimentacao.value = rota.despesas.alimentacao || 0;
                inputDespesaExtra.value = rota.despesas.extra || 0;

                // Atualiza o <select>
                selectRotaAtiva.value = rotaAtivaId;
                
                // Renderiza as entregas dessa rota
                renderizarEntregas();
            }

            /**
             * Limpa a tela e cria uma nova rota
             */
            function criarNovaRota(atualizarTela = true) {
                const novoId = Date.now().toString(); // ID baseado no timestamp
                const hoje = new Date().toISOString().split('T')[0]; // Formato yyyy-mm-dd

                const novaRota = {
                    id: novoId,
                    nome: "Nova Rota",
                    data: hoje,
                    entregas: [],
                    despesas: { abastecimento: 0, alimentacao: 0, extra: 0 }
                };

                todasAsRotas[novoId] = novaRota;
                rotaAtivaId = novoId;

                salvarTodasAsRotas();
                
                if (atualizarTela) {
                    popularSelectRotas();
                    carregarRotaAtiva();
                }
            }

            /**
             * Atualiza Nome e Data da rota ativa
             */
            function atualizarInfoRota() {
                const rota = todasAsRotas[rotaAtivaId];
                if (!rota) return;
                
                rota.nome = inputNomeRota.value || "Rota Sem Nome";
                rota.data = inputDataRota.value;
                
                displayDiaSemana.textContent = getDiaDaSemana(rota.data);

                salvarTodasAsRotas();
                popularSelectRotas(); // Atualiza o texto no select
            }

            /**
             * Salva os valores de despesa na rota ativa
             */
            function salvarDespesas() {
                const rota = todasAsRotas[rotaAtivaId];
                if (!rota) return;

                rota.despesas = {
                    abastecimento: parseFloat(inputDespesaAbastecimento.value) || 0,
                    alimentacao: parseFloat(inputDespesaAlimentacao.value) || 0,
                    extra: parseFloat(inputDespesaExtra.value) || 0
                };

                salvarTodasAsRotas();
            }

            /**
             * Exclui a rota ativa
             */
            function excluirRotaAtiva() {
                 if (Object.keys(todasAsRotas).length <= 1) {
                    mostrarAviso("Você não pode excluir a última rota.");
                    return;
                }
                
                delete todasAsRotas[rotaAtivaId];
                
                const chavesOrdenadas = Object.keys(todasAsRotas).sort((a, b) => b - a);
                rotaAtivaId = chavesOrdenadas[0];
                
                salvarTodasAsRotas();
                
                popularSelectRotas();
                carregarRotaAtiva();
            }
            
            /**
             * NOVO: Alterna entre os modos Admin e Entregador
             */
            function setModoVisualizacao(modo) {
                if (modo === 'admin') {
                    bodyEl.classList.remove('modo-entregador');
                    btnModoAdmin.classList.add('btn-modo-ativo');
                    btnModoEntregador.classList.remove('btn-modo-ativo');
                } else {
                    bodyEl.classList.add('modo-entregador');
                    btnModoAdmin.classList.remove('btn-modo-ativo');
                    btnModoEntregador.classList.add('btn-modo-ativo');
                }
            }

            /**
             * Renderiza todos os cards de entrega (DA ROTA ATIVA) na tela
             */
            function renderizarEntregas() {
                listaEntregasEl.innerHTML = ''; // Limpa a lista
                const entregas = getEntregasAtivas(); // MODIFICADO

                if (entregas.length === 0) {
                    listaVaziaEl.classList.remove('hidden');
                    return;
                }
                
                listaVaziaEl.classList.add('hidden');

                entregas.forEach((entrega, index) => {
                    const card = document.createElement('div');
                    card.dataset.id = entrega.id;
                    card.className = `p-4 bg-white rounded-lg shadow-sm border flex flex-col sm:flex-row items-start sm:items-center justify-between transition-all ${entrega.status === 'Entregue' ? 'entregue' : (entrega.status === 'Cancelada' ? 'cancelada' : '')} w-full overflow-hidden`;
                    
                    let infoTags = [];

                    if (entrega.tipo === 'Normal') {
                        infoTags.push(`<span class="text-xs font-semibold bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">Normal</span>`);
                    } else {
                        // Tags amarelas para Cesta Alterada
                        if (entrega.partesAlteradas && entrega.partesAlteradas.length > 0) {
                             infoTags.push(`<span class="text-xs font-semibold bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">${entrega.partesAlteradas.join(', ')}</span>`);
                        }
                    }

                    // Tag de Brinde
                    if (entrega.brinde === 'Sim') {
                        infoTags.push(`<span class="text-xs font-semibold bg-pink-100 text-pink-800 px-2 py-0.5 rounded-full">${entrega.brindeDescricao || 'Brinde'}</span>`);
                    }
                    
                    // NOVO: Bloco de Observação (pré-formatado)
                    let obsInfo = '';
                    if (entrega.observacao) {
                        obsInfo = `
                            <div class="mt-2 p-2 bg-red-50 border border-red-200 rounded-md">
                                <span class="text-xs font-bold text-red-700">OBSERVAÇÃO:</span>
                                <p class="pre-wrap-texto text-red-700">${entrega.observacao}</p>
                            </div>
                        `;
                    }
                    
                    // NOVO: Bloco de Detalhes da Cesta (pré-formatado)
                    let detalhesInfo = '';
                    if (entrega.tipo === 'Alterada' && entrega.codigoAlterada) {
                         detalhesInfo = `
                            <div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded-md">
                                <span class="text-xs font-bold text-yellow-700">DETALHES (ALTERADA):</span>
                                <p class="pre-wrap-texto text-yellow-700">${entrega.codigoAlterada}</p>
                            </div>
                        `;
                    }

                    let statusInfo = '';
                    if (entrega.status === 'Entregue') {
                        statusInfo = `
                            <div class="text-xs text-green-700 mt-1 sm:ml-4">
                                <span class="font-semibold">Pagamento:</span> ${entrega.formaPagamento.join(', ')}<br>
                                <span class="font-semibold">Horário:</span> ${formatarData(entrega.horarioEntrega)}
                            </div>
                        `;
                    } else if (entrega.status === 'Cancelada') {
                        statusInfo = `
                            <div class="text-xs text-red-700 mt-1 sm:ml-4">
                                <span class="font-semibold">Status:</span> CANCELADA<br>
                                <span class="font-semibold">Horário:</span> ${formatarData(entrega.horarioEntrega)}
                            </div>
                        `;
                    }
                    
                    // Tenta pegar o ID do cliente
                    const clienteId = entrega.cliente.id || entrega.cliente.Id || entrega.cliente.ID || null;
                    let idInfo = clienteId ? `<p class="text-xs text-gray-400 font-mono truncate" title="ID: ${clienteId}">ID: ${clienteId}</p>` : '';

                    // Info do Cliente
                    let infoClienteHtml = `
                        ${idInfo} <!-- ID do Cliente -->
                        <p class="text-lg font-semibold text-gray-800 truncate" title="${entrega.cliente.nome}">${entrega.cliente.nome}</p>
                        <p class="text-sm text-gray-600 truncate" title="${entrega.cliente.endereco || ''}">${entrega.cliente.endereco || 'Sem endereço'}</p>
                        <p class="text-sm text-gray-500 truncate" title="${entrega.cliente.complemento || ''}">${entrega.cliente.complemento || 'Sem complemento'}</p>
                        <p class="text-sm text-gray-500 truncate" title="${entrega.cliente.celular || ''}">Cel: ${entrega.cliente.celular || 'Sem celular'}</p>
                        
                        <!-- MODIFICADO: Destaque da Cesta e Valor -->
                        <div class="mt-2 p-2 bg-gray-50 rounded-md border border-gray-200">
                            ${(entrega.quantidade || 1) > 1 ? `
                                <span class="block text-base font-semibold text-gray-800">${entrega.quantidade}x ${entrega.cesta.nome}</span>
                                <span class="block text-lg font-bold text-blue-600">${formatarMoeda(entrega.cesta.valor * entrega.quantidade)}</span>
                                <span class="block text-sm text-gray-500">( ${formatarMoeda(entrega.cesta.valor)} cada )</span>
                            ` : `
                                <span class="block text-base font-semibold text-gray-800">${entrega.cesta.nome}</span>
                                <span class="block text-lg font-bold text-blue-600">${formatarMoeda(entrega.cesta.valor)}</span>
                            `}
                        </div>
                    `;
                    
                    const isPrimeiro = index === 0;
                    const isUltimo = index === entregas.length - 1;
                    const isFinalizada = entrega.status === 'Entregue' || entrega.status === 'Cancelada';

                    card.innerHTML = `
                        <div class="flex-1 min-w-0 overflow-hidden"> <!-- MODIFICADO: Adicionado overflow-hidden -->
                            <div class="flex items-center">
                                <!-- Botões de Seta -->
                                <div class="flex flex-col items-center justify-center mr-3">
                                    <!-- MODIFICADO: Área de clique maior -->
                                    <button class="btn-mover-cima btn-mover-container text-gray-400 ${isPrimeiro || isFinalizada ? 'opacity-25 cursor-not-allowed' : 'hover:text-blue-600'}" data-id="${entrega.id}" title="Mover para Cima" ${isPrimeiro || isFinalizada ? 'disabled' : ''}>
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
                                        </svg>
                                    </button>
                                    <button class="btn-mover-baixo btn-mover-container text-gray-400 ${isUltimo || isFinalizada ? 'opacity-25 cursor-not-allowed' : 'hover:text-blue-600'}" data-id="${entrega.id}" title="Mover para Baixo" ${isUltimo || isFinalizada ? 'disabled' : ''}>
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                </div>
                                <!-- Fim Botões de Seta -->

                                <div class="truncate">
                                    ${infoClienteHtml}
                                </div>
                            </div>
                            
                            <!-- Blocos de Info (Obs, Detalhes, Tags, Status) -->
                            <div class="mt-2 sm:ml-12 space-y-2">
                                ${obsInfo} <!-- Bloco de Observação -->
                                ${detalhesInfo} <!-- Bloco de Detalhes -->
                                
                                <div class="flex flex-wrap gap-2 items-center">
                                    ${infoTags.join(' ')} <!-- Tags (Normal, Alterada, Brinde) -->
                                </div>
                                ${statusInfo} <!-- Status (Entregue, Cancelada) -->
                            </div>
                        </div>
                        
                        <!-- Coluna de Botões -->
                        <div class="mt-4 sm:mt-0 sm:ml-4 flex-shrink-0 w-full sm:w-auto">
                            <!-- MODIFICADO: Layout de botões (Mobile/Desktop) -->
                            <!-- sm:grid-cols-2 (Desktop) / grid-cols-4 (Mobile) -->
                            <div class="grid grid-cols-4 sm:grid-cols-2 gap-2">
                                
                                <!-- Botões Linha 1 (Mobile) / Coluna 1 (Desktop) -->
                                <button class="btn-card-maps w-full sm:w-auto rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-white text-gray-700 border border-gray-300 ${isFinalizada ? 'cursor-not-allowed opacity-50' : 'hover:bg-gray-50'} col-span-1 flex justify-center items-center" title="Abrir no Google Maps" ${isFinalizada ? 'disabled' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                                </button>
                                
                                <button class="btn-card-whatsapp w-full sm:w-auto rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-green-500 text-white ${isFinalizada ? 'cursor-not-allowed opacity-50' : 'hover:bg-green-600'} col-span-1 flex justify-center items-center" title="Abrir WhatsApp" data-id="${entrega.id}" ${isFinalizada ? 'disabled' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM5.5 8.5A1.5 1.5 0 017 7h6a1.5 1.5 0 011.5 1.5v3A1.5 1.5 0 0113 13H7a1.5 1.5 0 01-1.5-1.5v-3z" /></svg>
                                </button>
                                
                                <button class="btn-card-ligar w-full sm:w-auto rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-blue-500 text-white ${isFinalizada ? 'cursor-not-allowed opacity-50' : 'hover:bg-blue-600'} col-span-1 flex justify-center items-center" title="Ligar para Cliente" data-id="${entrega.id}" ${isFinalizada ? 'disabled' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C6.477 18 2 13.523 2 8V3z" /></svg>
                                </button>
                                
                                <button class="btn-card-json w-full sm:w-auto rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-gray-600 text-white hover:bg-gray-700 col-span-1 flex justify-center items-center" title="Exportar Card (.json)" data-id="${entrega.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                </button>
                                
                                <!-- Botões Linha 2 (Mobile) / Coluna 2 (Desktop) -->
                                <!-- Lógica de Botões de Ação (col-span-2 ou col-span-4) -->
                                ${entrega.status === 'Pendente' ? `
                                    <!-- NOVO: Botão Editar (col-span-2) -->
                                    <button class="btn-editar-entrega w-full sm:w-auto rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-yellow-100 text-yellow-700 border border-yellow-300 hover:bg-yellow-200 col-span-2 flex justify-center items-center" data-id="${entrega.id}" title="Editar Pedido">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1 sm:mr-0" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                                    </button>
                                    <button class="btn-cancelar-entrega w-full sm:w-auto rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-red-100 text-red-700 border border-red-300 hover:bg-red-200 col-span-2" data-id="${entrega.id}">
                                        Cancelar
                                    </button>
                                    <button class="btn-entregue w-full sm:w-auto rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 col-span-4" data-id="${entrega.id}">
                                        Marcar Entrega
                                    </button>
                                ` : (entrega.status === 'Entregue' ? `
                                    <button class="btn-entregue w-full sm:w-auto rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-green-600 text-white cursor-not-allowed col-span-4" disabled>
                                        Entregue
                                    </button>
                                ` : `
                                    <button class="btn-entregue w-full sm:w-auto rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-gray-500 text-white cursor-not-allowed col-span-4" disabled>
                                        Cancelada
                                    </button>
                                `)}
                            </div>
                        </div>
                    `;
                    listaEntregasEl.appendChild(card);
                });
            }

            /**
             * Lida com o submit do formulário de nova entrega ou edição
             */
            function adicionarOuAtualizarEntrega(e) {
                e.preventDefault();
                
                const rotaAtiva = todasAsRotas[rotaAtivaId];
                if (!rotaAtiva) {
                    mostrarAviso("Nenhuma rota ativa selecionada. Crie uma nova rota.");
                    return;
                }
                const entregas = rotaAtiva.entregas;

                // --- 1. Coletar Dados do Formulário ---
                const nomeClienteSelecionado = inputCliente.value;
                const clienteSelecionado = CLIENTES_CACHE[nomeClienteSelecionado.toLowerCase()];
                let clienteData;

                if (clienteSelecionado) {
                    clienteData = clienteSelecionado;
                } else {
                    clienteData = {
                        nome: nomeClienteSelecionado,
                        celular: '',
                        endereco: nomeClienteSelecionado,
                        complemento: ''
                    };
                }

                if (!clienteData.nome) {
                    mostrarAviso('Por favor, selecione ou digite um nome de cliente.');
                    return;
                }

                const selectedOption = selectCesta.options[selectCesta.selectedIndex];
                const partesAlteradasSelecionadas = 
                    Array.from(formEntrega.querySelectorAll('input[name="partes_alteradas"]:checked'))
                         .map(input => input.value);
                const brindeSelecionado = document.querySelector('input[name="brinde"]:checked').value;
                const brindeDescricao = document.getElementById('input-brinde-descricao').value;
                const quantidade = parseInt(inputQuantidade.value) || 1;
                
                // Pacote de dados do formulário
                const dadosDoForm = {
                    cliente: clienteData,
                    observacao: obsClienteInput.value,
                    cesta: {
                        nome: selectedOption.value,
                        valor: parseFloat(selectedOption.dataset.valor) // Salva o valor UNITÁRIO
                    },
                    quantidade: quantidade,
                    tipo: document.querySelector('input[name="tipo-cesta"]:checked').value,
                    codigoAlterada: codigoAlteradaInput.value,
                    partesAlteradas: partesAlteradasSelecionadas,
                    brinde: brindeSelecionado,
                    brindeDescricao: brindeDescricao,
                };

                // --- 2. Decidir se é EDIÇÃO ou NOVA ENTREGA ---
                if (editingEntregaId) {
                    // MODO EDIÇÃO
                    const index = entregas.findIndex(e => e.id.toString() === editingEntregaId);
                    if (index !== -1) {
                        // Preserva os dados originais de status e ID
                        const entregaOriginal = entregas[index];
                        entregas[index] = {
                            ...entregaOriginal, // Mantém id, status, formaPagamento, horarioEntrega
                            ...dadosDoForm      // Sobrescreve com os dados do form
                        };
                        mostrarAviso("Entrega atualizada com sucesso!");
                    } else {
                        mostrarAviso("Erro: Não foi possível encontrar a entrega para atualizar.");
                    }
                    sairModoEdicao(); // Reseta o formulário
                } else {
                    // MODO NOVA ENTREGA
                    const novaEntrega = {
                        ...dadosDoForm, // Dados do form
                        id: Date.now(), // ID único
                        status: "Pendente",
                        formaPagamento: [],
                        horarioEntrega: null
                    };
                    entregas.push(novaEntrega);
                    // Limpa o formulário
                    formEntrega.reset();
                    inputCliente.value = '';
                    infoClienteSelecionado.classList.add('hidden');
                    inputQuantidade.value = 1;
                    atualizarValorCesta();
                    toggleCampoAlterada();
                    toggleCampoBrinde();
                }
                
                // --- 3. Salvar e Renderizar ---
                salvarLocalStorage();
                renderizarEntregas();
            }

            /**
             * Abre o Google Maps com o endereço do cliente
             */
            function abrirGoogleMaps(query) {
                if (!query) {
                    mostrarAviso('O cliente não possui um código ou endereço para abrir no mapa.');
                    return;
                }
                const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
                window.open(url, '_blank');
            }

            /**
             * Abre o modal de pagamento para a entrega clicada
             */
            function abrirModalPagamento(id) {
                const entregas = getEntregasAtivas();
                const entrega = entregas.find(e => e.id.toString() === id);
                if (!entrega) return;

                entregaParaPagarId = id;
                
                const quantidade = entrega.quantidade || 1;
                const valorTotal = entrega.cesta.valor * quantidade;

                modalClienteNome.textContent = entrega.cliente.nome;
                modalClienteValor.textContent = formatarMoeda(valorTotal);
                
                formPagamento.reset();
                modalErrorPagamento.classList.add('hidden');

                modalPagamento.classList.remove('hidden');
            }

            /**
             * Fecha o modal de pagamento
             */
            function fecharModalPagamento() {
                modalPagamento.classList.add('hidden');
                entregaParaPagarId = null;
            }

            /**
             * Marca uma entrega como Cancelada
             */
            function cancelarEntrega(id) {
                const entregas = getEntregasAtivas();
                const index = entregas.findIndex(e => e.id.toString() === id);
                if (index !== -1) {
                    entregas[index].status = "Cancelada";
                    entregas[index].formaPagamento = [];
                    entregas[index].horarioEntrega = new Date().toISOString();
                }
                salvarLocalStorage();
                renderizarEntregas();
            }

            /**
             * Move uma entrega para cima ou para baixo na lista
             */
            function moverEntrega(id, direcao) {
                const entregas = getEntregasAtivas();
                const index = entregas.findIndex(e => e.id.toString() === id);
                if (index === -1) return;

                if (direcao === 'cima' && index > 0) {
                    [entregas[index - 1], entregas[index]] = [entregas[index], entregas[index - 1]];
                } else if (direcao === 'baixo' && index < entregas.length - 1) {
                    [entregas[index + 1], entregas[index]] = [entregas[index], entregas[index + 1]];
                } else {
                    return;
                }

                salvarLocalStorage();
                renderizarEntregas();
            }

            /**
             * Lida com o clique nos cards (delegação de evento)
             */
            function handleCardClick(e) {
                // Botão MOVER CIMA
                const btnCima = e.target.closest('.btn-mover-cima');
                if (btnCima) {
                    moverEntrega(btnCima.dataset.id, 'cima');
                    return; 
                }

                // Botão MOVER BAIXO
                const btnBaixo = e.target.closest('.btn-mover-baixo');
                if (btnBaixo) {
                    moverEntrega(btnBaixo.dataset.id, 'baixo');
                    return;
                }

                // Botão CANCELAR
                const btnCancelar = e.target.closest('.btn-cancelar-entrega');
                if (btnCancelar) {
                    cancelarEntrega(btnCancelar.dataset.id);
                    return; 
                }

                // NOVO: Botão EDITAR
                const btnEdit = e.target.closest('.btn-editar-entrega');
                if (btnEdit && !btnEdit.disabled) {
                    entrarModoEdicao(btnEdit.dataset.id);
                    return; 
                }

                // Botão MAPA
                const btnMaps = e.target.closest('.btn-card-maps');
                if (btnMaps) {
                    const cardId = btnMaps.closest('[data-id]').dataset.id;
                    const entregas = getEntregasAtivas();
                    const entrega = entregas.find(e => e.id.toString() === cardId);
                    if (entrega) {
                        abrirGoogleMaps(entrega.cliente.endereco);
                    }
                    return;
                }
                
                // NOVO: Botão WHATSAPP
                const btnWhatsApp = e.target.closest('.btn-card-whatsapp');
                if (btnWhatsApp) {
                    abrirModalWhatsApp(btnWhatsApp.dataset.id);
                    return;
                }
                
                // NOVO: Botão LIGAR
                const btnLigar = e.target.closest('.btn-card-ligar');
                if (btnLigar) {
                    const cardId = btnLigar.closest('[data-id]').dataset.id;
                    const entregas = getEntregasAtivas();
                    const entrega = entregas.find(e => e.id.toString() === cardId);
                    if (entrega && entrega.cliente.celular) {
                        const telLimpo = entrega.cliente.celular.replace(/\D/g, '');
                        window.open(`tel:${telLimpo}`, '_self');
                    } else {
                        mostrarAviso('Cliente não possui número de celular cadastrado.');
                    }
                    return;
                }
                
                // NOVO: Botão EXPORTAR CARD JSON
                const btnJson = e.target.closest('.btn-card-json');
                if (btnJson) {
                    const cardId = btnJson.closest('[data-id]').dataset.id;
                    const entregas = getEntregasAtivas();
                    const entrega = entregas.find(e => e.id.toString() === cardId);
                    if (entrega) {
                        const jsonDados = JSON.stringify(entrega, null, 2);
                        const nomeArquivo = `card_${entrega.cliente.nome.replace(/[^a-z0-9]/gi, '_')}.json`;
                        compartilharOuBaixarArquivo(jsonDados, nomeArquivo, 'application/json');
                    }
                    return;
                }

                // Botão ENTREGUE
                const target = e.target.closest('.btn-entregue');
                if (target && !target.disabled) {
                    abrirModalPagamento(target.dataset.id);
                }
            }

            /**
             * NOVO: Entra no modo de edição, preenchendo o formulário
             */
            function entrarModoEdicao(id) {
                const entregas = getEntregasAtivas();
                const entrega = entregas.find(e => e.id.toString() === id);
                if (!entrega) return;

                editingEntregaId = id;

                // Preenche todos os campos do formulário com os dados da entrega
                inputCliente.value = entrega.cliente.nome;
                // Dispara o 'input' event para atualizar o info-box do cliente
                inputCliente.dispatchEvent(new Event('input', { bubbles: true }));

                obsClienteInput.value = entrega.observacao || '';
                selectCesta.value = entrega.cesta.nome;
                inputQuantidade.value = entrega.quantidade || 1;

                document.querySelector(`input[name="tipo-cesta"][value="${entrega.tipo}"]`).checked = true;
                document.querySelector(`input[name="brinde"][value="${entrega.brinde}"]`).checked = true;
                inputBrindeDescricao.value = entrega.brindeDescricao || '';
                
                codigoAlteradaInput.value = entrega.codigoAlterada || '';

                // Limpa checkboxes de 'partes_alteradas' antes de marcar
                document.querySelectorAll('input[name="partes_alteradas"]:checked').forEach(cb => cb.checked = false);
                // Marca os checkboxes corretos
                if (entrega.partesAlteradas && Array.isArray(entrega.partesAlteradas)) {
                    entrega.partesAlteradas.forEach(parte => {
                        const cb = document.querySelector(`input[name="partes_alteradas"][value="${parte}"]`);
                        if (cb) cb.checked = true;
                    });
                }

                // Atualiza UI dependente (valor, campos ocultos, etc)
                toggleCampoAlterada();
                toggleCampoBrinde();
                atualizarValorCesta();

                // Muda UI do formulário para "Modo Edição"
                formEntregaTitle.textContent = 'Editar Entrega';
                btnSubmitFormText.textContent = 'Atualizar Entrega';
                btnCancelarEdicao.classList.remove('hidden');

                // Rola a tela para o formulário
                formEntrega.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            /**
             * NOVO: Sai do modo de edição, limpando o formulário
             */
            function sairModoEdicao() {
                editingEntregaId = null;
                formEntrega.reset();

                // Limpezas manuais
                inputCliente.value = '';
                infoClienteSelecionado.classList.add('hidden');
                inputQuantidade.value = 1;
                // Garante que os radios padrão voltem
                document.querySelector('input[name="tipo-cesta"][value="Normal"]').checked = true;
                document.querySelector('input[name="brinde"][value="Não"]').checked = true;

                // Reseta UI dependente
                toggleCampoAlterada();
                toggleCampoBrinde();
                atualizarValorCesta();

                // Reseta UI do formulário para "Modo Lançamento"
                formEntregaTitle.textContent = 'Lançar Nova Entrega';
                btnSubmitFormText.textContent = 'Lançar Entrega';
                btnCancelarEdicao.classList.add('hidden');
            }


            /**
             * Lida com o submit do formulário de pagamento
             */
            function salvarPagamento(e) {
                e.preventDefault();
                
                const formasPagamentoSelecionadas = 
                    Array.from(formPagamento.querySelectorAll('input[name="forma_pagamento"]:checked'))
                         .map(input => input.value);
                
                if (formasPagamentoSelecionadas.length === 0) {
                    modalErrorPagamento.classList.remove('hidden');
                    return;
                }
                
                const entregas = getEntregasAtivas();
                const index = entregas.findIndex(e => e.id.toString() === entregaParaPagarId);

                if (index !== -1) {
                    entregas[index].status = "Entregue";
                    entregas[index].formaPagamento = formasPagamentoSelecionadas;
                    entregas[index].horarioEntrega = new Date().toISOString();
                }
                
                salvarLocalStorage();
                renderizarEntregas();
                fecharModalPagamento();
            }

            /**
             * NOVO: Gera texto completo do pedido para compartilhar
             */
            function gerarTextoPedidoCompleto(entrega) {
                const quantidade = entrega.quantidade || 1;
                const valorUnitario = entrega.cesta.valor;
                const valorTotal = valorUnitario * quantidade;

                let texto = `*PEDIDO COMPARTILHADO*\n\n`;
                texto += `*ID Cliente:* ${entrega.cliente.id || entrega.cliente.Id || entrega.cliente.ID || 'N/A'}\n`;
                texto += `*Cliente:* ${entrega.cliente.nome}\n`;
                texto += `*Celular:* ${entrega.cliente.celular || 'N/A'}\n`;
                texto += `*Endereço:* ${entrega.cliente.endereco || 'N/A'}\n`;
                texto += `*Complemento:* ${entrega.cliente.complemento || 'N/A'}\n\n`;
                texto += `*Cesta:* ${entrega.cesta.nome}\n`;
                texto += `*Quantidade:* ${quantidade}\n`;
                texto += `*Valor Unitário:* ${formatarMoeda(valorUnitario)}\n`;
                texto += `*Valor Total:* ${formatarMoeda(valorTotal)}\n`;
                texto += `*Brinde:* ${entrega.brinde} ${entrega.brindeDescricao || ''}\n`;
                texto += `*Tipo:* ${entrega.tipo}\n`;
                
                if (entrega.tipo === 'Alterada') {
                    if (entrega.partesAlteradas && entrega.partesAlteradas.length > 0) {
                        texto += `*Partes Alteradas:* ${entrega.partesAlteradas.join(', ')}\n`;
                    }
                    if (entrega.codigoAlterada) {
                        texto += `*Detalhes (Alterada):*\n${entrega.codigoAlterada}\n`;
                    }
                }
                if (entrega.observacao) {
                    texto += `*Observação (Cliente):*\n${entrega.observacao}\n`;
                }
                return texto;
            }
            
            /**
             * NOVO: Abre o modal do WhatsApp e configura os botões
             */
            function abrirModalWhatsApp(id) {
                const entregas = getEntregasAtivas();
                const entrega = entregas.find(e => e.id.toString() === id);
                if (!entrega) return;

                whatsAppEntregaId = id;
                modalWhatsAppCliente.textContent = entrega.cliente.nome;

                const telefoneLimpo = entrega.cliente.celular ? entrega.cliente.celular.replace(/\D/g, '') : null;
                const semTelefone = !telefoneLimpo;

                // Função auxiliar para desabilitar botões
                const toggleWhatsAppButton = (btn, disabled) => {
                    if (disabled) {
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                        btn.removeAttribute('href');
                    } else {
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                };

                // 1. Avisar Cliente (Chegando)
                const msgAvisar = "Olá! Sou o entregador da sua Cesta Básica. Estou chegando ao seu endereço em alguns minutos. Por favor, confirme que há alguém no local para receber. Obrigado";
                const urlAvisar = `https://api.whatsapp.com/send?phone=${telefoneLimpo}&text=${encodeURIComponent(msgAvisar)}`;
                const btnAvisar = document.getElementById('btn-whatsapp-avisar');
                btnAvisar.href = semTelefone ? '#' : urlAvisar;
                toggleWhatsAppButton(btnAvisar, semTelefone);

                // 2. Avisar (Chegou na Porta)
                const msgChegou = "Olá! Cheguei com a sua Cesta Básica e já estou aqui na porta aguardando. Obrigado!";
                const urlChegou = `https://api.whatsapp.com/send?phone=${telefoneLimpo}&text=${encodeURIComponent(msgChegou)}`;
                const btnChegou = document.getElementById('btn-whatsapp-chegou');
                btnChegou.href = semTelefone ? '#' : urlChegou;
                toggleWhatsAppButton(btnChegou, semTelefone);

                // 3. Agradecer Cliente
                const msgAgradecer = "Obrigado pela compra. Esperamos voce no proximo mês";
                const urlAgradecer = `https://api.whatsapp.com/send?phone=${telefoneLimpo}&text=${encodeURIComponent(msgAgradecer)}`;
                const btnAgradecer = document.getElementById('btn-whatsapp-agradecer');
                btnAgradecer.href = semTelefone ? '#' : urlAgradecer;
                toggleWhatsAppButton(btnAgradecer, semTelefone);

                // 4. Compartilhar Pedido (Admin)
                const numeroAdmin = "65996884599"; // Número fixo
                const msgCompartilhar = gerarTextoPedidoCompleto(entrega);
                const urlCompartilhar = `https://api.whatsapp.com/send?phone=${numeroAdmin}&text=${encodeURIComponent(msgCompartilhar)}`;
                const btnCompartilhar = document.getElementById('btn-whatsapp-compartilhar');
                btnCompartilhar.href = urlCompartilhar; // Sempre habilitado
                toggleWhatsAppButton(btnCompartilhar, false); 

                // 5. Compartilhar PIX
                const quantidadePix = entrega.quantidade || 1;
                const valorTotalPix = entrega.cesta.valor * quantidadePix;
                const msgPix = `Olá! O valor da sua cesta é ${formatarMoeda(valorTotalPix)}. Nossa chave Pix é: ${CHAVE_PIX_PADRAO}`;
                const urlPix = `https://api.whatsapp.com/send?phone=${telefoneLimpo}&text=${encodeURIComponent(msgPix)}`;
                const btnPix = document.getElementById('btn-whatsapp-pix');
                btnPix.href = semTelefone ? '#' : urlPix;
                toggleWhatsAppButton(btnPix, semTelefone);
                
                modalWhatsApp.classList.remove('hidden');
            }

            /**
             * Função para baixar dados (Fallback para Desktop)
             */
            function downloadArquivo(data, filename, mimeType) {
                const blob = new Blob([data], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            /**
             * NOVO: Tenta compartilhar o arquivo (Mobile) ou baixa (Desktop)
             */
            async function compartilharOuBaixarArquivo(data, filename, mimeType) {
                const file = new File([data], filename, { type: mimeType });
                
                // Verifica se a API de Compartilhamento (navigator.share) existe e pode compartilhar arquivos
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            title: 'Exportar Rota',
                            text: `Arquivo da rota: ${filename}`,
                            files: [file]
                        });
                    } catch (error) {
                        if (error.name !== 'AbortError') {
                            console.error('Erro ao compartilhar:', error);
                            // Fallback para download se o compartilhamento falhar
                            downloadArquivo(data, filename, mimeType);
                        }
                    }
                } else {
                    // Fallback para Desktop ou navegadores que não suportam
                    downloadArquivo(data, filename, mimeType);
                }
            }
            
            /**
             * Prepara e exibe o modal de exportação
             */
            function exportarDados() {
                const rotaAtiva = todasAsRotas[rotaAtivaId];
                if (!rotaAtiva) {
                    mostrarAviso("Nenhuma rota ativa para exportar.");
                    return;
                }
                const entregas = rotaAtiva.entregas;

                salvarLocalStorage(); 

                // 2. Prepara Relatório de Entregas Concluídas
                const entregasConcluidas = entregas.filter(e => e.status === 'Entregue');
                const entregasCanceladas = entregas.filter(e => e.status === 'Cancelada');
                
                let relatorioTexto = "Nenhuma entrega finalizada.\n";
                let whatsappTexto = `*Resumo da Rota: ${rotaAtiva.nome}* (${new Date(rotaAtiva.data + 'T12:00:00').toLocaleDateString('pt-BR')})\n\n`;

                if (entregasConcluidas.length > 0 || entregasCanceladas.length > 0) {
                    relatorioTexto = ""; // Limpa a mensagem padrão
                }

                if (entregasConcluidas.length > 0) {
                    relatorioTexto += "--- RELATÓRIO DE ENTREGAS ---\n\n";
                    entregasConcluidas.forEach(e => {
                        const quantidade = e.quantidade || 1;
                        const valorTotal = e.cesta.valor * quantidade;
                        const valorUnitarioTexto = quantidade > 1 ? ` (${quantidade}x ${formatarMoeda(e.cesta.valor)})` : '';

                        relatorioTexto += `Cliente: ${e.cliente.nome}\n`;
                        relatorioTexto += `Valor: ${formatarMoeda(valorTotal)}${valorUnitarioTexto}\n`;
                        relatorioTexto += `Pagamento: ${e.formaPagamento.join(', ')}\n`;
                        relatorioTexto += `Horário: ${formatarData(e.horarioEntrega)}\n`;
                        relatorioTexto += `-----------------------------\n`;
                    });
                }

                if (entregasCanceladas.length > 0) {
                    relatorioTexto += "\n--- ENTREGAS CANCELADAS ---\n\n";
                    entregasCanceladas.forEach(e => {
                        relatorioTexto += `Cliente: ${e.cliente.nome}\n`;
                        relatorioTexto += `Horário: ${formatarData(e.horarioEntrega)}\n`;
                        relatorioTexto += `-----------------------------\n`;
                    });
                }
                
                // 3. Prepara Texto para WhatsApp
                const entregasPendentes = entregas.filter(e => e.status === 'Pendente');
                whatsappTexto += `*Entregas Pendentes (${entregasPendentes.length})*:\n`;
                if(entregasPendentes.length > 0) {
                    entregasPendentes.forEach((e, index) => {
                        const quantidadePendente = e.quantidade || 1;
                        const valorTotalPendente = e.cesta.valor * quantidadePendente;
                        const valorUnitarioPendente = quantidadePendente > 1 ? ` (${formatarMoeda(e.cesta.valor)} cada)` : '';

                        whatsappTexto += `${index + 1}. *${e.cliente.nome}*\n`;
                        if (e.cliente.endereco) {
                            whatsappTexto += `   End: ${e.cliente.endereco}\n`;
                        }
                        if (e.cliente.complemento) {
                            whatsappTexto += `   Comp: ${e.cliente.complemento}\n`;
                        }
                        whatsappTexto += `   Cesta: ${quantidadePendente}x ${e.cesta.nome} (${formatarMoeda(valorTotalPendente)})${valorUnitarioPendente}\n`;
                        
                        if (e.brinde === 'Sim') {
                            whatsappTexto += `   BRINDE: ${e.brindeDescricao || 'Sim'}\n`;
                        }
                        if (e.observacao) {
                            whatsappTexto += `   OBS (Cliente): ${e.observacao}\n`;
                        }
                        if(e.tipo === 'Alterada') {
                            if (e.codigoAlterada) {
                                whatsappTexto += `   OBS (Cesta): ${e.codigoAlterada}\n`;
                            }
                            if (e.partesAlteradas && e.partesAlteradas.length > 0) {
                                whatsappTexto += `   Partes Alteradas: ${e.partesAlteradas.join(', ')}\n`;
                            }
                        }
                    });
                } else {
                    whatsappTexto += `Nenhuma entrega pendente.\n`;
                }
                
                // Seção Relatório Financeiro
                whatsappTexto += `\n\n--- RELATÓRIO FINANCEIRO ---\n`;
                
                let totalVendido = 0;
                let totalPorCesta = {};
                let totalPorPagamento = {};

                entregasConcluidas.forEach(e => {
                    const valor = e.cesta.valor * (e.quantidade || 1);
                    totalVendido += valor;
                    totalPorCesta[e.cesta.nome] = (totalPorCesta[e.cesta.nome] || 0) + valor;

                    if (e.formaPagamento.length === 0) {
                         totalPorPagamento['N/A'] = (totalPorPagamento['N/A'] || 0) + valor;
                    } else {
                        const valorDividido = valor / e.formaPagamento.length;
                        e.formaPagamento.forEach(forma => {
                            totalPorPagamento[forma] = (totalPorPagamento[forma] || 0) + valorDividido;
                        });
                    }
                });

                whatsappTexto += `\n*Vendas Concluídas:*\n`;
                whatsappTexto += `Total Vendido: *${formatarMoeda(totalVendido)}*\n`;

                whatsappTexto += `\n*Detalhado por Cesta:*\n`;
                if (Object.keys(totalPorCesta).length > 0) {
                    Object.keys(totalPorCesta).forEach(nomeCesta => {
                        whatsappTexto += `   ${nomeCesta}: ${formatarMoeda(totalPorCesta[nomeCesta])}\n`;
                    });
                } else {
                    whatsappTexto += `   Nenhuma.\n`;
                }

                whatsappTexto += `\n*Recebimentos por Forma:*\n`;
                if (Object.keys(totalPorPagamento).length > 0) {
                    Object.keys(totalPorPagamento).forEach(forma => {
                        whatsappTexto += `   ${forma}: ${formatarMoeda(totalPorPagamento[forma])}\n`;
                    });
                } else {
                     whatsappTexto += `   Nenhum.\n`;
                }

                // Despesas
                const despesas = rotaAtiva.despesas;
                const totalDespesas = (despesas.abastecimento || 0) + (despesas.alimentacao || 0) + (despesas.extra || 0);
                
                whatsappTexto += `\n*Despesas da Rota:*\n`;
                whatsappTexto += `   Abastecimento: ${formatarMoeda(despesas.abastecimento || 0)}\n`;
                whatsappTexto += `   Alimentação: ${formatarMoeda(despesas.alimentacao || 0)}\n`;
                whatsappTexto += `   Extras: ${formatarMoeda(despesas.extra || 0)}\n`;
                whatsappTexto += `Total Despesas: *${formatarMoeda(totalDespesas)}*\n`;

                // Balanço Final
                const balanco = totalVendido - totalDespesas;
                whatsappTexto += `\n*BALANÇO FINAL (Vendido - Despesas):*\n`;
                whatsappTexto += `*${formatarMoeda(balanco)}*\n`;

                whatsappTexto += `\n${relatorioTexto}`;

                exportRelatorioEl.querySelector('pre').textContent = relatorioTexto;
                
                // 4. Cria link do WhatsApp
                const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(whatsappTexto)}`;
                exportWhatsappLinkEl.innerHTML = `
                    <a href="${whatsappUrl}" target="_blank" class="inline-flex items-center justify-center w-full rounded-md border border-transparent bg-green-500 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-green-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM5.5 8.5A1.5 1.5 0 017 7h6a1.5 1.5 0 011.5 1.5v3A1.5 1.5 0 0113 13H7a1.5 1.5 0 01-1.5-1.5v-3z" /></svg>
                        Enviar Resumo no WhatsApp
                    </a>`;

                modalExportar.classList.remove('hidden');
            }

            /**
             * Lida com o carregamento de dados (JSON)
             */
            function carregarDados(jsonDados) {
                if (!jsonDados) {
                    mostrarAviso("O arquivo está vazio ou não pôde ser lido.");
                    return;
                }
                
                try {
                    const dadosCarregados = JSON.parse(jsonDados);
                    
                    // Caso 1: É o formato NOVO (Objeto Rota)
                    if (typeof dadosCarregados === 'object' && !Array.isArray(dadosCarregados) && dadosCarregados.entregas) {
                        
                        if (!dadosCarregados.id || !dadosCarregados.nome || !dadosCarregados.data) {
                            throw new Error('Objeto de rota inválido. Faltando id, nome ou data.');
                        }

                        let novoId = dadosCarregados.id;
                        if (todasAsRotas[novoId]) {
                            novoId = `import-${Date.now()}`;
                        }
                        dadosCarregados.id = novoId;

                        dadosCarregados.despesas = dadosCarregados.despesas || { abastecimento: 0, alimentacao: 0, extra: 0 };
                        dadosCarregados.entregas = dadosCarregados.entregas.map(e => ({
                            ...e,
                            quantidade: e.quantidade || 1, // Garante Qtd
                            cliente: typeof e.cliente === 'object' ? e.cliente : {
                                nome: e.codigoCliente || 'Cliente Antigo',
                                celular: '',
                                endereco: e.codigoCliente || 'Sem Endereço',
                                complemento: ''
                            }
                        }));

                        todasAsRotas[novoId] = dadosCarregados;
                        rotaAtivaId = novoId;
                        
                        salvarTodasAsRotas();
                        popularSelectRotas();
                        carregarRotaAtiva();

                    } 
                    // Caso 2: É o formato ANTIGO (Array de Entregas)
                    else if (Array.isArray(dadosCarregados)) {
                        const rotaAtiva = todasAsRotas[rotaAtivaId];
                        if (!rotaAtiva) {
                             mostrarAviso("Nenhuma rota ativa. Crie uma nova rota antes de carregar um arquivo antigo.");
                             return;
                        }

                        if (dadosCarregados.length > 0 && (!dadosCarregados[0].id)) {
                             throw new Error('Estrutura de dados antiga incompatível.');
                        }

                        rotaAtiva.entregas = dadosCarregados.map(e => ({
                            ...e,
                            quantidade: e.quantidade || 1,
                            brinde: e.brinde || 'Não',
                            brindeDescricao: e.brindeDescricao || '',
                            partesAlteradas: e.partesAlteradas || [],
                            cliente: typeof e.cliente === 'object' ? e.cliente : {
                                nome: e.codigoCliente || 'Cliente Antigo',
                                celular: '',
                                endereco: e.codigoCliente || 'Sem Endereço',
                                complemento: ''
                            }
                        }));
                        
                        salvarTodasAsRotas();
                        renderizarEntregas();

                    } else {
                        throw new Error('Formato de arquivo JSON desconhecido.');
                    }

                } catch (error) {
                    console.error("Erro ao carregar JSON:", error);
                    mostrarAviso(`Dados inválidos. Verifique o arquivo. (Erro: ${error.message})`);
                }
            }

            /**
             * Lida com o arquivo selecionado pelo usuário
             */
            function handleArquivoCarregado(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        carregarDados(event.target.result);
                    } catch (error) {
                        mostrarAviso(`Erro ao processar o arquivo: ${error.message}`);
                    }
                };
                reader.onerror = () => {
                    mostrarAviso('Não foi possível ler o arquivo.');
                };
                reader.readAsText(file);
                
                e.target.value = null;
            }
            
            /**
             * NOVO: Adiciona um card de um arquivo JSON na rota ativa
             */
            function carregarCardNaRota(cardJson) {
                try {
                    const novaEntrega = JSON.parse(cardJson);

                    if (!novaEntrega.id || !novaEntrega.cliente || !novaEntrega.cesta) {
                        throw new Error("Arquivo do card é inválido. Faltando id, cliente ou cesta.");
                    }
                    
                    // Garante campos novos
                    novaEntrega.quantidade = novaEntrega.quantidade || 1;
                    novaEntrega.brindeDescricao = novaEntrega.brindeDescricao || '';
                    novaEntrega.partesAlteradas = novaEntrega.partesAlteradas || [];

                    const rotaAtiva = todasAsRotas[rotaAtivaId];
                    if (!rotaAtiva) {
                         mostrarAviso("Nenhuma rota ativa para adicionar o card.");
                         return;
                    }

                    // Verifica se o ID já existe
                    const idExistente = rotaAtiva.entregas.find(e => e.id === novaEntrega.id);
                    if (idExistente) {
                        novaEntrega.id = Date.now(); // Gera novo ID para evitar duplicata
                    }

                    rotaAtiva.entregas.push(novaEntrega);
                    salvarLocalStorage();
                    renderizarEntregas();
                    mostrarAviso("Card importado com sucesso!");

                } catch (error) {
                    console.error("Erro ao carregar Card JSON:", error);
                    mostrarAviso(`Card inválido. (Erro: ${error.message})`);
                }
            }

            /**
             * NOVO: Lida com o arquivo de card selecionado
             */
            function handleCardImportado(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        carregarCardNaRota(event.target.result);
                    } catch (error) {
                        mostrarAviso(`Erro ao processar o arquivo: ${error.message}`);
                    }
                };
                reader.onerror = () => {
                    mostrarAviso('Não foi possível ler o arquivo.');
                };
                reader.readAsText(file);
                
                e.target.value = null;
            }
            
            // --- Inicialização e Event Listeners ---
            
            // Modos de Visualização
            btnModoAdmin.addEventListener('click', () => setModoVisualizacao('admin'));
            btnModoEntregador.addEventListener('click', () => setModoVisualizacao('entregador'));

            // Gerenciamento de Rotas
            selectRotaAtiva.addEventListener('change', (e) => {
                rotaAtivaId = e.target.value;
                localStorage.setItem('rotaAtivaId', rotaAtivaId);
                carregarRotaAtiva();
            });
            btnNovaRota.addEventListener('click', () => criarNovaRota(true));
            inputNomeRota.addEventListener('change', atualizarInfoRota);
            inputDataRota.addEventListener('change', atualizarInfoRota);
            btnExcluirRota.addEventListener('click', excluirRotaAtiva);

            // Listeners de Despesas
            inputDespesaAbastecimento.addEventListener('change', salvarDespesas);
            inputDespesaAlimentacao.addEventListener('change', salvarDespesas);
            inputDespesaExtra.addEventListener('change', salvarDespesas);

            // Listener para seleção de cliente
            inputCliente.addEventListener('input', (e) => {
                const nome = e.target.value.toLowerCase();
                const cliente = CLIENTES_CACHE[nome];
                if (cliente) {
                    displayClienteEndereco.textContent = cliente.endereco || '-';
                    displayClienteComplemento.textContent = cliente.complemento || '-';
                    displayClienteCelular.textContent = cliente.celular || '-';
                    infoClienteSelecionado.classList.remove('hidden');
                } else {
                    infoClienteSelecionado.classList.add('hidden');
                }
            });


            // Inputs do Formulário
            selectCesta.addEventListener('change', atualizarValorCesta);
            inputQuantidade.addEventListener('change', atualizarValorCesta);
            inputQuantidade.addEventListener('input', atualizarValorCesta);
            document.querySelectorAll('input[name="tipo-cesta"]').forEach(radio => {
                radio.addEventListener('change', toggleCampoAlterada);
            });
            document.querySelectorAll('input[name="brinde"]').forEach(radio => {
                radio.addEventListener('change', toggleCampoBrinde);
            });
            formEntrega.addEventListener('submit', adicionarOuAtualizarEntrega); // MODIFICADO

            // Lista de Entregas (Delegação de Evento)
            listaEntregasEl.addEventListener('click', handleCardClick);

            // Modal de Pagamento
            btnCancelarPagamento.addEventListener('click', fecharModalPagamento);
            formPagamento.addEventListener('submit', salvarPagamento);

            // Modal WhatsApp
            btnFecharWhatsApp.addEventListener('click', () => modalWhatsApp.classList.add('hidden'));
            
            // NOVO: Botão Cancelar Edição
            btnCancelarEdicao.addEventListener('click', sairModoEdicao);

            // Ações Globais (Exportar/Carregar)
            btnExportar.addEventListener('click', exportarDados);
            btnFecharExportar.addEventListener('click', () => modalExportar.classList.add('hidden'));

            // Listener para o botão de download
            btnBaixarJson.addEventListener('click', () => {
                const rotaAtiva = todasAsRotas[rotaAtivaId];
                if (!rotaAtiva) return;
                
                salvarLocalStorage();
                
                const jsonDados = JSON.stringify(rotaAtiva, null, 2);
                const nomeArquivo = `rota_${rotaAtiva.nome.replace(/[^a-z0-9]/gi, '_')}_${rotaAtiva.data}.json`;
                
                compartilharOuBaixarArquivo(jsonDados, nomeArquivo, 'application/json');
            });

            // Listener para o botão Carregar Rota
            btnCarregar.addEventListener('click', () => {
                inputCarregarArquivo.click();
            });
            inputCarregarArquivo.addEventListener('change', handleArquivoCarregado);
            
            // NOVO: Listener para o botão Importar Card
            btnImportarCard.addEventListener('click', () => {
                inputCarregarCard.click();
            });
            inputCarregarCard.addEventListener('change', handleCardImportado);

            // Modal de Aviso
            btnFecharAviso.addEventListener('click', fecharAviso);
            
            // Inicialização
            iniciarAplicativo();
            atualizarValorCesta();
        });
    </script>
</body>
</html>

