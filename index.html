<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8"> <!-- Charset para a página principal -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vademecum Digital</title>
    <!-- Carrega Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo para garantir que o iframe ocupe o espaço */
        #codeContent iframe {
            width: 100%;
            height: 100%;
            border: none;
            position: relative; /* Necessário para posicionamento absoluto dos botões */
        }
        /* Ajuste para o conteúdo do iframe não ter margens extras que escondam o início */
        body {
             font-family: 'Inter', sans-serif; /* Fonte padrão */
        }
         /* Estilos para o botão flutuante e sub-botões - REMOVIDOS */

         /* --- Estilos para os botões DENTRO do iframe --- */
         .article-button-container {
            position: absolute;
            right: 2px; /* Mais próximo da borda */
            top: 1px; /* Um pouco abaixo */
            display: flex;
            flex-direction: column;
            gap: 2px;
            opacity: 0; /* Começa invisível */
            transition: opacity 0.2s ease-in-out;
            z-index: 10; /* Acima do texto */
            background-color: rgba(240, 240, 240, 0.9); /* Fundo opaco */
            padding: 3px;
            border-radius: 4px;
            border: 1px solid #ddd;
            pointer-events: none; /* Não interage até hover */
         }
         /* Mostra ao passar o mouse ou ao focar (para acessibilidade/touch) */
         .relative-article:hover .article-button-container,
         .relative-article:focus-within .article-button-container {
             opacity: 1;
             pointer-events: auto; /* Permite clique nos botões */
         }

         .article-button {
             background-color: #fff;
             color: #333;
             border: 1px solid #ccc;
             border-radius: 4px; /* Voltando para quadrado pequeno */
             padding: 0;
             cursor: pointer;
             font-size: 0.65rem;
             line-height: 1;
             display: inline-flex;
             align-items: center;
             justify-content: center;
             width: 20px;
             height: 20px;
             box-shadow: 0 1px 2px rgba(0,0,0,0.1);
         }
          .article-button:hover {
              background-color: #eee;
              border-color: #bbb;
          }
         .article-button ion-icon {
             width: 14px; /* Ícone um pouco maior */
             height: 14px;
         }

        /* Estilo para highlight da busca */
        mark.search-highlight {
             background-color: yellow;
             font-weight: bold;
             padding: 0;
             margin: 0;
        }
        mark.current-highlight { /* Estilo para o resultado atual */
             background-color: orange;
        }

        /* Estilo para substituir links */
        span.link-replacement {
            color: #888; /* Cinza médio */
            font-size: 0.9em; /* Ligeiramente menor */
            word-break: break-all; /* Força a quebra de linha */
            /* Remove sublinhado e outras decorações de link */
            text-decoration: none;
            cursor: default; /* Remove cursor de link */
        }

    </style>
     <!-- Importa a fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
     <!-- Ícones IonIcons -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>


</head>
<body class="bg-gray-100">

    <!-- Container Principal -->
    <div id="appContainer" class="max-w-4xl mx-auto h-screen flex flex-col">

        <!-- Tela de Seleção de Código (Inicial) -->
        <div id="categorySelection" class="p-6 flex-grow flex flex-col">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Vademecum Digital</h1>
            <div class="space-y-4">
                <!-- Botão para carregar o Código Penal -->
                <button onclick="loadCode('DEL2848compilado.html', 'Código Penal')" class="w-full bg-white p-4 rounded-lg shadow hover:shadow-md transition text-left text-lg font-medium text-gray-700">
                    Código Penal (Decreto-Lei nº 2.848/1940)
                </button>
                <!-- Botão para carregar o Código Civil (Adicionado pelo usuário e corrigido) -->
                <button onclick="loadCode('codigo-civil.html', 'Código Civil')" class="w-full bg-white p-4 rounded-lg shadow hover:shadow-md transition text-left text-lg font-medium text-gray-700">
                     Código Civil
                 </button>
                 <!-- Placeholder para Constituição Federal -->
                 <div class="w-full bg-gray-200 p-4 rounded-lg shadow text-left text-lg font-medium text-gray-500 opacity-50">
                    Constituição Federal (Em breve)
                </div>
            </div> <!-- Fechamento correto do div space-y-4 -->
        </div>

        <!-- Tela de Visualização do Código (Oculta Inicialmente) -->
        <div id="codeView" class="hidden flex-grow flex flex-col h-full bg-white shadow-lg rounded-b-lg overflow-hidden">
             <!-- Cabeçalho da Visualização -->
            <div class="flex items-center p-3 bg-gray-50 border-b border-gray-200 sticky top-0 z-20"> <!-- z-index aumentado -->
                 <!-- Botão Voltar -->
                <button onclick="showCategories()" class="p-2 mr-2 text-blue-600 hover:bg-gray-200 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                    </svg>
                </button>
                 <!-- Título do Código -->
                <h2 id="codeTitle" class="text-lg font-semibold text-gray-800 flex-grow truncate mr-2">Código</h2>
                 <!-- Campo de Busca e Navegação -->
                <div class="flex items-center space-x-1">
                    <div class="relative">
                        <input type="search" id="searchInput" placeholder="Buscar no código..." class="pl-8 pr-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm w-32 md:w-48">
                        <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-gray-400">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                            </svg>
                        </div>
                    </div>
                    <!-- Botões de Navegação da Busca -->
                    <button id="searchPrev" onclick="goToPreviousResult()" class="p-1.5 text-gray-500 hover:bg-gray-200 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <span id="searchResultCount" class="text-xs text-gray-500 w-10 text-center">0/0</span>
                    <button id="searchNext" onclick="goToNextResult()" class="p-1.5 text-gray-500 hover:bg-gray-200 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                    </button>
                </div>
            </div>

            <!-- Área de Conteúdo do Código (usando iframe) -->
            <div id="codeContent" class="flex-grow overflow-auto p-1 bg-white relative">
                 <p class="p-4 text-gray-500">Carregando conteúdo...</p>
            </div>
        </div>

    </div>

    <script>
        const categorySelection = document.getElementById('categorySelection');
        const codeView = document.getElementById('codeView');
        const codeContent = document.getElementById('codeContent');
        const codeTitle = document.getElementById('codeTitle');
        const searchInput = document.getElementById('searchInput');
        const searchPrevBtn = document.getElementById('searchPrev');
        const searchNextBtn = document.getElementById('searchNext');
        const searchResultCountEl = document.getElementById('searchResultCount');

        const articleTextMap = new Map();
        let highlightMarkInstance;
        let searchResults = []; // Array para armazenar os elementos <mark>
        let currentSearchResultIndex = -1; // Índice do resultado atual

        function showCategories() {
            categorySelection.classList.remove('hidden');
            categorySelection.classList.add('flex');
            codeView.classList.add('hidden');
            codeView.classList.remove('flex');
            codeContent.innerHTML = '<p class="p-4 text-gray-500">Carregando conteúdo...</p>';
            resetSearch();
        }

        async function loadCode(url, title) {
            categorySelection.classList.add('hidden');
            categorySelection.classList.remove('flex');
            codeView.classList.remove('hidden');
            codeView.classList.add('flex');
            codeTitle.textContent = title;
            searchInput.value = '';
            articleTextMap.clear();
            resetSearch();

            codeContent.innerHTML = '';
            const iframe = document.createElement('iframe');
            iframe.src = url;
            iframe.onload = () => {
                console.log("Iframe carregado.");
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    console.log("Charset detectado no iframe:", iframeDoc.characterSet || iframeDoc.charset || "Não especificado");
                    if (!(iframeDoc.characterSet || iframeDoc.charset || '').toUpperCase().includes('UTF-8')) {
                         console.warn("A codificação do arquivo carregado não parece ser UTF-8. Verifique o <meta charset='UTF-8'> dentro do arquivo HTML.");
                    }
                     // Inicializa Mark.js APÓS garantir que o body existe
                     if (iframeDoc.body && typeof Mark !== 'undefined') {
                        highlightMarkInstance = new Mark(iframeDoc.body);
                     } else if (typeof Mark === 'undefined') {
                        console.error("Mark.js não está carregado.");
                     }
                } catch (e) {
                     console.error("Erro ao acessar documento do iframe ou inicializar Mark.js:", e);
                }
                 // Espera um pouco mais para garantir renderização e executa modificações/adição de botões
                setTimeout(() => {
                    prepareIframeContent(iframe);
                    addActionButtonsToIframe(iframe);
                }, 200); // Aumentado um pouco mais o tempo
            };
            iframe.onerror = () => {
                codeContent.innerHTML = '<p class="p-4 text-red-500">Erro ao carregar o conteúdo.</p>';
            };
            codeContent.appendChild(iframe);
        }


        // Verifica se é um elemento relevante (Artigo, Parágrafo, Inciso, etc.)
        function isRelevantElement(element) {
            // Verifica se é um <p> ou <div> (para cobrir mais casos)
            if (!['P', 'DIV'].includes(element.tagName)) return false; 
            
            const text = element.textContent.trim();
            
            // Remove qualquer texto de link substituído antes de verificar
            const cleanText = text.replace(/(\(Redação dada pela Lei.*\)|\(Incluído pela Lei.*\)|Vide Lei.*)/gi, '').trim();

             // Regex aprimorada para capturar mais padrões, incluindo alíneas e incisos romanos
             // Garante que o texto limpo comece com um desses padrões
             return cleanText.match(/^(Art\.\s*\d+[º°]?[\w-]*\.?)|(Parágrafo único)|(§\s*\d+[º°]?\.?)|(^[a-z]\))|(^[IVXLCDM]+\s*-)/i);
        }

        // Extrai o texto do elemento inicial e dos próximos <p> até encontrar outro elemento relevante
        function extractArticleText(startElement) {
            let text = startElement.textContent.trim();
            let currentElement = startElement.nextElementSibling;
            
            // Remove os textos dos links substituídos do final do texto principal, se houver
            const spanLinkMain = startElement.querySelector('span.link-replacement');
            if (spanLinkMain) {
                text = text.replace(spanLinkMain.textContent.trim(), '').trim();
            }

            while (currentElement && ['P', 'DIV'].includes(currentElement.tagName) && !isRelevantElement(currentElement)) {
                 // Inclui o texto do span.link-replacement, se houver
                 const spanLink = currentElement.querySelector('span.link-replacement');
                 let elementText = (spanLink ? spanLink.textContent.trim() : currentElement.textContent.trim());
                 
                 // Remove o texto do link se ele for o único conteúdo (para não duplicar)
                 if (spanLink && elementText === spanLink.textContent.trim()) {
                     text += "\n" + currentElement.textContent.replace(spanLink.textContent.trim(), '').trim();
                 } else {
                     text += "\n" + currentElement.textContent.trim();
                 }
                 
                 currentElement = currentElement.nextElementSibling;
            }
             
            // Limpa o texto extraído de todos os "(Redação...)", "(Incluído...)", "(Vide...)"
            text = text.replace(/(\(Redação dada pela Lei.*\)|\(Incluído pela Lei.*\)|\(Vide Lei.*\))/gi, '').trim();
            // Remove espaços múltiplos
            text = text.replace(/\s\s+/g, ' '); 

            return text;
        }

        // Função para modificar o conteúdo do iframe (substituir links)
        function prepareIframeContent(iframe) {
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                if (!iframeDoc || !iframeDoc.body) {
                    console.warn("Documento do Iframe não acessível para preparar conteúdo.");
                    return;
                }

                // Encontra todos os links <a> dentro do corpo do iframe
                const links = iframeDoc.body.querySelectorAll('a');
                console.log(`Encontrados ${links.length} links para processar.`);

                links.forEach(link => {
                    // Cria um novo elemento <span>
                    const span = iframeDoc.createElement('span');
                    // Copia o texto do link para o span
                    span.textContent = link.textContent;
                    // Adiciona a classe CSS para estilização e quebra de linha
                    span.className = 'link-replacement';
                    // Substitui o link <a> pelo novo <span> no DOM
                    link.parentNode.replaceChild(span, link);
                });
                 console.log(`Links substituídos por spans.`);

            } catch (e) {
                 console.error("Erro ao preparar conteúdo do iframe (substituir links): ", e);
            }
        }


         // Adiciona os botões de ação aos elementos relevantes
         function addActionButtonsToIframe(iframe) {
             try {
                 const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                 // Adiciona verificação robusta
                 if (!iframeDoc || !iframeDoc.body || iframeDoc.readyState !== 'complete' || !iframeDoc.head) {
                     console.warn("Documento do Iframe ainda não está pronto. Tentando novamente...");
                     setTimeout(() => addActionButtonsToIframe(iframe), 300);
                     return;
                 }

                 // Injeta CSS se não existir
                 const styleId = 'article-button-styles';
                 if (!iframeDoc.getElementById(styleId)) {
                    const style = iframeDoc.createElement('style');
                    style.id = styleId;
                    style.textContent = `
                        /* --- Font and Style Reset --- */
                        body { 
                            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif !important; 
                            font-size: 16px !important; 
                            line-height: 1.6 !important; 
                            color: #333 !important; 
                            background-color: #fff !important;
                            padding: 0.5rem 1rem !important; /* Adiciona um padding ao corpo do iframe */
                        }
                        /* Remove estilos de fonte antigos */
                        p, div, span, font, .Artart, .texto1, .texto2, .texto3, .MsoNormal, .cabea {
                             font-family: inherit !important;
                             font-size: inherit !important;
                             color: inherit !important;
                             background-color: transparent !important;
                             line-height: inherit !important;
                        }
                        /* --- Fim do Font Reset --- */

                        .relative-article { position: relative !important; padding-right: 30px !important; min-height: 25px; outline: none; /* Remove outline padrão do foco */ }
                        .article-button-container { position: absolute; right: 2px; top: 1px; display: flex; flex-direction: column; gap: 2px; opacity: 0; transition: opacity 0.2s ease-in-out; z-index: 10; background-color: rgba(240, 240, 240, 0.9); padding: 3px; border-radius: 4px; border: 1px solid #ddd; pointer-events: none; }
                        .relative-article:hover .article-button-container,
                        .relative-article:focus-within .article-button-container { opacity: 1; pointer-events: auto; }
                        .article-button { background-color: #fff; color: #333; border: 1px solid #ccc; border-radius: 4px; padding: 0; cursor: pointer; font-size: 0.65rem; line-height: 1; display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
                        .article-button:hover { background-color: #eee; border-color: #bbb; }
                        .article-button ion-icon { width: 14px; height: 14px; }
                        mark.search-highlight { background-color: yellow; font-weight: bold; padding: 0; margin: 0; }
                        mark.current-highlight { background-color: orange; }
                        span.link-replacement { color: #888; font-size: 0.9em; word-break: break-all; text-decoration: none; cursor: default; }
                    `;
                    iframeDoc.head.appendChild(style);
                 }

                 // Busca por P e DIVs
                 const elements = iframeDoc.body.querySelectorAll('p, div'); 
                 let articleCounter = 0;

                 elements.forEach(el => {
                      // Limpa botões antigos e classe
                     const oldContainer = el.querySelector('.article-button-container');
                     if(oldContainer) el.removeChild(oldContainer);
                     el.classList.remove('relative-article');
                     el.removeAttribute('tabindex'); // Remove tabindex se houver

                     // Verifica se é um elemento relevante
                     if (isRelevantElement(el)) {
                         articleCounter++;
                         const uniqueArticleId = `article-${articleCounter}`;
                         el.dataset.articleId = uniqueArticleId;

                         // Extrai texto e armazena (agora dentro do if)
                         const fullText = extractArticleText(el);
                         if (!fullText || fullText.length < 5) { // Pula se texto for muito curto ou vazio
                            // console.warn("Texto muito curto para elemento:", el.textContent.trim());
                            return;
                         }
                         articleTextMap.set(uniqueArticleId, fullText);

                         // Adiciona classe e tabindex para foco/touch
                         el.classList.add('relative-article');
                         el.setAttribute('tabindex', '-1'); // Permite foco programático ou via JS, mas não via Tab

                         // Cria container dos botões
                         const buttonContainer = iframeDoc.createElement('div');
                         buttonContainer.classList.add('article-button-container');

                         // Define os prompts usando o fullText extraído
                         const prompts = {
                            explain: `Explicação detalhada do artigo completo:\n\n"${fullText}"`,
                            glossary: `Glossário jurídico dos termos no artigo completo:\n\n"${fullText}"`,
                            related: `Buscar Súmulas, Enunciados, Teses e artigos correlatos para:\n\n"${fullText}"`
                         };

                         // Botões HTML com ícones corretos e chamadas de função
                         buttonContainer.innerHTML = `
                             <button class="article-button" title="Explicação Detalhada (IA)" onclick="window.parent.handleArticleAction('explain', '${uniqueArticleId}')">
                                 <ion-icon name="information-circle-outline"></ion-icon> <!-- Ícone para Explicação -->
                             </button>
                             <button class="article-button" title="Glossário Jurídico (IA)" onclick="window.parent.handleArticleAction('glossary', '${uniqueArticleId}')">
                                 <ion-icon name="book-outline"></ion-icon> <!-- Ícone para Glossário -->
                             </button>
                             <button class="article-button" title="Súmulas e Correlatos (IA)" onclick="window.parent.handleArticleAction('related', '${uniqueArticleId}')">
                                <ion-icon name="library-outline"></ion-icon> <!-- Ícone para Súmulas/Jurisprudência -->
                            </button>
                             <button class="article-button" title="Buscar Videoaula (YouTube)" onclick="window.parent.handleArticleAction('youtube', '${uniqueArticleId}')">
                                <ion-icon name="logo-youtube"></ion-icon> <!-- Ícone para YouTube -->
                             </button>
                         `;
                         // Adiciona dados dos prompts ao container
                         buttonContainer.dataset.promptExplain = prompts.explain;
                         buttonContainer.dataset.promptGlossary = prompts.glossary;
                         buttonContainer.dataset.promptRelated = prompts.related;


                         el.appendChild(buttonContainer);
                     }
                 });
                 console.log(`Botões adicionados a ${articleCounter} elementos relevantes no iframe.`);
             } catch (e) {
                 console.error("Erro ao adicionar botões ao iframe: ", e);
                 // Tenta novamente se for um erro de acesso inicial
                 if (e.message.includes("Cannot read properties of null (reading 'body')")) {
                      setTimeout(() => addActionButtonsToIframe(iframe), 500);
                 }
             }
         }

        // Função que lida com o clique nos botões
        function handleArticleAction(action, uniqueArticleId) {
             const fullArticleText = articleTextMap.get(uniqueArticleId);
             if (!fullArticleText) {
                console.error("Texto completo não encontrado para o ID:", uniqueArticleId);
                return; // Impede a execução se não houver texto
             }

             // Ação YouTube
             if (action === 'youtube') {
                const articleMatch = fullArticleText.match(/Art\.\s*\d+[º°]?[\w-]*\.?/i);
                // Tenta extrair apenas o número ou usa os primeiros 50 chars se não achar "Art."
                const queryBase = articleMatch ? articleMatch[0] : fullArticleText.substring(0, 50).trim();
                const searchQuery = `Videoaula ${queryBase} ${codeTitle.textContent}`;
                const youtubeUrl = `https://www.youtube.com/results?search_query=${encodeURIComponent(searchQuery)}`;
                console.log("Abrindo YouTube:", youtubeUrl);
                window.open(youtubeUrl, '_blank');
                return;
             }

             // Ações Google Search (IA)
             let promptText = '';
             try {
                // Recupera o prompt específico do dataset do container
                const iframeDoc = codeContent.querySelector('iframe')?.contentDocument;
                const articleElement = iframeDoc?.querySelector(`[data-article-id='${uniqueArticleId}']`);
                const buttonContainer = articleElement?.querySelector('.article-button-container');

                if (action === 'explain') promptText = buttonContainer?.dataset.promptExplain;
                else if (action === 'glossary') promptText = buttonContainer?.dataset.promptGlossary;
                else if (action === 'related') promptText = buttonContainer?.dataset.promptRelated;

             } catch(e) { console.error("Erro ao buscar prompt do dataset:", e)}

             if (!promptText) {
                 console.error("Prompt não definido para a ação:", action);
                 // Fallback genérico se o prompt específico falhar
                 promptText = `Informações sobre:\n\n"${fullArticleText}"`;
             }

             // Usa a URL base do Google Search com udm=50
             const googleSearchBaseUrl = "https://www.google.com/search?udm=50&q=";
             const encodedPrompt = encodeURIComponent(promptText);
             const finalUrl = googleSearchBaseUrl + encodedPrompt;

             console.log("Abrindo URL Google Search (IA):", finalUrl);
             window.open(finalUrl, '_blank');
        }


        // --- Funções de Busca ---
        function resetSearch() {
            if (highlightMarkInstance) {
                try {
                    highlightMarkInstance.unmark();
                } catch (e) { console.error("Erro ao desmarcar:", e);}
            }
            searchResults = [];
            currentSearchResultIndex = -1;
            updateSearchResultUI();
        }

        function updateSearchResultUI() {
            const total = searchResults.length;
            const current = total > 0 ? currentSearchResultIndex + 1 : 0;
            searchResultCountEl.textContent = `${current}/${total}`;
            // Habilita/desabilita botões baseado se há resultados
            searchPrevBtn.disabled = total <= 1;
            searchNextBtn.disabled = total <= 1;


             // Atualiza destaque do item atual
            searchResults.forEach((mark, index) => {
                mark.classList.toggle('current-highlight', index === currentSearchResultIndex);
            });
        }

        function scrollToResult(index) {
            if (searchResults[index]) {
                searchResults[index].scrollIntoView({
                    behavior: 'smooth', // Rolagem suave
                    block: 'center',    // Tenta centralizar verticalmente
                    inline: 'nearest'   // Rola horizontalmente o mínimo necessário
                });
                updateSearchResultUI(); // Atualiza contador e destaque
            }
        }

         function performSearch(term) {
             if (!highlightMarkInstance) {
                 console.warn("Instância do Mark.js não está pronta para busca.");
                 return;
             }
             // Usa unmark com um callback para garantir que a nova busca só comece depois de limpar
             highlightMarkInstance.unmark({
                 done: () => {
                     searchResults = [];
                     currentSearchResultIndex = -1;
                     updateSearchResultUI(); // Reseta a UI imediatamente

                     if (term && term.length > 1) { // Mínimo 2 caracteres para buscar
                         highlightMarkInstance.mark(term, {
                             separateWordSearch: false, // Busca exata
                             className: 'search-highlight',
                             each: (element) => {
                                 searchResults.push(element); // Adiciona ao array
                             },
                             done: () => {
                                 console.log(`Encontradas ${searchResults.length} ocorrências.`);
                                 if (searchResults.length > 0) {
                                     currentSearchResultIndex = 0; // Vai para o primeiro
                                     scrollToResult(currentSearchResultIndex);
                                 }
                                 // A UI já foi atualizada pelo updateSearchResultUI() no início do 'done' de unmark
                             },
                             noMatch: () => {
                                 console.log("Nenhuma ocorrência encontrada.");
                                 // UI já foi resetada
                             }
                         });
                     }
                     // Se termo for vazio/curto, a UI já foi resetada
                 }
             });
         }


         function goToNextResult() {
             if (searchResults.length === 0) return;
             // Avança o índice, ciclando se chegar ao final
             currentSearchResultIndex = (currentSearchResultIndex + 1) % searchResults.length;
             scrollToResult(currentSearchResultIndex);
         }

         function goToPreviousResult() {
             if (searchResults.length === 0) return;
             // Retrocede o índice, ciclando se chegar ao início
             currentSearchResultIndex = (currentSearchResultIndex - 1 + searchResults.length) % searchResults.length;
             scrollToResult(currentSearchResultIndex);
         }


        // Event Listener para o input de busca (com debounce)
        let searchTimeout;
        searchInput.addEventListener('input', (event) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                performSearch(event.target.value);
            }, 300); // 300ms de atraso
        });

        // Event Listener para tecla Enter na busca
         searchInput.addEventListener('keydown', (event) => {
             if (event.key === 'Enter') {
                 event.preventDefault(); // Impede envio de formulário (se houver)
                 // Se houver resultados, vai para o próximo, senão, não faz nada
                 if (searchResults.length > 0) {
                    goToNextResult();
                 }
             }
         });


        document.addEventListener('DOMContentLoaded', showCategories);

    </script>
     <!-- Adiciona a biblioteca Mark.js para a busca -->
     <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js"></script>

     <!-- Script para registrar o Service Worker -->
     <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                .then(registration => {
                    console.log('Service Worker registrado com sucesso:', registration);
                })
                .catch(error => {
                    console.error('Falha ao registrar o Service Worker:', error);
                });
            });
        } else {
            console.log('Service Worker não é suportado neste navegador.');
        }
     </script>

</body>
</html>

