<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>direito.love — Leitor jurídico</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#f6f7fb">
  <link rel="icon" href="icons/favicon-32.png" sizes="32x32" type="image/png">
  <link rel="icon" href="icons/favicon-192.png" sizes="192x192" type="image/png">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

  <style>
    :root{
      --white:#FFFFFF;
      --navy:#142B6F;
      --muted:#5f6470;

      --bg:#ffffff;
      --fg:#101418;

      --topbar-h:56px;
      --search-h:54px;

      --focus:#9bb6ff;
      --radius:12px;
      --shadow:0 2px 10px rgba(0,0,0,.06);

      --line:#e9ecf3;
      --soft:#f6f7fb;

      --wrap-max: 860px;

      --active-bg:#eef3ff;   /* destaque real para ícones ativos */
      --active-br:#9bb6ff;
    }

    *{box-sizing:border-box}
    html,body{margin:0;height:100%}
    body{
      background:var(--bg); color:var(--fg);
      font:15px/1.58 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      max-width:100%; overflow-x:hidden;
    }
    button,input,select{font:inherit}

    /* Utilitários */
    .hidden{display:none !important;}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* ======== TOP BAR (cinza claro, minimalista) ======== */
    .topbar{
      position:fixed; inset:0 0 auto 0; height:var(--topbar-h);
      display:flex; align-items:center; justify-content:center;
      background:var(--soft); color:#111; z-index:100; box-shadow:0 1px 0 var(--line);
    }
    .topbar-inner{
      width:min(var(--wrap-max), 92vw);
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:0 10px;
    }
    .brand{ height:40px; width:auto; object-fit:contain; display:block; cursor:pointer; }
    .brand:focus{outline:2px solid var(--focus); outline-offset:2px}

    .top-actions{ display:flex; align-items:center; gap:8px }
    .picker-btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 12px; border-radius:999px; border:1px solid #d6dbeb; background:#fff;
      font-weight:600; color:#1b2554; cursor:pointer; max-width:380px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      position:relative;
    }
    .picker-btn:focus{ outline:2px solid var(--focus); outline-offset:2px; }

    /* ======== BARRA DE BUSCA (colada na topbar) ======== */
    .searchbar{
      position:fixed; left:0; right:0; top:var(--topbar-h); height:var(--search-h);
      background:#fff; z-index:99; box-shadow:0 1px 0 var(--line);
      display:flex; align-items:center; justify-content:center;
    }
    .searchbar-inner{
      width:min(var(--wrap-max), 92vw);
      display:flex; align-items:center; gap:8px; padding:6px 10px;
    }
    .iconbtn{
      width:28px; height:28px; flex:0 0 28px; display:grid; place-items:center; cursor:pointer; user-select:none;
      font-size:13px; line-height:1; border-radius:999px; border:1px solid #d6dbeb; background:#fff;
      transition:transform .1s; position:relative;
    }
    .iconbtn:hover{ transform:translateY(-1px); }
    .iconbtn:active{ transform:translateY(0); }

    .search{flex:1; display:flex; align-items:center; gap:8px; min-width:0}
    .search input{
      width:100%; height:38px; border:1px solid #cfd4e2; border-radius:999px; padding:0 14px; background:#fff;
      box-shadow:0 1px 2px rgba(0,0,0,.03); transition:border .2s, box-shadow .2s;
    }
    .search input:focus{ border-color:#9bb6ff; box-shadow:0 0 0 3px rgba(155,182,255,.25); outline:none; }

    .spinner{
      width:18px; height:18px; border:2px solid #e2e5f2; border-top-color:#142B6F; border-radius:50%;
      animation:spin 1s linear infinite; flex:0 0 18px
    }
    .spinner[hidden]{display:none}
    @keyframes spin{to{transform:rotate(360deg)}}

    .result-count{
      min-width:52px; font-size:11px; color:#6c7282; border:1px solid #e2e5f2;
      background:#f7f8fc; padding:4px 8px; border-radius:999px; text-align:center;
    }

    /* ======== Breadcrumb (navbar discreta) ======== */
    .breadcrumb{
      position:fixed; left:0; right:0; top:calc(var(--topbar-h) + var(--search-h));
      background:#fff; z-index:98; box-shadow:0 1px 0 var(--line);
      display:flex; align-items:center; justify-content:center;
      height:36px;
    }
    .breadcrumb-inner{
      width:min(var(--wrap-max), 92vw);
      font-size:12px; color:#6c7282; padding:0 10px;
      display:flex; align-items:center; gap:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .breadcrumb a{ color:#4d5a8f; text-decoration:none; }
    .breadcrumb a:hover{ text-decoration:underline; }

    /* ======== CONTEÚDO ======== */
    .content{
      position:relative;
      padding: calc(var(--topbar-h) + var(--search-h) + 36px + 14px) 0 32px;
      min-height:100dvh;
    }
    .container{ width:min(var(--wrap-max), 92vw); margin:0 auto; padding:0 10px }

    /* HOME (somente logo + botão) */
    body.home .topbar,
    body.home .searchbar,
    body.home .breadcrumb{ display:none !important; }
    body.home .content{ padding:0; }
    .hero{
      height:100dvh;
      display:grid; place-items:center; text-align:center;
    }
    .hero .hero-inner{ display:flex; flex-direction:column; align-items:center; gap:18px }
    .hero .hero-logo{ height:62px; cursor:pointer; }
    .hero .hero-btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 14px; border-radius:999px; border:1px solid #d6dbeb; background:#fff;
      font-weight:600; color:#1b2554; cursor:pointer; position:relative;
    }

    /* ======== Artigos ======== */
    article{
      white-space:pre-wrap;
      padding:16px 4px 18px; scroll-margin: calc(var(--topbar-h) + var(--search-h) + 36px + 20px);
      overflow-wrap:anywhere; word-break:break-word; hyphens:auto; max-width:100%;
      position:relative;
    }
    article::after{
      content:""; display:block; width:90%; height:1px; background:var(--line);
      position:absolute; left:5%; bottom:0;
    }

    .supra{ color:#6c7282; font-weight:500; font-size:12px; margin:0 0 6px; }
    .supra div{ line-height:1.35 }

    .art-head{
      display:flex; align-items:center; justify-content:space-between; gap:10px; margin:0 0 6px;
    }
    .art-title{ display:block; font-weight:800; color:#0e1638; font-size:13px; margin:0 }
    .art-actions{ display:flex; align-items:center; gap:6px }
    .act-btn{
      width:28px; height:28px; border-radius:999px; border:1px solid transparent; background:#fff; display:grid; place-items:center;
      cursor:pointer; font-size:14px; line-height:1; position:relative;
    }
    .act-btn.active{
      background:var(--active-bg); border-color:var(--active-br);
      box-shadow:0 0 0 2px rgba(155,182,255,.25);
    }
    .act-btn:focus{ outline:2px solid var(--focus); outline-offset:2px; }

    .art-body { font-size:12px; line-height:1.45; }
    article.current-outline{ outline:3px solid #7aa8ff; outline-offset:2px; }
    article.highlight-study{ background:rgba(255,214,1,.12) }
    mark{padding:0 2px; border-radius:3px; background:#ffef99}

    /* Área de notas rápidas (oculta por padrão) */
    .note-pad{
      margin-top:8px; padding:10px; border:1px solid #e7eaf3; border-radius:10px; background:#f9fbff;
      display:none;
    }
    .note-pad textarea{
      width:100%; min-height:90px; resize:vertical; border:1px solid #cfd4e2; border-radius:8px; padding:8px; background:#fff;
      outline:none;
    }
    .note-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:8px; }
    .btn{ position:relative; }
    .btn, .note-actions button{
      padding:8px 12px; border-radius:10px; border:1px solid #d6dbeb; background:#fff; cursor:pointer;
    }

    /* ======== MODAIS (CENTRO DA TELA) ======== */
    .modal-backdrop{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.28); z-index:120; }
    .modal{ background:#fff; border-radius:16px; width:min(var(--wrap-max), 92vw); padding:0; border:1px solid #eceef7; box-shadow: var(--shadow); max-height:calc(100vh - 48px); overflow:auto; }

    /* MODAL ESTUDAR */
    .study-head{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid #eceef2; }
    .study-title{ margin:0; color:#0f173a; font-size:16px; font-weight:600; letter-spacing:.2px; }
    .study-sub{ margin:0; font-size:13px; color:#666; font-weight:400; padding:0 16px 12px; border-bottom:1px solid #f0f2f7; }
    .prompt-box{ margin:12px 16px; border:1px solid #e2e5f2; background:#f6f7fb; border-radius:12px; padding:10px; max-height:180px; overflow:auto; font-size:12px; line-height:1.45; white-space:pre-wrap; }
    .ia-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:0 16px 12px; }
    .ia-btn{ display:flex; align-items:center; justify-content:center; padding:12px; border:1px solid #e6e8f2; background:#fff; border-radius:12px; cursor:pointer; text-decoration:none; color:#111; font-weight:500; transition: background .2s, border .15s, transform .12s; position:relative; }
    .ia-btn:hover{ background:#f7f8ff; border-color:#c3cff5; transform:translateY(-1px); }
    .copy-prompt{ margin:0 16px 16px; display:flex; justify-content:center; }
    .copy-prompt button{ padding:10px 16px; border-radius:999px; background:#142B6F; color:#fff; border:1px solid #142B6F; font-weight:600; cursor:pointer; }
    .study-close{ width:32px; height:32px; border:1px solid #e2e5f2; background:#fff; border-radius:10px; display:grid; place-items:center; cursor:pointer; }

    /* MODAL PICKER (SELETOR DE ARQUIVOS) */
    .picker-head{ padding:12px 16px; border-bottom:1px solid #eceef2; display:flex; align-items:center; justify-content:space-between; }
    .picker-actions{ display:flex; align-items:center; gap:8px; }
    .emoji-menu{ display:flex; gap:8px; }
    .emoji-btn{
      width:36px; height:36px; border-radius:999px; border:1px solid #d6dbeb; background:#fff; display:grid; place-items:center; cursor:pointer; font-size:18px; position:relative;
    }
    .emoji-btn.active{ background:var(--active-bg); border-color:var(--active-br); box-shadow:0 0 0 2px rgba(155,182,255,.25); }
    .picker-body{ padding:0 16px 16px; }
    .picker-spacer{ height:12px; } /* respiro abaixo dos emojis */
    .picker-search{ padding:10px 0; }
    .picker-search input{ width:100%; height:38px; border:1px solid #cfd4e2; border-radius:10px; padding:0 12px; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.05); transition:border .2s, box-shadow .2s; }
    .picker-search input:focus{ border-color:#9bb6ff; box-shadow:0 0 0 3px rgba(155,182,255,.35); outline:none; }
    .sheet-body{ overflow:auto; padding:8px 0 0; }
    .list-section{ padding:6px 0; }
    .list-section h4{ font-size:14px; letter-spacing:.4px; font-weight:700; color:#052373; margin:6px 2px 4px; text-transform:uppercase; }
    .item{ width:100%; text-align:left; cursor:pointer; display:flex; align-items:center; gap:10px; padding:10px 11px; border-radius:10px; margin:6px 0; border:1px solid #eceff4; background:#f9fafc; position:relative; }
    .item b{ font-weight:400; color:#0e1638; }
    .item small{ color:#6c7282; }
    .item:hover, .item:focus{ outline:2px solid var(--focus); outline-offset:2px; }
    .highlight{ background:#ffef99; border-radius:3px; }

    /* Toast */
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      top: calc(var(--topbar-h) + var(--search-h) + 10px);
      background:#111; color:#fff; padding:8px 12px; border-radius:10px; opacity:0; pointer-events:none; transition:opacity .2s; z-index:200
    }
    .toast.show{opacity:1}

    /* Spinner sobre QUALQUER botão */
    .busy{ pointer-events:none; }
    .busy::after{
      content:""; position:absolute; inset:0; display:block;
      background:rgba(255,255,255,.65); border-radius:inherit;
    }
    .busy::before{
      content:""; position:absolute; left:50%; top:50%; width:16px; height:16px; margin:-8px 0 0 -8px;
      border:2px solid #cfd4e2; border-top-color:#142B6F; border-radius:50%; animation:spin 1s linear infinite;
    }

    /* Responsivo */
    .select-wrap, #codeSelect{ display:none !important; }
    @media (max-width: 768px){
      .brand{ height:36px; }
      .ia-grid{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body class="home">
  <!-- TOP BAR (não aparece no HOME) -->
  <header class="topbar">
    <div class="topbar-inner">
      <img src="icons/logo.png" alt="direito.love" class="brand" id="brandBtn" title="Escolher código">
      <div class="top-actions">
        <button class="picker-btn btn" id="openPickerTop" type="button" aria-haspopup="dialog" aria-controls="pickerModal" title="Escolher código">Escolher código</button>
      </div>
    </div>
  </header>

  <!-- BARRA DE BUSCA (sem X, colada na topbar) -->
  <div class="searchbar" id="topSearch" hidden>
    <div class="searchbar-inner" aria-live="polite">
      <button class="iconbtn btn" id="prevBtn" title="Anterior" aria-label="Anterior">◀</button>
      <button class="iconbtn btn" id="nextBtn" title="Próximo" aria-label="Próximo">▶</button>
      <div class="search">
        <input id="searchInput" type="search" placeholder="Buscar no texto…" autocomplete="off" />
        <div class="spinner" id="spinner" hidden></div>
      </div>
      <div class="result-count" title="Ocorrência atual / Total"><span id="count">0/0</span></div>
    </div>
  </div>

  <!-- BREADCRUMB (navbar discreta) -->
  <div class="breadcrumb" id="breadcrumb" hidden>
    <div class="breadcrumb-inner" id="breadcrumbInner">Início</div>
  </div>

  <!-- CONTEÚDO -->
  <main class="content">
    <div class="container">
      <div class="articles" id="articles">
        <!-- HOME: logo + botão centro, sem scroll extra -->
        <div class="hero" id="hero">
          <div class="hero-inner">
            <img src="icons/logo.png" alt="direito.love" class="hero-logo" id="heroLogo" title="Escolher código">
            <button class="hero-btn btn" id="openPickerHero" type="button" aria-haspopup="dialog" aria-controls="pickerModal" title="Escolher código">Escolher código</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- CATÁLOGO OCULTO (fonte dos itens) -->
  <select id="codeSelect" title="Escolher arquivo" style="display:none">
    <option value="">— selecione —</option>
    <optgroup label="CF88">
      <option value="data/CF88/CF88.txt">Constituição Federal 1988</option>
    </optgroup>
    <optgroup label="Códigos">
      <option value="data/codigos/codigo_civil.txt">Código Civil</option>
      <option value="data/codigos/codigo_processo_civil.txt">Código de Processo Civil</option>
      <option value="data/codigos/codigo_penal.txt">Código Penal</option>
      <option value="data/codigos/codigo_processo_penal.txt">Código de Processo Penal</option>
      <option value="data/codigos/codigo_consumidor.txt">Código de Defesa do Consumidor</option>
      <option value="data/codigos/codigo_clt.txt">CLT - Consolidação das Leis do Trabalho</option>
      <option value="data/codigos/codigo_tributario_nacional.txt">Código Tributário Nacional</option>
    </optgroup>
    <optgroup label="Leis">
      <option value="data/leis/lei_maria_da_penha.txt">Lei Maria da Penha</option>
      <option value="data/leis/lei_de_execucao_penal.txt">Lei de Execução Penal</option>
      <option value="data/leis/lei_de_drogas.txt">Lei de Drogas</option>
      <option value="data/leis/lei_lgpd.txt">Lei LGPD</option>
      <option value="data/leis/marco_civil_da_internet.txt">Marco Civil da Internet</option>
      <option value="data/leis/crimes_hediondos.txt">Lei dos Crimes Hediondos</option>
    </optgroup>
    <optgroup label="Estatutos">
      <option value="data/estatutos/eca.txt">ECA - Estatuto da Criança e Adolescente</option>
      <option value="data/estatutos/estatuto_do_desarmamento.txt">Estatuto do Desarmamento</option>
      <option value="data/estatutos/estatuto_do_idoso.txt">Estatuto do Idoso</option>
      <option value="data/estatutos/estatuto_da_juventude.txt">Estatuto da Juventude</option>
      <option value="data/estatutos/estatuto_da_pessoa_com_deficiencia.txt">Estatuto da Pessoa com Deficiência</option>
    </optgroup>
    <optgroup label="Súmulas">
      <option value="data/sumulas/sumulas_stj.txt">Súmulas do STJ</option>
      <option value="data/sumulas/sumulas_stf.txt">Súmulas do STF</option>
    </optgroup>
    <optgroup label="Princípios">
      <option value="data/principios/principios_do_direito.txt">Princípios (Rol Exemplificativo)</option>
    </optgroup>
  </select>

  <!-- TOAST -->
  <div class="toast" id="toast">Ok!</div>

  <!-- MODAL: ESTUDAR COM I.A. -->
  <div class="modal-backdrop" id="studyModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <div class="study-head">
        <h3 id="modalTitle" class="study-title">Estude com I.A.</h3>
        <button class="study-close btn" id="closeStudy" aria-label="Fechar">✕</button>
      </div>
      <p class="study-sub" id="studySub">Prompt gerado automaticamente. Você pode copiar e colar na IA preferida.</p>
      <pre class="prompt-box" id="promptPreview"></pre>
      <div class="ia-grid">
        <button class="ia-btn btn" data-url="https://chat.openai.com/">ChatGPT</button>
        <button class="ia-btn btn" data-url="https://gemini.google.com/">Gemini</button>
        <button class="ia-btn btn" data-url="https://copilot.microsoft.com/">Copilot</button>
        <button class="ia-btn btn" data-url="https://www.perplexity.ai/">Perplexity</button>
      </div>
      <div class="copy-prompt">
        <button class="btn" id="copyPromptBtn">Copiar prompt</button>
      </div>
    </div>
  </div>

  <!-- MODAL: PICKER (SELETOR DE ARQUIVOS) -->
  <div class="modal-backdrop" id="pickerModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <div class="picker-head">
        <div class="picker-actions">
          <div class="emoji-menu">
            <button class="emoji-btn btn" id="emojiFav" title="Favoritos">⭐</button>
            <button class="emoji-btn btn" id="emojiStudied" title="Últimos estudados">📘</button>
            <button class="emoji-btn btn" id="emojiNotes" title="Notas rápidas">📝</button>
          </div>
        </div>
        <button class="study-close btn" id="closePicker" aria-label="Fechar">✕</button>
      </div>
      <div class="picker-body">
        <div class="picker-spacer"></div>
        <div class="picker-search">
          <input id="pickerSearch" type="search" placeholder="Buscar…" autocomplete="off" />
        </div>
        <div class="sheet-body" id="pickerList" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <script>
    /* =================== Service Worker (PWA) =================== */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log("✅ Service Worker registrado", reg.scope))
          .catch(err => console.error("❌ SW falhou", err));
      });
    }
    window.addEventListener("beforeinstallprompt", (e) => { e.preventDefault(); }); // sem botão visível

    /* =================== Refs =================== */
    const els = {
      // topo e busca
      topbar: document.querySelector('.topbar'),
      topSearch: document.getElementById('topSearch'),
      breadcrumb: document.getElementById('breadcrumb'),
      breadcrumbInner: document.getElementById('breadcrumbInner'),

      searchInput: document.getElementById('searchInput'),
      prevBtn: document.getElementById('prevBtn'),
      nextBtn: document.getElementById('nextBtn'),
      spinner: document.getElementById('spinner'),
      count: document.getElementById('count'),

      // layout central
      articles: document.getElementById('articles'),
      hero: document.getElementById('hero'),
      heroLogo: document.getElementById('heroLogo'),

      // picker (top/home)
      brandBtn: document.getElementById('brandBtn'),
      openPickerTop: document.getElementById('openPickerTop'),
      openPickerHero: document.getElementById('openPickerHero'),
      pickerModal: document.getElementById('pickerModal'),
      pickerSearch: document.getElementById('pickerSearch'),
      pickerList: document.getElementById('pickerList'),
      closePicker: document.getElementById('closePicker'),
      emojiFav: document.getElementById('emojiFav'),
      emojiStudied: document.getElementById('emojiStudied'),
      emojiNotes: document.getElementById('emojiNotes'),
      codeSelect: document.getElementById('codeSelect'),

      // modal IA
      studyModal: document.getElementById('studyModal'),
      closeStudy: document.getElementById('closeStudy'),
      modalTitle: document.getElementById('modalTitle'),
      studySub: document.getElementById('studySub'),
      promptPreview: document.getElementById('promptPreview'),
      copyPromptBtn: document.getElementById('copyPromptBtn'),

      toast: document.getElementById('toast'),
    };

    /* =================== Estado + Storage =================== */
    const state = {
      mode: 'home', // home | file | favorites | notes | studied
      currentFileUrl: null,
      currentFileLabel: '',
      rawText: '',
      articles: [],
      currentArticleIdx: -1,

      currentList: [],   // lista atualmente renderizada (para re-render)
      currentTokens: [],
      matchArticles: [],
      matchIdx: -1,

      cache: new Map(),
      urlToLabel: new Map(),
    };

    const store = {
      get(k, def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def; }catch{ return def; } },
      set(k, v){ localStorage.setItem(k, JSON.stringify(v)); },
      // chaves
      keyFav: 'dl_favorites',
      keyNotes: 'dl_notes',
      keyStud: 'dl_studied',
      makeId: (fileUrl, htmlId)=> `${fileUrl}::${htmlId}`,

      // FAVORITOS
      listFavorites(){
        return store.get(store.keyFav, []);
      },
      isFavorite(id){
        return store.listFavorites().some(e => e.id === id);
      },
      addFavorite(entry){
        const list = store.listFavorites().filter(e => e.id !== entry.id);
        list.unshift(entry);
        store.set(store.keyFav, list);
      },
      removeFavorite(id){
        const list = store.listFavorites().filter(e => e.id !== id);
        store.set(store.keyFav, list);
      },

      // NOTAS (map por id)
      getNotesMap(){ return store.get(store.keyNotes, {}); },
      getNote(id){
        const map = store.getNotesMap();
        return map[id]?.note || '';
      },
      setNote(entry, noteText){
        const map = store.getNotesMap();
        if (noteText && noteText.trim()){
          map[entry.id] = { ...entry, note: noteText.trim() };
        } else {
          delete map[entry.id];
        }
        store.set(store.keyNotes, map);
      },
      listNotes(){
        const map = store.getNotesMap();
        return Object.values(map);
      },
      hasNote(id){ return !!store.getNotesMap()[id]; },

      // ESTUDADOS (últimos 50, sem duplicar)
      listStudied(){
        return store.get(store.keyStud, []);
      },
      markStudied(entry){
        let list = store.listStudied().filter(e => e.id !== entry.id);
        list.unshift(entry);
        if (list.length > 50) list = list.slice(0,50);
        store.set(store.keyStud, list);
      },
      isStudied(id){
        return store.listStudied().some(e => e.id === id);
      }
    };

    /* =================== Toast + Busy =================== */
    function notify(msg='Ok!'){
      els.toast.textContent = msg;
      els.toast.classList.add('show');
      setTimeout(()=> els.toast.classList.remove('show'), 1200);
    }
    async function withBusy(btn, fn){
      if (btn) btn.classList.add('busy');
      try{
        const min = 280;
        const t0 = performance.now();
        const res = await fn();
        const dt = performance.now() - t0;
        if (dt < min) await new Promise(r=>setTimeout(r, min - dt));
        return res;
      } finally {
        if (btn) btn.classList.remove('busy');
      }
    }

    /* =================== Helpers UI =================== */
    function setHome(on){
      document.body.classList.toggle('home', !!on);
      els.topSearch.hidden = on;
      els.breadcrumb.hidden = on;
      if (on){
        // botão topo volta para "Escolher código"
        els.openPickerTop.textContent = 'Escolher código';
      }
    }

    function updateBreadcrumb(){
      let path = 'Início';
      if (state.mode === 'file' && state.currentFileLabel){
        path += ' › ' + state.currentFileLabel;
      } else if (state.mode === 'favorites'){
        path += ' › Favoritos';
      } else if (state.mode === 'notes'){
        path += ' › Notas rápidas';
      } else if (state.mode === 'studied'){
        path += ' › Últimos estudados';
      }
      els.breadcrumbInner.textContent = path;
    }

    function setBusy(isBusy){
      els.topSearch.setAttribute('aria-busy', String(isBusy));
      els.prevBtn.disabled = isBusy;
      els.nextBtn.disabled = isBusy;
      els.spinner.hidden = !isBusy; // bolinha na barra de busca
    }

    function updateCount(){
      if (!state.matchArticles || state.matchArticles.length === 0){
        els.count.textContent = '0/0';
        return;
      }
      els.count.textContent = `${state.matchIdx+1}/${state.matchArticles.length}`;
    }

    function norm(s){
      return (s||'')
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g,'')
        .replace(/ç/g,'c')
        .toLowerCase();
    }
    const sanitizeForLayout = (s)=> s
      .replace(/\u00A0/g, ' ')
      .replace(/\t/g, ' ')
      .replace(/\s+\n/g, '\n');

    function buildCatalogMaps(){
      const sel = els.codeSelect;
      state.urlToLabel.clear();
      sel.querySelectorAll('option').forEach(opt=>{
        const url = opt.value?.trim();
        const label = opt.textContent?.trim();
        if (url) state.urlToLabel.set(url, label);
      });
    }
    function getGroupsFromSelect(){
      const sel = els.codeSelect;
      const groups = [];
      let current = null;
      sel.querySelectorAll('optgroup, option').forEach(node=>{
        if (node.tagName.toLowerCase()==='optgroup'){
          current = { label: node.label || '', items: [] };
          groups.push(current);
        } else if (node.tagName.toLowerCase()==='option'){
          const label = node.textContent.trim();
          const value = node.value;
          if (!label || !current) return;
          current.items.push({ label, value });
        }
      });
      return groups;
    }

    /* =================== Parser (corrigido) =================== */
    function splitBlockSupraTitleBody(raw){
      const lines = raw.replace(/^\s+|\s+$/g,'').split(/\r?\n/);
      const artIdx = lines.findIndex(line =>
        /^\s*(?:Art|ART)\.?\s*\d{1,4}(?:-?[A-Z])?(?:º|o)?\.?/.test(line)
      );

      if (artIdx >= 0){
        const supra = lines.slice(0, artIdx).map(s=>s.trim()).filter(Boolean);
        const titleLine = lines[artIdx];

        const mt = titleLine.match(/^\s*((?:Art|ART)\.?\s*\d{1,4}(?:-?[A-Z])?(?:º|o)?\.?)/);
        let titleText = mt ? mt[1].trim() : titleLine.trim();
        titleText = titleText.replace(/(\d+)-?([A-Z])/, "$1$2");

        const afterTitle = titleLine.slice(mt ? mt[1].length : 0).trimStart();
        const rest = lines.slice(artIdx+1).join('\n').trimStart();
        const body = afterTitle ? (rest ? afterTitle + '\n' + rest : afterTitle) : rest;

        return { supra, titleText, body };
      } else {
        const titleText = (lines[0]||'').trim();
        const body = lines.slice(1).join('\n').trimStart();
        return { supra:[], titleText, body };
      }
    }

    function parseByDelimiters(txt){
      const sepRe = /(^|\n)[^\S\r\n]*-{5,}[^\S\r\n]*(?=\n|$)/g;
      const seps = [];
      let m;
      while ((m = sepRe.exec(txt)) !== null) {
        const idx = m.index + (m[0].startsWith('\n') ? 1 : 0);
        seps.push(idx);
      }
      if (seps.length < 2) return [];
      const arts = [];
      for (let i = 0; i + 1 < seps.length; i += 1) {
        const startLineEnd = txt.indexOf('\n', seps[i]);
        const from = (startLineEnd === -1) ? txt.length : startLineEnd + 1;
        const to = seps[i + 1];
        if (from >= to) continue;
        const raw = txt.slice(from, to).trim();
        if (!raw) continue;
        const split = splitBlockSupraTitleBody(raw);
        const title = split.titleText || `Bloco ${arts.length + 1}`;
        arts.push({ title, text: raw, htmlId: `art-${arts.length}`, _split: split });
      }
      return arts;
    }

    function parseByArt(txt){
      const re = /(^|\n)\s*((?:Art|ART)\.?\s*\d{1,4}(?:-?[A-Z])?(?:º|o)?\.?)/g;
      const starts = [];
      let m;
      while ((m = re.exec(txt)) !== null) {
        const idxArt = re.lastIndex - m[2].length;
        starts.push(idxArt);
      }
      if (!starts.length) return [{
        title:'Texto',
        text: txt.trim(),
        htmlId:'art-0',
        _split: splitBlockSupraTitleBody(txt.trim())
      }];

      const arts = [];
      for (let i = 0; i < starts.length; i++) {
        const from = starts[i];
        const to   = (i + 1 < starts.length) ? starts[i + 1] : txt.length;
        let chunk = txt.slice(from, to).trimEnd();

        const endDot = chunk.lastIndexOf('.');
        const endPar = chunk.lastIndexOf(')');
        const end    = Math.max(endDot, endPar);
        if (end !== -1) chunk = chunk.slice(0, end + 1).trimEnd();

        const split = splitBlockSupraTitleBody(chunk);
        const title = split.titleText || chunk.split('\n')[0].slice(0,40);
        arts.push({ title, text: chunk, htmlId: `art-${i}`, _split: split });
      }
      return arts;
    }

    function parseSumulas(txt){
      const cleaned = sanitizeForLayout(txt.replace(/^\uFEFF/, '').replace(/\r\n/g, '\n'));
      const parts = cleaned.split(/^\s*-{5,}\s*$/m).map(s => s.trim()).filter(Boolean);
      const out = [];
      parts.forEach((block, i)=>{
        const lines = block.split('\n').map(l=>l.trim());
        const header = (lines.shift() || 'Súmula').trim();
        const body = lines.join('\n').trim();
        out.push({
          title: header,
          text: header + (body ? '\n' + body : ''),
          htmlId: `sumula-${i}`,
          _split: { supra: [], titleText: header, body }
        });
      });
      return out;
    }
    function parsePrincipios(txt){
      const cleaned = sanitizeForLayout(txt.replace(/^\uFEFF/, '').replace(/\r\n/g, '\n'));
      const parts = cleaned.split(/\s*-{5,}\s*$/m).map(s => s.trim()).filter(Boolean);
      const out = [];
      parts.forEach((block, i)=>{
        const lines = block.split('\n').map(l=>l.trim());
        let header = (lines.shift() || 'Princípio').trim();
        const reHeader = /^\s*Princ[ií]pio\b/i;
        if (!reHeader.test(header)){
          if (lines.length && reHeader.test(lines[0])) header = lines.shift();
          else header = 'Princípio';
        }
        const body = lines.join('\n').trim();
        out.push({
          title: header,
          text: header + (body ? '\n' + body : ''),
          htmlId: `principio-${i}`,
          _split: { supra: [], titleText: header, body }
        });
      });
      return out;
    }
    function parseByUrl(url, txt){
      const isSumulas = /(^|\/)data\/sumulas\/?/i.test(url);
      const isPrincipios = /(^|\/)data\/principios\/?/i.test(url);
      return isSumulas ? parseSumulas(txt)
           : isPrincipios ? parsePrincipios(txt)
           : (parseByDelimiters(txt).length ? parseByDelimiters(txt) : parseByArt(txt));
    }

    /* =================== Render (com 4 botões: ⭐ 📝 📘 📋) =================== */
    function renderArticles(list, {globalMode=false}={}){
      const frag = document.createDocumentFragment();
      list.forEach((a, i)=>{
        const el = document.createElement('article');
        el.dataset.idx = i;
        el.id = a.htmlId || `art-${i}`;
        el.dataset.fileUrl = a._fileUrl || state.currentFileUrl || '';
        el.dataset.fileLabel = a._fileLabel || state.currentFileLabel || '';

        const split = a._split || splitBlockSupraTitleBody(a.text);

        const supraWrap = document.createElement('div');
        supraWrap.className = 'supra';

        if (globalMode && (a._fileLabel || a._fileUrl)){
          const badge = document.createElement('div');
          badge.textContent = `[${a._fileLabel || state.urlToLabel.get(a._fileUrl)||'Arquivo'}]`;
          supraWrap.appendChild(badge);
        }
        if (split.supra && split.supra.length){
          split.supra.forEach(line=>{
            const d = document.createElement('div');
            d.textContent = line;
            supraWrap.appendChild(d);
          });
        }
        if (supraWrap.childNodes.length){ el.appendChild(supraWrap); }

        const head = document.createElement('div');
        head.className = 'art-head';

        const titleSpan = document.createElement('span');
        titleSpan.className = 'art-title';
        titleSpan.textContent = split.titleText || a.title || 'Artigo';

        const actions = document.createElement('div');
        actions.className = 'art-actions';

        // Ícones
        const starBtn = document.createElement('button');
        starBtn.className = 'act-btn btn'; starBtn.title = 'Favoritar'; starBtn.dataset.action = 'fav'; starBtn.textContent = '⭐';

        const noteBtn = document.createElement('button');
        noteBtn.className = 'act-btn btn'; noteBtn.title = 'Nota rápida'; noteBtn.dataset.action = 'note'; noteBtn.textContent = '📝';

        const studyBtn = document.createElement('button');
        studyBtn.className = 'act-btn btn'; studyBtn.title = 'Estudar com I.A.'; studyBtn.dataset.action = 'study'; studyBtn.textContent = '📘';

        const copyBtn = document.createElement('button');
        copyBtn.className = 'act-btn btn'; copyBtn.title = 'Copiar artigo'; copyBtn.dataset.action = 'copy'; copyBtn.textContent = '📋';

        actions.append(starBtn, noteBtn, studyBtn, copyBtn);

        head.append(titleSpan, actions);
        el.appendChild(head);

        const content = document.createElement('div');
        content.className = 'art-body';

        let body = split.body || '';
        body = body
          .replace(/(^|\n)(\s*(?:§|Parágrafo único))/g, "\n\n$2")
          .replace(/(^|\n)(\s*[IVXLCDM]+ ?-)/g, "\n\n$2")
          .replace(/(^|\n)(\s*[a-z]\))/g, "\n\n$2");

        content.innerHTML = body
          .replace(/(^|\n)(\s*(?:§|Parágrafo único))/g, '<br><b>$2</b>')
          .replace(/(^|\n)(\s*[IVXLCDM]+ ?-)/g, '<br><b>$2</b>')
          .replace(/(^|\n)(\s*[a-z]\))/g, '<br><b>$2</b>')
          .replace(/\n\n/g, '<br>')
          .replace(/\n/g, '<br>');

        el.appendChild(content);

        // Área de notas (oculta por padrão)
        const notePad = document.createElement('div');
        notePad.className = 'note-pad';
        notePad.innerHTML = `
          <textarea placeholder="Sua nota rápida aqui… (vazio para remover)"></textarea>
          <div class="note-actions">
            <button class="btn note-close">Fechar</button>
          </div>`;
        el.appendChild(notePad);

        // Ativar estados (⭐/📝/📘)
        const id = store.makeId(el.dataset.fileUrl, el.id);
        if (store.isFavorite(id)) starBtn.classList.add('active');
        if (store.hasNote(id)) noteBtn.classList.add('active');
        if (store.isStudied(id)) studyBtn.classList.add('active');

        frag.appendChild(el);
      });

      els.articles.innerHTML = '';
      if (list.length){ els.articles.appendChild(frag); }
      else { els.articles.innerHTML = '<div style="padding:24px; color:#6c7282; text-align:center;">🤔 Nenhum resultado com todos os termos.</div>'; }

      state.currentList = list;
      updateCurrentOutline();

      state.matchArticles = [];
      state.matchIdx = -1;
      updateCount();
    }

    function clearMarksAndRerender(){
      renderArticles(state.currentList || [], { globalMode: state.mode !== 'file' });
    }

    /* =================== Destaque busca (inalterado) =================== */
    function highlightTokens(art, tokens){
      const parts = ['.art-title', '.art-body', '.supra > div'];
      parts.forEach(sel=>{
        art.querySelectorAll(sel).forEach(el=>{
          const raw = el.textContent;
          el.innerHTML = raw.replace(/([\p{L}\p{N}]+)/gu, m=>{
            return tokens.some(t => norm(m).includes(t))
              ? `<mark>${m}</mark>`
              : m;
          });
        });
      });
    }

    /* =================== Scroll / Outline =================== */
    function getArticleInView(){
      const nodes = document.querySelectorAll('article[data-idx]');
      const cy = window.innerHeight / 2;
      let hitIdx = -1;
      for (const el of nodes){
        const r = el.getBoundingClientRect();
        if (r.top <= cy && r.bottom >= cy){ hitIdx = Number(el.dataset.idx); break; }
      }
      if (hitIdx === -1 && nodes.length){
        for (const el of nodes){
          const r = el.getBoundingClientRect();
          if (r.bottom > 0 && r.top < window.innerHeight){ hitIdx = Number(el.dataset.idx); break; }
        }
      }
      return hitIdx;
    }
    function updateCurrentOutline(){
      const idx = getArticleInView();
      if (idx === state.currentArticleIdx) return;
      state.currentArticleIdx = idx;
      document.querySelectorAll('article.current-outline').forEach(n=>n.classList.remove('current-outline'));
      if (idx >= 0){
        document.querySelector(`article[data-idx="${idx}"]`)?.classList.add('current-outline');
      }
    }
    window.addEventListener('scroll', ()=>{ if (state.currentList.length) updateCurrentOutline(); }, {passive:true});

    /* =================== Loader de arquivo =================== */
    async function fetchTextCached(url){
      if (state.cache.has(url)) return state.cache.get(url);
      const res = await fetch(url, {cache: 'force-cache'});
      if (!res.ok) throw new Error(`HTTP ${res.status} — ${res.statusText}`);
      const txt = sanitizeForLayout(await res.text());
      state.cache.set(url, txt);
      return txt;
    }
    async function loadFile(url){
      if (!url) return;
      setBusy(true);
      try{
        const txt = await fetchTextCached(url);
        state.rawText = txt;
        const list = parseByUrl(url, txt);
        state.currentFileUrl = url;
        state.currentFileLabel = state.urlToLabel.get(url) || 'Documento';
        state.articles = list;
        state.mode = 'file';

        // UI modo arquivo
        setHome(false);
        els.topSearch.hidden = false;
        els.breadcrumb.hidden = false;

        // nome do botão topo vira o arquivo atual
        els.openPickerTop.textContent = state.currentFileLabel;

        renderArticles(list, {globalMode:false});
        updateBreadcrumb();
        window.scrollTo({top:0,behavior:'instant'});
        notify(`Carregado: ${state.currentFileLabel}`);
      }catch(err){
        console.error(err);
        els.articles.innerHTML = `<div style="padding:24px; color:#a33; border:1px dashed #e7bcbc; border-radius:12px">Falha ao carregar:<br><code>${(err && err.message) || 'Erro desconhecido'}</code></div>`;
        notify('Erro ao carregar arquivo');
      }
      setBusy(false);
    }

    /* =================== Busca Local (lógica preservada) =================== */
    async function runLocalSearch(){
      const q = els.searchInput.value.trim();
      if (!q) { clearMarksAndRerender(); return; }

      const tokens = q.split(/\s+/).filter(Boolean).map(norm);
      state.currentTokens = tokens;

      setBusy(true);

      renderArticles(state.articles, { globalMode: false });

      state.matchArticles = [];
      const articles = document.querySelectorAll('article');

      for (const art of articles){
        const fullText = [
          art.querySelector('.art-title')?.textContent || '',
          art.querySelector('.art-body')?.textContent || '',
          ...[...art.querySelectorAll('.supra > div')].map(el => el.textContent || '')
        ].join(' ');
        const textNorm = norm(fullText);

        if (tokens.every(t => textNorm.includes(t))){
          state.matchArticles.push(art);
          highlightTokens(art, tokens);
        }
      }

      if (state.matchArticles.length){
        state.matchIdx = 0;
        state.matchArticles[0].scrollIntoView({behavior:'smooth', block:'center'});
      } else {
        state.matchIdx = -1;
      }

      updateCount();
      setBusy(false);
    }

    /* =================== Picker (modal central) =================== */
    function escRe(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    function renderPicker(filter=''){
      const groups = getGroupsFromSelect();
      const f = norm(filter);
      els.pickerList.innerHTML = '';
      let total = 0;

      groups.forEach(g=>{
        const items = g.items.filter(it => !f || norm(it.label).includes(f));
        if (!items.length) return;

        const sec = document.createElement('div'); sec.className = 'list-section';
        const h = document.createElement('h4'); h.textContent = g.label; sec.appendChild(h);

        items.forEach(it=>{
          const btn = document.createElement('button');
          btn.type = 'button'; btn.className = 'item btn';

          let labelHTML = it.label;
          if (f){
            const label = it.label; const normLabel = norm(label);
            const idx = normLabel.indexOf(f);
            if (idx >= 0){
              const a = label.slice(0, idx);
              const b = label.slice(idx, idx + filter.length);
              const c = label.slice(idx + filter.length);
              labelHTML = `${a}<span class="highlight">${b}</span>${c}`;
            }
          }

          btn.innerHTML = `<b>${labelHTML}</b>`;
          btn.addEventListener('click', async (e)=>{
            await withBusy(e.currentTarget, async ()=>{
              await loadFile(it.value);
              closePicker();
            });
          });
          sec.appendChild(btn);
          total++;
        });

        els.pickerList.appendChild(sec);
      });

      if (!total){
        els.pickerList.innerHTML = '<div style="padding:12px; color:#6c7282">Nada encontrado.</div>';
      }
    }
    function openPicker(){
      els.pickerModal.style.display = 'flex';
      els.pickerModal.setAttribute('aria-hidden', 'false');
      els.pickerSearch.value = '';
      // destacar emojis com base em quantidades
      const hasFav = store.listFavorites().length > 0;
      const hasStud = store.listStudied().length > 0;
      const hasNotes = store.listNotes().length > 0;
      els.emojiFav.classList.toggle('active', hasFav);
      els.emojiStudied.classList.toggle('active', hasStud);
      els.emojiNotes.classList.toggle('active', hasNotes);
      renderPicker('');
    }
    function closePicker(){
      els.pickerModal.style.display = 'none';
      els.pickerModal.setAttribute('aria-hidden', 'true');
    }

    // Emoji-menu: abrir visões na PÁGINA (não no modal)
    els.emojiFav.addEventListener('click', async (e)=>{
      await withBusy(e.currentTarget, async ()=>{
        closePicker(); showFavorites();
      });
    });
    els.emojiStudied.addEventListener('click', async (e)=>{
      await withBusy(e.currentTarget, async ()=>{
        closePicker(); showStudied();
      });
    });
    els.emojiNotes.addEventListener('click', async (e)=>{
      await withBusy(e.currentTarget, async ()=>{
        closePicker(); showNotes();
      });
    });

    /* =================== Visões especiais =================== */
    function makeArticleFromEntry(entry){
      return {
        title: splitBlockSupraTitleBody(entry.text).titleText || 'Artigo',
        text: entry.text,
        htmlId: entry.htmlId,
        _split: splitBlockSupraTitleBody(entry.text),
        _fileUrl: entry.fileUrl,
        _fileLabel: entry.fileLabel
      };
    }

    function showFavorites(){
      const favs = store.listFavorites();
      const list = favs.map(makeArticleFromEntry);
      state.mode = 'favorites';
      setHome(false);
      els.topSearch.hidden = true; // busca só no modo arquivo
      renderArticles(list, {globalMode:true});
      updateBreadcrumb();
      window.scrollTo({top:0,behavior:'instant'});
      notify('Favoritos');
      // botão topo volta para "Escolher código"
      els.openPickerTop.textContent = 'Escolher código';
    }

    function showNotes(){
      const notes = store.listNotes();
      const list = notes.map(makeArticleFromEntry);
      state.mode = 'notes';
      setHome(false);
      els.topSearch.hidden = true;
      renderArticles(list, {globalMode:true});
      updateBreadcrumb();
      window.scrollTo({top:0,behavior:'instant'});
      notify('Notas rápidas');
      els.openPickerTop.textContent = 'Escolher código';
    }

    function showStudied(){
      const studied = store.listStudied();
      const list = studied.map(makeArticleFromEntry);
      state.mode = 'studied';
      setHome(false);
      els.topSearch.hidden = true;
      renderArticles(list, {globalMode:true});
      updateBreadcrumb();
      window.scrollTo({top:0,behavior:'instant'});
      notify('Últimos estudados');
      els.openPickerTop.textContent = 'Escolher código';
    }

    /* =================== IA prompt =================== */
    function buildPrompt(a){
      const split = a._split || splitBlockSupraTitleBody(a.text);
      const supraText = split.supra && split.supra.length ? split.supra.join('\n') + '\n' : '';
      const artigo = (split.titleText ? split.titleText + ' ' : '') + (split.body || '');
      const tema = split.titleText || (a.title || 'Artigo');
      return [
        'Assuma a persona de um professor de Direito experiente convidado pelo direito.love e prepare um material de estudo. ',
        'Explique detalhadamente o artigo, súmula ou tema abaixo (incluindo caput, parágrafos, incisos e alíneas), seguindo esta estrutura: ',
        '(1) conceito detalhado; (2) checklist para provas; (3) mini exemplo prático; ',
        '(4) princípios relacionados; (5) pontos de atenção; (6) erros comuns; (7) artigos correlatos. ',
        'Responda em português claro, objetivo e didático.\n\n',
        `Tema: "${tema}"\n\n`,
        supraText + artigo,
        '\n\n💚 direito.love'
      ].join('');
    }
    function openIA(url){
      if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) location.href = url;
      else window.open(url, '_blank', 'noopener,noreferrer');
    }

    function openStudyModal(title, prompt){
      els.modalTitle.textContent = `Estude o ${title} com I.A.`;
      els.promptPreview.textContent = prompt;
      els.studyModal.style.display = 'flex';
      els.studyModal.setAttribute('aria-hidden','false');
    }
    function closeStudyModal(){
      els.studyModal.style.display = 'none';
      els.studyModal.setAttribute('aria-hidden','true');
    }

    /* =================== Eventos globais =================== */
    // Ações abrir picker (logo e botões)
    els.openPickerTop.addEventListener('click', (e)=> withBusy(e.currentTarget, async ()=> openPicker()));
    els.openPickerHero.addEventListener('click', (e)=> withBusy(e.currentTarget, async ()=> openPicker()));
    els.heroLogo.addEventListener('click', (e)=> withBusy(e.currentTarget, async ()=> openPicker()));
    els.brandBtn.addEventListener('click', (e)=> withBusy(e.currentTarget, async ()=> openPicker()));
    els.closePicker.addEventListener('click', ()=> closePicker());
    els.pickerModal.addEventListener('click', (e)=>{ if (e.target === els.pickerModal) closePicker(); });
    els.pickerSearch.addEventListener('input', e=> renderPicker(e.target.value));

    // Breadcrumb: clique em "Início"
    els.breadcrumbInner.addEventListener('click', (e)=>{
      if (e.target && e.target.nodeType === 3) return; // texto
      // Como simplificação, clique em breadcrumb volta pro início
      setHome(true);
      state.mode = 'home';
      els.articles.innerHTML = `
        <div class="hero" id="hero">
          <div class="hero-inner">
            <img src="icons/logo.png" alt="direito.love" class="hero-logo" id="heroLogo" title="Escolher código">
            <button class="hero-btn btn" id="openPickerHero" type="button" aria-haspopup="dialog" aria-controls="pickerModal" title="Escolher código">Escolher código</button>
          </div>
        </div>`;
      // reatacha eventos
      document.getElementById('openPickerHero').addEventListener('click', (ev)=> withBusy(ev.currentTarget, async ()=> openPicker()));
      document.getElementById('heroLogo').addEventListener('click', (ev)=> withBusy(ev.currentTarget, async ()=> openPicker()));
      window.scrollTo({top:0,behavior:'instant'});
      notify('Início');
    });

    // IA modal
    els.closeStudy.addEventListener('click', closeStudyModal);
    els.studyModal.addEventListener('click', (e)=>{ if (e.target === els.studyModal) closeStudyModal(); });
    document.querySelectorAll('.ia-btn').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        withBusy(e.currentTarget, async ()=>{
          const url = e.currentTarget.dataset.url;
          notify('Abrindo ' + e.currentTarget.textContent + '…');
          openIA(url);
        });
      });
    });
    els.copyPromptBtn.addEventListener('click', (e)=>{
      withBusy(e.currentTarget, async ()=>{
        try{ await navigator.clipboard.writeText(els.promptPreview.textContent||''); notify('✅ Prompt copiado!'); }
        catch{ notify('Copie manualmente.'); }
      });
    });

    // Controles busca & navegação
    els.searchInput.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){ e.preventDefault(); runLocalSearch(); }
    });
    els.nextBtn.addEventListener('click', (e)=> withBusy(e.currentTarget, async ()=>{
      if (!state.matchArticles || state.matchArticles.length === 0) return;
      state.matchIdx = (state.matchIdx + 1) % state.matchArticles.length;
      const art = state.matchArticles[state.matchIdx];
      art.scrollIntoView({behavior:'smooth', block:'center'});
      updateCount();
    }));
    els.prevBtn.addEventListener('click', (e)=> withBusy(e.currentTarget, async ()=>{
      if (!state.matchArticles || state.matchArticles.length === 0) return;
      state.matchIdx = (state.matchIdx - 1 + state.matchArticles.length) % state.matchArticles.length;
      const art = state.matchArticles[state.matchIdx];
      art.scrollIntoView({behavior:'smooth', block:'center'});
      updateCount();
    }));

    // Delegação de eventos nos cards
    els.articles.addEventListener('click', async (e)=>{
      const btn = e.target.closest('.act-btn');
      if (!btn) return;
      const artEl = e.target.closest('article');
      if (!artEl) return;

      const idx = Number(artEl?.dataset.idx);
      // Se estamos em visões especiais, idx ainda mapeia a currentList
      const a = (state.mode === 'file' ? state.articles[idx] : state.currentList[idx]);
      if (!a) return;

      const id = store.makeId(artEl.dataset.fileUrl, artEl.id);
      const entry = {
        id,
        fileUrl: artEl.dataset.fileUrl,
        fileLabel: artEl.dataset.fileLabel,
        htmlId: artEl.id,
        text: a.text
      };

      if (btn.dataset.action === 'copy'){
        await withBusy(btn, async ()=>{
          try{ await navigator.clipboard.writeText(a.text); notify('✅ Artigo copiado!'); }
          catch{ notify('Copie manualmente.'); }
        });
      }

      if (btn.dataset.action === 'study'){
        await withBusy(btn, async ()=>{
          const prompt = buildPrompt(a);
          // marcar como estudado
          store.markStudied(entry);
          btn.classList.add('active');
          notify('📘 Marcado como estudado');
          openStudyModal((a._split?.titleText) || a.title || 'Artigo', prompt);
          // realçar o card
          document.querySelectorAll('article.highlight-study').forEach(n=>n.classList.remove('highlight-study'));
          artEl.classList.add('highlight-study');
        });
      }

      if (btn.dataset.action === 'fav'){
        await withBusy(btn, async ()=>{
          if (store.isFavorite(id)){
            store.removeFavorite(id);
            btn.classList.remove('active');
            notify('⭐ Removido dos favoritos');
            // Se estiver na página de favoritos, remover o card da lista
            if (state.mode === 'favorites'){
              const list = store.listFavorites().map(makeArticleFromEntry);
              renderArticles(list, {globalMode:true});
            }
          } else {
            store.addFavorite(entry);
            btn.classList.add('active');
            notify('⭐ Adicionado aos favoritos');
          }
        });
      }

      if (btn.dataset.action === 'note'){
        await withBusy(btn, async ()=>{
          const pad = artEl.querySelector('.note-pad');
          const textarea = pad.querySelector('textarea');
          // abrir/fechar
          const visible = pad.style.display === 'block';
          pad.style.display = visible ? 'none' : 'block';
          if (!visible){
            // carregar nota, se houver
            textarea.value = store.getNote(id) || '';
            textarea.focus();
          }
          // estado ativo acompanha conteúdo
          const onInput = ()=>{
            const val = textarea.value;
            store.setNote(entry, val);
            if (val.trim()) btn.classList.add('active');
            else btn.classList.remove('active');
          };
          textarea.removeEventListener('input', textarea._onInput);
          textarea._onInput = onInput;
          textarea.addEventListener('input', onInput);

          // fechar botão
          pad.querySelector('.note-close').onclick = ()=>{ pad.style.display='none'; };
          // toast discreto
          notify(pad.style.display==='block' ? '📝 Nota aberta' : '📝 Nota fechada');
        });
      }
    });

    /* =================== Boot =================== */
    function resetHome(){
      state.mode = 'home';
      state.currentFileUrl = null;
      state.currentFileLabel = '';
      state.rawText = '';
      state.articles = [];
      state.currentArticleIdx = -1;
      state.currentList = [];
      state.currentTokens = [];
      state.matchArticles = [];
      state.matchIdx = -1;

      setHome(true);
      els.articles.innerHTML = `
        <div class="hero" id="hero">
          <div class="hero-inner">
            <img src="icons/logo.png" alt="direito.love" class="hero-logo" id="heroLogo" title="Escolher código">
            <button class="hero-btn btn" id="openPickerHero" type="button" aria-haspopup="dialog" aria-controls="pickerModal" title="Escolher código">Escolher código</button>
          </div>
        </div>`;
      document.getElementById('openPickerHero').addEventListener('click', (ev)=> withBusy(ev.currentTarget, async ()=> openPicker()));
      document.getElementById('heroLogo').addEventListener('click', (ev)=> withBusy(ev.currentTarget, async ()=> openPicker()));
      window.scrollTo({top:0,behavior:'instant'});
      updateBreadcrumb();
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      buildCatalogMaps();
      resetHome();
      // Controles extras de teclado para fechar modais
      document.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape'){
          if (els.studyModal.getAttribute('aria-hidden') === 'false') closeStudyModal();
          if (els.pickerModal.getAttribute('aria-hidden') === 'false') closePicker();
        }
      });
    });
  </script>
</body>
</html>
