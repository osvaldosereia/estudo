<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeuJus - Vídeos do Universo Jurídico</title>
    <!-- 1. Carrega o Tailwind CSS para estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Carrega a biblioteca Fuse.js para "fuzzy search" -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    
    <style>
        /* 3. Define a fonte padrão (Inter) e alguns estilos */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        html { scroll-behavior: smooth; }
        /* Fundo branco para melhor contraste */
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; }
        #listView, #detailView { display: none; }
        
        /* O JavaScript agora controla a altura e posição da timeline search */
        .sticky-search-top {
            top: 60px; /* O JS vai ajustar isso dinamicamente */
        }

        /* --- Destaque de Busca --- */
        .timeline-highlight {
            background-color: #fef08a; /* bg-yellow-200 */
            border-radius: 2px;
            padding: 0 1px;
        }
        /* Classe para destacar o card da timeline encontrado na busca */
        .timeline-search-active {
            box-shadow: 0 0 15px 5px rgba(59, 130, 246, 0.3); /* Sombra azul subtil */
            border-radius: 8px;
        }
        
        /* --- Classes "...mais" --- */
        .line-clamp-2 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
        }
        .line-clamp-none {
            -webkit-line-clamp: unset;
        }

        /* Estilo mais forte para links "...mais" */
        .more-link {
            font-weight: 500; /* font-medium */
            color: #2563eb; /* text-blue-600 */
            cursor: pointer;
        }
        .more-link:hover {
            color: #1d4ed8; /* text-blue-800 */
        }

        /* --- Barra de Categorias --- */
        .category-chips::-webkit-scrollbar {
            display: none;
        }
        .category-chips {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .category-chip {
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .category-chip.active {
            background-color: #1f2937; /* bg-gray-800 */
            color: #f9fafb; /* text-gray-50 */
        }

        /* Estilo para botões de toggle Grid/Lista */
        .view-toggle-btn.active {
            background-color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            color: #1f2937; /* text-gray-800 */
        }
        .view-toggle-btn {
             color: #6b7280; /* text-gray-500 */
        }

        /* Estilo para Sumário Clicável */
        .summary-item-link {
            cursor: pointer;
            color: #3b82f6; /* text-blue-500 */
            transition: color 0.2s;
        }
        .summary-item-link:hover {
            color: #1d4ed8; /* text-blue-700 */
            text-decoration: underline;
        }
    </style>
</head>
<body class="text-gray-900 antialiased">

    <!-- ====================================================== -->
    <!-- CABEÇALHO                                              -->
    <!-- ====================================================== -->
    <!-- CORREÇÃO: z-20 (camada de fundo) -->
    <header id="header" class="bg-gray-50 shadow-sm sticky top-0 z-20 transition-all duration-300 ease-in-out">
        <!-- Topbar Principal (Mais estreita) -->
        <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-1 flex items-center justify-between">
            <div>
                <a href="#" onclick="goHome(event)" title="Voltar ao início">
                    <h1 class="text-2xl font-bold text-blue-800">MeuJus</h1>
                </a>
            </div>
            
            <div class="flex items-center gap-x-2">
                <button id="favoritesToggleBtn" onclick="toggleFavoritesOnlyView()" class="p-2 rounded-md text-gray-600 hover:bg-gray-100 hover:text-gray-900" title="Ver Salvos">
                    <!-- Ícone de estrela (Material Design) -->
                    <svg id="favoritesToggleIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27z"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Barra de Categorias -->
        <div id="categoryContainer" class="hidden container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-2 relative">
            <!-- Seta Esquerda -->
            <button id="scrollLeftBtn" class="absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-gray-50 bg-opacity-90 rounded-full p-1 shadow hover:bg-gray-200 hidden">
                <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <!-- Chips -->
            <div id="categoryChips" class="category-chips flex items-center overflow-x-auto whitespace-nowrap space-x-2 py-1">
                <!-- Chips de Categoria serão inseridos aqui -->
            </div>
            <!-- Seta Direita -->
            <button id="scrollRightBtn" class="absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-gray-50 bg-opacity-90 rounded-full p-1 shadow hover:bg-gray-200 hidden">
                 <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>
    </header>

    <!-- Container Principal (Layout full-width) -->
    <main id="mainContent" class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6 transition-all duration-300 ease-in-out">

        <!-- ====================================================== -->
        <!-- TELA 1: LISTA DE VÍDEOS                                -->
        <!-- ====================================================== -->
        <div id="listView">
            <!-- Campo de busca com Autocomplete -->
            <div class="mb-6 max-w-lg mx-auto relative">
                <input type="text" id="searchInput" class="block w-full rounded-full border border-gray-200 shadow-md focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3.5 px-6 bg-gray-100 focus:bg-white" placeholder="Buscar..." autocomplete="off">
                
                <!-- Caixa de Sugestões (Autocomplete) -->
                <!-- CORREÇÃO: z-40 (acima do header e da busca da timeline) -->
                <div id="suggestionsBox" class="absolute top-full mt-2 w-full bg-white border border-gray-200 rounded-lg shadow-lg overflow-hidden z-40 hidden">
                    <!-- Sugestões Populares pelo JS -->
                </div>
            </div>
            
            <!-- Toggle de Visualização (Lista/Grid) -->
            <div class="flex justify-end items-center mb-4 pr-2">
                <div class="flex items-center gap-1 p-1 bg-gray-100 rounded-lg">
                    <button id="viewToggleGrid" onclick="toggleViewMode('grid')" class="p-1.5 rounded-md" title="Visão em Grade">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H4a1 1 0 01-1-1V3zm10 0a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1V3zM3 13a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H4a1 1 0 01-1-1v-4zm10 0a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" clip-rule="evenodd"></path></svg>
                    </button>
                    <button id="viewToggleList" onclick="toggleViewMode('list')" class="p-1.5 rounded-md" title="Visão em Lista">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            </div>
            
            <!-- Grid de vídeos (As classes de layout são controladas pelo JS) -->
            <div id="videoListContainer" class="">
                <p id="loadingIndicator" class="text-center text-gray-500 col-span-full">Carregando vídeos...</p>
            </div>
            <div id="noResults" class="hidden text-center text-gray-500 text-xl mt-12 col-span-full">
                <p>Nenhum vídeo encontrado para os filtros selecionados.</p>
            </div>
        </div>

        <!-- ====================================================== -->
        <!-- TELA 2: DETALHE DO VÍDEO                               -->
        <!-- ====================================================== -->
        <div id="detailView">
            
            <!-- Layout sem cards de fundo -->
            <div class="lg:grid lg:grid-cols-3 lg:gap-8">
                <!-- Coluna Esquerda (Player, Info, Relatório) -->
                <div class="lg:col-span-2 space-y-4">
                    
                    <!-- Player -->
                    <div id="videoPlayerContainer" class="aspect-video w-full mb-4 bg-black rounded-lg overflow-hidden">
                        <!-- Iframe do player será injetado aqui -->
                    </div>
                    
                    <!-- Informações (sem card) -->
                    <div id="videoInfo" class="pb-4 border-b border-gray-200">
                        <!-- Fonte menor e mais discreta -->
                        <h2 id="videoTitle" class="text-lg sm:text-xl font-medium text-gray-800 mb-3"></h2>
                        
                        <div class="mb-3">
                            <!-- NOVO: "Canal" substituído por "Palestrantes" -->
                            <span class="font-semibold text-sm text-gray-600">Palestrantes:</span>
                            <span id="videoSpeakersDesktop" class="hidden sm:inline text-sm text-gray-600"></span>
                            <div id="videoSpeakersMobileWrapper" class="sm:hidden text-sm text-gray-600 cursor-pointer" onclick="toggleSpeakers()">
                                <ul id="videoSpeakersMobile" class="list-disc list-inside line-clamp-3">
                                    <!-- JS vai preencher -->
                                </ul>
                                <span id="speakersMore" class="font-semibold text-gray-600 hover:text-gray-900 hidden">...mais</span>
                            </div>
                        </div>

                        <div class="flex flex-col sm:flex-row sm:items-center sm:gap-x-4 gap-y-1 text-sm text-gray-600 sm:mt-2">
                            <p class="flex items-center gap-1.5">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                <span id="videoDate"></span>
                            </p>
                            <p class="flex items-center gap-1.5">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                <span id="videoDuration"></span>
                            </p>
                        </div>
                        
                        <!-- Container de botões com 3 botões -->
                        <div class="flex items-center gap-x-2 sm:gap-x-4 mt-4">
                            <button id="nativeShareBtn" onclick="nativeShare()" class="flex items-center gap-2 px-3 py-2 rounded-full text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200" title="Compartilhar">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M15.172 7.172a.75.75 0 011.06 0l3 3a.75.75 0 010 1.06l-3 3a.75.75 0 11-1.06-1.06L16.94 11.5H10.75a.75.75 0 010-1.5h6.19l-1.818-1.818a.75.75 0 010-1.06z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M3 4.75A2.75 2.75 0 015.75 2h5.5a.75.75 0 010 1.5h-5.5A1.25 1.25 0 004.5 4.75v10.5A1.25 1.25 0 005.75 16.5h5.5a.75.75 0 010 1.5h-5.5A2.75 2.75 0 013 15.25V4.75z" clip-rule="evenodd" /></svg>
                                <!-- Texto oculto no mobile -->
                                <span class="hidden sm:inline">Compartilhar</span>
                            </button>
                            <button id="favoriteBtn" onclick="toggleFavorite()" class="flex items-center gap-2 px-3 py-2 rounded-full text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200" title="Salvar">
                                <!-- Ícone de estrela (Material Design) -->
                                <svg id="favoriteIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27z"></path>
                                </svg>
                                <!-- Texto oculto no mobile -->
                                <span id="favoriteText" class="hidden sm:inline">Salvar</span>
                            </button>
                            <!-- Botão Google I.A. -->
                            <a id="googleAIBtn" href="#" target="_blank" class="flex items-center gap-2 px-3 py-2 rounded-full text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200" title="Analisar com I.A.">
                                <!-- Ícone substituído -->
                                <img src="https://placehold.co/20x20/000000/FFFFFF/png?text=AI" alt="Google I.A." class="w-5 h-5">
                                <span>Google I.A.</span>
                            </a>
                        </div>
                    </div>
                    
                    <!-- SUMÁRIO CLICÁVEL -->
                    <div id="videoSummaryContainer" class="mt-4">
                         <h3 class="text-xl font-semibold text-gray-800 mb-2">Sumário da Sessão</h3>
                         <div id="summaryWrapper" class="text-sm text-gray-700 leading-relaxed">
                             <div id="videoSummary">
                                 <!-- Conteúdo do sumário (Placeholder) -->
                                 <p>Carregando sumário...</p>
                             </div>
                         </div>
                    </div>

                    <!-- BUSCA DO PAINEL -->
                    <!-- CORREÇÃO: z-30 (acima do header) -->
                    <div id="timelineSearchContainer" class="sticky sticky-search-top z-30 bg-gray-50 py-3 border-b border-t border-gray-200 shadow-md mt-6">
                        <div class="flex gap-2">
                            <input type="search" id="timelineSearchInput" 
                                   class="flex-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" 
                                   placeholder="Encontre no painel...">
                            <div id="timelineSearchResults" class="hidden items-center gap-1 text-sm">
                                <span id="timelineSearchCount" class="text-gray-600 font-medium whitespace-nowrap">(0)</span>
                                <button id="timelineSearchPrev" class="p-2 rounded-md bg-gray-100 hover:bg-gray-200" title="Anterior">
                                    <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                                </button>
                                <button id="timelineSearchNext" class="p-2 rounded-md bg-gray-100 hover:bg-gray-200" title="Próximo">
                                    <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Painel da Sessão (Legal Analytics) -->
                    <div id="reportContainer" class="mt-4 space-y-4">
                        <!-- Placeholder do Painel -->
                        <p id="reportLoading" class="text-gray-500">Carregando painel da sessão...</p>
                        <!-- Fichas de Temas/Timeline serão inseridas aqui -->
                    </div>
                </div>
                
                <!-- Coluna Direita (Vídeos Recomendados) -->
                <div class="lg:col-span-1 space-y-4 mt-6 lg:mt-0">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Vídeos Recomendados</h3>
                    <div id="recommendedVideosContainer" class="space-y-4">
                        <!-- Vídeos recomendados serão inseridos aqui -->
                    </div>
                </div>
            </div>
        </div>
    </main>
    

    <!-- ====================================================== -->
    <!-- SCRIPT PRINCIPAL (ATUALIZADO PARA O NOVO JSON)         -->
    <!-- ====================================================== -->

    <script>
        
        let database = []; // Guarda o ÍNDICE DE BUSCA (LEVE)
        let fuse = null; // Guarda a instância do Fuse.js
        
        let allCategories = new Set();
        let activeCategory = null;
        let currentViewMode = 'grid'; // 'grid' ou 'list'

        // Referências aos Elementos (mantidas)
        const mainContent = document.getElementById('mainContent');
        const header = document.getElementById('header'); 
        const listView = document.getElementById('listView');
        const detailView = document.getElementById('detailView');
        const searchInput = document.getElementById('searchInput');
        const suggestionsBox = document.getElementById('suggestionsBox'); 
        const videoListContainer = document.getElementById('videoListContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const noResults = document.getElementById('noResults');
        const videoPlayerContainer = document.getElementById('videoPlayerContainer');
        const videoTitle = document.getElementById('videoTitle');
        const videoSpeakersDesktop = document.getElementById('videoSpeakersDesktop');
        const videoSpeakersMobile = document.getElementById('videoSpeakersMobile');
        const speakersMore = document.getElementById('speakersMore');
        const videoDate = document.getElementById('videoDate');
        const videoDuration = document.getElementById('videoDuration');
        const videoSummary = document.getElementById('videoSummary');
        const reportContainer = document.getElementById('reportContainer'); 
        const reportLoading = document.getElementById('reportLoading'); 
        const recommendedVideosContainer = document.getElementById('recommendedVideosContainer');
        
        // --- BUSCA DA TIMELINE (PAINEL) ---
        const timelineSearchContainer = document.getElementById('timelineSearchContainer');
        const timelineSearchInput = document.getElementById('timelineSearchInput');
        const timelineSearchResults = document.getElementById('timelineSearchResults');
        const timelineSearchCount = document.getElementById('timelineSearchCount');
        const timelineSearchPrev = document.getElementById('timelineSearchPrev');
        const timelineSearchNext = document.getElementById('timelineSearchNext');
        let timelineMatches = []; 
        let timelineMatchIndex = -1; 
        // --- FIM BUSCA DA TIMELINE ---

        // Referências das Categorias
        const categoryContainer = document.getElementById('categoryContainer');
        const categoryChips = document.getElementById('categoryChips');
        const scrollLeftBtn = document.getElementById('scrollLeftBtn');
        const scrollRightBtn = document.getElementById('scrollRightBtn');
        
        let currentPlayer = null;

        let favorites = new Set(JSON.parse(localStorage.getItem('meujus_saved') || '[]'));
        let favoritesOnly = false; 
        let currentVideoForShare = null; 
        let currentFullSummaryText = ''; // Para o link da I.A.

        let headerHeight = 60; // Valor padrão

        // Funções Auxiliares
        function timeToSeconds(timeStr) {
            if (!timeStr) return 0;
            const parts = timeStr.split(':').map(Number);
            let seconds = 0;
            if (parts.length === 3) {
                seconds = parts[0] * 3600 + parts[1] * 60 + parts[2];
            } else if (parts.length === 2) {
                seconds = parts[0] * 60 + parts[1];
            }
            return seconds;
        }
        
        // NOVO: Função para formatar a data de AAAA-MM-DD para DD/MM/AAAA
        function formatDate(dateStr) {
            if (!dateStr || dateStr.length !== 10) return dateStr;
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}/${year}`;
        }

        // formatDescription (Legal Analytics)
        function formatDescription(text) {
            if (!text) return '';
            const textString = String(text);
            return textString
                .replace(/</g, '&lt;').replace(/>/g, '&gt;') 
                .replace(/\*(.*?)\*/g, '<span class="font-semibold text-gray-800">$1</span>');
        }

        // NOVO: Serializa a timeline para o prompt da I.A.
        // Usaremos as chaves "tema" e "explicacao" do novo JSON de timeline
        function serializeTimelineForAI(timeline) {
            if (!timeline || timeline.length === 0) return 'Timeline não disponível.';
            let text = "Estrutura do Vídeo (Timeline):\n";
            
            text += timeline.map(item => {
                // Remove quebras de linha e asteriscos para limpar o prompt
                const explicacaoLimpa = (item.explicacao || 'N/A').replace(/[\r\n\*]/g, '').trim(); 
                return `  - [${item.time}] ${item.tema}: ${explicacaoLimpa}`;
            }).join('\n');
            
            return text; 
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        function normalizeText(text) {
            if (typeof text !== 'string') return '';
            return text
                .toLowerCase()
                .normalize('NFD') 
                .replace(/[\u0300-\u036f]/g, '') 
                .replace(/ç/g, 'c'); 
        }
        
        function highlightText(text, searchTerms) { // searchTerms SÃO normalizados
            if (!text || !searchTerms || searchTerms.length === 0) {
                return text;
            }
            
            let highlightedText = text;
            
            searchTerms.forEach(term => {
                if (term.length === 0) return; 
                
                const isNumeric = !isNaN(term);
                let termRegex;

                if (isNumeric) {
                    termRegex = new RegExp(`(\\b${escapeRegExp(term)}\\b)`, 'gi');
                } else {
                    termRegex = new RegExp(escapeRegExp(term), 'gi');
                }
                
                const originalText = highlightedText; 
                const normalizedText = normalizeText(originalText); 
                
                let match;
                let lastIndex = 0;
                let newHtml = '';
                
                while ((match = termRegex.exec(normalizedText)) !== null) {
                    // A posição do match é no normalizedText, mas aplicamos no originalText
                    newHtml += originalText.substring(lastIndex, match.index);
                    newHtml += `<mark class="timeline-highlight">${originalText.substring(match.index, match.index + match[0].length)}</mark>`;
                    lastIndex = match.index + match[0].length;
                }
                newHtml += originalText.substring(lastIndex);
                highlightedText = newHtml; 
            });
            
            return highlightedText;
        }
        
        function highlightFuseMatch(text, indices) {
            let highlightedText = '';
            let lastIndex = 0;

            indices.sort((a, b) => a[0] - b[0]);

            indices.forEach(([start, end]) => {
                highlightedText += text.substring(lastIndex, start);
                highlightedText += `<mark class="timeline-highlight">${text.substring(start, end + 1)}</mark>`;
                lastIndex = end + 1;
            });

            highlightedText += text.substring(lastIndex);
            return highlightedText;
        }

        
        // --- Funções da Barra de Categoria (mantidas, usam 'activeCategory') ---
        function renderCategoryChips() {
            if (allCategories.size === 0) {
                categoryContainer.classList.add('hidden');
                updateHeaderHeight(); 
                return;
            }
            
            categoryContainer.classList.remove('hidden');
            categoryChips.innerHTML = ''; 

            const allChip = createChip('Tudo', null);
            categoryChips.appendChild(allChip);
            
            Array.from(allCategories).sort().forEach(category => {
                const chip = createChip(category, category);
                categoryChips.appendChild(chip);
            });

            updateChipSelection();
            setupChipScrolling();
            updateHeaderHeight(); 
        }
        
        function createChip(text, categoryValue) {
            const chip = document.createElement('button');
            chip.className = 'category-chip text-sm font-medium px-3 py-1.5 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 flex-shrink-0';
            chip.textContent = text;
            chip.dataset.category = categoryValue || 'null'; 
            chip.onclick = () => {
                selectCategory(categoryValue);
            };
            return chip;
        }
        
        function selectCategory(categoryValue) {
            activeCategory = categoryValue;
            updateChipSelection();
            
            if (detailView.style.display === 'block') {
                goHome(null, false); 
            } else {
                renderVideoList();
            }
        }


        function updateChipSelection() {
            const chips = categoryChips.querySelectorAll('.category-chip');
            chips.forEach(chip => {
                const chipCategory = chip.dataset.category === 'null' ? null : chip.dataset.category;
                chip.classList.toggle('active', chipCategory === activeCategory);
            });
        }

        function setupChipScrolling() {
            let container = categoryChips;
            let scrollAmount = 200;

            function checkScrollButtons() {
                requestAnimationFrame(() => {
                    if (!container) return;
                    const maxScroll = container.scrollWidth - container.clientWidth;
                    if (scrollLeftBtn) scrollLeftBtn.classList.toggle('hidden', container.scrollLeft <= 0);
                    if (scrollRightBtn) scrollRightBtn.classList.toggle('hidden', container.scrollLeft >= maxScroll - 1);
                });
            }

            if (scrollLeftBtn) {
                scrollLeftBtn.onclick = () => {
                    container.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
                };
            }
            if (scrollRightBtn) {
                scrollRightBtn.onclick = () => {
                    container.scrollBy({ left: scrollAmount, behavior: 'smooth' });
                };
            }

            if (container) {
                container.addEventListener('scroll', checkScrollButtons);
                new ResizeObserver(checkScrollButtons).observe(container);
                new MutationObserver(checkScrollButtons).observe(container, { childList: true });
            }
            
            checkScrollButtons();
        }


        // --- Funções da TELA 1 (Lista) ---
        
        function toggleViewMode(mode) {
            if (currentViewMode === mode) return;
            currentViewMode = mode;
            localStorage.setItem('meujus_view_mode', mode);
            updateViewModeToggleUI();
            renderVideoList(); 
        }

        function updateViewModeToggleUI() {
            const gridBtn = document.getElementById('viewToggleGrid');
            const listBtn = document.getElementById('viewToggleList');
            
            if (!gridBtn || !listBtn) return;
            
            gridBtn.classList.add('view-toggle-btn');
            listBtn.classList.add('view-toggle-btn');

            if (currentViewMode === 'grid') {
                gridBtn.classList.add('active');
                listBtn.classList.remove('active');
            } else {
                gridBtn.classList.remove('active');
                listBtn.classList.add('active');
            }
        }
        
        function searchDatabase(query) {
            let results;
            
            // Etapa 1: Busca de Texto (Fuzzy)
            if (query && query.length > 1) {
                if (!fuse) return []; 
                results = fuse.search(query);
            } else {
                results = database.map(item => ({ item: item, score: 1 }));
            }

            // Etapa 2: Filtros Manuais
            return results.filter(result => {
                const video = result.item;
                
                // Filtro de Favoritos
                if (favoritesOnly && !favorites.has(video.id)) {
                    return false;
                }
                
                // Filtro de Categoria (disciplina)
                if (activeCategory && video.category !== activeCategory) {
                    return false;
                }
                
                return true;
            });
        }


        function renderVideoList() {
            const query = normalizeText(searchInput.value);
            const filteredResults = searchDatabase(query);
            const filteredVideos = filteredResults.map(result => result.item);

            const loadingEl = document.getElementById('loadingIndicator');
            if(loadingEl) loadingEl.style.display = 'none';
            
            if (favoritesOnly && filteredVideos.length === 0 && query === '') {
                noResults.innerHTML = '<p>Você ainda não salvou nenhum vídeo.</p>';
            } else {
                noResults.innerHTML = '<p>Nenhum vídeo encontrado para os filtros selecionados.</p>';
            }
            noResults.classList.toggle('hidden', filteredVideos.length > 0);
            
            videoListContainer.innerHTML = ''; 

            if (currentViewMode === 'grid') {
                videoListContainer.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-6';
            } else {
                videoListContainer.className = 'flex flex-col';
            }
            
            filteredVideos.forEach(video => {
                const card = document.createElement('div');
                const thumbnailUrl = `https://i.ytimg.com/vi/${video.id}/mqdefault.jpg`;
                
                // A chave 'mini_resumo' agora está mapeada para os temas abordados
                const miniResumoHtml = video.mini_resumo 
                    ? `<p class="text-xs text-gray-600 mt-1">${video.mini_resumo}</p>` 
                    : '';

                if (currentViewMode === 'grid') {
                    card.className = "cursor-pointer mb-6";
                    card.innerHTML = `
                        <div onclick="showDetailView('${video.id}', 0, document.getElementById('searchInput').value)">
                            <img src="${thumbnailUrl}" alt="${video.title}" 
                                 class="w-full h-auto aspect-video object-cover rounded-lg"
                                 onerror="this.src='https://placehold.co/480x270/e2e8f0/94a3b8?text=Video indisponível'; this.onerror=null;">
                            <div class="pt-3">
                                <h3 class="text-sm font-medium text-gray-800" title="${video.title}">
                                    ${video.title}
                                </h3>
                                ${miniResumoHtml}
                            </div>
                        </div>
                    `;
                } else {
                    card.className = "flex gap-4 cursor-pointer pb-4 mb-4 border-b border-gray-200";
                    card.innerHTML = `
                        <div class="flex-shrink-0" onclick="showDetailView('${video.id}', 0, document.getElementById('searchInput').value)">
                            <img src="${thumbnailUrl}" alt="${video.title}" 
                                 class="w-40 sm:w-48 h-24 sm:h-28 object-cover rounded-lg"
                                 onerror="this.src='https://placehold.co/160x90/e2e8f0/94a3b8?text=Video'; this.onerror=null;">
                        </div>
                        <div class="flex-1 overflow-hidden" onclick="showDetailView('${video.id}', 0, document.getElementById('searchInput').value)">
                            <h3 class="text-base font-medium text-gray-800" title="${video.title}">
                                ${video.title}
                            </h3>
                            ${miniResumoHtml}
                        </div>
                    `;
                }
                videoListContainer.appendChild(card);
            });
        }
        
        // --- Funções da TELA 2 (Detalhe) ---
        async function showDetailView(videoId, startTime = 0, searchHighlight = '') {
            
            const videoIndexData = database.find(v => v.id === videoId);
            if (!videoIndexData) {
                console.error("Vídeo não encontrado no índice:", videoId);
                showListView(); 
                return;
            }

            categoryContainer.classList.add('hidden'); 

            currentVideoForShare = videoIndexData; 
            history.pushState({ videoId: videoId }, videoIndexData.title, `?video=${videoId}`);
            currentPlayer = videoId;

            videoTitle.textContent = videoIndexData.title;
            
            // Termos de busca (para realce)
            const searchTerms = normalizeText(searchHighlight).split(' ')
                .filter(term => term.trim() !== '') 
                .filter(term => term.length >= 2 || !isNaN(term.trim()));

            // Paletrantes: NOVO - Usa 'speakers' (mapeado para 'canal')
            const speakersText = (videoIndexData.speakers || []).join(', ');
            videoSpeakersDesktop.innerHTML = highlightText(speakersText, searchTerms);
            
            videoSpeakersMobile.innerHTML = '';
            (videoIndexData.speakers || []).forEach(speaker => {
                const li = document.createElement('li');
                li.innerHTML = highlightText(speaker, searchTerms);
                videoSpeakersMobile.appendChild(li);
            });
            
            setTimeout(() => {
                const needsClamp = videoSpeakersMobile.offsetHeight > 65; 
                speakersMore.classList.toggle('hidden', !needsClamp);
                if (needsClamp) {
                    videoSpeakersMobile.classList.add('line-clamp-3');
                    speakersMore.textContent = '...mais';
                } else {
                    videoSpeakersMobile.classList.remove('line-clamp-3');
                }
            }, 0);

            // Data: NOVO - Usa o 'date' (mapeado para 'data_publicacao' formatada)
            videoDate.textContent = videoIndexData.date;

            // Placeholders
            const summaryContainer = document.getElementById('videoSummary');
            summaryContainer.innerHTML = '<p class="text-gray-500">Carregando sumário...</p>';
            reportContainer.innerHTML = ''; // Limpa fichas antigas
            reportLoading.classList.remove('hidden'); // Mostra o loading do painel
            videoDuration.textContent = '...';

            videoPlayerContainer.innerHTML = `
                <iframe id="youtubePlayer"
                        class="w-full h-full" 
                        src="https://www.youtube.com/embed/${videoId}?rel=0&enablejsapi=1&origin=${window.location.origin}&start=${startTime}&autoplay=1" 
                        title="${videoIndexData.title}" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                </iframe>
            `;
            
            listView.style.display = 'none';
            detailView.style.display = 'block';
            window.scrollTo(0, 0);

            updateHeaderHeight(); 
            
            // Limpa a busca da timeline
            timelineSearchInput.value = '';
            clearTimelineHighlights();
            
            updateFavoriteButtonUI(videoId);
            
            try {
                // Carrega o JSON Completo
                // NOVO: Usa 'category' (disciplina) para montar o path
                const videoPath = `data/${videoIndexData.category}/${videoIndexData.id}.json`;
                const response = await fetch(videoPath, { cache: 'no-cache' });
                if (!response.ok) throw new Error(`Falha ao carregar JSON completo: ${response.statusText}`);
                const video = await response.json(); 

                // Atualiza os dados que faltavam
                // NOVO: Usa a chave 'duracao'
                videoDuration.textContent = video.duracao || '...';
                currentVideoForShare = video; // Atualiza para o vídeo completo

                // RENDERIZA O SUMÁRIO CLICÁVEL
                summaryContainer.innerHTML = ''; 
                // NOVO: Usa a chave 'timeline' para o sumário clicável
                const timelineData = video.timeline || [];
                
                if (timelineData.length > 0) {
                    // NOVO: Usa a explicação de cada item da timeline para o resumo completo
                    currentFullSummaryText = timelineData.map(item => `[${item.time}] ${item.tema}: ${item.explicacao}`).join(' \n'); 
                    const ul = document.createElement('ul');
                    ul.className = 'list-disc list-inside space-y-1.5 pl-2';
                    
                    timelineData.forEach((item, index) => {
                        const summaryTitle = item.tema; // O título do item do sumário é o tema
                        
                        if (summaryTitle) {
                            const li = document.createElement('li');
                            const a = document.createElement('a');
                            a.className = 'summary-item-link';
                            a.innerHTML = highlightText(formatDescription(summaryTitle), searchTerms);
                            a.onclick = () => jumpToPauta(index);
                            a.title = `Ir para [${item.time}] - ${item.tema}`;
                            li.appendChild(a);
                            ul.appendChild(li);
                        }
                    });
                    summaryContainer.appendChild(ul);
                    
                } else {
                    currentFullSummaryText = 'Sumário não disponível.';
                    const p = document.createElement('p');
                    p.textContent = 'Sumário não disponível.';
                    summaryContainer.appendChild(p);
                }
                
                // RENDERIZA O PAINEL DE SESSÃO: NOVO - Chama a função renderTimelineReport
                reportLoading.classList.add('hidden'); // Esconde o loading
                renderTimelineReport(timelineData, searchTerms);
                
                // Configura o link do botão de I.A. (Resumo Completo)
                const aiBtn = document.getElementById('googleAIBtn');
                const aiBaseUrl = 'https://www.google.com/search?udm=50&q=';
                // NOVO: Prompt focado em análise/resumo da aula/temas
                const prompt = `Faça um resumo e liste os principais pontos da seguinte aula/temas de estudo de Direito:\n\n`;
                const aiQuery = prompt + currentFullSummaryText;
                aiBtn.href = aiBaseUrl + encodeURIComponent(aiQuery);

            } catch (error) {
                console.error("Erro ao carregar dados completos do vídeo:", error);
                summaryContainer.innerHTML = '<p class="text-red-500">Erro ao carregar o sumário.</p>';
                reportLoading.classList.add('hidden');
                reportContainer.innerHTML = `<p class="text-red-500">Erro ao carregar o painel da sessão. Verifique se o ficheiro ${videoPath} existe.</p>`;
            }

            // NOVO: Passa a disciplina (mapeada para category)
            renderRecommendedVideos(videoIndexData.id, videoIndexData.category);
        }


        // NOVO: Função para renderizar o Painel de Temas (substitui o renderReport complexo)
        function renderTimelineReport(timelineData, searchTerms = []) {
            reportContainer.innerHTML = '';
            
            if (!timelineData || timelineData.length === 0) {
                 reportContainer.innerHTML = '<p class="text-gray-500">Painel de temas/timeline não disponível.</p>';
                 return;
            }
            
            timelineData.forEach((item, index) => {
                
                const card = document.createElement('div');
                card.id = `report-item-${index}`; 
                card.className = 'report-item-card bg-gray-50 p-4 border border-gray-200 rounded-lg shadow-sm';
                
                let cardSearchText = []; 

                // NOVO: Simplesmente usa o 'tema' como título principal
                let temaHtml = item.tema ? `<h4 class="text-lg font-semibold text-gray-800">${item.tema}</h4>` : '';
                cardSearchText.push(item.tema);

                // NOVO: Novo prompt da I.A. focado no tema específico
                const aiPrompt = `Pesquise na web pelo tema de Direito "${item.tema}" e faça uma síntese objetiva para estudo, com base na seguinte explicação do vídeo:\n\n${item.explicacao}`;
                const aiUrl = `https://www.google.com/search?udm=50&q=${encodeURIComponent(aiPrompt)}`;

                const timeSeconds = timeToSeconds(item.time);
                let timeHtml = `
                    <div class="flex items-center gap-2 mb-3">
                        <button onclick="jumpToTime(${timeSeconds})" 
                                class="inline-flex items-center gap-1.5 bg-blue-100 text-blue-800 text-xs font-mono font-bold px-2 py-0.5 rounded-full hover:bg-blue-200 transition-colors cursor-pointer"
                                title="Pular para ${item.time}">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                            <span>[${item.time}]</span>
                        </button>
                        <a href="${aiUrl}" target="_blank" class="flex-shrink-0" title="Analisar tópico com I.A.">
                            <img src="https://placehold.co/20x20/000000/FFFFFF/png?text=AI" class="w-4 h-4 rounded-full opacity-70 hover:opacity-100">
                        </a>
                    </div>`;
                
                // Explicação
                let explicacaoHtml = '';
                if (item.explicacao) {
                    const formattedExplicacao = formatDescription(item.explicacao);
                    explicacaoHtml = `
                        <div class="mt-2 pt-3 border-t border-gray-300">
                            <strong class="text-sm font-semibold text-gray-900">Detalhes:</strong>
                            <p class="text-sm text-gray-700 mt-1">${formattedExplicacao}</p>
                        </div>
                    `;
                    cardSearchText.push(item.explicacao);
                }
                
                card.innerHTML = `
                    ${timeHtml}
                    ${temaHtml}
                    ${explicacaoHtml}
                `;
                
                // Aplica o realce de busca no HTML gerado
                let cardHtml = card.innerHTML;
                if (searchTerms.length > 0) {
                     // Usa a função de realce para aplicar as <mark> tags
                     cardHtml = highlightText(cardHtml, searchTerms);
                     card.innerHTML = cardHtml;
                }

                // Armazena o texto normalizado (sem tags HTML) para a busca da timeline
                card.dataset.searchText = normalizeText(cardSearchText.join(' '));
                reportContainer.appendChild(card);
            });
        }

        function renderRecommendedVideos(currentVideoId, currentCategory) {
            recommendedVideosContainer.innerHTML = '';
            
            if (!currentCategory) {
                 recommendedVideosContainer.innerHTML = '<p class="text-sm text-gray-500">Sem vídeos recomendados.</p>';
                 return;
            }
            
            const otherVideos = database.filter(v => 
                v.id !== currentVideoId && 
                v.category === currentCategory
            );
            
            if (otherVideos.length === 0) {
                 recommendedVideosContainer.innerHTML = '<p class="text-sm text-gray-500">Sem outros vídeos desta categoria.</p>';
                 return;
            }

            const shuffled = otherVideos.sort(() => 0.5 - Math.random());
            const selectedVideos = shuffled.slice(0, 10);

            selectedVideos.forEach(video => {
                const card = document.createElement('div');
                card.className = "flex items-start gap-3 cursor-pointer";
                card.onclick = () => showDetailView(video.id, 0); 
                
                const thumbnailUrl = `https://i.ytimg.com/vi/${video.id}/mqdefault.jpg`;
                
                const miniResumoHtml = video.mini_resumo 
                    ? `<p class="text-xs text-gray-600 mt-0.5">${video.mini_resumo}</p>` 
                    : '';

                card.innerHTML = `
                    <img src="${thumbnailUrl}" alt="${video.title}" 
                         class="w-32 flex-shrink-0 rounded-md object-cover aspect-video"
                         onerror="this.src='https://placehold.co/120x90/e2e8f0/94a3b8?text=Video'; this.onerror=null;">
                    <div class="flex-1 overflow-hidden">
                        <h4 class="text-sm font-semibold text-gray-900 video-list-title" title="${video.title}">
                            ${video.title}
                        </h4>
                        ${miniResumoHtml}
                    </div>
                `;
                recommendedVideosContainer.appendChild(card);
            });
        }

        // --- Funções de Navegação e Player (mantidas) ---
        function showListView() {
            if (allCategories.size > 0) {
                categoryContainer.classList.remove('hidden'); 
            }

            detailView.style.display = 'none';
            listView.style.display = 'block';
            videoPlayerContainer.innerHTML = '';
            recommendedVideosContainer.innerHTML = ''; 
            currentPlayer = null;
            currentVideoForShare = null;
            currentFullSummaryText = '';
            if (window.location.search) {
                history.pushState(null, '', window.location.pathname);
            }
            updateHeaderHeight(); 
        }

        function jumpToTime(seconds) {
            const player = document.getElementById('youtubePlayer');
            if (player) {
                player.contentWindow.postMessage(JSON.stringify({
                    'event': 'command',
                    'func': 'seekTo',
                    'args': [seconds, true]
                }), '*');
                player.contentWindow.postMessage(JSON.stringify({
                    'event': 'command',
                    'func': 'playVideo'
                }), '*');
                
                const currentHeaderHeight = document.querySelector('header').offsetHeight || 60;
                const playerEl = document.getElementById('videoPlayerContainer');
                const playerTop = playerEl.getBoundingClientRect().top + window.scrollY;
                
                window.scrollTo({
                    top: playerTop - currentHeaderHeight - 10, 
                    behavior: 'smooth'
                });
            }
        }
        
        function jumpToPauta(index) {
            const element = document.getElementById(`report-item-${index}`);
            if (!element) return;
            
            element.classList.remove('hidden'); 
            
            const currentHeaderHeight = document.querySelector('header').offsetHeight;
            const searchBoxHeight = timelineSearchContainer.offsetHeight;
            const stickyOffset = currentHeaderHeight + searchBoxHeight + 20; 
            
            const elementRect = element.getBoundingClientRect();
            const elementTopInDocument = elementRect.top + window.scrollY;
            
            window.scrollTo({
                top: elementTopInDocument - stickyOffset,
                behavior: 'smooth'
            });
            
            element.classList.add('timeline-search-active');
            setTimeout(() => {
                element.classList.remove('timeline-search-active');
            }, 2000);
        }
        
        // --- Funções de Autocomplete (com Fuse.js) (mantidas) ---
        function showSuggestions() {
            if (!fuse) return; 
            
            const query = normalizeText(searchInput.value);
            if (query.length < 2) {
                hideSuggestions(0); 
                return;
            }
            
            const results = searchDatabase(query); 
            const suggestions = results.slice(0, 5); 

            suggestionsBox.innerHTML = '';
            if (suggestions.length === 0) {
                hideSuggestions(0);
                return;
            }

            suggestions.forEach(result => {
                const video = result.item;
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'block px-4 py-3 text-sm text-gray-700 hover:bg-gray-100';
                
                let highlightedTitle = video.title;
                let highlightedSnippet = video.mini_resumo || '';

                const bestMatch = result.matches?.[0]; 

                if (bestMatch) {
                    if (bestMatch.key === 'title') {
                        highlightedTitle = highlightFuseMatch(video.title, bestMatch.indices);
                    } else if (bestMatch.key === 'mini_resumo' && highlightedSnippet) {
                        highlightedSnippet = highlightFuseMatch(video.mini_resumo, bestMatch.indices);
                    }
                }
                
                item.innerHTML = `
                    <span class="font-medium">${highlightedTitle}</span>
                    <p class="text-xs text-gray-500 mt-0.5 truncate">${highlightedSnippet}</p>
                `; 

                item.onmousedown = (e) => {
                    e.preventDefault(); 
                    showDetailView(video.id, 0, searchInput.value); 
                    hideSuggestions(0);
                };
                suggestionsBox.appendChild(item);
            });

            suggestionsBox.classList.remove('hidden');
        }

        function hideSuggestions(delay = 200) {
            setTimeout(() => {
                if (suggestionsBox) {
                    suggestionsBox.classList.add('hidden');
                }
            }, delay);
        }

        // --- Funções de Ações (Compartilhar, Favoritar, Resumo) (mantidas) ---

        function toggleSpeakers() {
            videoSpeakersMobile.classList.toggle('line-clamp-3');
            if (videoSpeakersMobile.classList.contains('line-clamp-3')) {
                speakersMore.textContent = '...mais';
            } else {
                speakersMore.textContent = ' menos';
            }
        }
        
        function saveFavorites() {
            localStorage.setItem('meujus_saved', JSON.stringify(Array.from(favorites)));
        }

        function toggleFavorite() {
            if (!currentVideoForShare) return;
            const videoId = currentVideoForShare.id;
            
            if (favorites.has(videoId)) {
                favorites.delete(videoId);
            } else {
                favorites.add(videoId);
            }
            saveFavorites();
            updateFavoriteButtonUI(videoId);
            updateFavoritesToggleIcon(); 
        }

        function updateFavoriteButtonUI(videoId) {
            const icon = document.getElementById('favoriteIcon');
            const text = document.getElementById('favoriteText');
            if (!icon || !text) return;

            if (favorites.has(videoId)) {
                icon.style.fill = 'currentColor';
                icon.classList.add('text-yellow-500');
                icon.style.stroke = 'currentColor';
                text.textContent = 'Salvo';
            } else {
                icon.style.fill = 'none';
                icon.classList.remove('text-yellow-500');
                icon.style.stroke = 'currentColor';
                text.textContent = 'Salvar';
            }
        }

        async function nativeShare() {
            if (!currentVideoForShare) return;
            
            const video = currentVideoForShare; 
            const shareUrl = `${window.location.origin}${window.location.pathname}?video=${video.id}`;
            const shareData = {
                title: video.title,
                text: `${video.title}\n${(video.mini_resumo || currentFullSummaryText || '').substring(0, 100)}...`,
                url: shareUrl,
            };

            if (navigator.share) {
                try {
                    await navigator.share(shareData);
                } catch (error) {
                    console.log('Erro ao compartilhar', error);
                }
            } else {
                copyToClipboard(shareUrl, 'Link copiado para a área de transferência!');
            }
        }

        function copyToClipboard(text, message) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; 
            textArea.style.opacity = 0;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                if (message) {
                    console.log(message);
                }
            } catch (err) {
                console.error('Falha ao copiar o link: ', err);
            }
            document.body.removeChild(textArea);
        }
        
        // --- Funções do Header (Home e Filtro de Favoritos) (mantidas) ---
        
        function goHome(event, resetCategory = true) {
            if (event) event.preventDefault();
            favoritesOnly = false; 
            updateFavoritesToggleIcon(); 
            searchInput.value = ''; 
            hideSuggestions(0); 
            
            if (resetCategory) {
                activeCategory = null;
                updateChipSelection();
            }
            
            showListView();
            renderVideoList(); 
        }

        function toggleFavoritesOnlyView() {
            favoritesOnly = !favoritesOnly;
            updateFavoritesToggleIcon();
            
            showListView();
            renderVideoList(); 
        }

        function updateFavoritesToggleIcon() {
            const icon = document.getElementById('favoritesToggleIcon');
            if (!icon) return;
            if (favoritesOnly) {
                icon.style.fill = 'currentColor';
                icon.classList.add('text-yellow-500');
                icon.style.stroke = 'currentColor';
            } else if (favorites.size > 0) {
                icon.style.fill = 'none';
                icon.classList.add('text-yellow-500'); 
                icon.style.stroke = 'currentColor';
            } else {
                icon.style.fill = 'none';
                icon.classList.remove('text-yellow-500');
                icon.style.stroke = 'currentColor';
            }
        }

        
        // --- FUNÇÕES DA BUSCA DO PAINEL (TIMELINE) (mantidas, usam os cards simples) ---
        
        function clearTimelineHighlights() {
            const reportItems = reportContainer.querySelectorAll('.report-item-card');
            reportItems.forEach((item) => {
                item.classList.remove('hidden'); 
                item.classList.remove('timeline-search-active'); 
                
                const content = item.innerHTML;
                item.innerHTML = content.replace(/<mark class="timeline-highlight">(.*?)<\/mark>/g, '$1');
            });
            
            timelineMatches = [];
            timelineMatchIndex = -1;
            timelineSearchResults.classList.add('hidden');
            timelineSearchCount.textContent = '(0)';
        }
        
        function handleTimelineSearch() {
            const searchTerms = normalizeText(timelineSearchInput.value).trim().split(' ')
                .filter(term => term.length >= 2 || !isNaN(term.trim()));
            
            clearTimelineHighlights();
            
            if (searchTerms.length === 0) {
                return;
            }
            
            const reportItems = reportContainer.querySelectorAll('.report-item-card');
            
            reportItems.forEach((item, index) => {
                const originalText = item.dataset.searchText; 
                if (!originalText) return;

                const allMatch = searchTerms.every(term => {
                    const isNumeric = !isNaN(term);
                    if (isNumeric) {
                        const regex = new RegExp(`\\b${escapeRegExp(term)}\\b`);
                        return regex.test(originalText);
                    } else {
                        return originalText.includes(term); 
                    }
                });

                if (allMatch) {
                    // NOVO: Usa o innerHTML para realçar, já que é mais simples
                    const content = item.innerHTML;
                    const highlightedContent = highlightText(content, searchTerms);
                    item.innerHTML = highlightedContent;
                    
                    timelineMatches.push(item); 
                } else {
                    item.classList.add('hidden'); 
                }
            });
            
            if (timelineMatches.length > 0) {
                timelineSearchResults.classList.remove('hidden');
                timelineSearchResults.classList.add('flex');
                timelineSearchCount.textContent = `(${timelineMatches.length})`;
                timelineMatchIndex = 0;
                jumpToMatch(); 
            }
        }
        
        function jumpToMatch(next = true) {
            if (timelineMatches.length === 0) return;
            
            const prevActive = document.querySelector('.timeline-search-active');
            if (prevActive) prevActive.classList.remove('timeline-search-active');

            if (next) {
                timelineMatchIndex++;
                if (timelineMatchIndex >= timelineMatches.length) {
                    timelineMatchIndex = 0; 
                }
            } else {
                timelineMatchIndex--;
                if (timelineMatchIndex < 0) {
                    timelineMatchIndex = timelineMatches.length - 1; 
                }
            }
            
            const element = timelineMatches[timelineMatchIndex];
            if (!element) return;
            
            element.classList.add('timeline-search-active');
            
            // NOVO: Manteve o jumpToPauta, mas agora o ID é report-item-INDEX
            jumpToPauta(element.id.split('-').pop()); 
            
            timelineSearchCount.textContent = `(${timelineMatchIndex + 1}/${timelineMatches.length})`;
        }
        // --- FIM DA BUSCA DA TIMELINE ---

        // --- Funções de Layout e Inicialização (mantidas) ---

        function updateHeaderHeight() {
            requestAnimationFrame(() => {
                if (!header) return; 
                
                headerHeight = header.offsetHeight || 60; 
                
                const searchEl = document.getElementById('timelineSearchContainer');
                if (searchEl) {
                    searchEl.style.top = (headerHeight - 1) + 'px'; 
                }
            });
        }


        // Listeners (mantidos)
        searchInput.addEventListener('input', showSuggestions);
        searchInput.addEventListener('blur', () => hideSuggestions(200)); 
        searchInput.addEventListener('focus', showSuggestions);
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                hideSuggestions(0);
                renderVideoList();
            }
        });


        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.videoId) {
                showDetailView(event.state.videoId);
            } else {
                goHome(); 
            }
        });
        
        timelineSearchInput.addEventListener('input', handleTimelineSearch);
        timelineSearchNext.addEventListener('click', () => jumpToMatch(true));
        timelineSearchPrev.addEventListener('click', () => jumpToMatch(false));
        
        if (header) {
            new ResizeObserver(updateHeaderHeight).observe(header);
        }
        window.addEventListener('resize', updateHeaderHeight);
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

        // ======================================================
        // ARQUITETURA DE INICIALIZAÇÃO (ADAPTADA AO NOVO JSON)
        // ======================================================
        async function initializeApp() {
            
            currentViewMode = localStorage.getItem('meujus_view_mode') || 'grid';
            updateViewModeToggleUI(); 

            try {
                // Tenta carregar o índice, mas o código agora lida com o novo formato
                const response = await fetch('data/search_index.json', { cache: 'no-cache' }); 
                if (!response.ok) throw new Error('Falha ao carregar o índice de busca (data/search_index.json).');
                
                // NOVO: A base de dados carregada é a do novo formato JSON
                const rawDatabase = await response.json(); 
                
                // Mapeamento da nova estrutura para a estrutura interna esperada
                database = rawDatabase.map(item => {
                    // Extrai o ID do vídeo do link
                    let videoId = null;
                    try {
                        const url = new URL(item.link);
                        videoId = url.searchParams.get('v') || url.pathname.substring(url.pathname.lastIndexOf('/') + 1);
                    } catch (e) {
                        console.error("Link inválido, usando link como ID:", item.link);
                        videoId = item.link;
                    }

                    // NOVO: Mapeamento de chaves
                    return {
                        id: videoId, 
                        title: item.titulo,
                        // 'disciplina' -> 'category'
                        category: item.disciplina, 
                        // 'canal' -> 'speakers' (para a tela de detalhes)
                        speakers: [item.canal],
                        // 'data_publicacao' (AAAA-MM-DD) -> 'date' (DD/MM/AAAA)
                        date: formatDate(item.data_publicacao), 
                        // 'temas_abordados' -> 'mini_resumo' (usamos o primeiro tema para o resumo)
                        mini_resumo: item.temas_abordados && item.temas_abordados.length > 0 
                                     ? item.temas_abordados[0] : 'Conteúdo jurídico',
                        // Adiciona os temas para a busca por disciplina/tópico
                        disciplines: item.temas_abordados || [] 
                    };
                }).filter(item => item.id); // Remove entradas inválidas sem ID
                
                // CORREÇÃO: Configura o Fuse.js (chaves adaptadas)
                const fuseOptions = {
                    keys: [
                        { name: 'title', weight: 0.4 },
                        { name: 'mini_resumo', weight: 0.3 },
                        { name: 'speakers', weight: 0.2 }, // Ainda usa speakers (canal)
                        { name: 'disciplines', weight: 0.1 } // Disciplinas/Temas para busca
                    ],
                    includeScore: true,
                    includeMatches: true,
                    threshold: 0.4, 
                    ignoreLocation: true, 
                    minMatchCharLength: 2,
                    getFn: (obj, path) => {
                        const value = Fuse.config.getFn(obj, path);
                        if (Array.isArray(value)) {
                            return value.map(normalizeText).join(' ');
                        }
                        return normalizeText(value);
                    }
                };
                
                fuse = new Fuse(database, fuseOptions);

                // Ordena a base de dados original por data (para exibição padrão)
                if (database.length > 0 && database[0].date) {
                    database.sort((a, b) => {
                        // Data no formato DD/MM/AAAA. Reverte para AAAAMMDD para comparar
                        const dateA = a.date.split('/').reverse().join(''); 
                        const dateB = b.date.split('/').reverse().join(''); 
                        return dateB.localeCompare(dateA); // Decrescente (mais novo primeiro)
                    });
                }
                
                database.forEach(video => {
                    if(video.category) { // 'category' é a 'disciplina'
                        allCategories.add(video.category);
                    }
                });

                const params = new URLSearchParams(window.location.search);
                const videoId = params.get('video');
                
                if (videoId && database.some(v => v.id === videoId)) {
                    history.replaceState({ videoId: videoId }, database.find(v => v.id === videoId).title, `?video=${videoId}`);
                    showDetailView(videoId); 
                } else {
                    history.replaceState(null, '', window.location.pathname);
                    goHome(); 
                }
                
                renderCategoryChips(); 
                updateFavoritesToggleIcon(); 

            } catch (error) {
                console.error("Erro ao inicializar a aplicação:", error);
                if (videoListContainer) {
                    videoListContainer.innerHTML = `<p class="text-center text-red-500 col-span-full"><strong>Erro:</strong> Não foi possível carregar os dados dos vídeos. ${error.message}</p>`;
                }
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
            }
        }

    </script>
</body>
</html>
