<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8"> <!-- Charset para a página principal -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vademecum Digital</title>
    <!-- Carrega Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo para garantir que o iframe ocupe o espaço */
        #codeContent iframe {
            width: 100%;
            height: 100%;
            border: none;
            position: relative; /* Necessário para posicionamento absoluto dos botões */
        }
        /* Ajuste para o conteúdo do iframe não ter margens extras que escondam o início */
        body {
             font-family: 'Inter', sans-serif; /* Fonte padrão */
        }
         /* Estilos para o botão flutuante e sub-botões */
        .fab-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column-reverse; /* Sub-botões aparecerão acima */
            align-items: center;
             z-index: 100; /* Garante que FAB fique sobre o iframe */
        }

        .fab-main {
            background-color: #007AFF; /* Azul Apple */
            color: white;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: transform 0.3s ease;
            z-index: 10; /* Garante que o botão principal fique sobre os sub-botões */
        }

         .fab-main.open {
            transform: rotate(45deg); /* Gira o ícone '+' para 'x' */
         }

        .fab-options {
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            margin-bottom: 1rem; /* Espaço entre sub-botões e botão principal */
            transition: all 0.3s ease;
            max-height: 0; /* Começa escondido */
            overflow: hidden; /* Esconde o conteúdo que ultrapassa */
        }

         .fab-container.open .fab-options {
             max-height: 500px; /* Altura suficiente para mostrar os botões */
         }

        .fab-option {
            background-color: #E5E5EA; /* Cinza claro Apple */
            color: #007AFF; /* Azul Apple */
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            margin-top: 0.75rem; /* Espaçamento entre sub-botões */
            transition: all 0.3s ease;
             transform: scale(0); /* Começa escondido */
             opacity: 0;
        }

         /* Animação escalonada para os sub-botões */
         .fab-container.open .fab-option {
             transform: scale(1);
             opacity: 1;
         }
         .fab-container.open .fab-option:nth-child(1) { transition-delay: 0.1s; }
         .fab-container.open .fab-option:nth-child(2) { transition-delay: 0.15s; }
         .fab-container.open .fab-option:nth-child(3) { transition-delay: 0.2s; }
         .fab-container.open .fab-option:nth-child(4) { transition-delay: 0.25s; }

         /* --- Estilos para os botões DENTRO do iframe --- */
        /* Estes estilos precisam ser injetados no iframe ou definidos aqui e referenciados */
         .article-button-container {
            position: absolute;
            right: 5px; /* Posição à direita do parágrafo */
            top: 0; /* Alinha com o topo do parágrafo */
            display: flex;
            flex-direction: column; /* Botões um abaixo do outro */
            gap: 2px; /* Espaçamento pequeno */
            opacity: 0.1; /* Começa quase invisível */
            transition: opacity 0.2s ease-in-out;
             z-index: 5; /* Abaixo do FAB principal */
             background-color: rgba(255, 255, 255, 0.7); /* Fundo semi-transparente */
             padding: 2px;
             border-radius: 4px;
         }
         /* Mostra os botões quando o mouse passa sobre o parágrafo pai (que terá a classe 'relative-article') */
         .relative-article:hover .article-button-container {
             opacity: 1;
         }

         .article-button {
             background-color: #f0f0f0; /* Cinza claro */
             color: #333; /* Cinza escuro */
             border: 1px solid #ccc;
             border-radius: 4px; /* Voltando para quadrado pequeno */
             padding: 1px 3px; /* Pequeno */
             cursor: pointer;
             font-size: 0.65rem; /* Bem pequeno */
             line-height: 1;
             display: inline-flex; /* Para alinhar ícone e texto se houver */
             align-items: center;
             justify-content: center;
             width: 20px; /* Tamanho fixo pequeno */
             height: 20px;
         }
          .article-button:hover {
              background-color: #e0e0e0;
          }
         .article-button ion-icon { /* Aplicando tamanho ao ícone */
             width: 12px; /* Ícone pequeno */
             height: 12px;
         }

        /* Estilo para highlight da busca */
        .highlight {
            background-color: yellow;
            font-weight: bold;
        }

    </style>
     <!-- Importa a fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
     <!-- Ícones IonIcons -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>


</head>
<body class="bg-gray-100">

    <!-- Container Principal -->
    <div id="appContainer" class="max-w-4xl mx-auto h-screen flex flex-col">

        <!-- Tela de Seleção de Código (Inicial) -->
        <div id="categorySelection" class="p-6 flex-grow flex flex-col">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Vademecum Digital</h1>
            <div class="space-y-4">
                <!-- Botão para carregar o Código Penal -->
                <button onclick="loadCode('DEL2848compilado.html', 'Código Penal')" class="w-full bg-white p-4 rounded-lg shadow hover:shadow-md transition text-left text-lg font-medium text-gray-700">
                    Código Penal (Decreto-Lei nº 2.848/1940)
                </button>
                <!-- Adicionar mais botões para outros códigos aqui -->
                 <div class="w-full bg-gray-200 p-4 rounded-lg shadow text-left text-lg font-medium text-gray-500 opacity-50">
                    Código Civil (Em breve)
                </div>
                 <div class="w-full bg-gray-200 p-4 rounded-lg shadow text-left text-lg font-medium text-gray-500 opacity-50">
                    Constituição Federal (Em breve)
                </div>
            </div>
        </div>

        <!-- Tela de Visualização do Código (Oculta Inicialmente) -->
        <div id="codeView" class="hidden flex-grow flex flex-col h-full bg-white shadow-lg rounded-b-lg overflow-hidden">
             <!-- Cabeçalho da Visualização -->
            <div class="flex items-center p-3 bg-gray-50 border-b border-gray-200 sticky top-0 z-20"> <!-- z-index aumentado -->
                 <!-- Botão Voltar -->
                <button onclick="showCategories()" class="p-2 mr-2 text-blue-600 hover:bg-gray-200 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                    </svg>
                </button>
                 <!-- Título do Código -->
                <h2 id="codeTitle" class="text-lg font-semibold text-gray-800 flex-grow truncate mr-2">Código</h2>
                 <!-- Campo de Busca -->
                <div class="relative">
                    <input type="search" id="searchInput" placeholder="Buscar no código..." class="pl-8 pr-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm w-40 md:w-64">
                    <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-gray-400">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                    </svg>
                    </div>
                </div>
            </div>

            <!-- Área de Conteúdo do Código (usando iframe) -->
            <div id="codeContent" class="flex-grow overflow-auto p-1 bg-white relative"> <!-- Adicionado relative aqui -->
                <!-- Iframe será inserido aqui pelo JavaScript -->
                 <p class="p-4 text-gray-500">Carregando conteúdo...</p>
            </div>
        </div>

        <!-- Botão Flutuante (FAB) -->
        <div id="fabContainer" class="fab-container hidden"> <!-- Começa escondido, mostra na codeView -->
            <div class="fab-options">
                <!-- Sub-botões -->
                 <button class="fab-option" onclick="alert('Função 1 (ex: Anotar)')" aria-label="Anotar">
                      <ion-icon name="create-outline"></ion-icon>
                 </button>
                 <button class="fab-option" onclick="alert('Função 2 (ex: Copiar)')" aria-label="Copiar">
                      <ion-icon name="copy-outline"></ion-icon>
                 </button>
                 <button class="fab-option" onclick="alert('Função 3 (ex: Jurisprudência)')" aria-label="Jurisprudência">
                      <ion-icon name="library-outline"></ion-icon>
                 </button>
                 <button class="fab-option" onclick="alert('Função 4 (ex: Compartilhar)')" aria-label="Compartilhar">
                      <ion-icon name="share-social-outline"></ion-icon>
                 </button>
            </div>
             <!-- Botão Principal -->
            <button id="fabMain" class="fab-main" onclick="toggleFab()" aria-label="Abrir opções">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 icon-plus">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 icon-close hidden"> <!-- Ícone X escondido -->
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

    </div>

    <script>
        const categorySelection = document.getElementById('categorySelection');
        const codeView = document.getElementById('codeView');
        const codeContent = document.getElementById('codeContent');
        const codeTitle = document.getElementById('codeTitle');
        const searchInput = document.getElementById('searchInput');
        const fabContainer = document.getElementById('fabContainer');
        const fabMain = document.getElementById('fabMain');
        const iconPlus = fabMain.querySelector('.icon-plus');
        const iconClose = fabMain.querySelector('.icon-close');

        // Mapa para armazenar o texto completo dos artigos identificados
        const articleTextMap = new Map();
        let highlightMarkInstance; // Instância do Mark.js para highlight

        // Função para mostrar a tela de categorias
        function showCategories() {
            categorySelection.classList.remove('hidden');
            categorySelection.classList.add('flex');
            codeView.classList.add('hidden');
            codeView.classList.remove('flex');
            fabContainer.classList.add('hidden'); // Esconde FAB
            fabContainer.classList.remove('open'); // Garante que FAB feche
            fabMain.classList.remove('open');
            iconPlus.classList.remove('hidden'); // Mostra '+'
            iconClose.classList.add('hidden'); // Esconde 'X'
            codeContent.innerHTML = '<p class="p-4 text-gray-500">Carregando conteúdo...</p>'; // Limpa conteúdo anterior
            if (highlightMarkInstance) {
                highlightMarkInstance = null; // Limpa instância da busca
            }
        }

        // Função para carregar e mostrar o conteúdo do código
        async function loadCode(url, title) {
            categorySelection.classList.add('hidden');
            categorySelection.classList.remove('flex');
            codeView.classList.remove('hidden');
            codeView.classList.add('flex');
            fabContainer.classList.remove('hidden'); // Mostra FAB
            codeTitle.textContent = title;
            searchInput.value = ''; // Limpa busca
            articleTextMap.clear(); // Limpa o mapa de textos ao carregar novo código
            if (highlightMarkInstance) {
                 highlightMarkInstance = null; // Limpa instância da busca ao trocar de código
            }

            codeContent.innerHTML = ''; // Limpa mensagem de carregamento
            const iframe = document.createElement('iframe');
            iframe.src = url; // Define o src diretamente
            iframe.onload = () => {
                console.log("Iframe carregado.");
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    // Log da codificação detectada pelo navegador para o iframe
                    console.log("Charset detectado no iframe:", iframeDoc.characterSet || iframeDoc.charset || "Não especificado");
                    // Recomenda UTF-8 se não for
                    if (!(iframeDoc.characterSet || iframeDoc.charset || '').toUpperCase().includes('UTF-8')) {
                         console.warn("A codificação do arquivo carregado não parece ser UTF-8. Recomenda-se salvar o arquivo de origem como UTF-8 para melhor compatibilidade com acentos.");
                    }
                     // Inicializa o Mark.js para busca no conteúdo do iframe
                     // Certifique-se de que Mark.js está carregado (adicionarei o script no final)
                     if (typeof Mark !== 'undefined') {
                        highlightMarkInstance = new Mark(iframeDoc.body);
                     } else {
                         console.error("Mark.js não está carregado. A busca não funcionará.");
                     }
                } catch (e) {
                     console.error("Erro ao acessar documento do iframe ou inicializar Mark.js:", e);
                     // Pode ser erro de Same-Origin se testado localmente sem servidor
                }


                // Adiciona um pequeno delay para garantir que o DOM interno esteja pronto
                setTimeout(() => {
                    addActionButtonsToIframe(iframe);
                }, 100); // Espera 100ms
            };
            iframe.onerror = () => {
                codeContent.innerHTML = '<p class="p-4 text-red-500">Erro ao carregar o conteúdo. Verifique se o arquivo está acessível.</p>';
            };
            codeContent.appendChild(iframe);
        }

         // Função para alternar o FAB
        function toggleFab() {
            const isOpen = fabContainer.classList.toggle('open');
            fabMain.classList.toggle('open');
            iconPlus.classList.toggle('hidden', isOpen);
            iconClose.classList.toggle('hidden', !isOpen);
            fabMain.setAttribute('aria-label', isOpen ? 'Fechar opções' : 'Abrir opções');
        }

        // --- Funções para adicionar botões DENTRO do iframe ---

        // Função para verificar se um elemento é o início de um artigo ou parágrafo relevante
        function isRelevantElement(element) {
            if (element.tagName !== 'P') return false;
            const text = element.textContent.trim();
            // Verifica artigos, parágrafos únicos, alíneas e incisos
            return text.match(/^(Art\.\s*\d+[º°]?[\w-]*\.?)|(Parágrafo único)|(§\s*\d+[º°]?\.?)|(^[a-z]\))|(^[IVXLCDM]+\s*-)/i);
        }

        // Função para extrair texto de um artigo (incluindo parágrafos subsequentes não-artigos)
        function extractArticleText(startElement) {
            let text = startElement.textContent.trim();
            let currentElement = startElement.nextElementSibling;
            // Pega o texto dos próximos elementos <p> até encontrar um novo elemento relevante ou outro tipo de elemento
            while (currentElement && currentElement.tagName === 'P' && !isRelevantElement(currentElement)) {
                text += "\n" + currentElement.textContent.trim();
                currentElement = currentElement.nextElementSibling;
            }
            return text;
        }


         // Função principal para adicionar botões DENTRO do iframe
         function addActionButtonsToIframe(iframe) {
             try {
                 const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                 if (!iframeDoc || !iframeDoc.body || iframeDoc.readyState !== 'complete') { // Verifica se o body está pronto e completo
                     console.warn("Documento do Iframe ainda não está completo. Tentando novamente...");
                     // Tenta novamente após um delay maior
                     setTimeout(() => addActionButtonsToIframe(iframe), 300);
                     return;
                 }


                 // Injeta os estilos CSS para os botões dentro do head do iframe
                 const styleId = 'article-button-styles';
                 if (!iframeDoc.getElementById(styleId)) { // Evita injetar múltiplos estilos
                    const style = iframeDoc.createElement('style');
                    style.id = styleId;
                    style.textContent = `
                        .relative-article {
                            position: relative !important; /* Garante contexto de posicionamento */
                            padding-right: 30px !important; /* Espaço para botões */
                            min-height: 25px; /* Altura mínima para evitar sobreposição */
                        }
                        .article-button-container {
                            position: absolute;
                            right: 2px; /* Mais próximo da borda */
                            top: 1px; /* Um pouco abaixo */
                            display: flex;
                            flex-direction: column;
                            gap: 2px;
                            opacity: 0; /* Começa invisível */
                            transition: opacity 0.2s ease-in-out;
                            z-index: 10; /* Acima do texto */
                            background-color: rgba(240, 240, 240, 0.9); /* Fundo opaco */
                            padding: 3px;
                            border-radius: 4px;
                            border: 1px solid #ddd;
                            pointer-events: none; /* Não interage até hover */
                        }
                        .relative-article:hover .article-button-container {
                            opacity: 1;
                            pointer-events: auto; /* Permite clique nos botões */
                        }
                        .article-button {
                            background-color: #fff;
                            color: #333;
                            border: 1px solid #ccc;
                            border-radius: 4px; /* Voltando para quadrado pequeno */
                            padding: 0;
                            cursor: pointer;
                            font-size: 0.65rem;
                            line-height: 1;
                            display: inline-flex;
                            align-items: center;
                            justify-content: center;
                            width: 20px;
                            height: 20px;
                            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
                        }
                        .article-button:hover {
                            background-color: #eee;
                            border-color: #bbb;
                        }
                        .article-button ion-icon {
                            width: 14px; /* Ícone um pouco maior */
                            height: 14px;
                        }
                         /* Estilo injetado para highlight da busca no iframe */
                        mark.search-highlight {
                             background-color: yellow;
                             font-weight: bold;
                             padding: 0;
                             margin: 0;
                         }
                    `;
                    iframeDoc.head.appendChild(style);
                 }


                 // Seleciona todos os parágrafos dentro do body do iframe
                 const paragraphs = iframeDoc.body.querySelectorAll('p'); // Busca dentro do body
                 let articleCounter = 0; // Contador para gerar IDs únicos

                 paragraphs.forEach(p => {
                    // Limpa containers antigos
                     const oldContainer = p.querySelector('.article-button-container');
                     if(oldContainer) p.removeChild(oldContainer);
                     p.classList.remove('relative-article'); // Limpa classe antiga

                     if (isRelevantElement(p)) {
                         articleCounter++;
                         const uniqueArticleId = `article-${articleCounter}`; // ID Único
                         p.dataset.articleId = uniqueArticleId; // Armazena ID no elemento

                         // Extrai o texto completo do artigo e armazena no mapa
                         const fullText = extractArticleText(p);
                         articleTextMap.set(uniqueArticleId, fullText);

                         // Adiciona classe para posicionamento relativo
                         p.classList.add('relative-article');

                         // Cria o container de botões
                         const buttonContainer = iframeDoc.createElement('div');
                         buttonContainer.classList.add('article-button-container');

                         // Cria os botões (Passando o ID único)
                        const prompts = {
                            annotate: `Explique de forma simples e resumida o seguinte texto jurídico:\n\n"%%TEXT%%"`,
                            jurisprudence: `Encontre jurisprudência relevante e atualizada sobre o seguinte artigo/trecho da legislação:\n\n"%%TEXT%%"`,
                            share: `Crie um post curto para redes sociais explicando o ponto principal do seguinte texto jurídico:\n\n"%%TEXT%%"`
                        };

                         buttonContainer.innerHTML = `
                             <button class="article-button" title="Resumir/Explicar" onclick="window.parent.handleArticleAction('annotate', '${uniqueArticleId}', \`${prompts.annotate}\`)">
                                 <ion-icon name="information-circle-outline"></ion-icon>
                             </button>
                             <button class="article-button" title="Copiar" onclick="window.parent.handleArticleAction('copy', '${uniqueArticleId}')">
                                 <ion-icon name="copy-outline"></ion-icon>
                             </button>
                             <button class="article-button" title="Buscar Jurisprudência" onclick="window.parent.handleArticleAction('jurisprudence', '${uniqueArticleId}', \`${prompts.jurisprudence}\`)">
                                <ion-icon name="library-outline"></ion-icon>
                            </button>
                             <button class="article-button" title="Explicar para Redes Sociais" onclick="window.parent.handleArticleAction('share', '${uniqueArticleId}', \`${prompts.share}\`)">
                                <ion-icon name="share-social-outline"></ion-icon>
                             </button>
                         `;


                         // Adiciona o container ao parágrafo do artigo
                         p.appendChild(buttonContainer);
                     }
                 });

                 console.log(`Botões adicionados a ${articleCounter} elementos relevantes no iframe.`);

             } catch (e) {
                 console.error("Erro ao adicionar botões ao iframe: ", e);
             }
         }

        // --- Funções para lidar com as ações dos botões do artigo ---
        function handleArticleAction(action, uniqueArticleId, promptTemplate = "") {
            const fullArticleText = articleTextMap.get(uniqueArticleId) || 'Texto não encontrado';

            // Ação de cópia
            if (action === 'copy') {
                navigator.clipboard.writeText(fullArticleText)
                    .then(() => alert(`Texto completo do artigo copiado!`))
                    .catch(err => {
                        // Fallback para método antigo
                        try {
                            const textArea = document.createElement("textarea");
                            textArea.value = fullArticleText;
                            document.body.appendChild(textArea);
                            textArea.focus();
                            textArea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textArea);
                            alert(`Texto completo do artigo copiado! (Fallback)`);
                        } catch (fallbackErr) {
                             console.error('Erro ao copiar (Navigator e Fallback):', err, fallbackErr);
                             alert("Erro ao copiar o texto.");
                        }
                    });
                return; // Não abre Google AI para cópia
            }

            // Para outras ações, prepara o prompt
            const shortArticleText = fullArticleText.substring(0, 200) + (fullArticleText.length > 200 ? '...' : '');
            const promptText = promptTemplate.replace("%%TEXT%%", shortArticleText);

            if (!promptText) {
                 console.error("Ação desconhecida ou sem prompt:", action);
                 return;
            }

            const googleAiBaseUrl = "https://google.com/?ai=1&ai_prompt=";
            const encodedPrompt = encodeURIComponent(promptText);
            const finalUrl = googleAiBaseUrl + encodedPrompt;

            console.log("Abrindo URL:", finalUrl);
            window.open(finalUrl, '_blank');
        }

        // --- Função de Busca ---
        function performSearch(term) {
             if (!highlightMarkInstance) {
                 console.log("Instância de busca (Mark.js) não está pronta.");
                 return;
             }
             // Remove highlights anteriores
             highlightMarkInstance.unmark({
                 done: function(){
                     if (term && term.length > 1) { // Só busca com mais de 1 caractere
                         // Aplica novo highlight
                         highlightMarkInstance.mark(term, {
                             separateWordSearch: false, // Busca a frase exata
                             className: 'search-highlight',
                             done: function(counter) {
                                 console.log(`Encontradas ${counter} ocorrências.`);
                                 // Rola para a primeira ocorrência se houver
                                 const firstMark = document.querySelector('#codeContent iframe')
                                                       .contentDocument
                                                       .body
                                                       .querySelector('mark.search-highlight');
                                 if (firstMark) {
                                     firstMark.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                 }
                             }
                         });
                     }
                 }
             });
         }


        // Event Listener para o input de busca
        searchInput.addEventListener('input', (event) => {
            performSearch(event.target.value);
        });

        // Inicializa mostrando as categorias
        document.addEventListener('DOMContentLoaded', showCategories);

    </script>
     <!-- Adiciona a biblioteca Mark.js para a busca -->
     <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js"></script>

</body>
</html>

