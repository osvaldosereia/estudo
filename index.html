<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rota de Entrega</title>
    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- NOVO: Carrega o Banco de Dados de Clientes -->
    <!-- Este arquivo DEVE estar na mesma pasta que este HTML -->
    <script src="clientes.js"></script>
    <!-- Biblioteca SortableJS REMOVIDA -->
    <style>
        /* Estilos Sortable REMOVIDOS */

        /* Classe para item entregue */
        .entregue {
            background-color: #f0fdf4; /* green-50 */
            border-left-width: 4px;
            border-left-color: #22c55e; /* green-500 */
        }
        .entregue .btn-entregue {
            background-color: #22c55e; /* green-500 */
            color: white;
        }

        /* NOVO: Classe para item cancelado */
        .cancelada {
            background-color: #f3f4f6; /* gray-100 */
            border-left-width: 4px;
            border-left-color: #6b7280; /* gray-500 */
            opacity: 0.7;
        }
        .cancelada .btn-entregue,
        .cancelada .btn-card-maps,
        .cancelada .btn-mover-cima,
        .cancelada .btn-mover-baixo,
        .cancelada .btn-cancelar-entrega {
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* NOVO: Estilização do <select> de rotas */
        #select-rota-ativa {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
        }

        /* NOVO: Estilos Modo Entregador */
        body.modo-entregador #main-content > header,
        body.modo-entregador #main-content > section:not(#section-lista-entregas) {
            display: none;
        }
        body {
            /* Adiciona padding para não esconder o H1 embaixo da topbar */
            padding-top: 80px; 
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <!-- NOVO: Top Bar Fixa -->
    <div id="top-bar" class="fixed top-0 left-0 right-0 z-50 bg-gray-800 text-white shadow-lg p-4">
        <div class="container mx-auto max-w-5xl flex justify-center items-center gap-4">
            <button id="btn-modo-admin" class="px-6 py-2 rounded-md font-semibold text-sm bg-blue-500 text-white">
                ADMIN
            </button>
            <button id="btn-modo-entregador" class="px-6 py-2 rounded-md font-semibold text-sm bg-gray-600 text-gray-200 hover:bg-gray-500">
                ENTREGADOR
            </button>
        </div>
    </div>
    <!-- Fim Top Bar -->

    <!-- Container Principal (Agora dentro de um Wrapper) -->
    <div id="main-content" class="container mx-auto max-w-5xl p-4 sm:p-6 lg:p-8">

        <!-- Cabeçalho -->
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Rota de Entrega</h1>
        </header>

        <!-- NOVO: Seção de Gerenciamento de Rotas -->
        <section class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Gerenciar Rota</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <!-- Seletor de Rota Ativa -->
                <div class="md:col-span-2">
                    <label for="select-rota-ativa" class="block text-sm font-medium text-gray-700">Rota Ativa</label>
                    <select id="select-rota-ativa" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base">
                        <!-- Rotas serão preenchidas pelo JS -->
                    </select>
                </div>
                <!-- Botão Nova Rota -->
                <div class="md:col-span-1">
                    <button id="btn-nova-rota" class="w-full flex justify-center items-center rounded-md border border-transparent bg-green-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-green-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        Nova Rota
                    </button>
                </div>
                <!-- Botão Excluir Rota -->
                <div class="md:col-span-1">
                     <button id="btn-excluir-rota" class="w-full flex justify-center items-center rounded-md border border-gray-300 bg-red-100 px-4 py-3 text-sm font-medium text-red-700 shadow-sm hover:bg-red-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm2 3a1 1 0 100 2h2a1 1 0 100-2H9z" clip-rule="evenodd" /></svg>
                        Excluir Rota
                    </button>
                </div>

                <!-- Nome da Rota -->
                <div class="md:col-span-2">
                    <label for="input-nome-rota" class="block text-sm font-medium text-gray-700">Nome da Rota</label>
                    <input type="text" id="input-nome-rota" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Ex: Entregas Manhã">
                </div>
                <!-- Data da Rota -->
                <div class="md:col-span-2">
                    <label for="input-data-rota" class="block text-sm font-medium text-gray-700">Data da Rota</label>
                    <div class="flex items-center">
                        <input type="date" id="input-data-rota" class="mt-1 block w-full rounded-l-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base">
                        <span id="display-dia-semana" class="mt-1 inline-flex items-center px-3 py-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-base min-w-[120px] justify-center">-</span>
                    </div>
                </div>
            </div>
        </section>
        <!-- FIM NOVA SEÇÃO -->

        <!-- NOVO: Seção de Despesas da Rota -->
        <section class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Despesas da Rota</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label for="input-despesa-abastecimento" class="block text-sm font-medium text-gray-700">Abastecimento (R$)</label>
                    <input type="number" id="input-despesa-abastecimento" step="0.01" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="0.00">
                </div>
                <div>
                    <label for="input-despesa-alimentacao" class="block text-sm font-medium text-gray-700">Alimentação (R$)</label>
                    <input type="number" id="input-despesa-alimentacao" step="0.01" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="0.00">
                </div>
                <div>
                    <label for="input-despesa-extra" class="block text-sm font-medium text-gray-700">Extras (R$)</label>
                    <input type="number" id="input-despesa-extra" step="0.01" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="0.00">
                </div>
            </div>
        </section>
        <!-- FIM NOVA SEÇÃO DESPESAS -->

        <!-- Seção de Lançamento -->
        <section class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Lançar Nova Entrega</h2>
            <form id="form-entrega" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                
                <!-- Coluna 1: Cliente e Cesta -->
                <div class="md:col-span-1 space-y-4">
                    <!-- MODIFICADO: Campo de Cliente (Input com Datalist) -->
                    <div>
                        <label for="input-cliente" class="block text-sm font-medium text-gray-700">Cliente</label>
                        <input type="text" id="input-cliente" list="lista-clientes" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Digite ou selecione um cliente...">
                        <datalist id="lista-clientes">
                            <!-- Clientes carregados via JS -->
                        </datalist>
                    </div>

                    <!-- NOVO: Display de Infos do Cliente -->
                    <div id="info-cliente-selecionado" class="hidden space-y-2 text-sm text-gray-600 border-l-4 border-blue-200 pl-3 py-2 bg-blue-50 rounded-r-md">
                        <p><strong>Endereço:</strong> <span id="display-cliente-endereco">-</span></p>
                        <p><strong>Complemento:</strong> <span id="display-cliente-complemento">-</span></p>
                        <p><strong>Celular:</strong> <span id="display-cliente-celular">-</span></p>
                    </div>

                    <!-- CAMPO ANTIGO REMOVIDO -->
                    
                    <!-- NOVO CAMPO DE OBSERVAÇÃO -->
                    <div>
                        <label for="obs-cliente" class="block text-sm font-medium text-gray-700">Observação (Opcional)</label>
                        <input type="text" id="obs-cliente" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Ex: Casa azul, portão branco">
                    </div>
                    <!-- FIM NOVO CAMPO -->
                    <div>
                        <label for="select-cesta" class="block text-sm font-medium text-gray-700">Cesta Básica</label>
                        <select id="select-cesta" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base">
                            <option value="Mini Bonini" data-valor="165.00">Mini Bonini</option>
                            <option value="Mini Koblenz" data-valor="170.00">Mini Koblenz</option>
                            <option value="Pequena Bonini" data-valor="215.00">Pequena Bonini</option>
                            <option value="Pequena Koblenz" data-valor="220.00">Pequena kolenz</option>
                            <option value="mÉDIA Bonini" data-valor="320.00">Média Bonini</option>
                            <option value="Média Koblenz" data-valor="325.00">Média Koblenz</option>
                            <option value="Grande Bonini" data-valor="380.00">Grande Bonini</option>
                            <option value="Grande Koblenz" data-valor="390.00">Grande koblenz</option>
                        </select>
                    </div>
                </div>

                <!-- Coluna 2: Tipo e Valor -->
                <div class="md:col-span-1 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tipo da Cesta</label>
                        <div class="mt-2 flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="tipo-cesta" value="Normal" checked class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Normal</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="tipo-cesta" value="Alterada" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Alterada</span>
                            </label>
                        </div>
                    </div>
                    <!-- NOVO CAMPO: Brinde -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Brinde?</label>
                        <div class="mt-2 flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="brinde" value="Não" checked class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Não</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="brinde" value="Sim" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Sim</span>
                            </label>
                        </div>
                    </div>
                    <!-- FIM NOVO CAMPO: Brinde -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                        <div id="display-valor" class="mt-1 p-2 h-auto flex items-center bg-gray-100 rounded-md border border-gray-300 text-gray-800 font-semibold py-3 px-4 text-base">
                            0.00
                        </div>
                    </div>
                </div>
                
                <!-- Coluna 3: Campo Alterada e Botões -->
                <div class="md:col-span-1 space-y-4">
                    <div id="campo-alterada" class="hidden space-y-4">
                        <div>
                            <label for="codigo-alterada" class="block text-sm font-medium text-gray-700">Detalhe (Cesta Alterada)</label>
                            <input type="text" id="codigo-alterada" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Ex: Sem arroz, +1 feijão">
                        </div>

                        <!-- NOVO CAMPO: Partes Alteradas -->
                        <div id="campo-partes-alteradas">
                            <label class="block text-sm font-medium text-gray-700">Partes Alteradas (Múltiplo)</label>
                            <div class="mt-2 space-y-2">
                                <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                                    <input type="checkbox" name="partes_alteradas" value="Arroz" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                                    <span class="ml-3 text-sm font-medium text-gray-700">Arroz</span>
                                </label>
                                <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                                    <input type="checkbox" name="partes_alteradas" value="Alimento" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                                    <span class="ml-3 text-sm font-medium text-gray-700">Alimento</span>
                                </label>
                                <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                                    <input type="checkbox" name="partes_alteradas" value="Limpeza" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                                    <span class="ml-3 text-sm font-medium text-gray-700">Limpeza</span>
                                </label>
                            </div>
                        </div>
                        <!-- FIM NOVO CAMPO -->
                    </div>
                    <div class="pt-6 flex flex-col">
                        <button type="submit" class="w-full flex justify-center items-center rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            Lançar Entrega
                        </button>
                    </div>
                </div>
            </form>
        </section>

        <!-- Seção da Lista de Entregas (ID Adicionado) -->
        <section id="section-lista-entregas">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-700">Entregas na Rota</h2>
                <div class="flex space-x-2 mt-4 sm:mt-0">
                    <button id="btn-exportar" class="rounded-md bg-green-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-green-700">Exportar Rota</button>
                    <button id="btn-carregar" class="rounded-md bg-gray-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-gray-700">Carregar Rota</button>
                </div>
            </div>
            
            <!-- Lista de Cards de Entrega -->
            <div id="lista-entregas" class="space-y-3 min-h-[100px]">
                <!-- Cards serão injetados aqui pelo JavaScript -->
            </div>
            <p id="lista-vazia" class="text-center text-gray-500 py-6">Nenhuma entrega na rota.</p>
        </section>
    </div>

    <!-- Modal de Pagamento (Oculto por padrão) -->
    <div id="modal-pagamento" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <form id="form-pagamento">
                <div class="p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Confirmar Entrega e Pagamento</h3>
                    <p class="text-sm text-gray-600 mb-1">Cliente: <strong id="modal-cliente-nome"></strong></p>
                    <p class="text-sm text-gray-600 mb-4">Valor: <strong id="modal-cliente-valor"></strong></p>
                    
                    <label class="block text-sm font-medium text-gray-700 mb-2">Forma(s) de Pagamento (Selecione ao menos uma):</label>
                    <div id="modal-error-pagamento" class="text-red-600 text-sm mb-2 hidden">É obrigatório selecionar ao menos uma forma de pagamento.</div>
                    <div class="space-y-2">
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                            <input type="checkbox" name="forma_pagamento" value="Dinheiro" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">Dinheiro</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                            <input type="checkbox" name="forma_pagamento" value="Pix" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">Pix</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                            <input type="checkbox" name="forma_pagamento" value="Cartão" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">Cartão</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                            <input type="checkbox" name="forma_pagamento" value="Fiado" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">Fiado</span>
                        </label>
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3 rounded-b-lg">
                    <button type="button" id="btn-cancelar-pagamento" class="rounded-md border border-gray-300 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Cancelar</button>
                    <button type="submit" id="btn-confirmar-pagamento" class="rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700">Confirmar Entrega</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Exportar (Oculto por padrão) -->
    <div id="modal-exportar" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl m-4 overflow-hidden">
            <div class="p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Exportar Rota</h3>
                
                <label class="block text-sm font-medium text-gray-700 mb-2">Backup da Rota (Arquivo)</label>
                <button type="button" id="btn-baixar-json" class="w-full flex justify-center items-center rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Baixar Arquivo da Rota (.json)
                </button>

                <h4 class="text-lg font-semibold text-gray-700 mt-6 mb-2">Relatório de Entregas Concluídas</h4>
                <div id="export-relatorio" class="w-full max-h-48 overflow-y-auto p-2 border border-gray-300 rounded-md bg-gray-50">
                    <pre class="text-xs text-gray-700">Nenhuma entrega concluída.</pre>
                </div>

                <div id="export-whatsapp-link" class="mt-4">
                    <!-- Link do WhatsApp será gerado aqui -->
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end rounded-b-lg">
                <button type="button" id="btn-fechar-exportar" class="rounded-md border border-gray-300 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Aviso (Oculto por padrão) -->
    <div id="modal-aviso" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm m-4">
            <div class="p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Atenção</h3>
                <p id="modal-aviso-texto" class="text-gray-600 mb-6">Mensagem de aviso.</p>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end rounded-b-lg">
                <button type="button" id="btn-fechar-aviso" class="rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700">OK</button>
            </div>
        </div>
    </div>

    <!-- Input de Arquivo (Oculto) -->
    <input type="file" id="input-carregar-arquivo" class="hidden" accept=".json,application/json">


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Seletores de Elementos ---
            // NOVO: Top Bar
            const btnModoAdmin = document.getElementById('btn-modo-admin');
            const btnModoEntregador = document.getElementById('btn-modo-entregador');

            // NOVO: Gerenciamento de Rotas
            const btnNovaRota = document.getElementById('btn-nova-rota');
            const selectRotaAtiva = document.getElementById('select-rota-ativa');
            const inputNomeRota = document.getElementById('input-nome-rota');
            const inputDataRota = document.getElementById('input-data-rota');
            const displayDiaSemana = document.getElementById('display-dia-semana');
            const btnExcluirRota = document.getElementById('btn-excluir-rota');

            // NOVO: Seletores de Despesas
            const inputDespesaAbastecimento = document.getElementById('input-despesa-abastecimento');
            const inputDespesaAlimentacao = document.getElementById('input-despesa-alimentacao');
            const inputDespesaExtra = document.getElementById('input-despesa-extra');

            const formEntrega = document.getElementById('form-entrega');
            // MODIFICADO: Seletor de Cliente
            const inputCliente = document.getElementById('input-cliente');
            const datalistClientes = document.getElementById('lista-clientes');
            const infoClienteSelecionado = document.getElementById('info-cliente-selecionado');
            const displayClienteEndereco = document.getElementById('display-cliente-endereco');
            const displayClienteComplemento = document.getElementById('display-cliente-complemento');
            const displayClienteCelular = document.getElementById('display-cliente-celular');
            
            const obsClienteInput = document.getElementById('obs-cliente'); // NOVO SELETOR
            const selectCesta = document.getElementById('select-cesta');
            const displayValor = document.getElementById('display-valor');
            const campoAlterada = document.getElementById('campo-alterada');
            const codigoAlteradaInput = document.getElementById('codigo-alterada');
            const listaEntregasEl = document.getElementById('lista-entregas');
            const listaVaziaEl = document.getElementById('lista-vazia');
            
            // Modais
            const modalPagamento = document.getElementById('modal-pagamento');
            const formPagamento = document.getElementById('form-pagamento');
            const btnCancelarPagamento = document.getElementById('btn-cancelar-pagamento');
            const modalClienteNome = document.getElementById('modal-cliente-nome');
            const modalClienteValor = document.getElementById('modal-cliente-valor');
            const modalErrorPagamento = document.getElementById('modal-error-pagamento');

            const btnExportar = document.getElementById('btn-exportar');
            const btnCarregar = document.getElementById('btn-carregar');
            
            const modalExportar = document.getElementById('modal-exportar');
            const exportRelatorioEl = document.getElementById('export-relatorio');
            const exportWhatsappLinkEl = document.getElementById('export-whatsapp-link');
            const btnFecharExportar = document.getElementById('btn-fechar-exportar');

            // Modal de Aviso
            const modalAviso = document.getElementById('modal-aviso');
            const modalAvisoTexto = document.getElementById('modal-aviso-texto');
            const btnFecharAviso = document.getElementById('btn-fechar-aviso');

            // --- Estado da Aplicação ---
            let todasAsRotas = {}; // NOVO: Objeto para guardar todas as rotas
            let rotaAtivaId = null; // NOVO: ID da rota sendo visualizada
            const MAX_ROTAS = 30; // Limite de rotas salvas
            let CLIENTES_CACHE = {}; // NOVO: Cache para busca rápida de clientes por nome

            let entregaParaPagarId = null; // ID da entrega no modal de pagamento

            // --- Funções ---

            /**
             * Exibe o modal de aviso com uma mensagem
             */
            function mostrarAviso(mensagem) {
                modalAvisoTexto.textContent = mensagem;
                modalAviso.classList.remove('hidden');
            }

            /**
             * Fecha o modal de aviso
             */
            function fecharAviso() {
                modalAviso.classList.add('hidden');
            }

            /**
             * Formata um valor numérico para o formato de moeda BRL (R$ 123,45)
             */
            function formatarMoeda(valor) {
                return parseFloat(valor).toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
            }
            
            /**
             * Formata um ISO Date String (ou Date obj) para um formato legível (dd/mm/aaaa hh:mm)
             */
            function formatarData(isoString) {
                if (!isoString) return '';
                const data = new Date(isoString);
                return data.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            /**
             * NOVO: Limpa um número de telefone para formato de API (55DDDNUMERO)
             */
            function limparTelefone(telefone) {
                if (!telefone) return '';
                // Remove tudo que não for dígito
                const limpo = telefone.replace(/\D/g, '');
                
                // Caso 1: Já está no formato 55DDDXXXX (12 ou 13 dígitos)
                if (limpo.startsWith('55') && (limpo.length === 12 || limpo.length === 13)) {
                    return limpo;
                }
                
                // Caso 2: Formato DDD + 9XXXX (11 dígitos)
                if (limpo.length === 11) {
                    return '55' + limpo;
                }
                
                // Caso 3: Formato DDD + 8XXXX (10 dígitos, celular antigo ou fixo)
                if (limpo.length === 10) {
                    return '55' + limpo;
                }
                
                // Se não se encaixa, retorna vazio
                return '';
            }

            /**
             * NOVO: Pega o dia da semana de uma data (yyyy-mm-dd)
             */
            function getDiaDaSemana(dataString) {
                if (!dataString) return '-';
                // Adiciona T12:00:00 para evitar problemas de fuso horário com new Date()
                const data = new Date(dataString + 'T12:00:00');
                const dia = data.toLocaleDateString('pt-BR', { weekday: 'long' });
                // Capitaliza a primeira letra
                return dia.charAt(0).toUpperCase() + dia.slice(1);
            }

            /**
             * Atualiza o display de valor quando a cesta é selecionada
             */
            function atualizarValorCesta() {
                const selectedOption = selectCesta.options[selectCesta.selectedIndex];
                const valor = selectedOption.dataset.valor || "165.00"; // MODIFICADO: Pega o valor da primeira opção como padrão
                displayValor.textContent = formatarMoeda(valor);
            }

            /**
             * Mostra/oculta o campo de "cesta alterada"
             */
            function toggleCampoAlterada() {
                const tipo = document.querySelector('input[name="tipo-cesta"]:checked').value;
                if (tipo === 'Alterada') {
                    campoAlterada.classList.remove('hidden');
                    codigoAlteradaInput.required = true;
                } else {
                    campoAlterada.classList.add('hidden');
                    codigoAlteradaInput.required = false;
                    codigoAlteradaInput.value = '';
                    // NOVO: Reseta checkboxes
                    document.querySelectorAll('input[name="partes_alteradas"]:checked').forEach(cb => {
                        cb.checked = false;
                    });
                }
            }

            /**
             * Salva o estado atual das entregas na ROTA ATIVA
             */
            function salvarLocalStorage() {
                // Esta função agora apenas salva a rota ativa.
                // A função salvarTodasAsRotas() cuida do objeto principal
                if (rotaAtivaId && todasAsRotas[rotaAtivaId]) {
                    // A reordenação agora é feita em 'moverEntrega'
                    // As despesas são salvas em 'salvarDespesas'
                    salvarTodasAsRotas();
                }
            }

            /**
             * NOVO: Salva o objeto 'todasAsRotas' no LocalStorage
             */
            function salvarTodasAsRotas() {
                // Gerenciamento de limite (MAX_ROTAS)
                const chavesRotas = Object.keys(todasAsRotas);
                if (chavesRotas.length > MAX_ROTAS) {
                    // Encontra as rotas mais antigas (baseado no ID, que é um timestamp)
                    const chavesOrdenadas = chavesRotas.sort((a, b) => a - b);
                    const chavesParaRemover = chavesOrdenadas.slice(0, chavesOrdenadas.length - MAX_ROTAS);
                    
                    chavesParaRemover.forEach(chave => {
                        delete todasAsRotas[chave];
                    });
                }
                
                localStorage.setItem('gerenciadorDeRotas', JSON.stringify(todasAsRotas));
                
                // Salva o ID da rota ativa
                if (rotaAtivaId) {
                    localStorage.setItem('rotaAtivaId', rotaAtivaId);
                }
            }

            /**
             * NOVO: Carrega todas as rotas do LocalStorage e inicia o app
             */
            function iniciarAplicativo() {
                // 1. Carregar Clientes (do clientes.js)
                try {
                    if (typeof CLIENTES_DB !== 'undefined' && Array.isArray(CLIENTES_DB)) {
                        datalistClientes.innerHTML = ''; // Limpa
                        CLIENTES_DB.forEach(cliente => {
                            const option = document.createElement('option');
                            option.value = cliente.nome;
                            datalistClientes.appendChild(option);
                            // Cria um cache para busca rápida
                            CLIENTES_CACHE[cliente.nome.toLowerCase()] = cliente;
                        });
                    } else {
                        console.error("CLIENTES_DB não encontrado ou em formato inválido. Verifique o 'clientes.js'.");
                        mostrarAviso("Erro ao carregar banco de dados de clientes. Verifique o arquivo 'clientes.js'.");
                    }
                } catch (e) {
                     console.error("Erro ao processar clientes:", e);
                     mostrarAviso("Erro ao processar o arquivo 'clientes.js'.");
                }


                // 2. Carregar Rotas
                const dadosSalvos = localStorage.getItem('gerenciadorDeRotas');
                if (dadosSalvos) {
                    todasAsRotas = JSON.parse(dadosSalvos);
                }

                // 3. Descobrir qual rota está ativa
                rotaAtivaId = localStorage.getItem('rotaAtivaId');

                // 4. Se não houver rotas, ou a rota ativa não existir, cria uma nova
                if (!rotaAtivaId || !todasAsRotas[rotaAtivaId]) {
                    // Se não tiver nenhuma rota salva, cria a primeira
                    if (Object.keys(todasAsRotas).length === 0) {
                        criarNovaRota(false); // Cria a primeira rota
                    } else {
                        // Se tiver rotas, mas a ativa sumiu, pega a primeira da lista
                        rotaAtivaId = Object.keys(todasAsRotas)[0];
                        localStorage.setItem('rotaAtivaId', rotaAtivaId);
                    }
                }

                // 5. Popular o <select> e carregar a rota ativa na tela
                popularSelectRotas();
                carregarRotaAtiva();
            }

            /**
             * NOVO: Pega o array de entregas da rota ativa
             */
            function getEntregasAtivas() {
                if (rotaAtivaId && todasAsRotas[rotaAtivaId]) {
                    return todasAsRotas[rotaAtivaId].entregas;
                }
                return []; // Retorna array vazio se não houver rota
            }

            /**
             * NOVO: Atualiza o <select> com as rotas salvas
             */
            function popularSelectRotas() {
                selectRotaAtiva.innerHTML = ''; // Limpa
                
                // Ordena as rotas (pela data ou ID, vamos usar ID por enquanto)
                const chavesOrdenadas = Object.keys(todasAsRotas).sort((a, b) => b - a); // Mais novas primeiro

                chavesOrdenadas.forEach(id => {
                    const rota = todasAsRotas[id];
                    const option = document.createElement('option');
                    option.value = id;
                    // Formata o texto da opção
                    const dataFormatada = rota.data ? new Date(rota.data + 'T12:00:00').toLocaleDateString('pt-BR') : 'Sem Data';
                    option.textContent = `${rota.nome} (${dataFormatada})`;
                    
                    if (id === rotaAtivaId) {
                        option.selected = true;
                    }
                    selectRotaAtiva.appendChild(option);
                });
            }

            /**
             * NOVO: Carrega os dados da rota ativa (ID salvo em rotaAtivaId) na tela
             */
            function carregarRotaAtiva() {
                const rota = todasAsRotas[rotaAtivaId];
                if (!rota) {
                    // Isso não deve acontecer se 'iniciarAplicativo' funcionar
                    console.error("Erro: Tentando carregar rota ativa, mas ID não encontrado.");
                    // Tenta criar uma nova rota como fallback
                    if (Object.keys(todasAsRotas).length === 0) {
                        criarNovaRota(false);
                    } else {
                        // Pega a primeira que existir
                        rotaAtivaId = Object.keys(todasAsRotas)[0];
                        localStorage.setItem('rotaAtivaId', rotaAtivaId);
                    }
                    popularSelectRotas();
                    carregarRotaAtiva(); // Tenta novamente com a nova rota
                    return;
                }

                // Atualiza os inputs de gerenciamento
                inputNomeRota.value = rota.nome;
                inputDataRota.value = rota.data;
                displayDiaSemana.textContent = getDiaDaSemana(rota.data);

                // NOVO: Atualiza os inputs de despesa
                // Garante que o objeto despesas exista
                rota.despesas = rota.despesas || { abastecimento: 0, alimentacao: 0, extra: 0 };
                inputDespesaAbastecimento.value = rota.despesas.abastecimento || 0;
                inputDespesaAlimentacao.value = rota.despesas.alimentacao || 0;
                inputDespesaExtra.value = rota.despesas.extra || 0;

                // Atualiza o <select>
                selectRotaAtiva.value = rotaAtivaId;
                
                // Renderiza as entregas dessa rota
                renderizarEntregas();
            }

            /**
             * NOVO: Limpa a tela e cria uma nova rota
             */
            function criarNovaRota(atualizarTela = true) {
                const novoId = Date.now().toString(); // ID baseado no timestamp
                const hoje = new Date().toISOString().split('T')[0]; // Formato yyyy-mm-dd

                const novaRota = {
                    id: novoId,
                    nome: "Nova Rota",
                    data: hoje,
                    entregas: [],
                    despesas: { abastecimento: 0, alimentacao: 0, extra: 0 } // NOVO
                };

                todasAsRotas[novoId] = novaRota;
                rotaAtivaId = novoId;

                salvarTodasAsRotas();
                
                if (atualizarTela) {
                    popularSelectRotas();
                    carregarRotaAtiva();
                }
            }

            /**
             * NOVO: Atualiza Nome e Data da rota ativa
             */
            function atualizarInfoRota() {
                const rota = todasAsRotas[rotaAtivaId];
                if (!rota) return;
                
                rota.nome = inputNomeRota.value || "Rota Sem Nome";
                rota.data = inputDataRota.value;
                
                displayDiaSemana.textContent = getDiaDaSemana(rota.data);

                salvarTodasAsRotas();
                popularSelectRotas(); // Atualiza o texto no select
            }

            /**
             * NOVO: Salva os valores de despesa na rota ativa
             */
            function salvarDespesas() {
                const rota = todasAsRotas[rotaAtivaId];
                if (!rota) return;

                rota.despesas = {
                    abastecimento: parseFloat(inputDespesaAbastecimento.value) || 0,
                    alimentacao: parseFloat(inputDespesaAlimentacao.value) || 0,
                    extra: parseFloat(inputDespesaExtra.value) || 0
                };

                salvarTodasAsRotas();
                // Não precisa renderizar tudo, só salvar
            }

            /**
             * NOVO: Exclui a rota ativa
             */
            function excluirRotaAtiva() {
                 if (Object.keys(todasAsRotas).length <= 1) {
                    mostrarAviso("Você não pode excluir a última rota.");
                    return;
                }

                // Confirmação (Simples, idealmente usar um modal customizado)
                // Usando o modal de aviso de forma criativa (não é o ideal, mas evita 'confirm')
                // Vamos pular a confirmação por enquanto e apenas excluir
                
                delete todasAsRotas[rotaAtivaId];
                
                // Pega a próxima rota (a mais recente)
                const chavesOrdenadas = Object.keys(todasAsRotas).sort((a, b) => b - a);
                rotaAtivaId = chavesOrdenadas[0];
                
                salvarTodasAsRotas(); // Salva a exclusão e o novo ID ativo
                
                popularSelectRotas();
                carregarRotaAtiva();
            }

            /**
             * Renderiza todos os cards de entrega (DA ROTA ATIVA) na tela
             */
            function renderizarEntregas() {
                listaEntregasEl.innerHTML = ''; // Limpa a lista
                const entregas = getEntregasAtivas(); // MODIFICADO

                if (entregas.length === 0) {
                    listaVaziaEl.classList.remove('hidden');
                    return;
                }
                
                listaVaziaEl.classList.add('hidden');

                entregas.forEach((entrega, index) => {
                    const card = document.createElement('div');
                    card.dataset.id = entrega.id;
                    // MODIFICADO: Adicionado w-full e overflow-hidden
                    card.className = `p-4 bg-white rounded-lg shadow-sm border flex flex-col sm:flex-row items-start sm:items-center justify-between transition-all ${entrega.status === 'Entregue' ? 'entregue' : (entrega.status === 'Cancelada' ? 'cancelada' : '')} w-full overflow-hidden`;
                    
                    let infoTags = []; // Use an array for cleaner logic

                    if (entrega.tipo === 'Normal') {
                        infoTags.push(`<span class="text-xs font-semibold bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">Normal</span>`);
                    } else {
                        // É Alterada, mostrar tags amarelas
                        if (entrega.codigoAlterada) {
                            infoTags.push(`<span class="text-xs font-semibold bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">${entrega.codigoAlterada}</span>`);
                        }
                        if (entrega.partesAlteradas && entrega.partesAlteradas.length > 0) {
                             infoTags.push(`<span class="text-xs font-semibold bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">${entrega.partesAlteradas.join(', ')}</span>`);
                        }
                        // Se for alterada mas não tiver info, bota um default
                        if (!entrega.codigoAlterada && (!entrega.partesAlteradas || entrega.partesAlteradas.length === 0)) {
                            infoTags.push(`<span class="text-xs font-semibold bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">Alterada</span>`);
                        }
                    }

                    // NOVO: Adiciona info de Brinde
                    if (entrega.brinde === 'Sim') {
                        infoTags.push(`<span class="text-xs font-semibold bg-pink-100 text-pink-800 px-2 py-0.5 rounded-full">Brinde</span>`);
                    }
                    
                    // NOVO: Adiciona info da Observação como tag
                    if (entrega.observacao) {
                        infoTags.push(`<span class="text-xs font-semibold bg-red-100 text-red-700 px-2 py-0.5 rounded-full" title="${entrega.observacao}">OBS: ${entrega.observacao}</span>`);
                    }

                    let statusInfo = '';
                    if (entrega.status === 'Entregue') {
                        statusInfo = `
                            <div class="text-xs text-green-700 mt-1 sm:ml-4 bg-green-100 px-2 py-1 rounded">
                                <span class="font-semibold">Pagamento:</span> ${entrega.formaPagamento.join(', ')}<br>
                                <span class="font-semibold">Horário:</span> ${formatarData(entrega.horarioEntrega)}
                            </div>
                        `;
                    // NOVO: Status para Cancelada
                    } else if (entrega.status === 'Cancelada') {
                        statusInfo = `
                            <div class="text-xs text-red-700 mt-1 sm:ml-4 bg-red-100 px-2 py-1 rounded">
                                <span class="font-semibold">Status:</span> CANCELADA<br>
                                <span class="font-semibold">Horário:</span> ${formatarData(entrega.horarioEntrega)}
                            </div>
                        `;
                    }

                    // NOVO: Pega ID do cliente
                    const clienteId = (entrega.cliente.id || entrega.cliente.ID || entrega.cliente.Id || '').toString();
                    let idInfo = clienteId ? `<p class="text-xs text-gray-400 font-mono truncate" title="ID: ${clienteId}">ID: ${clienteId}</p>` : '';

                    // MODIFICADO: Info do Cliente (Nome, Endereço, Complemento)
                    let infoClienteHtml = `
                        ${idInfo} <!-- ID ADICIONADO AQUI -->
                        <p class="text-base font-semibold text-gray-800 truncate" title="${entrega.cliente.nome}">${entrega.cliente.nome}</p>
                        <!-- OBS REMOVIDA DAQUI, MOVIDA PARA infoTags -->
                        <p class="text-sm text-gray-600 truncate" title="${entrega.cliente.endereco || ''}">${entrega.cliente.endereco || 'Sem endereço'}</p>
                        <p class="text-sm text-gray-500 truncate" title="${entrega.cliente.complemento || ''}">${entrega.cliente.complemento || 'Sem complemento'}</p>
                        <!-- NOVO: Mostrar Celular -->
                        <p class="text-sm text-gray-500 truncate" title="${entrega.cliente.celular || ''}">Cel: ${entrega.cliente.celular || 'Sem celular'}</p>
                        <p class="text-sm text-gray-500 mt-1">${entrega.cesta.nome} - <span class="font-medium">${formatarMoeda(entrega.cesta.valor)}</span></p>
                    `;
                    
                    // Lógica para desabilitar botões de mover
                    const isPrimeiro = index === 0;
                    const isUltimo = index === entregas.length - 1;
                    // NOVO: Trava botões se não estiver pendente
                    const isFinalizada = entrega.status === 'Entregue' || entrega.status === 'Cancelada';

                    // --- Lógica de Botões de Ação ---
                    const telefoneLimpo = limparTelefone(entrega.cliente.celular);
                    const semTelefone = !telefoneLimpo;

                    // WhatsApp
                    const mensagemFormatada = `Olá! Sou o entregador da sua Cesta Básica. Estou chegando ao seu endereço em alguns minutos. Por favor, confirme que há alguém no local para receber. Obrigado`;
                    const whatsappUrl = `https://api.whatsapp.com/send?phone=${telefoneLimpo}&text=${encodeURIComponent(mensagemFormatada)}`;
                    
                    // Ligar (tel:)
                    const telefoneParaLigacao = `+${telefoneLimpo}`; // tel:+55...
                    const ligarUrl = `tel:${telefoneParaLigacao}`;

                    // Kyte - REMOVIDO
                    

                    card.innerHTML = `
                        <div class="flex-1 min-w-0 overflow-hidden"> <!-- MODIFICADO: Adicionado overflow-hidden -->
                            <div class="flex items-center">
                                <!-- NOVO: Botões de Seta -->
                                <div class="flex flex-col items-center justify-center mr-3">
                                    <button class="btn-mover-cima text-gray-400 ${isPrimeiro || isFinalizada ? 'opacity-25 cursor-not-allowed' : 'hover:text-blue-600'}" data-id="${entrega.id}" title="Mover para Cima" ${isPrimeiro || isFinalizada ? 'disabled' : ''}>
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
                                        </svg>
                                    </button>
                                    <button class="btn-mover-baixo text-gray-400 ${isUltimo || isFinalizada ? 'opacity-25 cursor-not-allowed' : 'hover:text-blue-600'}" data-id="${entrega.id}" title="Mover para Baixo" ${isUltimo || isFinalizada ? 'disabled' : ''}>
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                </div>
                                <!-- Fim Botões de Seta -->

                                <div class="truncate">
                                    ${infoClienteHtml} <!-- MODIFICADO -->
                                </div>
                            </div>
                            <div class="mt-2 sm:ml-12 flex flex-wrap gap-2 items-center">
                                ${infoTags.join(' ')} <!-- Injeta as tags (agora com OBS) -->
                                ${statusInfo}
                            </div>
                        </div>
                        <!-- MODIFICADO: Layout de Botões (grid-cols-6 no mobile) -->
                        <div class="mt-4 sm:mt-0 sm:ml-4 flex-shrink-0 grid grid-cols-6 sm:flex sm:flex-row sm:flex-wrap gap-2">
                            <!-- Botão Mapa (col-span-2) -->
                            <button class="btn-card-maps w-full sm:w-auto rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-white text-gray-700 border border-gray-300 ${isFinalizada ? 'cursor-not-allowed opacity-50' : 'hover:bg-gray-50'} col-span-2" title="Abrir no Google Maps" ${isFinalizada ? 'disabled' : ''}>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                                <span class="sm:hidden ml-2">Mapa</span>
                            </button>
                            
                            <!-- Botão WhatsApp (col-span-2) -->
                            <a href="${semTelefone || isFinalizada ? '#' : whatsappUrl}" 
                               target="_blank" 
                               rel="noopener noreferrer"
                               class="btn-card-whatsapp w-full sm:w-auto rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-green-100 text-green-700 border border-green-300 ${isFinalizada || semTelefone ? 'cursor-not-allowed opacity-50' : 'hover:bg-green-200'} col-span-2 flex justify-center items-center" 
                               title="Enviar WhatsApp" 
                               ${isFinalizada || semTelefone ? 'aria-disabled="true" onclick="event.preventDefault()"' : ''}>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M18 10c0-4.418-3.582-8-8-8S2 5.582 2 10c0 1.758.57 3.395 1.524 4.766L2.04 18.42a.5.5 0 00.58.58l3.656-1.484A7.94 7.94 0 0010 18c4.418 0 8-3.582 8-8zM6.666 9.345c-.2-.48-.389-.738-.567-.738-.178 0-.356.0c-.533.015-.71.24-.888.48-.178.24-.71.694-.71 1.688 0 .994.71 1.94 1.156 2.498.444.558 1.423 1.39 3.445 2.34.502.24.8.389.978.389.178 0 .356-.015.533-.165.178-.15.71-.694.888-1.39.178-.694.178-1.284.105-1.39-.073-.105-.163-.165-.34-.315-.178-.15-.356-.24-.534-.24-.178 0-.444.09-.533.165s-.356.48-.533.738c-.178.255-.267.27-.444.12-.178-.15-1.067-.54-2.03-1.284-.76-.588-1.267-1.306-1.122-1.688.144-.382.444-.664.533-.738.09-.075.178-.165.267-.255.09-.09.134-.165.178-.27.045-.105.015-.24-.045-.315-.06-.075-.533-1.284-.71-1.782z" clip-rule="evenodd" />
                                </svg>
                                <span class="sm:hidden ml-2">Wpp</span>
                            </a>

                            <!-- NOVO: Botão Ligar (col-span-2) -->
                            <a href="${semTelefone || isFinalizada ? '#' : ligarUrl}"
                               class="btn-card-ligar w-full sm:w-auto rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-blue-100 text-blue-700 border border-blue-300 ${isFinalizada || semTelefone ? 'cursor-not-allowed opacity-50' : 'hover:bg-blue-200'} col-span-2 flex justify-center items-center" 
                               title="Ligar para Cliente" 
                               ${isFinalizada || semTelefone ? 'aria-disabled="true" onclick="event.preventDefault()"' : ''}>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C6.477 18 2 13.523 2 8V3z" />
                                </svg>
                                <span class="sm:hidden ml-2">Ligar</span>
                            </a>

                            <!-- Botão Kyte REMOVIDO -->
                            

                            <!-- Lógica de Botões de Ação (col-span-3 ou col-span-6) -->
                            ${entrega.status === 'Pendente' ? `
                                <button class="btn-cancelar-entrega w-full sm:w-auto rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-red-100 text-red-700 border border-red-300 hover:bg-red-200 col-span-3" data-id="${entrega.id}">
                                    Cancelar
                                </button>
                                <button class="btn-entregue w-full sm:w-auto rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 col-span-3" data-id="${entrega.id}">
                                    Marcar Entrega
                                </button>
                            ` : (entrega.status === 'Entregue' ? `
                                <button class="btn-entregue w-full sm:w-auto rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-green-600 text-white cursor-not-allowed col-span-6" disabled>
                                    Entregue
                                </button>
                            ` : `
                                <button class="btn-entregue w-full sm:w-auto rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-gray-500 text-white cursor-not-allowed col-span-6" disabled>
                                    Cancelada
                                </button>
                            `)}
                            <!-- FIM LÓGICA DE BOTÕES -->

                        </div>
                    `;
                    listaEntregasEl.appendChild(card);
                });
            }

            /**
             * Lida com o submit do formulário de nova entrega
             */
            function adicionarEntrega(e) {
                e.preventDefault();
                
                // MODIFICADO: Pega a rota ativa
                const rotaAtiva = todasAsRotas[rotaAtivaId];
                if (!rotaAtiva) {
                    mostrarAviso("Nenhuma rota ativa selecionada. Crie uma nova rota.");
                    return;
                }
                const entregas = rotaAtiva.entregas; // Pega o array de entregas da rota

                const selectedOption = selectCesta.options[selectCesta.selectedIndex];
                
                // MODIFICADO: Busca o cliente selecionado no Cache
                const nomeClienteSelecionado = inputCliente.value;
                const clienteSelecionado = CLIENTES_CACHE[nomeClienteSelecionado.toLowerCase()];

                let clienteData;
                if (clienteSelecionado) {
                    // Cliente encontrado no DB
                    clienteData = clienteSelecionado;
                } else {
                    // Cliente avulso (digitado)
                    clienteData = {
                        // id: null, // ID será undefined, o que é esperado
                        nome: nomeClienteSelecionado,
                        celular: '',
                        endereco: nomeClienteSelecionado, // Usa o nome como endereço
                        complemento: ''
                    };
                }

                if (!clienteData.nome) {
                    mostrarAviso('Por favor, selecione ou digite um nome de cliente.');
                    return;
                }
                
                // NOVO: Coleta Partes Alteradas
                const partesAlteradasSelecionadas = 
                    Array.from(formEntrega.querySelectorAll('input[name="partes_alteradas"]:checked'))
                         .map(input => input.value);
                // NOVO: Coleta Brinde
                const brindeSelecionado = document.querySelector('input[name="brinde"]:checked').value;
                
                const novaEntrega = {
                    id: Date.now(), // ID único
                    cliente: clienteData, // MODIFICADO: Salva o objeto do cliente
                    observacao: obsClienteInput.value, // Campo de observação separado
                    cesta: {
                        nome: selectedOption.value,
                        valor: parseFloat(selectedOption.dataset.valor)
                    },
                    tipo: document.querySelector('input[name="tipo-cesta"]:checked').value,
                    codigoAlterada: codigoAlteradaInput.value,
                    partesAlteradas: partesAlteradasSelecionadas, // NOVO CAMPO
                    brinde: brindeSelecionado, // NOVO CAMPO
                    status: "Pendente",
                    formaPagamento: [],
                    horarioEntrega: null
                };

                entregas.push(novaEntrega); // MODIFICADO: Adiciona na rota ativa
                salvarLocalStorage();
                renderizarEntregas();

                // Limpa o formulário
                formEntrega.reset();
                inputCliente.value = ''; // Limpa o input do cliente
                infoClienteSelecionado.classList.add('hidden'); // Esconde o display de info
                atualizarValorCesta();
                toggleCampoAlterada();
            }

            /**
             * Abre o Google Maps com o código/endereço do cliente
             */
            function abrirGoogleMaps(query) {
                if (!query) {
                    mostrarAviso('O cliente não possui um código ou endereço para abrir no mapa.');
                    return;
                }
                const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
                window.open(url, '_blank');
            }

            /**
             * Abre o modal de pagamento para a entrega clicada
             */
            function abrirModalPagamento(id) {
                const entregas = getEntregasAtivas(); // MODIFICADO
                const entrega = entregas.find(e => e.id.toString() === id);
                if (!entrega) return;

                entregaParaPagarId = id;
                
                // Preenche dados do modal
                modalClienteNome.textContent = entrega.cliente.nome; // MODIFICADO
                modalClienteValor.textContent = formatarMoeda(entrega.cesta.valor);
                
                // Reseta o formulário do modal
                formPagamento.reset();
                modalErrorPagamento.classList.add('hidden');

                // Exibe o modal
                modalPagamento.classList.remove('hidden');
            }

            /**
             * Fecha o modal de pagamento
             */
            function fecharModalPagamento() {
                modalPagamento.classList.add('hidden');
                entregaParaPagarId = null;
            }

            /**
             * NOVO: Marca uma entrega como Cancelada
             */
            function cancelarEntrega(id) {
                const entregas = getEntregasAtivas(); // MODIFICADO
                const index = entregas.findIndex(e => e.id.toString() === id);
                if (index !== -1) {
                    entregas[index].status = "Cancelada";
                    entregas[index].formaPagamento = []; // Garante que está limpo
                    entregas[index].horarioEntrega = new Date().toISOString(); // Salva a hora do cancelamento
                }
                salvarLocalStorage();
                renderizarEntregas();
            }

            /**
             * NOVO: Move uma entrega para cima ou para baixo na lista
             */
            function moverEntrega(id, direcao) {
                const entregas = getEntregasAtivas(); // MODIFICADO
                const index = entregas.findIndex(e => e.id.toString() === id);
                if (index === -1) return;

                if (direcao === 'cima' && index > 0) {
                    // Swap com o item anterior
                    [entregas[index - 1], entregas[index]] = [entregas[index], entregas[index - 1]];
                } else if (direcao === 'baixo' && index < entregas.length - 1) {
                    // Swap com o próximo item
                    [entregas[index + 1], entregas[index]] = [entregas[index], entregas[index + 1]];
                } else {
                    return; // Não faz nada se for o primeiro/ultimo
                }

                salvarLocalStorage();
                renderizarEntregas();
            }

            /**
             * Lida com o clique nos cards (delegação de evento)
             */
            function handleCardClick(e) {
                // NOVO: Checa clique no Botão MOVER CIMA
                const btnCima = e.target.closest('.btn-mover-cima');
                if (btnCima) {
                    moverEntrega(btnCima.dataset.id, 'cima');
                    return; 
                }

                // NOVO: Checa clique no Botão MOVER BAIXO
                const btnBaixo = e.target.closest('.btn-mover-baixo');
                if (btnBaixo) {
                    moverEntrega(btnBaixo.dataset.id, 'baixo');
                    return;
                }

                // NOVO: Checa clique no Botão CANCELAR
                const btnCancelar = e.target.closest('.btn-cancelar-entrega');
                if (btnCancelar) {
                    cancelarEntrega(btnCancelar.dataset.id);
                    return; 
                }

                // Checa clique no Botão MAPA
                const btnMaps = e.target.closest('.btn-card-maps');
                if (btnMaps) {
                    const cardId = btnMaps.closest('[data-id]').dataset.id;
                    const entregas = getEntregasAtivas(); // MODIFICADO
                    const entrega = entregas.find(e => e.id.toString() === cardId);
                    if (entrega) {
                        abrirGoogleMaps(entrega.cliente.endereco); // MODIFICADO
                    }
                    return; // Para a execução
                }

                // NOVO: Ignora clique nos links de ação (<a>)
                const btnWpp = e.target.closest('.btn-card-whatsapp');
                if (btnWpp) {
                    return;
                }
                const btnLigar = e.target.closest('.btn-card-ligar');
                if (btnLigar) {
                    return;
                }
                const btnKyte = e.target.closest('.btn-card-kyte');
                if (btnKyte) {
                    return;
                }

                // Checa clique no Botão ENTREGUE
                const target = e.target.closest('.btn-entregue');
                if (target && !target.disabled) {
                    abrirModalPagamento(target.dataset.id);
                }
            }

            /**
             * Lida com o submit do formulário de pagamento
             */
            function salvarPagamento(e) {
                e.preventDefault();
                
                const formasPagamentoSelecionadas = 
                    Array.from(formPagamento.querySelectorAll('input[name="forma_pagamento"]:checked'))
                         .map(input => input.value);
                
                if (formasPagamentoSelecionadas.length === 0) {
                    modalErrorPagamento.classList.remove('hidden');
                    return;
                }
                
                // Encontra a entrega e atualiza
                const entregas = getEntregasAtivas(); // MODIFICADO
                const index = entregas.findIndex(e => e.id.toString() === entregaParaPagarId);
                if (index !== -1) {
                    entregas[index].status = "Entregue";
                    entregas[index].formaPagamento = formasPagamentoSelecionadas;
                    entregas[index].horarioEntrega = new Date().toISOString();
                }
                
                salvarLocalStorage();
                renderizarEntregas();
                fecharModalPagamento();
            }

            /**
             * Função para baixar dados como um arquivo JSON
             */
            function downloadArquivo(data, filename) {
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            /**
             * Prepara e exibe o modal de exportação
             */
            function exportarDados() {
                // MODIFICADO: Pega a rota ativa
                const rotaAtiva = todasAsRotas[rotaAtivaId];
                if (!rotaAtiva) {
                    mostrarAviso("Nenhuma rota ativa para exportar.");
                    return;
                }
                const entregas = rotaAtiva.entregas;

                // Garante que o array 'entregas' está na ordem da tela antes de exportar
                salvarLocalStorage(); 

                // 2. Prepara Relatório de Entregas Concluídas
                const entregasConcluidas = entregas.filter(e => e.status === 'Entregue');
                // NOVO: Prepara Relatório de Canceladas
                const entregasCanceladas = entregas.filter(e => e.status === 'Cancelada');
                
                let relatorioTexto = "Nenhuma entrega finalizada.\n";
                let whatsappTexto = `*Resumo da Rota: ${rotaAtiva.nome}* (${new Date(rotaAtiva.data + 'T12:00:00').toLocaleDateString('pt-BR')})\n\n`;

                if (entregasConcluidas.length > 0 || entregasCanceladas.length > 0) {
                    relatorioTexto = ""; // Limpa a mensagem padrão
                }

                if (entregasConcluidas.length > 0) {
                    relatorioTexto += "--- RELATÓRIO DE ENTREGAS ---\n\n";
                    entregasConcluidas.forEach(e => {
                        relatorioTexto += `Cliente: ${e.cliente.nome}\n`; // MODIFICADO
                        relatorioTexto += `Valor: ${formatarMoeda(e.cesta.valor)}\n`;
                        relatorioTexto += `Pagamento: ${e.formaPagamento.join(', ')}\n`;
                        relatorioTexto += `Horário: ${formatarData(e.horarioEntrega)}\n`;
                        relatorioTexto += `-----------------------------\n`;
                    });
                }

                // NOVO: Adiciona Canceladas ao relatório
                if (entregasCanceladas.length > 0) {
                    relatorioTexto += "\n--- ENTREGAS CANCELADAS ---\n\n";
                    entregasCanceladas.forEach(e => {
                        relatorioTexto += `Cliente: ${e.cliente.nome}\n`; // MODIFICADO
                        relatorioTexto += `Horário: ${formatarData(e.horarioEntrega)}\n`; // Canceled time
                        relatorioTexto += `-----------------------------\n`;
                    });
                }
                
                // 3. Prepara Texto para WhatsApp (Lista de Pendentes + Relatório)
                const entregasPendentes = entregas.filter(e => e.status === 'Pendente');
                whatsappTexto += `*Entregas Pendentes (${entregasPendentes.length})*:\n`;
                if(entregasPendentes.length > 0) {
                    entregasPendentes.forEach((e, index) => {
                        whatsappTexto += `${index + 1}. *${e.cliente.nome}*\n`; // MODIFICADO
                        // NOVO: Adiciona endereço e complemento no resumo
                        if (e.cliente.endereco) {
                            whatsappTexto += `   End: ${e.cliente.endereco}\n`;
                        }
                        if (e.cliente.complemento) {
                            whatsappTexto += `   Comp: ${e.cliente.complemento}\n`;
                        }
                        whatsappTexto += `   Cesta: ${e.cesta.nome} (${formatarMoeda(e.cesta.valor)})\n`;
                        
                        // Bloco modificado para incluir OBS Cliente, Brinde e Cesta
                        if (e.brinde === 'Sim') {
                            whatsappTexto += `   BRINDE: Sim\n`;
                        }
                        if (e.observacao) {
                            whatsappTexto += `   OBS (Cliente): ${e.observacao}\n`;
                        }
                        if(e.tipo === 'Alterada') {
                            if (e.codigoAlterada) {
                                whatsappTexto += `   OBS (Cesta): ${e.codigoAlterada}\n`;
                            }
                            if (e.partesAlteradas && e.partesAlteradas.length > 0) {
                                whatsappTexto += `   Partes Alteradas: ${e.partesAlteradas.join(', ')}\n`;
                            }
                        }
                    });
                } else {
                    whatsappTexto += `Nenhuma entrega pendente.\n`;
                }
                
                // NOVO: Seção Relatório Financeiro
                whatsappTexto += `\n\n--- RELATÓRIO FINANCEIRO ---\n`;
                
                let totalVendido = 0;
                let totalPorCesta = {};
                let totalPorPagamento = {};

                entregasConcluidas.forEach(e => {
                    const valor = e.cesta.valor;
                    totalVendido += valor;
                    
                    // Total por Cesta
                    totalPorCesta[e.cesta.nome] = (totalPorCesta[e.cesta.nome] || 0) + valor;

                    // Total por Pagamento
                    if (e.formaPagamento.length === 0) {
                         totalPorPagamento['N/A'] = (totalPorPagamento['N/A'] || 0) + valor;
                    } else {
                        // Se houver múltiplas formas, divide o valor igualmente entre elas
                        const valorDividido = valor / e.formaPagamento.length;
                        e.formaPagamento.forEach(forma => {
                            totalPorPagamento[forma] = (totalPorPagamento[forma] || 0) + valorDividido;
                        });
                    }
                });

                whatsappTexto += `\n*Vendas Concluídas:*\n`;
                whatsappTexto += `Total Vendido: *${formatarMoeda(totalVendido)}*\n`;

                whatsappTexto += `\n*Detalhado por Cesta:*\n`;
                if (Object.keys(totalPorCesta).length > 0) {
                    Object.keys(totalPorCesta).forEach(nomeCesta => {
                        whatsappTexto += `   ${nomeCesta}: ${formatarMoeda(totalPorCesta[nomeCesta])}\n`;
                    });
                } else {
                    whatsappTexto += `   Nenhuma.\n`;
                }

                whatsappTexto += `\n*Recebimentos por Forma:*\n`;
                if (Object.keys(totalPorPagamento).length > 0) {
                    Object.keys(totalPorPagamento).forEach(forma => {
                        whatsappTexto += `   ${forma}: ${formatarMoeda(totalPorPagamento[forma])}\n`;
                    });
                } else {
                     whatsappTexto += `   Nenhum.\n`;
                }

                // Despesas
                const despesas = rotaAtiva.despesas;
                const totalDespesas = (despesas.abastecimento || 0) + (despesas.alimentacao || 0) + (despesas.extra || 0);
                
                whatsappTexto += `\n*Despesas da Rota:*\n`;
                whatsappTexto += `   Abastecimento: ${formatarMoeda(despesas.abastecimento || 0)}\n`;
                whatsappTexto += `   Alimentação: ${formatarMoeda(despesas.alimentacao || 0)}\n`;
                whatsappTexto += `   Extras: ${formatarMoeda(despesas.extra || 0)}\n`;
                whatsappTexto += `Total Despesas: *${formatarMoeda(totalDespesas)}*\n`;

                // Balanço Final
                const balanco = totalVendido - totalDespesas;
                whatsappTexto += `\n*BALANÇO FINAL (Vendido - Despesas):*\n`;
                whatsappTexto += `*${formatarMoeda(balanco)}*\n`;
                // FIM RELATÓRIO FINANCEIRO


                whatsappTexto += `\n${relatorioTexto}`; // Adiciona o relatório de entregues/canceladas

                exportRelatorioEl.querySelector('pre').textContent = relatorioTexto;
                
                // 4. Cria link do WhatsApp
                const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(whatsappTexto)}`;
                exportWhatsappLinkEl.innerHTML = `
                    <a href="${whatsappUrl}" target="_blank" class="inline-flex items-center justify-center w-full rounded-md border border-transparent bg-green-500 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-green-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM5.5 8.5A1.5 1.5 0 017 7h6a1.5 1.5 0 011.5 1.5v3A1.5 1.5 0 0113 13H7a1.5 1.5 0 01-1.5-1.5v-3z" /></svg>
                        Enviar Resumo no WhatsApp
                    </a>`;

                // 5. Exibe Modal
                modalExportar.classList.remove('hidden');
            }

            /**
             * Lida com o carregamento de dados (JSON)
             */
            function carregarDados(jsonDados) {
                if (!jsonDados) {
                    mostrarAviso("O arquivo está vazio ou não pôde ser lido.");
                    return;
                }
                
                try {
                    const dadosCarregados = JSON.parse(jsonDados);
                    
                    // Caso 1: É o formato NOVO (Objeto Rota)
                    if (typeof dadosCarregados === 'object' && !Array.isArray(dadosCarregados) && dadosCarregados.entregas) {
                        
                        if (!dadosCarregados.id || !dadosCarregados.nome || !dadosCarregados.data) {
                            throw new Error('Objeto de rota inválido. Faltando id, nome ou data.');
                        }

                        // Checa conflito de ID
                        let novoId = dadosCarregados.id;
                        if (todasAsRotas[novoId]) {
                            // Conflito! Gera um novo ID
                            novoId = `import-${Date.now()}`;
                        }
                        dadosCarregados.id = novoId;

                        // NOVO: Garante que os novos campos existem
                        dadosCarregados.despesas = dadosCarregados.despesas || { abastecimento: 0, alimentacao: 0, extra: 0 };
                        dadosCarregados.entregas = dadosCarregados.entregas.map(e => ({
                            ...e,
                            // Garante que o cliente é um objeto (compatibilidade com formato antigo)
                            cliente: typeof e.cliente === 'object' ? e.cliente : {
                                nome: e.codigoCliente || 'Cliente Antigo', // Tenta migrar do campo antigo
                                celular: '',
                                endereco: e.codigoCliente || 'Sem Endereço',
                                complemento: ''
                                // id será undefined, o que é ok
                            }
                        }));

                        todasAsRotas[novoId] = dadosCarregados; // Adiciona nova rota
                        rotaAtivaId = novoId; // Torna a rota carregada ativa
                        
                        salvarTodasAsRotas();
                        popularSelectRotas();
                        carregarRotaAtiva();

                    } 
                    // Caso 2: É o formato ANTIGO (Array de Entregas)
                    else if (Array.isArray(dadosCarregados)) {
                        // Carrega os dados na ROTA ATIVA ATUAL
                        const rotaAtiva = todasAsRotas[rotaAtivaId];
                        if (!rotaAtiva) {
                             mostrarAviso("Nenhuma rota ativa. Crie uma nova rota antes de carregar um arquivo antigo.");
                             return;
                        }

                        // Validação mais profunda (opcional, mas bom)
                        if (dadosCarregados.length > 0 && (!dadosCarregados[0].id)) {
                             throw new Error('Estrutura de dados antiga incompatível.');
                        }

                        // Mapeia os dados carregados para garantir que os novos campos existam
                        // MODIFICADO: Mapeamento de dados antigos para novos
                        rotaAtiva.entregas = dadosCarregados.map(e => ({
                            ...e,
                            brinde: e.brinde || 'Não',
                            partesAlteradas: e.partesAlteradas || [],
                            // Garante que o cliente é um objeto
                            cliente: typeof e.cliente === 'object' ? e.cliente : {
                                nome: e.codigoCliente || 'Cliente Antigo',
                                celular: '',
                                endereco: e.codigoCliente || 'Sem Endereço',
                                complemento: ''
                                // id será undefined
                            }
                        }));
                        
                        salvarTodasAsRotas(); // Salva os novos dados na rota ativa
                        renderizarEntregas(); // Renderiza na tela

                    } else {
                        throw new Error('Formato de arquivo JSON desconhecido.');
                    }

                } catch (error) {
                    console.error("Erro ao carregar JSON:", error);
                    mostrarAviso(`Dados inválidos. Verifique o arquivo. (Erro: ${error.message})`);
                }
            }

            /**
             * Lida com o arquivo selecionado pelo usuário
             */
            function handleArquivoCarregado(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        carregarDados(event.target.result);
                    } catch (error) {
                        mostrarAviso(`Erro ao processar o arquivo: ${error.message}`);
                    }
                };
                reader.onerror = () => {
                    mostrarAviso('Não foi possível ler o arquivo.');
                };
                reader.readAsText(file);
                
                // Reseta o input para permitir carregar o mesmo arquivo novamente
                e.target.value = null;
            }
            
            // --- Inicialização e Event Listeners ---

            // NOVO: Listeners Top Bar
            btnModoAdmin.addEventListener('click', () => {
                document.body.classList.remove('modo-entregador');
                // Atualiza estilo do botão
                btnModoAdmin.classList.add('bg-blue-500', 'text-white');
                btnModoAdmin.classList.remove('bg-gray-600', 'text-gray-200', 'hover:bg-gray-500');
                btnModoEntregador.classList.add('bg-gray-600', 'text-gray-200', 'hover:bg-gray-500');
                btnModoEntregador.classList.remove('bg-blue-500', 'text-white');
            });
            btnModoEntregador.addEventListener('click', () => {
                document.body.classList.add('modo-entregador');
                // Atualiza estilo do botão
                btnModoEntregador.classList.add('bg-blue-500', 'text-white');
                btnModoEntregador.classList.remove('bg-gray-600', 'text-gray-200', 'hover:bg-gray-500');
                btnModoAdmin.classList.add('bg-gray-600', 'text-gray-200', 'hover:bg-gray-500');
                btnModoAdmin.classList.remove('bg-blue-500', 'text-white');
            });


            // NOVO: Gerenciamento de Rotas
            selectRotaAtiva.addEventListener('change', (e) => {
                rotaAtivaId = e.target.value;
                localStorage.setItem('rotaAtivaId', rotaAtivaId); // Salva a seleção
                carregarRotaAtiva();
            });
            btnNovaRota.addEventListener('click', () => criarNovaRota(true));
            // Atualiza nome/data ao perder o foco (change)
            inputNomeRota.addEventListener('change', atualizarInfoRota);
            inputDataRota.addEventListener('change', atualizarInfoRota);
            btnExcluirRota.addEventListener('click', excluirRotaAtiva);

            // NOVO: Listeners de Despesas
            inputDespesaAbastecimento.addEventListener('change', salvarDespesas);
            inputDespesaAlimentacao.addEventListener('change', salvarDespesas);
            inputDespesaExtra.addEventListener('change', salvarDespesas);

            // NOVO: Listener para seleção de cliente
            inputCliente.addEventListener('input', (e) => {
                const nome = e.target.value.toLowerCase();
                const cliente = CLIENTES_CACHE[nome];
                if (cliente) {
                    displayClienteEndereco.textContent = cliente.endereco || '-';
                    displayClienteComplemento.textContent = cliente.complemento || '-';
                    displayClienteCelular.textContent = cliente.celular || '-';
                    infoClienteSelecionado.classList.remove('hidden');
                } else {
                    infoClienteSelecionado.classList.add('hidden');
                }
            });


            // Inputs do Formulário
            selectCesta.addEventListener('change', atualizarValorCesta);
            document.querySelectorAll('input[name="tipo-cesta"]').forEach(radio => {
                radio.addEventListener('change', toggleCampoAlterada);
            });
            formEntrega.addEventListener('submit', adicionarEntrega);

            // Lista de Entregas (Delegação de Evento)
            listaEntregasEl.addEventListener('click', handleCardClick);

            // Modal de Pagamento
            btnCancelarPagamento.addEventListener('click', fecharModalPagamento);
            formPagamento.addEventListener('submit', salvarPagamento);

            // Ações Globais (Exportar/Carregar)
            btnExportar.addEventListener('click', exportarDados);
            btnFecharExportar.addEventListener('click', () => modalExportar.classList.add('hidden'));

            // Listener para o novo botão de download
            document.getElementById('btn-baixar-json').addEventListener('click', () => {
                const rotaAtiva = todasAsRotas[rotaAtivaId];
                if (!rotaAtiva) return;
                
                salvarLocalStorage(); // Garante que a ordem está correta
                
                // MODIFICADO: Exporta o objeto da Rota Ativa, não só as entregas
                const jsonDados = JSON.stringify(rotaAtiva, null, 2);
                
                // Cria um nome de arquivo descritivo
                const nomeArquivo = `rota_${rotaAtiva.nome.replace(/[^a-z0-9]/gi, '_')}_${rotaAtiva.data}.json`;
                
                downloadArquivo(jsonDados, nomeArquivo);
            });

            // Listener para o botão Carregar (agora trigga o input)
            btnCarregar.addEventListener('click', () => {
                document.getElementById('input-carregar-arquivo').click();
            });

            // Listener para o input de arquivo
            document.getElementById('input-carregar-arquivo').addEventListener('change', handleArquivoCarregado);

            // Modal de Aviso
            btnFecharAviso.addEventListener('click', fecharAviso);

            // Carrega dados do LocalStorage ao iniciar
            iniciarAplicativo(); // NOVO
            
            // NOVO: Define o valor padrão da cesta no início
            atualizarValorCesta();
        });
    </script>
</body>
</html>



