<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rota de Entrega</title>
    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca SortableJS REMOVIDA -->
    <style>
        /* ... (Estilos .entregue e .cancelada sem alteração) ... */

        /* Classe para item entregue */
        .entregue {
            background-color: #f0fdf4; /* green-50 */
            border-left-width: 4px;
            border-left-color: #22c55e; /* green-500 */
        }
        .entregue .btn-entregue {
            background-color: #22c55e; /* green-500 */
            color: white;
        }

        /* NOVO: Classe para item cancelado */
        .cancelada {
            background-color: #f3f4f6; /* gray-100 */
            border-left-width: 4px;
            border-left-color: #6b7280; /* gray-500 */
            opacity: 0.7;
        }
        .cancelada .btn-entregue,
        .cancelada .btn-card-maps,
        .cancelada .btn-mover-cima,
        .cancelada .btn-mover-baixo,
        .cancelada .btn-cancelar-entrega {
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* NOVO: Estilo para o <select> de rotas */
        #select-rota-ativa {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25em 1.25em;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <!-- Container Principal -->
    <div class="container mx-auto max-w-5xl p-4 sm:p-6 lg:p-8">

        <!-- Cabeçalho -->
        <header class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center">
            <h1 class="text-3xl font-bold text-gray-800">Rota de Entrega</h1>
            <!-- NOVO: Botão Nova Rota -->
            <button id="btn-nova-rota" class="mt-2 sm:mt-0 w-full sm:w-auto flex justify-center items-center rounded-md border border-transparent bg-indigo-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-indigo-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                Nova Rota
            </button>
        </header>

        <!-- NOVO: Seção de Gerenciamento da Rota Ativa -->
        <section class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Gerenciar Rota Ativa</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <!-- Coluna 1: Selecionar Rota -->
                <div class="md:col-span-1">
                    <label for="select-rota-ativa" class="block text-sm font-medium text-gray-700">Carregar Rota Salva</label>
                    <select id="select-rota-ativa" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base">
                        <!-- Opções carregadas via JS -->
                    </select>
                </div>
                <!-- Coluna 2: Nome e Data -->
                <div class="md:col-span-1 grid grid-cols-2 gap-4">
                    <div>
                        <label for="input-nome-rota" class="block text-sm font-medium text-gray-700">Nome da Rota</label>
                        <input type="text" id="input-nome-rota" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Ex: Entregas Manhã">
                    </div>
                    <div>
                        <label for="input-data-rota" class="block text-sm font-medium text-gray-700">Data da Rota</label>
                        <input type="date" id="input-data-rota" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base">
                    </div>
                </div>
                 <!-- Coluna 3: Dia da Semana e Excluir -->
                <div class="md:col-span-1 flex items-end justify-between gap-4">
                     <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700">Dia da Semana</label>
                        <span id="display-dia-semana" class="mt-1 block w-full rounded-md bg-gray-100 border border-gray-300 py-3 px-4 text-base font-medium text-gray-600 truncate">-</span>
                    </div>
                    <button id="btn-excluir-rota" class="rounded-md bg-red-600 p-3 text-sm font-medium text-white shadow-sm hover:bg-red-700" title="Excluir Rota Ativa">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            </div>
        </section>
        <!-- FIM NOVA SEÇÃO -->

        <!-- Seção de Lançamento -->
        <section class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Lançar Nova Entrega</h2>
            <form id="form-entrega" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                
                <!-- Coluna 1: Cliente e Cesta -->
                <div class="md:col-span-1 space-y-4">
                    <div>
                        <label for="codigo-cliente" class="block text-sm font-medium text-gray-700">Código/Endereço Cliente</label>
                        <!-- AUMENTADO: py-3, px-4, text-base -->
                        <input type="text" id="codigo-cliente" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Ex: Rua Fictícia, 123">
                    </div>
                    <!-- NOVO CAMPO DE OBSERVAÇÃO -->
                    <div>
                        <label for="obs-cliente" class="block text-sm font-medium text-gray-700">Observação (Opcional)</label>
                        <!-- AUMENTADO: py-3, px-4, text-base -->
                        <input type="text" id="obs-cliente" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Ex: Casa azul, portão branco">
                    </div>
                    <!-- FIM NOVO CAMPO -->
                    <div>
                        <label for="select-cesta" class="block text-sm font-medium text-gray-700">Cesta Básica</label>
                        <!-- AUMENTADO: py-3, px-4, text-base -->
                        <select id="select-cesta" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base">
                            <option value="" data-valor="0">Selecione...</option>
                            <option value="Mini Bonini" data-valor="165.00">Mini Bonini</option>
                            <option value="Mini Koblenz" data-valor="170.00">Mini Koblenz</option>
                            <option value="Pequena Bonini" data-valor="215.00">Pequena Bonini</option>
                            <option value="Pequena Koblenz" data-valor="220.00">Pequena kolenz</option>
                            <option value="Média Bonini" data-valor="320.00">Média Bonini</option>
                            <option value="Média Koblenz" data-valor="325.00">Média Koblenz</option>
                            <option value="Grande Bonini" data-valor="380.00">Grande Bonini</option>
                            <option value="Grande Koblenz" data-valor="390.00">Grande koblenz</option>
                        </select>
                    </div>
                </div>

                <!-- Coluna 2: Tipo e Valor -->
                <div class="md:col-span-1 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tipo da Cesta</label>
                        <div class="mt-2 flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="tipo-cesta" value="Normal" checked class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Normal</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="tipo-cesta" value="Alterada" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Alterada</span>
                            </label>
                        </div>
                    </div>
                    <!-- NOVO CAMPO: Brinde -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Brinde?</label>
                        <div class="mt-2 flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="brinde" value="Não" checked class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Não</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="brinde" value="Sim" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Sim</span>
                            </label>
                        </div>
                    </div>
                    <!-- FIM NOVO CAMPO: Brinde -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                        <!-- AUMENTADO: h-auto, py-3, px-4, text-base -->
                        <div id="display-valor" class="mt-1 p-2 h-auto flex items-center bg-gray-100 rounded-md border border-gray-300 text-gray-800 font-semibold py-3 px-4 text-base">
                            0.00
                        </div>
                    </div>
                </div>
                
                <!-- Coluna 3: Campo Alterada e Botões -->
                <div class="md:col-span-1 space-y-4">
                    <div id="campo-alterada" class="hidden space-y-4">
                        <div>
                            <label for="codigo-alterada" class="block text-sm font-medium text-gray-700">Detalhe (Cesta Alterada)</label>
                            <!-- AUMENTADO: py-3, px-4, text-base -->
                            <input type="text" id="codigo-alterada" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Ex: Sem arroz, +1 feijão">
                        </div>

                        <!-- NOVO CAMPO: Partes Alteradas -->
                        <div id="campo-partes-alteradas">
                            <label class="block text-sm font-medium text-gray-700">Partes Alteradas (Múltiplo)</label>
                            <div class="mt-2 space-y-2">
                                <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                                    <input type="checkbox" name="partes_alteradas" value="Arroz" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                                    <span class="ml-3 text-sm font-medium text-gray-700">Arroz</span>
                                </label>
                                <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                                    <input type="checkbox" name="partes_alteradas" value="Alimento" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                                    <span class="ml-3 text-sm font-medium text-gray-700">Alimento</span>
                                </label>
                                <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                                    <input type="checkbox" name="partes_alteradas" value="Limpeza" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                                    <span class="ml-3 text-sm font-medium text-gray-700">Limpeza</span>
                                </label>
                            </div>
                        </div>
                        <!-- FIM NOVO CAMPO -->
                    </div>
                    <div class="pt-6 flex flex-col">
                        <!-- AUMENTADO: py-3 -->
                        <button type="submit" class="w-full flex justify-center items-center rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            Lançar Entrega
                        </button>
                    </div>
                </div>
            </form>
        </section>

        <!-- Seção da Lista de Entregas -->
        <section>
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-700">Entregas na Rota</h2>
                <div class="flex space-x-2 mt-4 sm:mt-0">
                    <!-- AUMENTADO: py-3 -->
                    <button id="btn-exportar" class="rounded-md bg-green-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-green-700">Exportar Rota</button>
                    <!-- AUMENTADO: py-3 -->
                    <button id="btn-carregar" class="rounded-md bg-gray-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-gray-700">Carregar Rota</button>
                </div>
            </div>
            
            <!-- Lista de Cards de Entrega -->
            <div id="lista-entregas" class="space-y-3 min-h-[100px]">
                <!-- Cards serão injetados aqui pelo JavaScript -->
            </div>
            <p id="lista-vazia" class="text-center text-gray-500 py-6">Nenhuma entrega na rota.</p>
        </section>
    </div>

    <!-- Modal de Pagamento (Oculto por padrão) -->
    <div id="modal-pagamento" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <form id="form-pagamento">
                <!-- ... (conteúdo do modal sem alteração) ... -->
                <div class="p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Confirmar Entrega e Pagamento</h3>
                    <p class="text-sm text-gray-600 mb-1">Cliente: <strong id="modal-cliente-nome"></strong></p>
                    <p class="text-sm text-gray-600 mb-4">Valor: <strong id="modal-cliente-valor"></strong></p>
                    
                    <label class="block text-sm font-medium text-gray-700 mb-2">Forma(s) de Pagamento (Selecione ao menos uma):</label>
                    <div id="modal-error-pagamento" class="text-red-600 text-sm mb-2 hidden">É obrigatório selecionar ao menos uma forma de pagamento.</div>
                    <div class="space-y-2">
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                            <input type="checkbox" name="forma_pagamento" value="Dinheiro" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">Dinheiro</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                            <input type="checkbox" name="forma_pagamento" value="Pix" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">Pix</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                            <input type="checkbox" name="forma_pagamento" value="Cartão" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">Cartão</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                            <input type="checkbox" name="forma_pagamento" value="Fiado" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">Fiado</span>
                        </label>
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3 rounded-b-lg">
                    <!-- AUMENTADO: py-3 -->
                    <button type="button" id="btn-cancelar-pagamento" class="rounded-md border border-gray-300 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Cancelar</button>
                    <!-- AUMENTADO: py-3 -->
                    <button type="submit" id="btn-confirmar-pagamento" class="rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700">Confirmar Entrega</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Exportar (Oculto por padrão) -->
    <div id="modal-exportar" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl m-4">
            <div class="p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Exportar Rota</h3>
                
                <label class="block text-sm font-medium text-gray-700 mb-2">Backup da Rota (Arquivo)</label>
                <!-- AUMENTADO: py-3 -->
                <button type="button" id="btn-baixar-json" class="w-full flex justify-center items-center rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Baixar Arquivo da Rota (.json)
                </button>

                <h4 class="text-lg font-semibold text-gray-700 mt-6 mb-2">Relatório de Entregas Concluídas</h4>
                <div id="export-relatorio" class="w-full max-h-48 overflow-y-auto p-2 border border-gray-300 rounded-md bg-gray-50">
                    <pre class="text-xs text-gray-700">Nenhuma entrega concluída.</pre>
                </div>

                <div id="export-whatsapp-link" class="mt-4">
                    <!-- Link do WhatsApp será gerado aqui -->
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end rounded-b-lg">
                <!-- AUMENTADO: py-3 -->
                <button type="button" id="btn-fechar-exportar" class="rounded-md border border-gray-300 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Carregar (Oculto por padrão) -->
    <!-- REMOVIDO MODAL DE CARREGAR (AGORA É FEITO VIA INPUT DE ARQUIVO) -->

    <!-- Modal de Aviso (Oculto por padrão) -->
    <div id="modal-aviso" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm m-4">
            <div class="p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Atenção</h3>
                <p id="modal-aviso-texto" class="text-gray-600 mb-6">Mensagem de aviso.</p>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end rounded-b-lg">
                <!-- AUMENTADO: py-3 -->
                <button type="button" id="btn-fechar-aviso" class="rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700">OK</button>
            </div>
        </div>
    </div>

    <!-- Input de Arquivo (Oculto) -->
    <input type="file" id="input-carregar-arquivo" class="hidden" accept=".json,application/json">


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Seletores de Elementos ---
            // NOVO: Seletores de Gerenciamento
            const btnNovaRota = document.getElementById('btn-nova-rota');
            const selectRotaAtiva = document.getElementById('select-rota-ativa');
            const inputNomeRota = document.getElementById('input-nome-rota');
            const inputDataRota = document.getElementById('input-data-rota');
            const displayDiaSemana = document.getElementById('display-dia-semana');
            const btnExcluirRota = document.getElementById('btn-excluir-rota');

            const formEntrega = document.getElementById('form-entrega');
            const codigoClienteInput = document.getElementById('codigo-cliente');
            const obsClienteInput = document.getElementById('obs-cliente'); // NOVO SELETOR
            const selectCesta = document.getElementById('select-cesta');
            const displayValor = document.getElementById('display-valor');
            const campoAlterada = document.getElementById('campo-alterada');
            const codigoAlteradaInput = document.getElementById('codigo-alterada');
            //const btnGoogleMaps = document.getElementById('btn-google-maps'); // Removido
            const listaEntregasEl = document.getElementById('lista-entregas');
            const listaVaziaEl = document.getElementById('lista-vazia');
            
            // Modais
            const modalPagamento = document.getElementById('modal-pagamento');
            const formPagamento = document.getElementById('form-pagamento');
            const btnCancelarPagamento = document.getElementById('btn-cancelar-pagamento');
            const modalClienteNome = document.getElementById('modal-cliente-nome');
            const modalClienteValor = document.getElementById('modal-cliente-valor');
            const modalErrorPagamento = document.getElementById('modal-error-pagamento');

            const btnExportar = document.getElementById('btn-exportar');
            const btnCarregar = document.getElementById('btn-carregar');
            
            const modalExportar = document.getElementById('modal-exportar');
            // const exportJsonEl = document.getElementById('export-json'); // Removido
            const exportRelatorioEl = document.getElementById('export-relatorio');
            const exportWhatsappLinkEl = document.getElementById('export-whatsapp-link');
            const btnFecharExportar = document.getElementById('btn-fechar-exportar');

            // Modal Carregar (Removido)
            // ...

            // Modal de Aviso
            const modalAviso = document.getElementById('modal-aviso');
            const modalAvisoTexto = document.getElementById('modal-aviso-texto');
            const btnFecharAviso = document.getElementById('btn-fechar-aviso');

            // --- Estado da Aplicação ---
            // let entregas = []; // Removido
            let todasAsRotas = {}; // NOVO: Objeto para guardar todas as rotas
            let rotaAtivaId = null; // NOVO: ID da rota sendo visualizada
            const MAX_ROTAS = 30; // Limite de rotas salvas

            let entregaParaPagarId = null; // ID da entrega no modal de pagamento

            // --- Funções ---

            /**
             * Exibe o modal de aviso com uma mensagem
             */
            function mostrarAviso(mensagem) {
                modalAvisoTexto.textContent = mensagem;
                modalAviso.classList.remove('hidden');
            }

            /**
             * Fecha o modal de aviso
             */
            function fecharAviso() {
                modalAviso.classList.add('hidden');
            }

            /**
             * Formata um valor numérico para o formato de moeda BRL (R$ 123,45)
             */
            function formatarMoeda(valor) {
                return parseFloat(valor).toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
            }
            
            /**
             * Formata um ISO Date String (ou Date obj) para um formato legível (dd/mm/aaaa hh:mm)
             */
            function formatarData(isoString) {
                if (!isoString) return '';
                const data = new Date(isoString);
                return data.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            /**
             * NOVO: Formata uma data YYYY-MM-DD para "Dia da Semana"
             */
            function getDiaDaSemana(dataString) {
                if (!dataString) return '-';
                // Adiciona T12:00:00 para evitar problemas de fuso horário com new Date()
                const data = new Date(dataString + 'T12:00:00');
                const dias = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];
                return dias[data.getUTCDay()];
            }

            /**
             * Atualiza o display de valor quando a cesta é selecionada
             */
            function atualizarValorCesta() {
                const selectedOption = selectCesta.options[selectCesta.selectedIndex];
                const valor = selectedOption.dataset.valor || "0";
                displayValor.textContent = formatarMoeda(valor);
            }

            /**
             * Mostra/oculta o campo de "cesta alterada"
             */
            function toggleCampoAlterada() {
                const tipo = document.querySelector('input[name="tipo-cesta"]:checked').value;
                if (tipo === 'Alterada') {
                    campoAlterada.classList.remove('hidden');
                    codigoAlteradaInput.required = true;
                } else {
                    campoAlterada.classList.add('hidden');
                    codigoAlteradaInput.required = false;
                    codigoAlteradaInput.value = '';
                    // NOVO: Reseta checkboxes
                    document.querySelectorAll('input[name="partes_alteradas"]:checked').forEach(cb => {
                        cb.checked = false;
                    });
                }
            }

            /**
             * NOVO: Retorna a lista de entregas da rota ativa
             */
            function getEntregasAtivas() {
                if (rotaAtivaId && todasAsRotas[rotaAtivaId]) {
                    return todasAsRotas[rotaAtivaId].entregas || [];
                }
                return [];
            }

            /**
             * Salva o estado atual de TODAS AS ROTAS no LocalStorage
             * Gerencia o limite de 30 rotas.
             */
            function salvarTodasAsRotas() {
                // Gerenciamento de limite (MAX_ROTAS)
                const chavesRotas = Object.keys(todasAsRotas);
                if (chavesRotas.length > MAX_ROTAS) {
                    // Ordena por ID (timestamp, do mais antigo ao mais novo)
                    chavesRotas.sort((a, b) => a - b);
                    // Pega as chaves que excedem o limite (as mais antigas)
                    const chavesParaExcluir = chavesRotas.slice(0, chavesRotas.length - MAX_ROTAS);
                    
                    chavesParaExcluir.forEach(chave => {
                        delete todasAsRotas[chave];
                    });
                }

                localStorage.setItem('gerenciadorDeRotas', JSON.stringify(todasAsRotas));
                
                // Salva o ID da rota ativa
                if (rotaAtivaId) {
                    localStorage.setItem('rotaAtivaId', rotaAtivaId);
                }
            }

            /**
             * NOVO: Carrega todas as rotas do LocalStorage e inicia o app
             */
            function iniciarAplicativo() {
                const dadosSalvos = localStorage.getItem('gerenciadorDeRotas');
                if (dadosSalvos) {
                    todasAsRotas = JSON.parse(dadosSalvos);
                }

                let idSalvo = localStorage.getItem('rotaAtivaId');

                // Se não houver rotas, ou o ID salvo for inválido, cria uma nova rota
                if (Object.keys(todasAsRotas).length === 0 || !todasAsRotas[idSalvo]) {
                    criarNovaRota(false); // Cria uma rota sem trocar (false)
                } else {
                    rotaAtivaId = idSalvo;
                }
                
                popularSelectRotas();
                carregarRotaAtiva();
            }

            /**
             * NOVO: Popula o <select> com as rotas salvas
             */
            function popularSelectRotas() {
                selectRotaAtiva.innerHTML = ''; // Limpa o select
                
                // Ordena as rotas pela data (mais nova primeiro)
                const rotasOrdenadas = Object.values(todasAsRotas).sort((a, b) => {
                    // Compara data (desc)
                    if (a.data > b.data) return -1;
                    if (a.data < b.data) return 1;
                    // Se datas iguais, compara por ID (desc)
                    return b.id - a.id;
                });

                rotasOrdenadas.forEach(rota => {
                    const dataFormatada = rota.data ? new Date(rota.data + 'T12:00:00').toLocaleDateString('pt-BR') : 'Sem Data';
                    const option = document.createElement('option');
                    option.value = rota.id;
                    option.textContent = `${dataFormatada} - ${rota.nome} (${rota.entregas.length} ent.)`;
                    if (rota.id.toString() === rotaAtivaId.toString()) {
                        option.selected = true;
                    }
                    selectRotaAtiva.appendChild(option);
                });
            }

            /**
             * NOVO: Carrega os dados da Rota Ativa nos campos e renderiza
             */
            function carregarRotaAtiva() {
                const rota = todasAsRotas[rotaAtivaId];
                if (!rota) {
                    console.error("Tentando carregar rota inválida:", rotaAtivaId);
                    // Se a rota ativa falhar, cria uma nova
                    criarNovaRota(false); 
                    popularSelectRotas();
                    carregarRotaAtiva(); // Tenta novamente com a nova rota
                    return;
                }

                // Atualiza os inputs de gerenciamento
                inputNomeRota.value = rota.nome;
                inputDataRota.value = rota.data;
                displayDiaSemana.textContent = getDiaDaSemana(rota.data);

                // Atualiza o <select>
                selectRotaAtiva.value = rotaAtivaId;

                // Renderiza as entregas dessa rota
                renderizarEntregas();
            }

            /**
             * NOVO: Cria uma nova rota, salva e a torna ativa
             */
            function criarNovaRota(trocarImediato = true) {
                const novoId = Date.now().toString();
                const hoje = new Date().toISOString().split('T')[0]; // Formato YYYY-MM-DD
                
                const novaRota = {
                    id: novoId,
                    nome: "Nova Rota",
                    data: hoje,
                    entregas: []
                };

                todasAsRotas[novoId] = novaRota;
                rotaAtivaId = novoId; // Torna a nova rota ativa

                salvarTodasAsRotas();
                
                if (trocarImediato) {
                    popularSelectRotas(); // Atualiza o select
                    carregarRotaAtiva(); // Carrega os (novos) dados na tela
                }
            }

            /**
             * NOVO: Atualiza o nome ou data da rota ativa
             */
            function atualizarInfoRota() {
                const rota = todasAsRotas[rotaAtivaId];
                if (!rota) return;

                rota.nome = inputNomeRota.value || "Rota Sem Nome";
                rota.data = inputDataRota.value;
                
                displayDiaSemana.textContent = getDiaDaSemana(rota.data);

                salvarTodasAsRotas();
                popularSelectRotas(); // Atualiza o texto no select
            }

            /**
             * NOVO: Exclui a rota ativa
             */
            function excluirRotaAtiva() {
                // Não deixa excluir a última rota
                if (Object.keys(todasAsRotas).length <= 1) {
                    mostrarAviso("Não é possível excluir a única rota existente.");
                    return;
                }

                // Pergunta ao usuário (usando o modal de aviso de forma "criativa")
                // NOTE: Isso não é um confirm() real, mas é o que temos sem `confirm`
                // Vamos pular a confirmação para evitar complexidade de modal
                
                delete todasAsRotas[rotaAtivaId];
                
                // Pega a primeira rota que sobrou
                rotaAtivaId = Object.keys(todasAsRotas)[0];
                
                salvarTodasAsRotas();
                popularSelectRotas();
                carregarRotaAtiva();
            }


            /**
             * Renderiza todos os cards de entrega na tela
             */
            function renderizarEntregas() {
                const entregas = getEntregasAtivas(); // MODIFICADO

                listaEntregasEl.innerHTML = ''; // Limpa a lista

                if (entregas.length === 0) {
                    listaVaziaEl.classList.remove('hidden');
                    return;
                }
                
                listaVaziaEl.classList.add('hidden');

                entregas.forEach((entrega, index) => {
                    const card = document.createElement('div');
                    card.dataset.id = entrega.id;
                    card.className = `p-4 bg-white rounded-lg shadow-sm border flex flex-col sm:flex-row items-start sm:items-center justify-between transition-all ${entrega.status === 'Entregue' ? 'entregue' : (entrega.status === 'Cancelada' ? 'cancelada' : '')}`;
                    
                    let infoTags = []; // Use an array for cleaner logic

                    if (entrega.tipo === 'Normal') {
                        infoTags.push(`<span class="text-xs font-semibold bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">Normal</span>`);
                    } else {
                        // É Alterada, mostrar tags amarelas
                        if (entrega.codigoAlterada) {
                            infoTags.push(`<span class="text-xs font-semibold bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">${entrega.codigoAlterada}</span>`);
                        }
                        if (entrega.partesAlteradas && entrega.partesAlteradas.length > 0) {
                             infoTags.push(`<span class="text-xs font-semibold bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">${entrega.partesAlteradas.join(', ')}</span>`);
                        }
                        // Se for alterada mas não tiver info, bota um default
                        if (!entrega.codigoAlterada && (!entrega.partesAlteradas || entrega.partesAlteradas.length === 0)) {
                            infoTags.push(`<span class="text-xs font-semibold bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">Alterada</span>`);
                        }
                    }

                    // NOVO: Adiciona info de Brinde
                    if (entrega.brinde === 'Sim') {
                        infoTags.push(`<span class="text-xs font-semibold bg-pink-100 text-pink-800 px-2 py-0.5 rounded-full">Brinde</span>`);
                    }

                    let statusInfo = '';
                    if (entrega.status === 'Entregue') {
                        statusInfo = `
                            <div class="text-xs text-green-700 mt-1 sm:ml-4">
                                <span class="font-semibold">Pagamento:</span> ${entrega.formaPagamento.join(', ')}<br>
                                <span class="font-semibold">Horário:</span> ${formatarData(entrega.horarioEntrega)}
                            </div>
                        `;
                    // NOVO: Status para Cancelada
                    } else if (entrega.status === 'Cancelada') {
                        statusInfo = `
                            <div class="text-xs text-red-700 mt-1 sm:ml-4">
                                <span class="font-semibold">Status:</span> CANCELADA<br>
                                <span class="font-semibold">Horário:</span> ${formatarData(entrega.horarioEntrega)}
                            </div>
                        `;
                    }

                    // NOVO: Adiciona info da Observação
                    let obsInfo = '';
                    if (entrega.observacao) {
                        obsInfo = `<p class="text-sm text-red-600 font-medium truncate" title="${entrega.observacao}">OBS: ${entrega.observacao}</p>`;
                    }
                    
                    // Lógica para desabilitar botões de mover
                    const isPrimeiro = index === 0;
                    const isUltimo = index === entregas.length - 1;
                    // NOVO: Trava botões se não estiver pendente
                    const isFinalizada = entrega.status === 'Entregue' || entrega.status === 'Cancelada';

                    card.innerHTML = `
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center">
                                <!-- NOVO: Botões de Seta -->
                                <div class="flex flex-col items-center justify-center mr-3">
                                    <button class="btn-mover-cima text-gray-400 ${isPrimeiro || isFinalizada ? 'opacity-25 cursor-not-allowed' : 'hover:text-blue-600'}" data-id="${entrega.id}" title="Mover para Cima" ${isPrimeiro || isFinalizada ? 'disabled' : ''}>
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
                                        </svg>
                                    </button>
                                    <button class="btn-mover-baixo text-gray-400 ${isUltimo || isFinalizada ? 'opacity-25 cursor-not-allowed' : 'hover:text-blue-600'}" data-id="${entrega.id}" title="Mover para Baixo" ${isUltimo || isFinalizada ? 'disabled' : ''}>
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                </div>
                                <!-- Fim Botões de Seta -->

                                <div class="truncate">
                                    <p class="text-base font-semibold text-gray-800 truncate" title="${entrega.codigoCliente}">${entrega.codigoCliente}</p>
                                    ${obsInfo} <!-- INJETADO AQUI -->
                                    <p class="text-sm text-gray-600">${entrega.cesta.nome} - <span class="font-medium">${formatarMoeda(entrega.cesta.valor)}</span></p>
                                </div>
                            </div>
                            <div class="mt-2 sm:ml-12 flex flex-wrap gap-2 items-center">
                                ${infoTags.join(' ')} <!-- Injeta as tags -->
                                ${statusInfo}
                            </div>
                        </div>
                        <div class="mt-4 sm:mt-0 sm:ml-4 flex-shrink-0 flex flex-col sm:flex-row gap-2">
                            <!-- AUMENTADO: py-3 -->
                            <button class="btn-card-maps w-full sm:w-auto rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-white text-gray-700 border border-gray-300 ${isFinalizada ? 'cursor-not-allowed opacity-50' : 'hover:bg-gray-50'}" title="Abrir no Google Maps" ${isFinalizada ? 'disabled' : ''}>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                                <span class="sm:hidden ml-2">Abrir Mapa</span>
                            </button>
                            
                            <!-- NOVO: Lógica de Botões de Ação (Entregar/Cancelar/Status) -->
                            ${entrega.status === 'Pendente' ? `
                                <button class="btn-cancelar-entrega w-full sm:w-auto rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-red-100 text-red-700 border border-red-300 hover:bg-red-200" data-id="${entrega.id}">
                                    Cancelar
                                </button>
                                <button class="btn-entregue w-full sm:w-auto rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-white text-gray-700 border border-gray-300 hover:bg-gray-50" data-id="${entrega.id}">
                                    Marcar Entrega
                                </button>
                            ` : (entrega.status === 'Entregue' ? `
                                <button class="btn-entregue w-full sm:w-auto rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-green-600 text-white cursor-not-allowed" disabled>
                                    Entregue
                                </button>
                            ` : `
                                <button class="btn-entregue w-full sm:w-auto rounded-md px-4 py-3 text-sm font-medium shadow-sm bg-gray-500 text-white cursor-not-allowed" disabled>
                                    Cancelada
                                </button>
                            `)}
                            <!-- FIM LÓGICA DE BOTÕES -->

                        </div>
                    `;
                    listaEntregasEl.appendChild(card);
                });
            }

            /**
             * Lida com o submit do formulário de nova entrega
             */
            function adicionarEntrega(e) {
                e.preventDefault();
                
                // MODIFICADO: Pega a rota ativa
                const rotaAtiva = todasAsRotas[rotaAtivaId];
                if (!rotaAtiva) {
                    mostrarAviso("Nenhuma rota ativa. Crie uma nova rota.");
                    return;
                }

                const selectedOption = selectCesta.options[selectCesta.selectedIndex];
                
                if (!selectedOption || !selectedOption.value) {
                    mostrarAviso('Por favor, selecione um tipo de cesta.');
                    return;
                }
                
                // NOVO: Coleta Partes Alteradas
                const partesAlteradasSelecionadas = 
                    Array.from(formEntrega.querySelectorAll('input[name="partes_alteradas"]:checked'))
                         .map(input => input.value);
                // NOVO: Coleta Brinde
                const brindeSelecionado = document.querySelector('input[name="brinde"]:checked').value;
                
                const novaEntrega = {
                    id: Date.now(), // ID único
                    codigoCliente: codigoClienteInput.value,
                    observacao: obsClienteInput.value, // NOVO CAMPO SALVO
                    cesta: {
                        nome: selectedOption.value,
                        valor: parseFloat(selectedOption.dataset.valor)
                    },
                    tipo: document.querySelector('input[name="tipo-cesta"]:checked').value,
                    codigoAlterada: codigoAlteradaInput.value,
                    partesAlteradas: partesAlteradasSelecionadas, // NOVO CAMPO
                    brinde: brindeSelecionado, // NOVO CAMPO
                    status: "Pendente",
                    formaPagamento: [],
                    horarioEntrega: null
                };

                // MODIFICADO: Adiciona na rota ativa
                rotaAtiva.entregas.push(novaEntrega);
                salvarTodasAsRotas(); // MODIFICADO
                renderizarEntregas();
                popularSelectRotas(); // Atualiza contagem de entregas no select

                // Limpa o formulário
                formEntrega.reset();
                atualizarValorCesta();
                toggleCampoAlterada();
            }

            /**
             * Abre o Google Maps com o código/endereço do cliente
             */
            function abrirGoogleMaps(query) {
                if (!query) {
                    mostrarAviso('O cliente não possui um código ou endereço para abrir no mapa.');
                    return;
                }
                const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
                window.open(url, '_blank');
            }

            /**
             * Abre o modal de pagamento para a entrega clicada
             */
            function abrirModalPagamento(id) {
                const entregas = getEntregasAtivas(); // MODIFICADO
                const entrega = entregas.find(e => e.id.toString() === id);
                if (!entrega) return;

                entregaParaPagarId = id;
                
                // Preenche dados do modal
                modalClienteNome.textContent = entrega.codigoCliente;
                modalClienteValor.textContent = formatarMoeda(entrega.cesta.valor);
                
                // Reseta o formulário do modal
                formPagamento.reset();
                modalErrorPagamento.classList.add('hidden');

                // Exibe o modal
                modalPagamento.classList.remove('hidden');
            }

            /**
             * Fecha o modal de pagamento
             */
            function fecharModalPagamento() {
                modalPagamento.classList.add('hidden');
                entregaParaPagarId = null;
            }

            /**
             * NOVO: Marca uma entrega como Cancelada
             */
            function cancelarEntrega(id) {
                const entregas = getEntregasAtivas(); // MODIFICADO
                const index = entregas.findIndex(e => e.id.toString() === id);
                if (index !== -1) {
                    entregas[index].status = "Cancelada";
                    entregas[index].formaPagamento = []; // Garante que está limpo
                    entregas[index].horarioEntrega = new Date().toISOString(); // Salva a hora do cancelamento
                }
                salvarTodasAsRotas(); // MODIFICADO
                renderizarEntregas();
            }

            /**
             * NOVO: Move uma entrega para cima ou para baixo na lista
             */
            function moverEntrega(id, direcao) {
                const entregas = getEntregasAtivas(); // MODIFICADO
                const index = entregas.findIndex(e => e.id.toString() === id);
                if (index === -1) return;

                if (direcao === 'cima' && index > 0) {
                    // Swap com o item anterior
                    [entregas[index - 1], entregas[index]] = [entregas[index], entregas[index - 1]];
                } else if (direcao === 'baixo' && index < entregas.length - 1) {
                    // Swap com o próximo item
                    [entregas[index + 1], entregas[index]] = [entregas[index], entregas[index + 1]];
                } else {
                    return; // Não faz nada se for o primeiro/ultimo
                }

                salvarTodasAsRotas(); // MODIFICADO
                renderizarEntregas();
            }

            /**
             * Lida com o clique nos cards (delegação de evento)
             */
            function handleCardClick(e) {
                // NOVO: Checa clique no Botão MOVER CIMA
                const btnCima = e.target.closest('.btn-mover-cima');
                if (btnCima) {
                    moverEntrega(btnCima.dataset.id, 'cima');
                    return; 
                }

                // NOVO: Checa clique no Botão MOVER BAIXO
                const btnBaixo = e.target.closest('.btn-mover-baixo');
                if (btnBaixo) {
                    moverEntrega(btnBaixo.dataset.id, 'baixo');
                    return;
                }

                // NOVO: Checa clique no Botão CANCELAR
                const btnCancelar = e.target.closest('.btn-cancelar-entrega');
                if (btnCancelar) {
                    cancelarEntrega(btnCancelar.dataset.id);
                    return; 
                }

                // Checa clique no Botão MAPA
                const btnMaps = e.target.closest('.btn-card-maps');
                if (btnMaps) {
                    const cardId = btnMaps.closest('[data-id]').dataset.id;
                    const entregas = getEntregasAtivas(); // MODIFICADO
                    const entrega = entregas.find(e => e.id.toString() === cardId);
                    if (entrega) {
                        abrirGoogleMaps(entrega.codigoCliente);
                    }
                    return; // Para a execução
                }

                // Checa clique no Botão ENTREGUE
                const target = e.target.closest('.btn-entregue');
                if (target && !target.disabled) {
                    abrirModalPagamento(target.dataset.id);
                }
            }

            /**
             * Lida com o submit do formulário de pagamento
             */
            function salvarPagamento(e) {
                e.preventDefault();
                
                const formasPagamentoSelecionadas = 
                    Array.from(formPagamento.querySelectorAll('input[name="forma_pagamento"]:checked'))
                         .map(input => input.value);
                
                if (formasPagamentoSelecionadas.length === 0) {
                    modalErrorPagamento.classList.remove('hidden');
                    return;
                }
                
                // Encontra a entrega e atualiza
                const entregas = getEntregasAtivas(); // MODIFICADO
                const index = entregas.findIndex(e => e.id.toString() === entregaParaPagarId);
                if (index !== -1) {
                    entregas[index].status = "Entregue";
                    entregas[index].formaPagamento = formasPagamentoSelecionadas;
                    entregas[index].horarioEntrega = new Date().toISOString();
                }
                
                salvarTodasAsRotas(); // MODIFICADO
                renderizarEntregas();
                fecharModalPagamento();
            }

            /**
             * Função para baixar dados como um arquivo JSON
             */
            function downloadArquivo(data, filename) {
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            /**
             * Prepara e exibe o modal de exportação
             */
            function exportarDados() {
                // MODIFICADO: Pega a rota ativa
                const rotaAtiva = todasAsRotas[rotaAtivaId];
                if (!rotaAtiva) {
                    mostrarAviso("Nenhuma rota ativa para exportar.");
                    return;
                }
                // Garante que o array 'entregas' está na ordem da tela antes de exportar
                salvarTodasAsRotas(); 

                // 1. Prepara JSON para backup/carga (Será usado no botão de download)
                // Agora exporta o objeto da rota inteira
                // ...

                // 2. Prepara Relatório de Entregas Concluídas
                const entregas = getEntregasAtivas(); // MODIFICADO
                const entregasConcluidas = entregas.filter(e => e.status === 'Entregue');
                // NOVO: Prepara Relatório de Canceladas
                const entregasCanceladas = entregas.filter(e => e.status === 'Cancelada');
                
                let relatorioTexto = "Nenhuma entrega finalizada.\n";
                let whatsappTexto = `*Resumo da Rota: ${rotaAtiva.nome}*\n`; // MODIFICADO
                whatsappTexto += `*Data: ${new Date(rotaAtiva.data + 'T12:00:00').toLocaleDateString('pt-BR')} (${getDiaDaSemana(rotaAtiva.data)})*\n\n`;

                if (entregasConcluidas.length > 0 || entregasCanceladas.length > 0) {
                    relatorioTexto = ""; // Limpa a mensagem padrão
                }

                if (entregasConcluidas.length > 0) {
                    relatorioTexto += "--- RELATÓRIO DE ENTREGAS ---\n\n";
                    entregasConcluidas.forEach(e => {
                        relatorioTexto += `Cliente: ${e.codigoCliente}\n`;
                        relatorioTexto += `Valor: ${formatarMoeda(e.cesta.valor)}\n`;
                        relatorioTexto += `Pagamento: ${e.formaPagamento.join(', ')}\n`;
                        relatorioTexto += `Horário: ${formatarData(e.horarioEntrega)}\n`;
                        relatorioTexto += `-----------------------------\n`;
                    });
                }

                // NOVO: Adiciona Canceladas ao relatório
                if (entregasCanceladas.length > 0) {
                    relatorioTexto += "\n--- ENTREGAS CANCELADAS ---\n\n";
                    entregasCanceladas.forEach(e => {
                        relatorioTexto += `Cliente: ${e.codigoCliente}\n`;
                        relatorioTexto += `Horário: ${formatarData(e.horarioEntrega)}\n`; // Canceled time
                        relatorioTexto += `-----------------------------\n`;
                    });
                }
                
                // 3. Prepara Texto para WhatsApp (Lista de Pendentes + Relatório)
                const entregasPendentes = entregas.filter(e => e.status === 'Pendente');
                whatsappTexto += `*Entregas Pendentes (${entregasPendentes.length})*:\n`;
                if(entregasPendentes.length > 0) {
                    entregasPendentes.forEach((e, index) => {
                        whatsappTexto += `${index + 1}. *${e.codigoCliente}*\n`;
                        whatsappTexto += `   Cesta: ${e.cesta.nome} (${formatarMoeda(e.cesta.valor)})\n`;
                        
                        // Bloco modificado para incluir OBS Cliente, Brinde e Cesta
                        if (e.brinde === 'Sim') {
                            whatsappTexto += `   BRINDE: Sim\n`;
                        }
                        if (e.observacao) {
                            whatsappTexto += `   OBS (Cliente): ${e.observacao}\n`;
                        }
                        if(e.tipo === 'Alterada') {
                            if (e.codigoAlterada) {
                                whatsappTexto += `   OBS (Cesta): ${e.codigoAlterada}\n`;
                            }
                            if (e.partesAlteradas && e.partesAlteradas.length > 0) {
                                whatsappTexto += `   Partes Alteradas: ${e.partesAlteradas.join(', ')}\n`;
                            }
                        }
                    });
                } else {
                    whatsappTexto += `Nenhuma entrega pendente.\n`;
                }
                
                whatsappTexto += `\n${relatorioTexto}`;

                exportRelatorioEl.querySelector('pre').textContent = relatorioTexto;
                
                // 4. Cria link do WhatsApp
                const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(whatsappTexto)}`;
                exportWhatsappLinkEl.innerHTML = `
                    <a href="${whatsappUrl}" target="_blank" class="inline-flex items-center justify-center w-full rounded-md border border-transparent bg-green-500 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-green-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM5.5 8.5A1.5 1.5 0 017 7h6a1.5 1.5 0 011.5 1.5v3A1.5 1.5 0 0113 13H7a1.5 1.5 0 01-1.5-1.5v-3z" /></svg>
                        Enviar Resumo no WhatsApp
                    </a>`;

                // 5. Exibe Modal
                modalExportar.classList.remove('hidden');
            }

            /**
             * Lida com o carregamento de dados (JSON)
             */
            function carregarDados(jsonDados) {
                if (!jsonDados) {
                    mostrarAviso("O arquivo está vazio ou não pôde ser lido.");
                    return;
                }
                
                try {
                    // MODIFICADO: Agora espera um Objeto Rota, mas checa se é o formato antigo (Array)
                    const dadosCarregados = JSON.parse(jsonDados);
                    
                    // Caso 1: É o formato NOVO (Objeto Rota)
                    if (typeof dadosCarregados === 'object' && !Array.isArray(dadosCarregados) && dadosCarregados.entregas) {
                        
                        // Validação
                        if (!dadosCarregados.id || !dadosCarregados.nome || !dadosCarregados.data) {
                            throw new Error('Objeto de rota inválido. Faltando id, nome ou data.');
                        }

                        // Checa conflito de ID
                        const novoId = todasAsRotas[dadosCarregados.id] ? Date.now().toString() : dadosCarregados.id;
                        dadosCarregados.id = novoId;

                        todasAsRotas[novoId] = dadosCarregados; // Adiciona nova rota
                        rotaAtivaId = novoId; // Torna a rota carregada ativa
                        
                        salvarTodasAsRotas();
                        popularSelectRotas();
                        carregarRotaAtiva(); // Carrega a rota recém-adicionada

                    } 
                    // Caso 2: É o formato ANTIGO (Array de Entregas)
                    else if (Array.isArray(dadosCarregados)) {
                        
                        // Validação mais profunda (opcional, mas bom)
                        if (dadosCarregados.length > 0 && (!dadosCarregados[0].id || !dadosCarregados[0].codigoCliente)) {
                             throw new Error('Estrutura de dados (array) incompatível.');
                        }
                        
                        // Carrega os dados na ROTA ATIVA ATUAL
                        const rotaAtiva = todasAsRotas[rotaAtivaId];
                        if (!rotaAtiva) {
                             throw new Error('Nenhuma rota ativa para carregar os dados.');
                        }

                        // Mapeia os dados carregados para garantir que os novos campos existam
                        rotaAtiva.entregas = dadosCarregados.map(e => ({
                            ...e,
                            brinde: e.brinde || 'Não', // Define 'Não' como padrão
                            partesAlteradas: e.partesAlteradas || [] // Define array vazio como padrão
                        }));
                        
                        salvarTodasAsRotas(); // Salva os novos dados na rota ativa
                        renderizarEntregas(); // Renderiza na tela
                        popularSelectRotas(); // Atualiza contagem

                    } else {
                        throw new Error('Formato de arquivo desconhecido.');
                    }

                } catch (error) {
                    console.error("Erro ao carregar JSON:", error);
                    mostrarAviso(`Dados inválidos. Verifique o arquivo. (Erro: ${error.message})`);
                }
            }

            /**
             * Lida com o arquivo selecionado pelo usuário
             */
            function handleArquivoCarregado(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        carregarDados(event.target.result);
                    } catch (error) {
                        mostrarAviso(`Erro ao processar o arquivo: ${error.message}`);
                    }
                };
                reader.onerror = () => {
                    mostrarAviso('Não foi possível ler o arquivo.');
                };
                reader.readAsText(file);
                
                // Reseta o input para permitir carregar o mesmo arquivo novamente
                e.target.value = null;
            }
            
            // --- Inicialização e Event Listeners ---

            // NOVO: Listeners de Gerenciamento
            btnNovaRota.addEventListener('click', () => criarNovaRota(true));
            selectRotaAtiva.addEventListener('change', (e) => {
                rotaAtivaId = e.target.value;
                localStorage.setItem('rotaAtivaId', rotaAtivaId); // Salva a troca
                carregarRotaAtiva();
            });
            inputNomeRota.addEventListener('change', atualizarInfoRota);
            inputDataRota.addEventListener('change', atualizarInfoRota);
            btnExcluirRota.addEventListener('click', excluirRotaAtiva);


            // Inputs do Formulário
            selectCesta.addEventListener('change', atualizarValorCesta);
            document.querySelectorAll('input[name="tipo-cesta"]').forEach(radio => {
                radio.addEventListener('change', toggleCampoAlterada);
            });
            formEntrega.addEventListener('submit', adicionarEntrega);

            // Lista de Entregas (Delegação de Evento)
            listaEntregasEl.addEventListener('click', handleCardClick);

            // Modal de Pagamento
            btnCancelarPagamento.addEventListener('click', fecharModalPagamento);
            formPagamento.addEventListener('submit', salvarPagamento);

            // Ações Globais (Exportar/Carregar)
            btnExportar.addEventListener('click', exportarDados);
            btnFecharExportar.addEventListener('click', () => modalExportar.classList.add('hidden'));

            // Listener para o novo botão de download
            document.getElementById('btn-baixar-json').addEventListener('click', () => {
                const rotaAtiva = todasAsRotas[rotaAtivaId];
                if (!rotaAtiva) return;
                
                salvarTodasAsRotas(); // Garante que a ordem está correta
                
                // MODIFICADO: Exporta o objeto da rota ativa, não só as entregas
                const jsonDados = JSON.stringify(rotaAtiva, null, 2); 
                const nomeArquivo = `${rotaAtiva.data}_${rotaAtiva.nome.replace(/ /g, '_') || 'rota'}.json`;
                downloadArquivo(jsonDados, nomeArquivo);
            });

            // Listener para o botão Carregar (agora trigga o input)
            btnCarregar.addEventListener('click', () => {
                document.getElementById('input-carregar-arquivo').click();
            });

            // Listener para o input de arquivo
            document.getElementById('input-carregar-arquivo').addEventListener('change', handleArquivoCarregado);

            // Modal de Aviso
            btnFecharAviso.addEventListener('click', fecharAviso);

            // Inicializa o SortableJS (Arrastar e Soltar)
            // REMOVIDO

            // Carrega dados do LocalStorage ao iniciar
            // carregarLocalStorage(); // SUBSTITUÍDO
            iniciarAplicativo(); // NOVO
        });
    </script>
</body>
</html>

