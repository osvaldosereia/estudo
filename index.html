<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Rota de Entrega Profissional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="clientes.js"></script>
    
    <style>
        /* Estilos de Status de Entrega */
        .entregue {
            background-color: #f0fdf4; /* green-50 */
            border-left-width: 4px;
            border-left-color: #22c55e; /* green-500 */
        }
        .entregue .btn-entregue {
            background-color: #22c55e; /* green-500 */
            color: white;
        }

        .cancelada {
            background-color: #f3f4f6; /* gray-100 */
            border-left-width: 4px;
            border-left-color: #6b7280; /* gray-500 */
            opacity: 0.7;
        }
        /* Desabilita bot√µes em itens cancelados */
        .cancelada .btn-entregue,
        .cancelada .btn-card-maps,
        .cancelada .btn-card-whatsapp,
        .cancelada .btn-mover-cima,
        .cancelada .btn-mover-baixo,
        .cancelada .btn-cancelar-entrega {
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Estiliza√ß√£o do <select> de rotas */
        #select-rota-ativa {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
        }
        /* Classe para transi√ß√£o suave de elementos retr√°teis */
        .collapse-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
        }
        .collapse-content.open {
            max-height: 1000px; /* Valor grande para cobrir todo o conte√∫do */
            opacity: 1;
        }
        /* Ajuste do modal de exportar para mobile (para n√£o sair da tela) */
        @media (max-width: 640px) {
            #modal-exportar > div {
                max-width: 100%;
                width: 100%;
                margin: 0;
                border-radius: 0;
                max-height: 100vh;
                overflow-y: auto;
            }
        }

        /* Otimiza√ß√£o para quebra de texto em mobile (end. e obs.) */
        .break-words-mobile {
            word-wrap: break-word; /* Para navegadores antigos */
            overflow-wrap: break-word; /* Padr√£o moderno */
            min-width: 0; /* Ajuda o flexbox a for√ßar a quebra */
        }
        
        /* Estilos para o checklist do card */
        .card-info-item {
            font-size: 0.95rem; /* Um pouco maior que 'text-sm' */
            font-weight: 500; /* Medium */
            color: #4b5563; /* Cor cinza padr√£o */
            padding-left: 1.5rem;
            position: relative;
        }
        .card-info-item::before {
            content: '‚Ä¢';
            position: absolute;
            left: 0;
            color: #6b7280; /* Cinza mais escuro */
            font-weight: bold;
        }
        /* Cores mais sutis para os itens especiais */
        .card-info-item.alterada {
            color: #b45309; /* √¢mbar-700 */
        }
        .card-info-item.brinde {
            color: #9d174d; /* Rosa escuro */
        }
        
        /* Estilo para quebras de linha em campos multiline no card */
        .card-multiline {
            white-space: pre-wrap; /* Preserva quebras de linha e wraps o texto */
            font-size: 0.95rem;
            color: #b45309;
        }
        
        /* Estilo para o chip de regi√£o ATIVO */
        .chip-regiao.active {
            background-color: #2563eb; /* blue-600 */
            color: white;
            font-weight: 600;
        }
        /* Estilo para a barra do placar (NOVO) */
        #placar-entregas {
            background-color: #1e3a8a; /* blue-900 */
        }

    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <div class="container mx-auto max-w-5xl p-4 sm:p-6 lg:p-8">

        <header class="mb-6">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-800">Gerenciador de Rotas de Entrega</h1>
                
                <button id="btn-nova-rota-simples" class="w-auto flex justify-center items-center rounded-md border border-transparent bg-green-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-green-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Nova Rota
                </button>
            </div>
        </header>
        
        <section class="bg-white p-6 rounded-lg shadow-md mb-8">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-2xl font-semibold text-gray-700">Lan√ßar Nova Entrega</h2>
                 <button id="btn-toggle-lancamento" class="text-gray-500 hover:text-gray-700 p-2 rounded-full">
                    <svg id="icon-chevron-lancamento" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                </button>
            </div>

            <div id="content-lancamento" class="collapse-content">
                <form id="form-entrega" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    
                    <div class="md:col-span-1 space-y-4">
                        <div>
                            <label for="input-cliente" class="block text-sm font-medium text-gray-700">Cliente</label>
                            <input type="text" id="input-cliente" list="lista-clientes" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Digite ou selecione um cliente...">
                            <datalist id="lista-clientes">
                                <option value="Carregando clientes..."></option> 
                            </datalist>
                        </div>

                        <div id="info-cliente-selecionado" class="hidden space-y-2 text-sm text-gray-600 border-l-4 border-blue-200 pl-3 py-2 bg-blue-50 rounded-r-md">
                            <p><strong>Endere√ßo:</strong> <span id="display-cliente-endereco">-</span></p>
                            <p><strong>Complemento:</strong> <span id="display-cliente-complemento">-</span></p>
                            <p><strong>Celular:</strong> <span id="display-cliente-celular">-</span></p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">Regi√£o da Entrega <span class="text-red-500">*</span></label>
                            <div id="radio-regioes" class="mt-2 grid grid-cols-2 gap-2 text-sm">
                                <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-300 has-[:checked]:bg-blue-100 has-[:checked]:border-blue-500">
                                    <input type="radio" name="regiao-entrega" value="COXIPO" required class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-gray-700">COXIP√ì</span>
                                </label>
                                <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-300 has-[:checked]:bg-blue-100 has-[:checked]:border-blue-500">
                                    <input type="radio" name="regiao-entrega" value="VG" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-gray-700">VG</span>
                                </label>
                                <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-300 has-[:checked]:bg-blue-100 has-[:checked]:border-blue-500">
                                    <input type="radio" name="regiao-entrega" value="CUIABA" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-gray-700">CUIAB√Å</span>
                                </label>
                                <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-300 has-[:checked]:bg-blue-100 has-[:checked]:border-blue-500">
                                    <input type="radio" name="regiao-entrega" value="CPA" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-gray-700">CPA</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label for="obs-cliente" class="block text-sm font-medium text-gray-700">Observa√ß√£o (Opcional)</label>
                            <input type="text" id="obs-cliente" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Ex: Casa azul, port√£o branco">
                        </div>
                    </div>

                    <div class="md:col-span-1 space-y-4">
                        <div class="border border-blue-200 p-3 rounded-md bg-blue-50 space-y-3">
                            <label class="block text-sm font-bold text-gray-700">Adicionar Cesta ao Pedido <span class="text-red-500">*</span></label>
                            
                            <div class="grid grid-cols-4 gap-2">
                                <div class="col-span-2">
                                    <select id="select-cesta-adicionar" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base">
                                        <option value="ESPECIAL" data-valor="000.00">ESPECIAL</option>
                                        <option value="Mini Bonini" data-valor="165.00">Mini Bonini</option>
                                        <option value="Mini Koblenz" data-valor="170.00">Mini Koblenz</option>
                                        <option value="Pequena Bonini" data-valor="215.00">Pequena Bonini</option>
                                        <option value="Pequena Koblenz" data-valor="220.00">Pequena Kolenz</option>
                                        <option value="M√©dia Bonini" data-valor="320.00">M√©dia Bonini</option>
                                        <option value="M√©dia Koblenz" data-valor="325.00">M√©dia Koblenz</option>
                                        <option value="Grande Bonini" data-valor="380.00">Grande Bonini</option>
                                        <option value="Grande Koblenz" data-valor="390.00">Grande Koblenz</option>
                                    </select>
                                </div>
                                <div class="col-span-1">
                                    <input type="number" id="input-qtd-cesta-adicionar" min="1" value="1" class="w-full text-center rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-2 text-base">
                                </div>
                                <div class="col-span-1 flex items-center">
                                    <input type="number" id="input-valor-cesta-adicionar" step="0.01" min="0" value="165.00" class="w-full text-center rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-2 text-base font-bold" placeholder="Valor">
                                </div>
                            </div>
                            
                            <div class="border-t border-blue-100 pt-3 space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Tipo (Alterada/Normal)</label>
                                    <div class="mt-2 flex space-x-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="tipo-cesta-adicionar" value="Normal" checked class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                            <span class="ml-2 text-sm text-gray-700">Normal</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="tipo-cesta-adicionar" value="Alterada" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                            <span class="ml-2 text-sm text-gray-700">Alterada</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div id="campo-alterada-adicionar" class="hidden space-y-3 p-3 bg-red-50 border border-red-200 rounded-md">
                                    <label for="codigo-alterada-adicionar" class="block text-sm font-bold text-red-700">Detalhe da Altera√ß√£o</label>
                                    <textarea id="codigo-alterada-adicionar" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 py-2 px-3 text-sm" placeholder="Ex: TIRA: Arroz, Feij√£o | POR: Caf√©, A√ß√∫car"></textarea>
                                    
                                    <div id="campo-partes-alteradas-adicionar">
                                        <label class="block text-sm font-medium text-red-700">Itens Alterados</label>
                                        <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
                                            <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-red-100 has-[:checked]:border-red-300">
                                                <input type="checkbox" name="partes_alteradas_adicionar" value="Arroz" class="h-4 w-4 border-gray-300 text-red-600 focus:ring-red-500 rounded">
                                                <span class="ml-2 font-medium text-gray-700">Arroz</span>
                                            </label>
                                            <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-red-100 has-[:checked]:border-red-300">
                                                <input type="checkbox" name="partes_alteradas_adicionar" value="Alimento" class="h-4 w-4 border-gray-300 text-red-600 focus:ring-red-500 rounded">
                                                <span class="ml-2 font-medium text-gray-700">Alimento (Geral)</span>
                                            </label>
                                            <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-red-100 has-[:checked]:border-red-300">
                                                <input type="checkbox" name="partes_alteradas_adicionar" value="Limpeza" class="h-4 w-4 border-gray-300 text-red-600 focus:ring-red-500 rounded">
                                                <span class="ml-2 font-medium text-gray-700">Limpeza</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Brinde (Opcional)</label>
                                    <div class="mt-2 grid grid-cols-3 gap-2 text-sm">
                                        <label class="flex items-center">
                                            <input type="checkbox" name="brindes_adicionar" value="Ovo" class="h-4 w-4 border-gray-300 text-pink-600 focus:ring-pink-500 rounded">
                                            <span class="ml-2 text-gray-700">Ovo</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" name="brindes_adicionar" value="Amaciante" class="h-4 w-4 border-gray-300 text-pink-600 focus:ring-pink-500 rounded">
                                            <span class="ml-2 text-gray-700">Amaciante</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" name="brindes_adicionar" value="Cafe 250g" class="h-4 w-4 border-gray-300 text-pink-600 focus:ring-pink-500 rounded">
                                            <span class="ml-2 text-gray-700">Caf√© 250g</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="button" id="btn-adicionar-cesta" class="w-full flex justify-center items-center rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                Adicionar Cesta √† Lista
                            </button>
                        </div>
                    </div>

                    <div class="md:col-span-1 space-y-4">
                        <div class="space-y-3">
                            <label class="block text-sm font-bold text-gray-700">Itens no Pedido (Total: <span id="display-total-pedido" class="text-green-600">R$ 0,00</span>)</label>
                            <div id="lista-cestas-pedido" class="space-y-2 max-h-40 overflow-y-auto p-2 bg-white rounded-md border border-gray-300">
                                <p class="text-sm text-gray-500">Nenhuma cesta adicionada.</p>
                            </div>
                            
                            <label for="input-valor-total-pedido" class="block text-sm font-medium text-gray-700">Ajuste Manual do Valor (Opcional)</label>
                            <input type="number" id="input-valor-total-pedido" step="0.01" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base font-bold text-lg" placeholder="0.00">
                        </div>
                        
                        <div class="pt-2">
                            <label class="block text-sm font-medium text-gray-700">Informa√ß√µes Adicionais do Pedido</label>
                            <div class="text-sm text-gray-600 border-l-4 border-gray-200 pl-3 py-2 bg-gray-50 rounded-r-md mt-2">
                                <p>Os detalhes de Altera√ß√£o e Brindes s√£o salvos individualmente para cada cesta acima.</p>
                            </div>
                        </div>
                        
                        <div class="pt-6 flex flex-col">
                            <button type="submit" class="w-full flex justify-center items-center rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                Lan√ßar Entrega
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </section>

        <section>
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-700">Entregas na Rota</h2>
                <div class="flex space-x-2 mt-4 sm:mt-0">
                    <button id="btn-exportar" class="rounded-md bg-green-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-green-700">Exportar Rota</button>
                    <button id="btn-carregar" class="rounded-md bg-gray-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-gray-700">Carregar Rota</button>
                </div>
            </div>
            <div id="placar-entregas" class="bg-blue-800 text-white p-4 rounded-lg shadow-lg mb-4">
            </div>

            <div id="filtros-regiao" class="flex flex-wrap gap-2 mb-4">
            </div>

            <div id="lista-entregas" class="space-y-3 min-h-[100px]">
                </div>
            <p id="lista-vazia" class="text-center text-gray-500 py-6">Nenhuma entrega na rota.</p>
        </section>
    </div>

    <div id="modal-pagamento" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <form id="form-pagamento">
                <div class="p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Confirmar Entrega e Pagamento</h3>
                    <p class="text-sm text-gray-600 mb-1">Cliente: <strong id="modal-cliente-nome"></strong></p>
                    <p class="text-sm text-gray-600 mb-4">Valor: <strong id="modal-cliente-valor"></strong></p>
                    
                    <label class="block text-sm font-medium text-gray-700 mb-2">Forma(s) de Pagamento (Selecione ao menos uma):</label>
                    <div id="modal-error-pagamento" class="text-red-600 text-sm mb-2 hidden">√â obrigat√≥rio selecionar ao menos uma forma de pagamento.</div>
                    <div class="space-y-2">
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                            <input type="checkbox" name="forma_pagamento" value="DINHEIRO" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">DINHEIRO</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                            <input type="checkbox" name="forma_pagamento" value="PIX" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">PIX</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                            <input type="checkbox" name="forma_pagamento" value="CART√ÉO" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">CART√ÉO</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                            <input type="checkbox" name="forma_pagamento" value="S√ì ENTREGAR" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">S√ì ENTREGAR</span>
                        </label>
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3 rounded-b-lg">
                    <button type="button" id="btn-cancelar-pagamento" class="rounded-md border border-gray-300 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Cancelar</button>
                    <button type="submit" id="btn-confirmar-pagamento" class="rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700">Confirmar Entrega</button>
                </div>
            </form>
        </div>
        
    </div>
    
    <div id="modal-whatsapp-opcoes" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <div class="p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Mensagens R√°pidas para <span id="modal-whatsapp-cliente-nome"></span></h3>
                <p class="text-sm text-gray-600 mb-6">Cesta: <strong id="modal-whatsapp-cesta-info"></strong></p>
                
                <div class="space-y-3">
                    <button id="btn-msg-chegando" data-msg-id="1" class="w-full text-left rounded-md border border-blue-300 bg-blue-50 px-4 py-3 text-sm font-medium text-blue-700 shadow-sm hover:bg-blue-100">
                        1. üöó Aviso de Chegada (10 minutos)
                    </button>
                    
                    <button id="btn-msg-cheguei" data-msg-id="2" class="w-full text-left rounded-md border border-blue-300 bg-blue-50 px-4 py-3 text-sm font-medium text-blue-700 shadow-sm hover:bg-blue-100">
                        2. üö™ Cheguei no local
                    </button>
                    
                    <button id="btn-msg-pix" data-msg-id="3" class="w-full text-left rounded-md border border-blue-300 bg-blue-50 px-4 py-3 text-sm font-medium text-blue-700 shadow-sm hover:bg-blue-100">
                        3. üí∞ Dados PIX para Pagamento
                    </button>

                    <button id="btn-msg-pedido" data-msg-id="4" class="w-full text-left rounded-md border border-red-300 bg-red-50 px-4 py-3 text-sm font-medium text-red-700 shadow-sm hover:bg-red-100">
                        4. üö® Enviar Pedido para Gerente (65996884599)
                    </button>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end rounded-b-lg">
                <button type="button" id="btn-fechar-whatsapp-opcoes" class="rounded-md border border-gray-300 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Fechar</button>
            </div>
        </div>
    </div>


¬†<div id="modal-exportar" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-sm m-4 overflow-hidden sm:m-8 sm:rounded-lg">
        <div class="p-6">
             <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800">Exportar Rota</h3>
                <button type="button" id="btn-fechar-exportar-top" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <h4 class="text-lg font-semibold text-gray-700 mt-2 mb-3 border-b pb-1">Regi√µes para Backup</h4>
            <div class="grid grid-cols-2 gap-3 mb-6">
                <label class="flex items-center">
                    <input type="checkbox" name="regiao-exportar" value="CUIABA" checked class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                    <span class="ml-2 text-sm font-medium text-gray-700">CUIAB√Å</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" name="regiao-exportar" value="COXIPO" checked class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                    <span class="ml-2 text-sm font-medium text-gray-700">COXIP√ì</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" name="regiao-exportar" value="VG" checked class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                    <span class="ml-2 text-sm font-medium text-gray-700">VG</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" name="regiao-exportar" value="CPA" checked class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                    <span class="ml-2 text-sm font-medium text-gray-700">CPA</span>
                </label>
            </div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Backup da Rota (Arquivo)</label>
            <button type="button" id="btn-baixar-json" class="w-full flex justify-center items-center rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Baixar Arquivo da Rota (.json)
            </button>
            
            </div>
        <div class="bg-gray-50 px-6 py-4 flex justify-end rounded-b-lg">
            <button type="button" id="btn-fechar-exportar" class="rounded-md border border-gray-300 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Fechar</button>
        </div>
    </div>
</div>

¬† ¬† <div id="modal-aviso" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
¬† ¬† ¬† ¬† <div class="bg-white rounded-lg shadow-xl w-full max-w-sm m-4">
¬† ¬† ¬† ¬† ¬† ¬† <div class="p-6">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <h3 class="text-xl font-semibold text-gray-800 mb-4">Aten√ß√£o</h3>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <p id="modal-aviso-texto" class="text-gray-600 mb-6">Mensagem de aviso.</p>
¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† ¬† <div class="bg-gray-50 px-6 py-4 flex justify-end rounded-b-lg">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <button type="button" id="btn-fechar-aviso" class="rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700">OK</button>
¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† </div>
¬† ¬† </div>
¬† ¬†¬†

¬† ¬† <input type="file" id="input-carregar-arquivo" class="hidden" accept=".json,application/json">


<script>
        /**
         * =================================================================
         * BLOCO DE C√ìDIGO JS PRINCIPAL (Revisado para Altera√ß√£o por Cesta)
         * =================================================================
         */

        // --- Constantes Globais ---
        const PIX_NOME = "Osvaldo Sereia Junior";
        const PIX_CELULAR = "65984491018";
        const NUMERO_GERENTE = "5565996884599"; 
        const NOME_EMPRESA = "Cesta B√°sica Dona Ant√¥nia";
        const MAX_ROTAS = 1; // Simplificado para apenas uma rota
        const REGIOES = ["VG", "CUIABA", "COXIPO", "CPA"];
        
        // REMOVIDO: Frases de incentivo (simplifica√ß√£o)
        const FRASES_GAMIFICADAS = [
            "Pronto para mais um dia de sucesso!",
        ]; 
        
        let indiceFrase = 0;


        // --- Estado da Aplica√ß√£o ---
        let todasAsRotas = {};
        let rotaAtivaId = null;
        let CLIENTES_CACHE = {}; 
        let entregaParaPagarId = null;
        let entregaParaWhatsappId = null; 
        let regiaoAtiva = 'VG';
        
        // NOVO: Estado tempor√°rio das cestas no formul√°rio de lan√ßamento
        let cestasNoPedido = [];


        // --- Seletores de Elementos (Inicializados no DOMContentLoaded) ---
        let btnNovaRotaSimples;
        let btnToggleLancamento, contentLancamento, iconChevronLancamento; 
        let formEntrega, inputCliente, datalistClientes, infoClienteSelecionado, displayClienteEndereco, displayClienteComplemento, displayClienteCelular, obsClienteInput, listaEntregasEl, listaVaziaEl, radioRegioes;
        let modalPagamento, formPagamento, btnCancelarPagamento, modalClienteNome, modalClienteValor, modalErrorPagamento, btnExportar, btnCarregar, modalExportar, exportRelatorioEl, exportWhatsappLinkEl, btnFecharExportar, btnFecharExportarTop, modalAviso, modalAvisoTexto, btnFecharAviso, inputCarregarArquivo;
        let modalWhatsappOpcoes, modalWhatsappClienteNome, modalWhatsappCestaInfo, btnFecharWhatsappOpcoes;
        let filtrosRegiaoEl;
        
        // NOVOS SELETORES
        let placarEntregasEl;
        let selectCestaAdicionar, inputQtdCestaAdicionar, btnAdicionarCesta, listaCestasPedidoEl, displayTotalPedidoEl, inputValorTotalPedidoEl, inputValorCestaAdicionar;
        let campoAlteradaAdicionar, codigoAlteradaAdicionar;


        function inicializarSeletores() {
            
            // Se√ß√£o Retr√°til - Lan√ßamento
            btnToggleLancamento = document.getElementById('btn-toggle-lancamento');
            contentLancamento = document.getElementById('content-lancamento');
            iconChevronLancamento = document.getElementById('icon-chevron-lancamento');

            // Lan√ßamento de Entrega
            formEntrega = document.getElementById('form-entrega');
            inputCliente = document.getElementById('input-cliente');
            datalistClientes = document.getElementById('lista-clientes');
            infoClienteSelecionado = document.getElementById('info-cliente-selecionado');
            displayClienteEndereco = document.getElementById('display-cliente-endereco');
            displayClienteComplemento = document.getElementById('display-cliente-complemento');
            displayClienteCelular = document.getElementById('display-cliente-celular');
            obsClienteInput = document.getElementById('obs-cliente');
            radioRegioes = document.getElementById('radio-regioes');
            listaEntregasEl = document.getElementById('lista-entregas');
            listaVaziaEl = document.getElementById('lista-vazia');
            filtrosRegiaoEl = document.getElementById('filtros-regiao');
            
            // NOVOS SELETORES DE LAN√áAMENTO (Multi-Cestas)
            selectCestaAdicionar = document.getElementById('select-cesta-adicionar');
            inputQtdCestaAdicionar = document.getElementById('input-qtd-cesta-adicionar');
            btnAdicionarCesta = document.getElementById('btn-adicionar-cesta');
            listaCestasPedidoEl = document.getElementById('lista-cestas-pedido');
            displayTotalPedidoEl = document.getElementById('display-total-pedido');
            inputValorTotalPedidoEl = document.getElementById('input-valor-total-pedido'); // Campo de Valor Final
            inputValorCestaAdicionar = document.getElementById('input-valor-cesta-adicionar');
            campoAlteradaAdicionar = document.getElementById('campo-alterada-adicionar');
            codigoAlteradaAdicionar = document.getElementById('codigo-alterada-adicionar');


            // Modais
            modalPagamento = document.getElementById('modal-pagamento');
            formPagamento = document.getElementById('form-pagamento');
            btnCancelarPagamento = document.getElementById('btn-cancelar-pagamento');
            modalClienteNome = document.getElementById('modal-cliente-nome');
            modalClienteValor = document.getElementById('modal-cliente-valor');
            modalErrorPagamento = document.getElementById('modal-error-pagamento');
            btnExportar = document.getElementById('btn-exportar');
            btnCarregar = document.getElementById('btn-carregar');
            modalExportar = document.getElementById('modal-exportar');
            btnFecharExportar = document.getElementById('btn-fechar-exportar');
            btnFecharExportarTop = document.getElementById('btn-fechar-exportar-top'); 
            modalAviso = document.getElementById('modal-aviso');
            modalAvisoTexto = document.getElementById('modal-aviso-texto');
            btnFecharAviso = document.getElementById('btn-fechar-aviso');
            inputCarregarArquivo = document.getElementById('input-carregar-arquivo');
            
            // Modal WhatsApp Op√ß√µes
            modalWhatsappOpcoes = document.getElementById('modal-whatsapp-opcoes');
            modalWhatsappClienteNome = document.getElementById('modal-whatsapp-cliente-nome');
            modalWhatsappCestaInfo = document.getElementById('modal-whatsapp-cesta-info');
            btnFecharWhatsappOpcoes = document.getElementById('btn-fechar-whatsapp-opcoes');
            
            // Placar
            placarEntregasEl = document.getElementById('placar-entregas');

            // NOVO: Bot√£o Nova Rota Simples
            btnNovaRotaSimples = document.getElementById('btn-nova-rota-simples');
            
        }

        // --- Fun√ß√µes de Utilit√°rios ---
        function mostrarAviso(mensagem) {
            modalAvisoTexto.textContent = mensagem;
            modalAviso.classList.remove('hidden');
        }

        function fecharAviso() {
            modalAviso.classList.add('hidden');
        }

        function formatarMoeda(valor) {
            const num = parseFloat(valor);
            if (isNaN(num)) return 'R$ 0,00';
            return num.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
        }
        
        function formatarValorFloat(valor) {
            const num = parseFloat(valor);
            return isNaN(num) ? 0.00 : parseFloat(num.toFixed(2));
        }


        function formatarData(isoString) {
            if (!isoString) return '';
            const data = new Date(isoString);
            if (isNaN(data)) return '';
            return data.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getDiaDaSemana(dataString) {
            if (!dataString) return '-';
            const data = new Date(dataString + 'T12:00:00');
            if (isNaN(data)) return '-';
            const dia = data.toLocaleDateString('pt-BR', { weekday: 'long' });
            return dia.charAt(0).toUpperCase() + dia.slice(1);
        }

        // NOVO: Fun√ß√£o para obter o valor da cesta selecionada para adicionar
        function atualizarValorCestaAdicionar() {
            const selectedOption = selectCestaAdicionar.options[selectCestaAdicionar.selectedIndex];
            const valor = selectedOption ? selectedOption.dataset.valor || "165.00" : "165.00"; 
            inputValorCestaAdicionar.value = parseFloat(valor).toFixed(2);
        }

        // NOVO: Toggle para o campo de alterada na se√ß√£o de adicionar cesta
        function toggleCampoAlteradaAdicionar() {
            // Seletor corrigido para o novo layout
            const tipo = document.querySelector('input[name="tipo-cesta-adicionar"]:checked').value; 
            if (tipo === 'Alterada') {
                campoAlteradaAdicionar.classList.remove('hidden');
            } else {
                campoAlteradaAdicionar.classList.add('hidden');
                codigoAlteradaAdicionar.value = '';
                document.querySelectorAll('input[name="partes_alteradas_adicionar"]:checked').forEach(cb => {
                    cb.checked = false;
                });
            }
        }
        
        // REMOVIDO: toggleGerenciarRota

        function toggleLancamento() {
            const isOpen = contentLancamento.classList.toggle('open');
            if (isOpen) {
                iconChevronLancamento.classList.remove('rotate-90');
                iconChevronLancamento.classList.add('rotate-180');
            } else {
                iconChevronLancamento.classList.remove('rotate-180');
                iconChevronLancamento.classList.add('rotate-90'); 
            }
        }

        /**
         * NOVO: Move a entrega para o final da lista de entregas da rota.
         * @param {string} id - ID da entrega
         */
        function moverEntregaParaOFinal(id) {
            const entregas = getEntregasAtivas();
            const index = entregas.findIndex(e => e.id.toString() === id);
            
            if (index !== -1) {
                const [entrega] = entregas.splice(index, 1);
                
                // NOVO: Inserir a entrega finalizada no final.
                entregas.push(entrega);
                
                // Re-ordenar for√ßando Pendentes primeiro
                entregas.sort((a, b) => {
                    if (a.status === 'Pendente' && b.status !== 'Pendente') return -1;
                    if (a.status !== 'Pendente' && b.status === 'Pendente') return 1;

                    // Se ambos forem finalizados, ordenar pelo hor√°rio de entrega (mais recente por √∫ltimo)
                    if (a.status !== 'Pendente' && b.status !== 'Pendente') {
                        return new Date(a.horarioEntrega) - new Date(b.horarioEntrega);
                    }

                    return 0;
                });
                
                salvarLocalStorage();
                renderizarEntregas();
            }
        }


        // --- Fun√ß√µes de Persist√™ncia (LocalStorage) ---

        function salvarTodasAsRotas() {
            const chavesRotas = Object.keys(todasAsRotas);
            // Simplifica√ß√£o: Garantimos que s√≥ haja uma rota salva
            const chavesOrdenadas = chavesRotas.sort((a, b) => parseInt(b, 10) - parseInt(a, 10));

            if (chavesOrdenadas.length > MAX_ROTAS) {
                 chavesOrdenadas.slice(MAX_ROTAS).forEach(chave => {
                    delete todasAsRotas[chave];
                });
            }
            
            try {
                localStorage.setItem('gerenciadorDeRotas', JSON.stringify(todasAsRotas));
                if (rotaAtivaId) {
                    localStorage.setItem('rotaAtivaId', rotaAtivaId);
                }
            } catch (e) {
                console.error("Erro ao salvar no LocalStorage:", e);
                mostrarAviso("Erro ao salvar dados. Seu navegador pode estar sem espa√ßo ou configurado para bloquear o LocalStorage.");
            }
        }

        function salvarLocalStorage() {
            salvarTodasAsRotas();
        }
        
        // REMOVIDO: salvarDespesasDoModal() pois despesas foram removidas do fluxo do modal.

        // --- Fun√ß√µes de Gerenciamento de Rota ---

        function iniciarAplicativo() {
            // 1. Carregar Clientes (do clientes.js)
            try {
                if (typeof CLIENTES_DB !== 'undefined' && Array.isArray(CLIENTES_DB)) {
                    datalistClientes.innerHTML = '';
                    CLIENTES_DB.forEach(cliente => {
                        const option = document.createElement('option');
                        option.value = cliente.nome;
                        datalistClientes.appendChild(option);
                        CLIENTES_CACHE[cliente.nome.toLowerCase()] = cliente;
                    });
                } else {
                    console.warn("CLIENTES_DB n√£o encontrado. O recurso de autocompletar cliente n√£o funcionar√°.");
                    datalistClientes.innerHTML = '<option value="Aviso: clientes.js n√£o carregado."></option>';
                }
            } catch (e) {
                console.error("Erro ao processar clientes:", e);
                datalistClientes.innerHTML = '<option value="Erro ao carregar clientes."></option>';
            }

            // 2. Carregar Rotas
            const dadosSalvos = localStorage.getItem('gerenciadorDeRotas');
            if (dadosSalvos) {
                try {
                    todasAsRotas = JSON.parse(dadosSalvos);
                } catch (e) {
                    console.error("Erro ao parsear rotas salvas. Resetando dados.", e);
                    todasAsRotas = {};
                }
            }

            // 3. Descobrir qual rota est√° ativa
            rotaAtivaId = localStorage.getItem('rotaAtivaId');

            // 4. Se n√£o houver rotas, ou a rota ativa n√£o existir, cria uma nova
            const chavesRotas = Object.keys(todasAsRotas);
            if (!rotaAtivaId || !todasAsRotas[rotaAtivaId]) {
                if (chavesRotas.length === 0) {
                    criarNovaRota(false);
                } else {
                    // Mant√©m a rota mais recente como ativa
                    const chavesOrdenadas = chavesRotas.sort((a, b) => parseInt(b, 10) - parseInt(a, 10));
                    rotaAtivaId = chavesOrdenadas[0];
                    localStorage.setItem('rotaAtivaId', rotaAtivaId);
                }
            }
            
            // 5. Popular filtros e carregar rota
            popularFiltrosRegiao();
            carregarRotaAtiva();
        }

        function getEntregasAtivas() {
            if (rotaAtivaId && todasAsRotas[rotaAtivaId]) {
                return todasAsRotas[rotaAtivaId].entregas;
            }
            return [];
        }
        
        /**
         * Popula os chips de filtro de regi√£o
         */
        function popularFiltrosRegiao() {
            filtrosRegiaoEl.innerHTML = '';
            
            REGIOES.forEach(regiao => {
                const button = document.createElement('button');
                button.type = 'button';
                button.dataset.regiao = regiao;
                button.textContent = regiao;
                button.className = `chip-regiao px-3 py-1 border rounded-full text-sm transition-colors ${regiao === regiaoAtiva ? 'active' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`;
                
                filtrosRegiaoEl.appendChild(button);
            });
        }

        /**
         * Filtra e renderiza as entregas com base na regi√£o ativa
         */
        function filtrarEntregas(novaRegiao) {
            if (novaRegiao) {
                regiaoAtiva = novaRegiao;
            }
            popularFiltrosRegiao();
            renderizarEntregas();
            atualizarPlacar();
        }


        function carregarRotaAtiva() {
            const rota = todasAsRotas[rotaAtivaId];
            if (!rota) {
                iniciarAplicativo(); 
                return;
            }

            // Garante que a lista de cestas do formul√°rio esteja limpa
            cestasNoPedido = [];
            renderizarListaCestasPedido();
            atualizarValorCestaAdicionar(); // Para iniciar com o valor correto
            toggleCampoAlteradaAdicionar(); // Para iniciar o campo alterada escondido

            filtrarEntregas(regiaoAtiva);
        }

        function criarNovaRota(atualizarTela = true) {
            let novoId = Date.now().toString(); 
            while(todasAsRotas[novoId]) {
                novoId = (parseInt(novoId, 10) + 1).toString();
            }
            
            const hoje = new Date().toISOString().split('T')[0];

            const novaRota = {
                id: novoId,
                nome: `Rota ${hoje}`,
                data: hoje,
                entregas: [],
                despesas: { abastecimento: 0, alimentacao: 0, extra: 0 } 
            };

            // Simplifica√ß√£o: Remove rotas antigas
            todasAsRotas = {}; 
            todasAsRotas[novoId] = novaRota;
            rotaAtivaId = novoId;

            salvarTodasAsRotas();
            
            if (atualizarTela) {
                // Redireciona a p√°gina para garantir que o localStorage esteja limpo e a rota ativa seja carregada
                window.location.reload(); 
            }
        }
        
        /**
         * NOVO: Fun√ß√£o para o bot√£o Nova Rota Simples
         */
        function resetarTudoEIniciarNovaRota() {
            if (confirm("ATEN√á√ÉO: Isso ir√° DESTRUIR A ROTA ATUAL e todas as rotas salvas! Deseja continuar?")) {
                // Limpa tudo e cria uma nova rota
                localStorage.removeItem('gerenciadorDeRotas');
                localStorage.removeItem('rotaAtivaId');
                criarNovaRota(true);
            }
        }

        // REMOVIDO: atualizarInfoRota() e excluirRotaAtiva()

        // --- Fun√ß√µes de Placar e Gamifica√ß√£o ---

        function atualizarPlacar() {
            const entregas = getEntregasAtivas();
            const pendentes = entregas.filter(e => e.status === 'Pendente');
            
            const contagemPorRegiao = REGIOES.reduce((acc, regiao) => {
                acc[regiao] = pendentes.filter(e => e.regiao === regiao).length;
                return acc;
            }, {});

            const totalFaltam = pendentes.length;
            const resumoRegioes = REGIOES.map(regiao => 
                `${contagemPorRegiao[regiao]} ${regiao}`).join(' | ');

            // REMOVIDO: Frase Motivacional (Simplifica√ß√£o)
            placarEntregasEl.innerHTML = `
                <p class="text-xl font-bold mb-2">Falta ${totalFaltam} entregas</p>
                <p class="text-2xl font-bold">${resumoRegioes}</p>
            `;
        }

        // --- Fun√ß√µes de Renderiza√ß√£o e Intera√ß√£o da Lista ---

        function renderizarEntregas() {
            listaEntregasEl.innerHTML = '';
            
            // 1. Separar pendentes (e ordenar), e finalizadas/canceladas (e ordenar)
            const todasEntregas = getEntregasAtivas();
            const entregasRenderizar = todasEntregas.filter(e => e.regiao === regiaoAtiva)
                .sort((a, b) => {
                    // Pendente primeiro
                    if (a.status === 'Pendente' && b.status !== 'Pendente') return -1;
                    if (a.status !== 'Pendente' && b.status === 'Pendente') return 1;

                    // Se ambos s√£o finalizadas/canceladas, ordenar por hor√°rio de entrega (mais recente por √∫ltimo)
                    if (a.status !== 'Pendente' && b.status !== 'Pendente') {
                        return new Date(a.horarioEntrega) - new Date(b.horarioEntrega);
                    }
                    
                    // Se ambos s√£o pendentes, manter a ordem natural (que √© a ordem de lan√ßamento/movimenta√ß√£o)
                    return 0;
                });

            if (entregasRenderizar.length === 0) {
                listaVaziaEl.classList.remove('hidden');
                listaVaziaEl.textContent = `Nenhuma entrega na regi√£o ${regiaoAtiva}.`;
                return;
            }
            
            listaVaziaEl.classList.add('hidden');
            
            let primeiroPendenteIndex = entregasRenderizar.findIndex(e => e.status === 'Pendente');


            entregasRenderizar.forEach((entrega, index) => {
                const card = document.createElement('div');
                card.dataset.id = entrega.id;
                const isFinalizada = entrega.status !== 'Pendente';
                const isPendente = entrega.status === 'Pendente';
                
                // Destaque da pr√≥xima (primeira pendente)
                const isProxima = isPendente && index === primeiroPendenteIndex; 

                // Estiliza√ß√£o base + status
                card.className = `p-4 bg-white rounded-lg shadow-md border flex flex-col sm:flex-row items-start sm:items-center justify-between transition-all relative overflow-hidden break-words 
                    ${entrega.status === 'Entregue' ? 'entregue' : (entrega.status === 'Cancelada' ? 'cancelada' : '')} 
                    ${isProxima ? 'border-4 border-yellow-500 shadow-xl' : ''}
                `;
                
                // --- Bloco de Informa√ß√µes ---
                
                // NOVO: Renderizar todas as cestas com seus detalhes
                const listaCestasHtml = entrega.cestas.map(cesta => {
                    const itemTotal = cesta.valor * cesta.qtd;
                    
                    let infoBrinde = '';
                    if (Array.isArray(cesta.brindes) && cesta.brindes.length > 0) {
                        infoBrinde = `<span class="text-xs font-semibold text-pink-700 ml-2">(BRINDES: ${cesta.brindes.join(', ')})</span>`;
                    }

                    let infoAlteracao = '';
                    if (cesta.tipo === 'Alterada') {
                        const detalhes = cesta.codigoAlterada.trim();
                        const itensAlterados = Array.isArray(cesta.partesAlteradas) && cesta.partesAlteradas.length > 0
                            ? `<span class="text-xs font-semibold text-red-700 ml-2"> (Itens: ${cesta.partesAlteradas.join(', ')})</span>`
                            : '';
                        
                        infoAlteracao = `
                            <div class="mt-1 text-sm font-bold text-amber-700">
                                <span class="card-info-item alterada !p-0 !pl-0 !before:content-none">ALTERADA:</span>
                                ${itensAlterados}
                                ${detalhes ? `<pre class="card-multiline !mt-1 !mb-0 !ml-4">${detalhes}</pre>` : ''}
                            </div>
                        `;
                    }
                    
                    return `
                        <div class="border-t border-gray-100 pt-1 mt-1">
                            <p class="text-lg font-bold text-gray-700">
                                ${cesta.qtd}x ${cesta.nome} - <span class="font-extrabold text-blue-800">${formatarMoeda(itemTotal)}</span>
                                ${infoBrinde}
                            </p>
                            ${infoAlteracao}
                        </div>
                    `;
                }).join('');
                
                // NOVO: C√°lculo do Valor Total do Pedido
                const valorTotalPedido = entrega.cestas[0].valorTotalAjustado 
                    ? formatarValorFloat(entrega.cestas[0].valorTotalAjustado)
                    : entrega.cestas.reduce((total, c) => total + (c.valor * c.qtd), 0);


                let statusInfo = '';
                let faixaStatusTexto = '';
                if (entrega.status === 'Entregue') {
                    statusInfo = `
                        <div class="mt-4 text-sm font-semibold text-green-700">
                            Status: Entregue<br>
                            Pagamento: ${entrega.formaPagamento.join(', ')}<br>
                            Hora: ${formatarData(entrega.horarioEntrega)}
                        </div>
                    `;
                    faixaStatusTexto = 'ENTREGUE';
                } else if (entrega.status === 'Cancelada') {
                    statusInfo = `
                        <div class="mt-4 text-sm font-semibold text-gray-700">
                            Status: Cancelada<br>
                            Hora: ${formatarData(entrega.horarioEntrega)}
                        </div>
                    `;
                    faixaStatusTexto = 'CANCELADA';
                }
                
                // Faixa de Status (para Entregue e Cancelada)
                let faixaStatusHtml = '';
                if (isFinalizada) {
                    faixaStatusHtml = `
                        <div class="absolute inset-0 bg-white/70 flex items-center justify-center pointer-events-none z-10">
                            <span class="text-7xl font-black ${entrega.status === 'Entregue' ? 'text-green-500' : 'text-gray-500'} opacity-80 transform -rotate-12 select-none">${faixaStatusTexto}</span>
                        </div>
                    `;
                }

                let obsInfo = '';
                if (entrega.observacao) {
                    obsInfo = `<p class="card-info-item text-red-600 font-bold break-words-mobile">OBS: ${entrega.observacao}</p>`;
                }

                // Layout de Informa√ß√µes Principais (Mobile e Desktop)
                let infoClienteHtml = `
                    <p class="text-lg font-bold text-gray-800 break-words-mobile" title="${entrega.cliente.nome}">${entrega.cliente.nome} <span class="text-sm font-extrabold text-blue-700 ml-1">(${entrega.regiao})</span></p>
                    <p class="text-base text-gray-600 break-words-mobile" title="${entrega.cliente.endereco || ''}">Endere√ßo: ${entrega.cliente.endereco || 'Sem endere√ßo'}</p>
                    <p class="text-base text-gray-500 break-words-mobile" title="${entrega.cliente.complemento || ''}">Complemento: ${entrega.cliente.complemento || '-'}</p>
                    <p class="text-base font-bold text-blue-600">Celular: ${entrega.cliente.celular || 'Sem celular'}</p>
                    
                    <p class="text-xl font-extrabold text-green-700 mt-2 border-t border-gray-300 pt-2">TOTAL PEDIDO: ${formatarMoeda(valorTotalPedido)}</p>
                    
                    <div class="mt-2 w-full space-y-1">
                        ${obsInfo}
                    </div>
                `;
                
                // Mover Cima/Baixo s√≥ pode ser ativado em entregas pendentes
                const isPrimeiroPendente = isPendente && index === primeiroPendenteIndex;
                const isUltimoPendente = isPendente && (index === entregasRenderizar.filter(e => e.status === 'Pendente').length - 1);
                
                const podeMoverCima = isPendente && !isPrimeiroPendente;
                const podeMoverBaixo = isPendente && !isUltimoPendente;

                let whatsappDisabled = true;
                let whatsappClass = 'bg-white text-gray-400 border border-gray-300 cursor-not-allowed';
                if (entrega.cliente.celular && isPendente) {
                    const numeroLimpo = entrega.cliente.celular.replace(/\D/g, '');
                    const numeroFinal = numeroLimpo.startsWith('55') ? numeroLimpo : `55${numeroLimpo}`;
                    
                    if(numeroFinal.length >= 10) { 
                        whatsappDisabled = false;
                        whatsappClass = 'bg-green-600 text-white hover:bg-green-700'; 
                    }
                }
                
                // Defini√ß√£o dos bot√µes simples (texto)
                const btnClassesBase = "w-full text-sm font-medium shadow-sm py-3 rounded-md";
                
                const desabilitarBotoes = isFinalizada ? 'disabled' : '';

                const btnWhatsapp = `<button data-id="${entrega.id}" class="btn-whatsapp-modal ${btnClassesBase} ${whatsappClass}" ${whatsappDisabled || isFinalizada ? 'disabled' : ''}>WHATSAPP</button>`;
                const btnMaps = `<button class="btn-card-maps ${btnClassesBase} bg-white text-gray-700 border border-gray-300 hover:bg-gray-50" ${desabilitarBotoes}>MAPA</button>`;
                
                const btnAcaoPrincipal = isPendente ? `
                    <button class="btn-entregue ${btnClassesBase} bg-blue-600 text-white hover:bg-blue-700" data-id="${entrega.id}">ENTREGUE</button>
                ` : `<button class="btn-entregue ${btnClassesBase} bg-green-600 text-white cursor-not-allowed" disabled>ENTREGUE</button>`;
                
                const btnCancelar = isPendente ? `
                    <button class="btn-cancelar-entrega ${btnClassesBase} bg-red-100 text-red-700 border border-red-300 hover:bg-red-200" data-id="${entrega.id}">CANCELAR</button>
                ` : `<button class="btn-cancelar-entrega ${btnClassesBase} bg-gray-300 text-gray-600 cursor-not-allowed" disabled>CANCELAR</button>`;


                card.innerHTML = `
                    ${faixaStatusHtml} 
                    <div class="flex-1 min-w-0 ${isFinalizada ? 'opacity-50' : ''}">
                        <div class="flex items-start">
                            <div class="flex flex-col items-center justify-center mr-3 pt-2 flex-shrink-0">
                                <button class="btn-mover-cima text-gray-400 ${podeMoverCima ? 'hover:text-blue-600' : 'opacity-25 cursor-not-allowed'}" data-id="${entrega.id}" title="Mover Cima" ${podeMoverCima ? '' : 'disabled'}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg>
                                </button>
                                <button class="btn-mover-baixo text-gray-400 ${podeMoverBaixo ? 'hover:text-blue-600' : 'opacity-25 cursor-not-allowed'}" data-id="${entrega.id}" title="Mover Baixo" ${podeMoverBaixo ? '' : 'disabled'}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                                </button>
                            </div>

                            <div class="w-full min-w-0 space-y-1">
                                ${infoClienteHtml}
                            </div>
                        </div>
                        
                        <div class="mt-2 sm:ml-12 w-full">
                            ${listaCestasHtml}
                            ${statusInfo}
                        </div>
                    </div>
                    
                    <div class="mt-4 sm:mt-0 sm:ml-4 flex-shrink-0 w-full sm:w-auto ${isFinalizada ? 'opacity-50' : ''}">
                        <div class="grid grid-cols-2 gap-2 w-full sm:w-auto">
                            ${btnWhatsapp}
                            ${btnMaps}
                            ${btnCancelar}
                            ${btnAcaoPrincipal}
                        </div>
                    </div>
                `;
                listaEntregasEl.appendChild(card);
            });
            
            atualizarPlacar();
        }
        
        // --- Fun√ß√µes para M√∫ltiplas Cestas no Lan√ßamento ---

        /**
         * Adiciona uma cesta √† lista tempor√°ria do pedido.
         */
        function adicionarCestaAoPedido() {
            const selectedOption = selectCestaAdicionar.options[selectCestaAdicionar.selectedIndex];
            const nome = selectedOption.value;
            const valor = formatarValorFloat(inputValorCestaAdicionar.value);
            const qtd = parseInt(inputQtdCestaAdicionar.value) || 1;
            
            if (qtd < 1 || valor <= 0) {
                mostrarAviso("A quantidade deve ser >= 1 e o valor deve ser maior que 0.");
                return;
            }
            
            const tipo = document.querySelector('input[name="tipo-cesta-adicionar"]:checked').value;
            let codigoAlterada = '';
            let partesAlteradas = [];
            let brindes = [];

            if (tipo === 'Alterada') {
                codigoAlterada = codigoAlteradaAdicionar.value.trim();
                partesAlteradas = Array.from(document.querySelectorAll('input[name="partes_alteradas_adicionar"]:checked')).map(input => input.value);
            }
            
            brindes = Array.from(document.querySelectorAll('input[name="brindes_adicionar"]:checked')).map(input => input.value);

            // Novo item na lista tempor√°ria
            const novoItem = { 
                idTemp: Date.now(), 
                nome, 
                valor, 
                qtd, 
                tipo, 
                codigoAlterada, 
                partesAlteradas, 
                brindes 
            };
            
            cestasNoPedido.push(novoItem);
            
            // Limpar formul√°rio de adicionar item
            selectCestaAdicionar.selectedIndex = 0;
            inputQtdCestaAdicionar.value = 1;
            atualizarValorCestaAdicionar(); // Recarrega valor padr√£o
            document.querySelector('input[name="tipo-cesta-adicionar"][value="Normal"]').checked = true;
            toggleCampoAlteradaAdicionar(); // Esconde Alterada
            document.querySelectorAll('input[name="brindes_adicionar"]:checked').forEach(cb => cb.checked = false);
            
            renderizarListaCestasPedido();
        }

        /**
         * Remove uma cesta da lista tempor√°ria do pedido.
         * @param {string} idTemp - ID tempor√°rio da cesta a ser removida
         */
        function removerCestaDoPedido(idTemp) {
            cestasNoPedido = cestasNoPedido.filter(c => c.idTemp.toString() !== idTemp);
            renderizarListaCestasPedido();
        }

        /**
         * Renderiza a lista de cestas tempor√°rias e atualiza o total.
         */
        function renderizarListaCestasPedido() {
            listaCestasPedidoEl.innerHTML = '';
            let total = 0;
            
            if (cestasNoPedido.length === 0) {
                listaCestasPedidoEl.innerHTML = '<p class="text-sm text-gray-500">Nenhuma cesta adicionada.</p>';
                inputValorTotalPedidoEl.value = '';
                displayTotalPedidoEl.textContent = 'R$ 0,00';
                return;
            }
            
            cestasNoPedido.forEach(cesta => {
                const itemTotal = cesta.valor * cesta.qtd;
                total += itemTotal;
                
                const tipoTexto = cesta.tipo === 'Alterada' ? `<span class="font-bold text-red-600"> (ALT)</span>` : '';
                const brindesTexto = cesta.brindes.length > 0 ? `<span class="font-normal text-pink-600 ml-2">(+Brinde)</span>` : '';

                const itemEl = document.createElement('div');
                itemEl.className = 'flex flex-col p-2 rounded-md border border-blue-200 bg-white shadow-sm';
                itemEl.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-800">${cesta.qtd}x ${cesta.nome}${tipoTexto}${brindesTexto}</span>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-bold text-blue-600">${formatarMoeda(itemTotal)}</span>
                            <button type="button" data-id-temp="${cesta.idTemp}" class="btn-remover-cesta text-red-500 hover:text-red-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                    </div>
                    ${cesta.tipo === 'Alterada' ? `<p class="text-xs text-red-500 mt-1">Detalhes: ${cesta.codigoAlterada.substring(0, 50)}...</p>` : ''}
                `;
                listaCestasPedidoEl.appendChild(itemEl);
            });
            
            // Preencher o campo de ajuste manual com o total calculado, mas permitir edi√ß√£o
            inputValorTotalPedidoEl.value = total.toFixed(2);
            displayTotalPedidoEl.textContent = formatarMoeda(total);
        }

        // --- Fun√ß√µes Espec√≠ficas do WhatsApp ---

        function abrirModalWhatsapp(id) {
            const entregas = getEntregasAtivas();
            const entrega = entregas.find(e => e.id.toString() === id);
            if (!entrega) return;

            entregaParaWhatsappId = id;

            modalWhatsappClienteNome.textContent = entrega.cliente.nome;
            
            // NOVO: Info de Cesta no Modal WhatsApp
            const totalPedido = entrega.cestas.reduce((total, c) => total + (c.valor * c.qtd), 0);
            const cestaNomes = entrega.cestas.map(c => {
                 let info = `${c.qtd}x ${c.nome}`;
                 if (c.tipo === 'Alterada') info += ' (ALT)';
                 if (c.brindes.length > 0) info += ' (+B)';
                 return info;
            }).join(' | ');

            let cestaInfo = `TOTAL: ${formatarMoeda(totalPedido)}. ${cestaNomes}`;
            
            modalWhatsappCestaInfo.textContent = cestaInfo;
            
            modalWhatsappOpcoes.classList.remove('hidden');
        }

        function fecharModalWhatsapp() {
            modalWhatsappOpcoes.classList.add('hidden');
            entregaParaWhatsappId = null;
        }

        /**
         * NOVO: Gera um relat√≥rio r√°pido e abre o WhatsApp (para o n√∫mero de Pagamento)
         * @param {Object} entrega - O objeto da entrega.
         * @param {Array} formasPagamento - Array de strings com as formas de pagamento.
         */
        function gerarRelatorioRapidoWhatsapp(entrega, formasPagamento) {
             const numeroDestino = `55${PIX_CELULAR}`; // Sempre para o n√∫mero de pagamento
             
             // NOVO: Calcula o valor total do pedido
             const totalPedido = entrega.cestas[0].valorTotalAjustado 
                ? formatarValorFloat(entrega.cestas[0].valorTotalAjustado)
                : entrega.cestas.reduce((total, c) => total + (c.valor * c.qtd), 0);
             const cestaValor = formatarMoeda(totalPedido);
             
             const horaEntrega = formatarData(entrega.horarioEntrega).split(' ')[1]; // Pega apenas a hora

             let mensagem = `*‚úÖ ENTREGA CONCLU√çDA - Relat√≥rio R√°pido*\n\n`;
             mensagem += `*Cliente:* ${entrega.cliente.nome}\n`;
             mensagem += `*Regi√£o:* ${entrega.regiao}\n`;
             mensagem += `*Valor Pago:* ${cestaValor}\n`;
             mensagem += `*Formas de Pagamento:* ${formasPagamento.join(', ')}\n`;
             mensagem += `*Hora:* ${horaEntrega}\n\n`;
             
             // Detalhe de cada cesta
             mensagem += `--- Cestas do Pedido ---\n`;
             entrega.cestas.forEach((c, index) => {
                 mensagem += `*${index + 1}.* ${c.qtd}x ${c.nome}\n`;
                 if (c.brindes.length > 0) {
                     mensagem += `   *Brindes:* ${c.brindes.join(', ')}\n`;
                 }
                 if (c.tipo === 'Alterada') {
                     mensagem += `   *ALTERADA:* ${c.codigoAlterada.trim()}\n`;
                     if (c.partesAlteradas.length > 0) {
                         mensagem += `   *Itens:* ${c.partesAlteradas.join(', ')}\n`;
                     }
                 }
             });

             // Incluir observa√ß√µes do pedido, se houver
             if (entrega.observacao) {
                mensagem += `\n*Obs Pedido:* ${entrega.observacao}\n`;
             }

             const url = `https://api.whatsapp.com/send?phone=${numeroDestino}&text=${encodeURIComponent(mensagem)}`;
             window.open(url, '_blank');
        }


        function gerarMensagem(msgId, entrega) {
            const clienteNome = entrega.cliente.nome;
            
            // Calcula o valor total do pedido (usando o valor ajustado se houver)
            const totalPedido = entrega.cestas[0].valorTotalAjustado 
                ? formatarValorFloat(entrega.cestas[0].valorTotalAjustado)
                : entrega.cestas.reduce((total, c) => total + (c.valor * c.qtd), 0);

            const cestaValor = formatarMoeda(totalPedido);
            
            const numeroCliente = entrega.cliente.celular ? entrega.cliente.celular.replace(/\D/g, '') : '';
            const numeroClienteFinal = numeroCliente.length > 0 && !numeroCliente.startsWith('55') ? `55${numeroCliente}` : numeroCliente;
            
            let mensagem = "";
            let numeroDestino = numeroClienteFinal;
            let targetBlank = true;

            if (!numeroClienteFinal && msgId !== 4) {
                 mostrarAviso("O cliente n√£o tem um n√∫mero de celular cadastrado para enviar esta mensagem.");
                 return;
            }

            switch(msgId) {
                case 1: 
                    mensagem = `Ol√°, aqui √© o entregador da ${NOME_EMPRESA}. A sua cesta b√°sica chegar√° em 10 minutos.`;
                    break;
                case 2: 
                    mensagem = `Ol√°, cheguei, j√° pode sair para receber a cesta.`;
                    break;
                case 3: 
                    mensagem = `Dados do pix para pagamento:\n*PIX*: ${PIX_CELULAR} (celular)\n*Nome*: ${PIX_NOME}\n*Valor Total*: ${cestaValor}`;
                    break;
                case 4: 
                    numeroDestino = NUMERO_GERENTE;
                    targetBlank = true; 
                    
                    let detalhesCestas = '';
                    entrega.cestas.forEach((c, index) => {
                        detalhesCestas += `\n--- Cesta ${index + 1} (${c.qtd}x ${c.nome}) ---`;
                        if (c.tipo === 'Alterada') {
                            detalhesCestas += `\n*ALTERADA:*`;
                            const detalhes = c.codigoAlterada.trim();
                            if (detalhes.length > 0) {
                                detalhesCestas += `\n${detalhes.split('\n').map(line => `   ${line}`).join('\n')}`; 
                            }
                            if (Array.isArray(c.partesAlteradas) && c.partesAlteradas.length > 0) {
                                detalhesCestas += `\n*Itens Alterados*: ${c.partesAlteradas.join(', ')}`;
                            }
                        }
                        if (Array.isArray(c.brindes) && c.brindes.length > 0) { 
                             detalhesCestas += `\n*Brindes*: ${c.brindes.join(', ')}`;
                        }
                    });

                    let obsCliente = entrega.observacao ? `\n\n*Obs Pedido*: ${entrega.observacao}` : "";

                    mensagem = `*NOVO PEDIDO (ENTREGA)*\n\n*Cliente*: ${clienteNome}\n*Valor Total*: ${cestaValor}\n*Celular Cliente*: ${entrega.cliente.celular}${detalhesCestas}${obsCliente}`;
                    break;
                default:
                    return;
            }

            // CORRE√á√ÉO FINAL: Garante que a mensagem √© codificada corretamente para a URL
            const url = `https://api.whatsapp.com/send?phone=${numeroDestino}&text=${encodeURIComponent(mensagem)}`;
            
            fecharModalWhatsapp();
            window.open(url, targetBlank ? '_blank' : '_self');
        }

        // --- Fun√ß√µes de Lan√ßamento e Status ---

        function adicionarEntrega(e) {
            e.preventDefault();
            
            if (cestasNoPedido.length === 0) {
                 mostrarAviso('Por favor, adicione ao menos uma cesta ao pedido.');
                 return;
            }
            
            const rotaAtiva = todasAsRotas[rotaAtivaId];
            if (!rotaAtiva) {
                mostrarAviso("Nenhuma rota ativa selecionada. Crie uma nova rota.");
                return;
            }
            const entregas = rotaAtiva.entregas;

            const nomeClienteSelecionado = inputCliente.value.trim();
            const clienteSelecionado = CLIENTES_CACHE[nomeClienteSelecionado.toLowerCase()];

            let clienteData;
            if (clienteSelecionado) {
                clienteData = { ...clienteSelecionado };
            } else {
                clienteData = {
                    nome: nomeClienteSelecionado,
                    celular: '',
                    endereco: nomeClienteSelecionado,
                    complemento: ''
                };
            }

            if (!clienteData.nome) {
                mostrarAviso('Por favor, selecione ou digite um nome de cliente.');
                return;
            }
            
            // Coleta Regi√£o
            const regiaoSelecionadaEl = document.querySelector('input[name="regiao-entrega"]:checked');
            if (!regiaoSelecionadaEl) {
                mostrarAviso('Por favor, selecione a Regi√£o da Entrega.');
                return;
            }
            const regiaoSelecionada = regiaoSelecionadaEl.value;
            
            // O valor final do pedido pode ter sido alterado manualmente
            const valorAjustado = formatarValorFloat(inputValorTotalPedidoEl.value);

            // A nova estrutura da entrega armazena o array de cestas
            const novaEntrega = {
                id: Date.now(),
                cliente: clienteData,
                observacao: obsClienteInput.value.trim(),
                regiao: regiaoSelecionada, 
                // A lista de cestas j√° cont√©m todos os detalhes (tipo, alterada, brindes)
                cestas: cestasNoPedido.map(c => ({ 
                    nome: c.nome, 
                    valor: c.valor, 
                    qtd: c.qtd, 
                    tipo: c.tipo, 
                    codigoAlterada: c.codigoAlterada, 
                    partesAlteradas: c.partesAlteradas,
                    brindes: c.brindes,
                    // Valor Ajustado √© salvo no objeto principal para refer√™ncia r√°pida se necess√°rio
                    valorTotalAjustado: valorAjustado
                })), 
                status: "Pendente",
                formaPagamento: [],
                horarioEntrega: null
            };

            entregas.push(novaEntrega);
            salvarLocalStorage();
            
            filtrarEntregas(regiaoAtiva); 

            // Resetar o formul√°rio de cestas e inputs
            cestasNoPedido = [];
            renderizarListaCestasPedido();

            formEntrega.reset();
            inputCliente.value = '';
            infoClienteSelecionado.classList.add('hidden');
            // Resetar o formul√°rio de adicionar cesta
            selectCestaAdicionar.selectedIndex = 0;
            inputQtdCestaAdicionar.value = 1;
            atualizarValorCestaAdicionar(); 
            toggleCampoAlteradaAdicionar(); 
            
            // Aumenta o √≠ndice da frase motivacional
            indiceFrase = (indiceFrase + 1) % FRASES_GAMIFICADAS.length;
            
            if (!contentLancamento.classList.contains('open')) {
                toggleLancamento();
            }
        }

        function abrirGoogleMaps(query) {
            const enderecoFormatado = query.trim();
            if (!enderecoFormatado) {
                mostrarAviso('O cliente n√£o possui um endere√ßo cadastrado para abrir no mapa.');
                return;
            }
            // OBS: A URL foi corrigida aqui (removida a parte 'https://www.google.com/maps/search/?api=1&query=$')
            const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(enderecoFormatado)}`;
            window.open(url, '_blank');
        }

        function abrirModalPagamento(id) {
            const entregas = getEntregasAtivas();
            const entrega = entregas.find(e => e.id.toString() === id);
            if (!entrega) return;
            
            // C√°lculo do valor total
            // Se houver valor ajustado (manual), usa-o. Caso contr√°rio, calcula.
            const totalPedido = entrega.cestas[0].valorTotalAjustado 
                ? formatarValorFloat(entrega.cestas[0].valorTotalAjustado)
                : entrega.cestas.reduce((total, c) => total + (c.valor * c.qtd), 0);

            entregaParaPagarId = id;
            
            modalClienteNome.textContent = entrega.cliente.nome;
            modalClienteValor.textContent = formatarMoeda(totalPedido);
            
            formPagamento.reset();
            modalErrorPagamento.classList.add('hidden');

            modalPagamento.classList.remove('hidden');
        }

        function fecharModalPagamento() {
            modalPagamento.classList.add('hidden');
            entregaParaPagarId = null;
        }

        function cancelarEntrega(id) {
            if (!confirm("Tem certeza que deseja MARCAR ESTA ENTREGA COMO CANCELADA?")) return;

            const entregas = getEntregasAtivas();
            const index = entregas.findIndex(e => e.id.toString() === id);
            if (index !== -1) {
                entregas[index].status = "Cancelada";
                entregas[index].formaPagamento = [];
                entregas[index].horarioEntrega = new Date().toISOString();
                
                // NOVO: Mover para o final ap√≥s o cancelamento
                moverEntregaParaOFinal(id); 
            }
            salvarLocalStorage();
            renderizarEntregas();
        }

        function moverEntrega(id, direcao) {
            const todasEntregas = getEntregasAtivas();
            const pendentesNaRegiao = todasEntregas.filter(e => e.status === 'Pendente' && e.regiao === regiaoAtiva);

            const indexEmPendentes = pendentesNaRegiao.findIndex(e => e.id.toString() === id);
            if (indexEmPendentes === -1) return; 

            let novaPosicaoEmPendentes = indexEmPendentes;

            if (direcao === 'cima' && indexEmPendentes > 0) {
                novaPosicaoEmPendentes = indexEmPendentes - 1;
            } else if (direcao === 'baixo' && indexEmPendentes < pendentesNaRegiao.length - 1) {
                novaPosicaoEmPendentes = indexEmPendentes + 1;
            } else {
                return;
            }

            // Identificar as duas entregas envolvidas na lista GERAL
            const entregaA = pendentesNaRegiao[indexEmPendentes];
            const entregaB = pendentesNaRegiao[novaPosicaoEmPendentes];
            
            const indexNaRotaA = todasEntregas.findIndex(e => e.id.toString() === entregaA.id.toString());
            const indexNaRotaB = todasEntregas.findIndex(e => e.id.toString() === entregaB.id.toString());

            // Troca de posi√ß√£o na lista GERAL
            if (indexNaRotaA !== -1 && indexNaRotaB !== -1) {
                [todasEntregas[indexNaRotaA], todasEntregas[indexNaRotaB]] = [todasEntregas[indexNaRotaB], todasEntregas[indexNaRotaA]];
            } else {
                return;
            }
            
            salvarLocalStorage();
            renderizarEntregas();
        }

        function handleCardClick(e) {
            // Verifica se o card n√£o est√° em modo desabilitado (cancelada ou entregue)
            const cardEl = e.target.closest('[data-id]');
            // N√£o bloqueia o clique se for entregue, apenas se for no bot√£o cancelada/maps
            // if (cardEl && cardEl.classList.contains('cancelada')) return; 
            
            const btnCima = e.target.closest('.btn-mover-cima');
            if (btnCima && !btnCima.disabled) {
                moverEntrega(btnCima.dataset.id, 'cima');
                return;
            }

            const btnBaixo = e.target.closest('.btn-mover-baixo');
            if (btnBaixo && !btnBaixo.disabled) {
                moverEntrega(btnBaixo.dataset.id, 'baixo');
                return;
            }

            const btnCancelar = e.target.closest('.btn-cancelar-entrega');
            if (btnCancelar && !btnCancelar.disabled) {
                cancelarEntrega(btnCancelar.dataset.id);
                return;
            }

            const btnMaps = e.target.closest('.btn-card-maps');
            if (btnMaps && !btnMaps.disabled) {
                const cardId = btnMaps.closest('[data-id]').dataset.id;
                const entregas = getEntregasAtivas();
                const entrega = entregas.find(e => e.id.toString() === cardId);
                if (entrega) {
                    abrirGoogleMaps(entrega.cliente.endereco);
                }
                return;
            }
            
            // Checa clique no bot√£o ENTREGUE
            const target = e.target.closest('.btn-entregue');
            const isMarcarEntrega = target && target.textContent.trim().toUpperCase().includes('ENTREGUE') && !target.disabled;
            
            if (isMarcarEntrega) {
                const cardId = target.dataset.id;
                abrirModalPagamento(cardId);
                return;
            }

            // A√ß√£o WhatsApp
            const btnWhatsapp = e.target.closest('.btn-whatsapp-modal');
            if (btnWhatsapp && !btnWhatsapp.disabled) {
                abrirModalWhatsapp(btnWhatsapp.dataset.id); 
                return;
            }
        }

        /**
         * MODIFICADO: Salva a entrega, move para o final e redireciona para o WhatsApp com relat√≥rio r√°pido.
         */
        function salvarPagamento(e) {
            e.preventDefault();
            
            const formasPagamentoSelecionadas = 
                Array.from(formPagamento.querySelectorAll('input[name="forma_pagamento"]:checked'))
                     .map(input => input.value);
            
            if (formasPagamentoSelecionadas.length === 0) {
                modalErrorPagamento.classList.remove('hidden');
                return;
            }
            
            const entregas = getEntregasAtivas();
            const index = entregas.findIndex(e => e.id.toString() === entregaParaPagarId);
            
            if (index !== -1) {
                const entrega = entregas[index];

                // 1. Atualiza o status e salva
                entrega.status = "Entregue";
                entrega.formaPagamento = formasPagamentoSelecionadas;
                entrega.horarioEntrega = new Date().toISOString();
                
                moverEntregaParaOFinal(entregaParaPagarId); // Move para o final antes de renderizar
                
                salvarLocalStorage();
                renderizarEntregas();
                fecharModalPagamento();

                // Aumenta o √≠ndice da frase motivacional
                indiceFrase = (indiceFrase + 1) % FRASES_GAMIFICADAS.length;

                // 2. Gera e envia o relat√≥rio r√°pido via WhatsApp
                gerarRelatorioRapidoWhatsapp(entrega, formasPagamentoSelecionadas);

            } else {
                fecharModalPagamento();
            }
        }
        
        // --- Fun√ß√µes de Exporta√ß√£o/Relat√≥rio ---

        function downloadArquivo(data, filename) {
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function fecharModalExportar() {
            modalExportar.classList.add('hidden');
        }

       function exportarDados() {
            const rotaAtiva = todasAsRotas[rotaAtivaId];
            if (!rotaAtiva) {
                mostrarAviso("Nenhuma rota ativa para exportar.");
                return;
            }
            
            // Obter regi√µes selecionadas para filtro
            const regioesSelecionadas = 
                Array.from(document.querySelectorAll('input[name="regiao-exportar"]:checked'))
                     .map(input => input.value);
            
            if (regioesSelecionadas.length === 0) {
                 mostrarAviso("Selecione pelo menos uma regi√£o para baixar o arquivo de backup.");
                 return;
            }
            
            // Filtra as entregas que ser√£o inclu√≠das no arquivo JSON de backup
            const entregasFiltradas = rotaAtiva.entregas.filter(e => regioesSelecionadas.includes(e.regiao));

            // Cria um objeto de rota tempor√°rio para exporta√ß√£o (apenas com as entregas filtradas)
            const rotaParaExportar = {
                ...rotaAtiva,
                entregas: entregasFiltradas
            };
            
            const jsonDados = JSON.stringify(rotaParaExportar, null, 2);
            
            const nomeArquivo = `backup_rota_${rotaAtiva.nome.replace(/[^a-z0-9]/gi, '_')}_${rotaAtiva.data}.json`;
            
            downloadArquivo(jsonDados, nomeArquivo);
            fecharModalExportar();
        }

        function carregarDados(jsonDados) {
            if (!jsonDados) {
                mostrarAviso("O arquivo est√° vazio ou n√£o p√¥de ser lido.");
                return;
            }
            
            try {
                const dadosCarregados = JSON.parse(jsonDados);
                
                // Fun√ß√£o auxiliar para padronizar cestas
                const padronizarCestas = (entrega) => {
                    // Se j√° for a nova estrutura (array de cestas), usa
                    if (entrega.cestas && Array.isArray(entrega.cestas)) {
                        return entrega.cestas.map(c => ({
                            ...c,
                            tipo: c.tipo || 'Normal',
                            codigoAlterada: c.codigoAlterada || '',
                            partesAlteradas: c.partesAlteradas || [],
                            brindes: c.brindes || [],
                        }));
                    }
                    // Se for a estrutura antiga (cesta √∫nica), converte
                    if (entrega.cesta && typeof entrega.cesta === 'object') {
                        // Converte a antiga estrutura de altera√ß√£o/brinde para a nova estrutura individual
                        return [{
                            nome: entrega.cesta.nome || 'Cesta Padr√£o',
                            valor: parseFloat(entrega.cesta.valor) || 0,
                            qtd: 1,
                            tipo: entrega.tipo || 'Normal', // Tipo vinha no objeto entrega
                            codigoAlterada: entrega.codigoAlterada || '', // C√≥digo vinha no objeto entrega
                            partesAlteradas: entrega.partesAlteradas || [], // Partes alteradas vinha no objeto entrega
                            brindes: (entrega.brindes && Array.isArray(entrega.brindes)) ? entrega.brindes : (entrega.brinde === 'Sim' ? ['Brinde Padr√£o'] : []), 
                        }];
                    }
                    // Caso contr√°rio, retorna um array vazio (erro de dados)
                    return [];
                };

                const padronizarCliente = (e) => {
                    return typeof e.cliente === 'object' ? e.cliente : {
                        nome: e.codigoCliente || 'Cliente Antigo',
                        celular: e.celular || '',
                        endereco: e.endereco || e.codigoCliente || 'Sem Endere√ßo',
                        complemento: e.complemento || ''
                    };
                };
                
                // CARREGAMENTO DE ROTA COMPLETA (NOVA ESTRUTURA)
                if (typeof dadosCarregados === 'object' && !Array.isArray(dadosCarregados) && dadosCarregados.entregas) {
                    
                    if (!dadosCarregados.id || !dadosCarregados.nome || !dadosCarregados.data) {
                        throw new Error('Objeto de rota inv√°lido. Faltando id, nome ou data.');
                    }

                    let novoId = dadosCarregados.id;
                    if (todasAsRotas[novoId]) {
                        novoId = `import-${Date.now()}`;
                    }
                    dadosCarregados.id = novoId;

                    dadosCarregados.despesas = dadosCarregados.despesas || { abastecimento: 0, alimentacao: 0, extra: 0 };
                    
                    dadosCarregados.entregas = dadosCarregados.entregas.map(e => ({
                        regiao: e.regiao || 'CUIABA', 
                        observacao: e.observacao || '',
                        status: e.status || "Pendente",
                        formaPagamento: e.formaPagamento || [],
                        horarioEntrega: e.horarioEntrega || null,
                        ...e,
                        cliente: padronizarCliente(e),
                        cestas: padronizarCestas(e), // Converte/padroniza
                    }));

                    // Se for importa√ß√£o de arquivo, limpa as rotas antigas para manter a simplifica√ß√£o
                    todasAsRotas = {}; 
                    todasAsRotas[novoId] = dadosCarregados;
                    rotaAtivaId = novoId;
                    
                    salvarTodasAsRotas();
                    // N√£o precisa de popularSelectRotas()
                    carregarRotaAtiva();
                    mostrarAviso(`Rota "${dadosCarregados.nome}" importada com sucesso e definida como ativa!`);

                } 
                // CARREGAMENTO DE LISTA SIMPLES (ANTIGA ESTRUTURA)
                else if (Array.isArray(dadosCarregados) && dadosCarregados.length > 0) {
                    const rotaAtiva = todasAsRotas[rotaAtivaId];
                    if (!rotaAtiva) {
                        mostrarAviso("Nenhuma rota ativa. Crie uma nova rota antes de carregar um arquivo antigo.");
                        return;
                    }

                    rotaAtiva.entregas = dadosCarregados.map(e => ({
                        regiao: e.regiao || 'CUIABA', 
                        observacao: e.observacao || '',
                        status: e.status || "Pendente",
                        formaPagamento: e.formaPagamento || [],
                        horarioEntrega: e.horarioEntrega || null,
                        ...e,
                        cliente: padronizarCliente(e),
                        cestas: padronizarCestas(e), // Converte/padroniza
                    }));
                    
                    rotaAtiva.despesas = { abastecimento: 0, alimentacao: 0, extra: 0 }; 

                    salvarTodasAsRotas();
                    carregarRotaAtiva();
                    mostrarAviso(`Lista de ${dadosCarregados.length} entregas carregada na rota ativa!`);

                } else {
                    throw new Error('Formato de arquivo JSON desconhecido ou lista vazia.');
                }
                
                // NOVO: Esconde a se√ß√£o Lan√ßar Nova Entrega ap√≥s carregar uma rota.
                const lancamentoSection = document.querySelector('section.bg-white.p-6.rounded-lg.shadow-md.mb-8');
                if (lancamentoSection) {
                     lancamentoSection.style.display = 'none';
                }


            } catch (error) {
                console.error("Erro ao carregar JSON:", error);
                mostrarAviso(`Dados inv√°lidos. Verifique o arquivo. (Erro: ${error.message})`);
            }
        }

        function handleArquivoCarregado(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    carregarDados(event.target.result);
                } catch (error) {
                    mostrarAviso(`Erro ao processar o arquivo: ${error.message}`);
                }
            };
            reader.onerror = () => {
                mostrarAviso('N√£o foi poss√≠vel ler o arquivo.');
            };
            reader.readAsText(file);
            
            e.target.value = null;
        }


        // --- Inicializa√ß√£o e Event Listeners ---

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Inicializa todos os seletores
            inicializarSeletores();
            
            // 2. Associa Event Listeners
            
            // NOVO: Listener para o bot√£o Nova Rota Simples
            if (btnNovaRotaSimples) {
                btnNovaRotaSimples.addEventListener('click', resetarTudoEIniciarNovaRota);
            }
            

            // Se√ß√£o Retr√°til - Lan√ßamento
            if (btnToggleLancamento) {
                contentLancamento.classList.remove('open');
                iconChevronLancamento.classList.add('rotate-90');
                btnToggleLancamento.addEventListener('click', toggleLancamento);
            }
            
            // Cliente e Lan√ßamento
            inputCliente.addEventListener('input', (e) => {
                const nome = e.target.value.toLowerCase().trim();
                const cliente = CLIENTES_CACHE[nome];
                if (cliente) {
                    displayClienteEndereco.textContent = cliente.endereco || '-';
                    displayClienteComplemento.textContent = cliente.complemento || '-';
                    displayClienteCelular.textContent = cliente.celular || '-';
                    infoClienteSelecionado.classList.remove('hidden');
                } else {
                    infoClienteSelecionado.classList.add('hidden');
                }
            });

            // NOVO: Eventos para M√∫ltiplas Cestas (Adicionar Item)
            selectCestaAdicionar.addEventListener('change', atualizarValorCestaAdicionar);
            document.querySelectorAll('input[name="tipo-cesta-adicionar"]').forEach(radio => {
                radio.addEventListener('change', toggleCampoAlteradaAdicionar);
            });

            btnAdicionarCesta.addEventListener('click', adicionarCestaAoPedido);
            listaCestasPedidoEl.addEventListener('click', (e) => {
                const btnRemover = e.target.closest('.btn-remover-cesta');
                if (btnRemover) {
                    removerCestaDoPedido(btnRemover.dataset.idTemp);
                }
            });

            // NOVO: Listener para o campo de Valor Final (ajuste manual)
            inputValorTotalPedidoEl.addEventListener('change', (e) => {
                const totalCalculado = cestasNoPedido.reduce((total, c) => total + (c.valor * c.qtd), 0);
                const valorAtual = formatarValorFloat(e.target.value);
                
                // Atualiza o display do bot√£o para refletir o valor manual
                displayTotalPedidoEl.textContent = formatarMoeda(valorAtual);
                
                if (valorAtual !== totalCalculado && valorAtual !== 0) {
                     mostrarAviso(`O valor total foi ajustado manualmente para ${formatarMoeda(valorAtual)}. O valor original calculado era ${formatarMoeda(totalCalculado)}.`);
                }
                
                // Salva o valor ajustado no primeiro item da lista para refer√™ncia no objeto final
                if (cestasNoPedido.length > 0) {
                    cestasNoPedido[0].valorTotalAjustado = valorAtual;
                }
            });
            
            // CORRIGIDO: Adiciona o listener de submit ao formul√°rio
            formEntrega.addEventListener('submit', adicionarEntrega);
            
            // Listener para filtros de regi√£o
            filtrosRegiaoEl.addEventListener('click', (e) => {
                const chip = e.target.closest('.chip-regiao');
                if (chip && chip.dataset.regiao !== regiaoAtiva) {
                    filtrarEntregas(chip.dataset.regiao);
                }
            });


            // Lista de Entregas (Delega√ß√£o de Evento)
            listaEntregasEl.addEventListener('click', handleCardClick);
            
            // A√ß√£o espec√≠fica para abrir o Modal de WhatsApp
            listaEntregasEl.addEventListener('click', (e) => {
                const btnWhatsapp = e.target.closest('.btn-whatsapp-modal');
                if (btnWhatsapp && !btnWhatsapp.disabled) {
                    abrirModalWhatsapp(btnWhatsapp.dataset.id); 
                    return;
                }
            });

            // Modal de Pagamento
            btnCancelarPagamento.addEventListener('click', fecharModalPagamento);
            formPagamento.addEventListener('submit', salvarPagamento);
            
            // Modal de WhatsApp Op√ß√µes
            btnFecharWhatsappOpcoes.addEventListener('click', fecharModalWhatsapp);
            
            // CORRIGIDO: Delega o evento de clique para os bot√µes internos e CHAMA a fun√ß√£o correta
            modalWhatsappOpcoes.addEventListener('click', (e) => {
                const btnMsg = e.target.closest('[data-msg-id]');
                if (btnMsg) {
                    const idEntrega = entregaParaWhatsappId; // Usa o ID armazenado ao abrir o modal
                    const entregas = getEntregasAtivas();
                    const entrega = entregas.find(e => e.id.toString() === idEntrega);
                    
                    if (entrega) {
                        // CORRE√á√ÉO APLICADA: Chama a fun√ß√£o gerarMensagem com o ID do bot√£o
                        gerarMensagem(parseInt(btnMsg.dataset.msgId), entrega);
                    }
                }
            });


            // A√ß√µes Globais (Exportar/Carregar)
            // Bot√£o Exportar: Apenas abre o modal, exportarDados √© chamado pelo listener de click na regi√£o
            btnExportar.addEventListener('click', () => {
                modalExportar.classList.remove('hidden');
            });
            
            // Bot√£o de Download JSON (dentro do modal)
            document.getElementById('btn-baixar-json').addEventListener('click', exportarDados);
            
            // Fechar Modal Exportar (Desktop e Mobile)
            btnFecharExportar.addEventListener('click', fecharModalExportar);
            btnFecharExportarTop.addEventListener('click', fecharModalExportar);

            btnCarregar.addEventListener('click', () => {
                inputCarregarArquivo.click();
            });

            inputCarregarArquivo.addEventListener('change', handleArquivoCarregado);
            
            // Adiciona listener para recalcular o relat√≥rio/link do WhatsApp ao abrir/usar o modal
            // REMOVIDO: O listener de 'change' do modal exportar (pois n√£o tem mais relat√≥rio)
            
            btnFecharAviso.addEventListener('click', fecharAviso);

            // 3. Inicia o app
            iniciarAplicativo();
            atualizarValorCestaAdicionar();
            toggleCampoAlteradaAdicionar();
            renderizarListaCestasPedido(); // Inicia com o display do total correto
            
            // Verifica se deve esconder a se√ß√£o de lan√ßamento (se a rota n√£o estiver vazia)
            const entregasNaRota = getEntregasAtivas();
            if (entregasNaRota.length > 0) {
                 const lancamentoSection = document.querySelector('section.bg-white.p-6.rounded-lg.shadow-md.mb-8');
                 if (lancamentoSection) {
                     lancamentoSection.style.display = 'none';
                 }
            }
        });
    </script>
</body>
</html>
