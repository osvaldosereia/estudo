<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Rota de Entrega Profissional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="clientes.js"></script>
    
    <style>
        /* Estilos de Status de Entrega */
        .entregue {
            background-color: #f0fdf4; /* green-50 */
            border-left-width: 4px;
            border-left-color: #22c55e; /* green-500 */
        }
        .entregue .btn-entregue {
            background-color: #22c55e; /* green-500 */
            color: white;
        }

        .cancelada {
            background-color: #f3f4f6; /* gray-100 */
            border-left-width: 4px;
            border-left-color: #6b7280; /* gray-500 */
            opacity: 0.7;
        }
        /* Desabilita bot√µes em itens cancelados */
        .cancelada .btn-entregue,
        .cancelada .btn-card-maps,
        .cancelada .btn-card-whatsapp,
        .cancelada .btn-mover-cima,
        .cancelada .btn-mover-baixo,
        .cancelada .btn-cancelar-entrega {
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Estiliza√ß√£o do <select> de rotas */
        #select-rota-ativa {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
        }
        /* Classe para transi√ß√£o suave de elementos retr√°teis */
        .collapse-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
        }
        .collapse-content.open {
            max-height: 1000px; /* Valor grande para cobrir todo o conte√∫do */
            opacity: 1;
        }
        /* Ajuste do modal de exportar para mobile (para n√£o sair da tela) */
        @media (max-width: 640px) {
            #modal-exportar > div {
                max-width: 100%;
                width: 100%;
                margin: 0;
                border-radius: 0;
                max-height: 100vh;
                overflow-y: auto;
            }
        }

        /* Otimiza√ß√£o para quebra de texto em mobile (end. e obs.) */
        .break-words-mobile {
            word-wrap: break-word; /* Para navegadores antigos */
            overflow-wrap: break-word; /* Padr√£o moderno */
            min-width: 0; /* Ajuda o flexbox a for√ßar a quebra */
        }
        
        /* Estilos para o checklist do card */
        .card-info-item {
            font-size: 0.95rem; /* Um pouco maior que 'text-sm' */
            font-weight: 500; /* Medium */
            color: #4b5563; /* Cor cinza padr√£o */
            padding-left: 1.5rem;
            position: relative;
        }
        .card-info-item::before {
            content: '‚Ä¢';
            position: absolute;
            left: 0;
            color: #6b7280; /* Cinza mais escuro */
            font-weight: bold;
        }
        /* Cores mais sutis para os itens especiais */
        .card-info-item.alterada {
            color: #b45309; /* √¢mbar-700 */
        }
        .card-info-item.brinde {
            color: #9d174d; /* Rosa escuro */
        }
        
        /* Estilo para quebras de linha em campos multiline no card */
        .card-multiline {
            white-space: pre-wrap; /* Preserva quebras de linha e wraps o texto */
            font-size: 0.95rem;
            color: #b45309;
        }
        
        /* Estilo para o chip de regi√£o ATIVO */
        .chip-regiao.active {
            background-color: #2563eb; /* blue-600 */
            color: white;
            font-weight: 600;
        }

    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <div class="container mx-auto max-w-5xl p-4 sm:p-6 lg:p-8">

        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Gerenciador de Rotas de Entrega</h1>
        </header>

        <section class="bg-white p-6 rounded-lg shadow-md mb-8">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-2xl font-semibold text-gray-700">Gerenciar Rota</h2>
                <button id="btn-toggle-gerenciar-rota" class="text-gray-500 hover:text-gray-700 p-2 rounded-full">
                    <svg id="icon-chevron" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                </button>
            </div>
            
            <div id="content-gerenciar-rota" class="collapse-content">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div class="md:col-span-2">
                        <label for="select-rota-ativa" class="block text-sm font-medium text-gray-700">Rota Ativa</label>
                        <select id="select-rota-ativa" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base">
                            </select>
                    </div>
                    <div class="md:col-span-1">
                        <button id="btn-nova-rota" class="w-full flex justify-center items-center rounded-md border border-transparent bg-green-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-green-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            Nova Rota
                        </button>
                    </div>
                    <div class="md:col-span-1">
                        <button id="btn-excluir-rota" class="w-full flex justify-center items-center rounded-md border border-gray-300 bg-red-100 px-4 py-3 text-sm font-medium text-red-700 shadow-sm hover:bg-red-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm2 3a1 1 0 100 2h2a1 1 0 100-2H9z" clip-rule="evenodd" /></svg>
                            Excluir Rota
                        </button>
                    </div>

                    <div class="md:col-span-2">
                        <label for="input-nome-rota" class="block text-sm font-medium text-gray-700">Nome da Rota</label>
                        <input type="text" id="input-nome-rota" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Ex: Entregas Manh√£">
                    </div>
                    <div class="md:col-span-2">
                        <label for="input-data-rota" class="block text-sm font-medium text-gray-700">Data da Rota</label>
                        <div class="flex items-center">
                            <input type="date" id="input-data-rota" class="mt-1 block w-full rounded-l-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base">
                            <span id="display-dia-semana" class="mt-1 inline-flex items-center px-3 py-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-base min-w-[120px] justify-center">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="bg-white p-6 rounded-lg shadow-md mb-8">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-2xl font-semibold text-gray-700">Lan√ßar Nova Entrega</h2>
                 <button id="btn-toggle-lancamento" class="text-gray-500 hover:text-gray-700 p-2 rounded-full">
                    <svg id="icon-chevron-lancamento" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                </button>
            </div>

            <div id="content-lancamento" class="collapse-content">
                <form id="form-entrega" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    
                    <div class="md:col-span-1 space-y-4">
                        <div>
                            <label for="input-cliente" class="block text-sm font-medium text-gray-700">Cliente</label>
                            <input type="text" id="input-cliente" list="lista-clientes" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Digite ou selecione um cliente...">
                            <datalist id="lista-clientes">
                                <option value="Carregando clientes..."></option> 
                            </datalist>
                        </div>

                        <div id="info-cliente-selecionado" class="hidden space-y-2 text-sm text-gray-600 border-l-4 border-blue-200 pl-3 py-2 bg-blue-50 rounded-r-md">
                            <p><strong>Endere√ßo:</strong> <span id="display-cliente-endereco">-</span></p>
                            <p><strong>Complemento:</strong> <span id="display-cliente-complemento">-</span></p>
                            <p><strong>Celular:</strong> <span id="display-cliente-celular">-</span></p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">Regi√£o da Entrega <span class="text-red-500">*</span></label>
                            <div id="radio-regioes" class="mt-2 grid grid-cols-2 gap-2 text-sm">
                                <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-300 has-[:checked]:bg-blue-100 has-[:checked]:border-blue-500">
                                    <input type="radio" name="regiao-entrega" value="COXIPO" required class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-gray-700">COXIP√ì</span>
                                </label>
                                <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-300 has-[:checked]:bg-blue-100 has-[:checked]:border-blue-500">
                                    <input type="radio" name="regiao-entrega" value="VG" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-gray-700">VG</span>
                                </label>
                                <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-300 has-[:checked]:bg-blue-100 has-[:checked]:border-blue-500">
                                    <input type="radio" name="regiao-entrega" value="CUIABA" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-gray-700">CUIAB√Å</span>
                                </label>
                                <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-300 has-[:checked]:bg-blue-100 has-[:checked]:border-blue-500">
                                    <input type="radio" name="regiao-entrega" value="CPA" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-gray-700">CPA</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label for="obs-cliente" class="block text-sm font-medium text-gray-700">Observa√ß√£o (Opcional)</label>
                            <input type="text" id="obs-cliente" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Ex: Casa azul, port√£o branco">
                        </div>
                        
                        
                    </div>

                   <div class="md:col-span-1 space-y-4">
    <div class="border border-blue-200 p-3 rounded-md bg-blue-50 space-y-3">
        <label class="block text-sm font-bold text-gray-700">Cestas no Pedido <span class="text-red-500">*</span></label>
        
        <div id="lista-cestas-pedido" class="space-y-2">
            </div>
        
        <div class="flex space-x-2">
             <select id="select-cesta-adicionar" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base">
                <option value="Mini Bonini" data-valor="165.00">Mini Bonini</option>
                <option value="Mini Koblenz" data-valor="170.00">Mini Koblenz</option>
                <option value="Pequena Bonini" data-valor="215.00">Pequena Bonini</option>
                <option value="Pequena Koblenz" data-valor="220.00">Pequena Kolenz</option>
                <option value="M√©dia Bonini" data-valor="320.00">M√©dia Bonini</option>
                <option value="M√©dia Koblenz" data-valor="325.00">M√©dia Koblenz</option>
                <option value="Grande Bonini" data-valor="380.00">Grande Bonini</option>
                <option value="Grande Koblenz" data-valor="390.00">Grande Koblenz</option>
            </select>
            <input type="number" id="input-qtd-cesta-adicionar" min="1" value="1" class="w-20 text-center rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-2 text-base">
        </div>
        <button type="button" id="btn-adicionar-cesta" class="w-full flex justify-center items-center rounded-md border border-transparent bg-blue-500 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-600">
            Adicionar √† Lista (Total: <span id="display-total-pedido">R$ 0,00</span>)
        </button>
    </div>
    <div>
        <label for="input-valor-total-pedido" class="block text-sm font-medium text-gray-700">Valor **FINAL** do Pedido (R$)</label>
        <input type="number" id="input-valor-total-pedido" step="0.01" min="0" value="0.00" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base font-bold text-lg" placeholder="0.00">
    </div>

    <div>
        <label class="block text-sm font-medium text-gray-700">Tipo da Cesta</label>
        <div class="mt-2 flex space-x-4">
            <label class="flex items-center">
                <input type="radio" name="tipo-cesta" value="Normal" checked class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-sm text-gray-700">Normal</span>
            </label>
            <label class="flex items-center">
                <input type="radio" name="tipo-cesta" value="Alterada" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-sm text-gray-700">Alterada</span>
            </label>
        </div>
    </div>

     <div>
        <label class="block text-sm font-medium text-gray-700">Brinde (Opcional)</label>
        <div class="mt-2 space-y-2">
            <label class="flex items-center">
                <input type="checkbox" name="brindes_opcoes" value="Ovo" class="h-4 w-4 border-gray-300 text-pink-600 focus:ring-pink-500 rounded">
                <span class="ml-2 text-sm text-gray-700">Ovo</span>
            </label>
            <label class="flex items-center">
                <input type="checkbox" name="brindes_opcoes" value="Amaciante" class="h-4 w-4 border-gray-300 text-pink-600 focus:ring-pink-500 rounded">
                <span class="ml-2 text-sm text-gray-700">Amaciante</span>
            </label>
            <label class="flex items-center">
                <input type="checkbox" name="brindes_opcoes" value="Cafe 250g" class="h-4 w-4 border-gray-300 text-pink-600 focus:ring-pink-500 rounded">
                <span class="ml-2 text-sm text-gray-700">Caf√© 250g</span>
            </label>
        </div>
    </div>
</div>
                    
                    <div class="md:col-span-1 space-y-4">
                        <div id="campo-alterada" class="hidden space-y-4">
                            <div>
                                <label for="codigo-alterada" class="block text-sm font-medium text-gray-700">Detalhe (Cesta Alterada)</label>
                                <textarea id="codigo-alterada" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Ex: TIRA: Arroz, Feij√£o
POR: Caf√©, A√ß√∫car"></textarea>
                            </div>

                            <div id="campo-partes-alteradas">
                                <label class="block text-sm font-medium text-gray-700">Itens Alterados</label>
                                <div class="mt-2 space-y-2">
                                    <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                                        <input type="checkbox" name="partes_alteradas" value="Arroz" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                                        <span class="ml-3 text-sm font-medium text-gray-700">Arroz</span>
                                    </label>
                                    <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                                        <input type="checkbox" name="partes_alteradas" value="Alimento" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                                        <span class="ml-3 text-sm font-medium text-gray-700">Alimento (Geral)</span>
                                    </label>
                                    <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                                        <input type="checkbox" name="partes_alteradas" value="Limpeza" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                                        <span class="ml-3 text-sm font-medium text-gray-700">Limpeza</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="pt-6 flex flex-col">
                            <button type="submit" class="w-full flex justify-center items-center rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                Lan√ßar Entrega
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </section>

        <section>
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-700">Entregas na Rota</h2>
                <div class="flex space-x-2 mt-4 sm:mt-0">
                    <button id="btn-exportar" class="rounded-md bg-green-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-green-700">Exportar Rota</button>
                    <button id="btn-carregar" class="rounded-md bg-gray-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-gray-700">Carregar Rota</button>
                </div>
            </div>
            <div id="placar-entregas" class="bg-blue-800 text-white p-4 rounded-lg shadow-lg mb-4">
    </div>

            <div id="filtros-regiao" class="flex flex-wrap gap-2 mb-4">
                 </div>

            <div id="lista-entregas" class="space-y-3 min-h-[100px]">
                </div>
            <p id="lista-vazia" class="text-center text-gray-500 py-6">Nenhuma entrega na rota.</p>
        </section>
    </div>

    <div id="modal-pagamento" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <form id="form-pagamento">
                <div class="p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Confirmar Entrega e Pagamento</h3>
                    <p class="text-sm text-gray-600 mb-1">Cliente: <strong id="modal-cliente-nome"></strong></p>
                    <p class="text-sm text-gray-600 mb-4">Valor: <strong id="modal-cliente-valor"></strong></p>
                    
                    <label class="block text-sm font-medium text-gray-700 mb-2">Forma(s) de Pagamento (Selecione ao menos uma):</label>
                    <div id="modal-error-pagamento" class="text-red-600 text-sm mb-2 hidden">√â obrigat√≥rio selecionar ao menos uma forma de pagamento.</div>
                    <div class="space-y-2">
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                            <input type="checkbox" name="forma_pagamento" value="Dinheiro" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">Dinheiro</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                            <input type="checkbox" name="forma_pagamento" value="Pix" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">Pix</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                            <input type="checkbox" name="forma_pagamento" value="Cart√£o" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">Cart√£o</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                            <input type="checkbox" name="forma_pagamento" value="Fiado" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">Fiado</span>
                        </label>
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3 rounded-b-lg">
                    <button type="button" id="btn-cancelar-pagamento" class="rounded-md border border-gray-300 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Cancelar</button>
                    <button type="submit" id="btn-confirmar-pagamento" class="rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700">Confirmar Entrega</button>
                </div>
            </form>
        </div>
        
    </div>
    
    <div id="modal-whatsapp-opcoes" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <div class="p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Mensagens R√°pidas para <span id="modal-whatsapp-cliente-nome"></span></h3>
                <p class="text-sm text-gray-600 mb-6">Cesta: <strong id="modal-whatsapp-cesta-info"></strong></p>
                
                <div class="space-y-3">
                    <button id="btn-msg-chegando" data-msg-id="1" class="w-full text-left rounded-md border border-blue-300 bg-blue-50 px-4 py-3 text-sm font-medium text-blue-700 shadow-sm hover:bg-blue-100">
                        1. üöó Aviso de Chegada (10 minutos)
                    </button>
                    
                    <button id="btn-msg-cheguei" data-msg-id="2" class="w-full text-left rounded-md border border-blue-300 bg-blue-50 px-4 py-3 text-sm font-medium text-blue-700 shadow-sm hover:bg-blue-100">
                        2. üö™ Cheguei no local
                    </button>
                    
                    <button id="btn-msg-pix" data-msg-id="3" class="w-full text-left rounded-md border border-blue-300 bg-blue-50 px-4 py-3 text-sm font-medium text-blue-700 shadow-sm hover:bg-blue-100">
                        3. üí∞ Dados PIX para Pagamento
                    </button>

                    <button id="btn-msg-pedido" data-msg-id="4" class="w-full text-left rounded-md border border-red-300 bg-red-50 px-4 py-3 text-sm font-medium text-red-700 shadow-sm hover:bg-red-100">
                        4. üö® Enviar Pedido para Gerente (65996884599)
                    </button>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end rounded-b-lg">
                <button type="button" id="btn-fechar-whatsapp-opcoes" class="rounded-md border border-gray-300 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Fechar</button>
            </div>
        </div>
    </div>


   <div id="modal-exportar" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl m-4 overflow-hidden sm:m-8 sm:rounded-lg">
        <div class="p-6">
             <div class="flex justify-between items-center mb-4 sm:hidden">
                <h3 class="text-xl font-semibold text-gray-800">Exportar Rota</h3>
                <button type="button" id="btn-fechar-exportar-top" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <h3 class="text-xl font-semibold text-gray-800 mb-4 hidden sm:block">Exportar Rota e Despesas</h3>

            <h4 class="text-lg font-semibold text-gray-700 mt-2 mb-3 border-b pb-1">Despesas da Rota</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end mb-6">
                <div>
                    <label for="input-despesa-abastecimento" class="block text-sm font-medium text-gray-700">Abastecimento (R$)</label>
                    <input type="number" id="modal-despesa-abastecimento" step="0.01" min="0" value="0.00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="0.00">
                </div>
                <div>
                    <label for="input-despesa-alimentacao" class="block text-sm font-medium text-gray-700">Alimenta√ß√£o (R$)</label>
                    <input type="number" id="modal-despesa-alimentacao" step="0.01" min="0" value="0.00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="0.00">
                </div>
                <div>
                    <label for="input-despesa-extra" class="block text-sm font-medium text-gray-700">Extras (R$)</label>
                    <input type="number" id="modal-despesa-extra" step="0.01" min="0" value="0.00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="0.00">
                </div>
            </div>
            
            <h4 class="text-lg font-semibold text-gray-700 mt-6 mb-3 border-b pb-1">Filtro de Regi√£o (Relat√≥rio e Resumo)</h4>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
                <label class="flex items-center">
                    <input type="checkbox" name="regiao-exportar" value="CUIABA" checked class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                    <span class="ml-2 text-sm font-medium text-gray-700">CUIAB√Å</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" name="regiao-exportar" value="COXIPO" checked class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                    <span class="ml-2 text-sm font-medium text-gray-700">COXIP√ì</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" name="regiao-exportar" value="VG" checked class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                    <span class="ml-2 text-sm font-medium text-gray-700">VG</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" name="regiao-exportar" value="CPA" checked class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                    <span class="ml-2 text-sm font-medium text-gray-700">CPA</span>
                </label>
            </div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Backup da Rota (Arquivo)</label>
            <button type="button" id="btn-baixar-json" class="w-full flex justify-center items-center rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Baixar Arquivo da Rota (.json)
            </button>

            <h4 class="text-lg font-semibold text-gray-700 mt-6 mb-2">Relat√≥rio de Entregas Conclu√≠das</h4>
            <div id="export-relatorio" class="w-full max-h-48 overflow-y-auto p-2 border border-gray-300 rounded-md bg-gray-50">
                <pre class="text-xs text-gray-700">Nenhuma entrega conclu√≠da.</pre>
            </div>

            <div id="export-whatsapp-link" class="mt-4">
                </div>
        </div>
        <div class="bg-gray-50 px-6 py-4 flex justify-end rounded-b-lg hidden sm:flex">
            <button type="button" id="btn-fechar-exportar" class="rounded-md border border-gray-300 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Fechar</button>
        </div>
    </div>
</div>

    <div id="modal-aviso" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm m-4">
            <div class="p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Aten√ß√£o</h3>
                <p id="modal-aviso-texto" class="text-gray-600 mb-6">Mensagem de aviso.</p>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end rounded-b-lg">
                <button type="button" id="btn-fechar-aviso" class="rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700">OK</button>
            </div>
        </div>
    </div>

    <input type="file" id="input-carregar-arquivo" class="hidden" accept=".json,application/json">


   <script>
        /**
         * =================================================================
         * BLOCO DE C√ìDIGO JS PRINCIPAL (Revisado para Fluxo Simplificado)
         * =================================================================
         */

        // --- Constantes Globais ---
        const PIX_NOME = "Osvaldo Sereia Junior";
        const PIX_CELULAR = "65984491018";
        const NUMERO_GERENTE = "5565996884599"; 
        const NOME_EMPRESA = "Cesta B√°sica Dona Ant√¥nia";
        const MAX_ROTAS = 30;
        const REGIOES = ["VG", "CUIABA", "COXIPO", "CPA"];
        
        const FRASES_GAMIFICADAS = [
            "Mandando bem! Mais uma entrega √© um abra√ßo a mais!",
            "Foco na miss√£o! O pr√≥ximo cliente est√° contando com voc√™!",
            "Ningu√©m te segura! Pr√≥xima parada, sucesso garantido!",
            "Velocidade m√°xima! Transformando cestas em sorrisos!",
            "Quase l√°! Essa rota vai ser um recorde!",
            "A lenda da entrega ataca novamente! Vamos com tudo!",
            "Miss√£o dada √© miss√£o cumprida! Rumo √† pr√≥xima!",
            "Obrigado por fazer a diferen√ßa! Pr√≥ximo passo!",
            "Voc√™ √© um guerreiro(a) da log√≠stica! Continue assim!",
            "Entrega de Campe√£o! Partiu para a pr√≥xima vit√≥ria!"
        ];
        
        let indiceFrase = 0;


        // --- Estado da Aplica√ß√£o ---
        let todasAsRotas = {};
        let rotaAtivaId = null;
        let CLIENTES_CACHE = {}; 
        let entregaParaPagarId = null;
        let entregaParaWhatsappId = null; 
        let regiaoAtiva = 'VG';
        
        // NOVO: Estado tempor√°rio das cestas no formul√°rio de lan√ßamento
        let cestasNoPedido = [];

        // --- Seletores de Elementos (Inicializados no DOMContentLoaded) ---
        let btnNovaRota, selectRotaAtiva, inputNomeRota, inputDataRota, displayDiaSemana, btnExcluirRota;
        let modalDespesaAbastecimento, modalDespesaAlimentacao, modalDespesaExtra; 
        let btnToggleGerenciarRota, contentGerenciarRota, iconChevron; 
        let btnToggleLancamento, contentLancamento, iconChevronLancamento; 
        let formEntrega, inputCliente, datalistClientes, infoClienteSelecionado, displayClienteEndereco, displayClienteComplemento, displayClienteCelular, obsClienteInput, campoAlterada, codigoAlteradaInput, listaEntregasEl, listaVaziaEl, radioRegioes;
        let modalPagamento, formPagamento, btnCancelarPagamento, modalClienteNome, modalClienteValor, modalErrorPagamento, btnExportar, btnCarregar, modalExportar, exportRelatorioEl, exportWhatsappLinkEl, btnFecharExportar, btnFecharExportarTop, modalAviso, modalAvisoTexto, btnFecharAviso, inputCarregarArquivo;
        let modalWhatsappOpcoes, modalWhatsappClienteNome, modalWhatsappCestaInfo, btnFecharWhatsappOpcoes;
        let filtrosRegiaoEl;
        
        // NOVOS SELETORES
        let placarEntregasEl;
        let selectCestaAdicionar, inputQtdCestaAdicionar, btnAdicionarCesta, listaCestasPedidoEl, displayTotalPedidoEl, inputValorTotalPedidoEl;


        function inicializarSeletores() {
            // Se√ß√£o Retr√°til - Gerenciar Rota
            btnToggleGerenciarRota = document.getElementById('btn-toggle-gerenciar-rota');
            contentGerenciarRota = document.getElementById('content-gerenciar-rota');
            iconChevron = document.getElementById('icon-chevron');

            // Se√ß√£o Retr√°til - Lan√ßamento
            btnToggleLancamento = document.getElementById('btn-toggle-lancamento');
            contentLancamento = document.getElementById('content-lancamento');
            iconChevronLancamento = document.getElementById('icon-chevron-lancamento');

            // Gerenciamento de Rota
            btnNovaRota = document.getElementById('btn-nova-rota');
            selectRotaAtiva = document.getElementById('select-rota-ativa');
            inputNomeRota = document.getElementById('input-nome-rota');
            inputDataRota = document.getElementById('input-data-rota');
            displayDiaSemana = document.getElementById('display-dia-semana');
            btnExcluirRota = document.getElementById('btn-excluir-rota');

            // Despesas no Modal
            modalDespesaAbastecimento = document.getElementById('modal-despesa-abastecimento');
            modalDespesaAlimentacao = document.getElementById('modal-despesa-alimentacao');
            modalDespesaExtra = document.getElementById('modal-despesa-extra');

            // Lan√ßamento de Entrega
            formEntrega = document.getElementById('form-entrega');
            inputCliente = document.getElementById('input-cliente');
            datalistClientes = document.getElementById('lista-clientes');
            infoClienteSelecionado = document.getElementById('info-cliente-selecionado');
            displayClienteEndereco = document.getElementById('display-cliente-endereco');
            displayClienteComplemento = document.getElementById('display-cliente-complemento');
            displayClienteCelular = document.getElementById('display-cliente-celular');
            obsClienteInput = document.getElementById('obs-cliente');
            radioRegioes = document.getElementById('radio-regioes');
            campoAlterada = document.getElementById('campo-alterada');
            codigoAlteradaInput = document.getElementById('codigo-alterada');
            listaEntregasEl = document.getElementById('lista-entregas');
            listaVaziaEl = document.getElementById('lista-vazia');
            filtrosRegiaoEl = document.getElementById('filtros-regiao');
            
            // NOVOS SELETORES DE LAN√áAMENTO
            selectCestaAdicionar = document.getElementById('select-cesta-adicionar');
            inputQtdCestaAdicionar = document.getElementById('input-qtd-cesta-adicionar');
            btnAdicionarCesta = document.getElementById('btn-adicionar-cesta');
            listaCestasPedidoEl = document.getElementById('lista-cestas-pedido');
            displayTotalPedidoEl = document.getElementById('display-total-pedido');
            inputValorTotalPedidoEl = document.getElementById('input-valor-total-pedido'); // Campo de Valor Final

            // Modais
            modalPagamento = document.getElementById('modal-pagamento');
            formPagamento = document.getElementById('form-pagamento');
            btnCancelarPagamento = document.getElementById('btn-cancelar-pagamento');
            modalClienteNome = document.getElementById('modal-cliente-nome');
            modalClienteValor = document.getElementById('modal-cliente-valor');
            modalErrorPagamento = document.getElementById('modal-error-pagamento');
            btnExportar = document.getElementById('btn-exportar');
            btnCarregar = document.getElementById('btn-carregar');
            modalExportar = document.getElementById('modal-exportar');
            exportRelatorioEl = document.getElementById('export-relatorio');
            exportWhatsappLinkEl = document.getElementById('export-whatsapp-link');
            btnFecharExportar = document.getElementById('btn-fechar-exportar');
            btnFecharExportarTop = document.getElementById('btn-fechar-exportar-top'); 
            modalAviso = document.getElementById('modal-aviso');
            modalAvisoTexto = document.getElementById('modal-aviso-texto');
            btnFecharAviso = document.getElementById('btn-fechar-aviso');
            inputCarregarArquivo = document.getElementById('input-carregar-arquivo');
            
            // Modal WhatsApp Op√ß√µes
            modalWhatsappOpcoes = document.getElementById('modal-whatsapp-opcoes');
            modalWhatsappClienteNome = document.getElementById('modal-whatsapp-cliente-nome');
            modalWhatsappCestaInfo = document.getElementById('modal-whatsapp-cesta-info');
            btnFecharWhatsappOpcoes = document.getElementById('btn-fechar-whatsapp-opcoes');
            
            // Placar
            placarEntregasEl = document.getElementById('placar-entregas');
            
        }

        // --- Fun√ß√µes de Utilit√°rios ---
        function mostrarAviso(mensagem) {
            modalAvisoTexto.textContent = mensagem;
            modalAviso.classList.remove('hidden');
        }

        function fecharAviso() {
            modalAviso.classList.add('hidden');
        }

        function formatarMoeda(valor) {
            const num = parseFloat(valor);
            if (isNaN(num)) return 'R$ 0,00';
            return num.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
        }
        
        function formatarValorFloat(valor) {
            const num = parseFloat(valor);
            return isNaN(num) ? 0.00 : parseFloat(num.toFixed(2));
        }


        function formatarData(isoString) {
            if (!isoString) return '';
            const data = new Date(isoString);
            if (isNaN(data)) return '';
            return data.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getDiaDaSemana(dataString) {
            if (!dataString) return '-';
            const data = new Date(dataString + 'T12:00:00');
            if (isNaN(data)) return '-';
            const dia = data.toLocaleDateString('pt-BR', { weekday: 'long' });
            return dia.charAt(0).toUpperCase() + dia.slice(1);
        }

        // REMOVIDA: atualizarValorCesta - substitu√≠da por atualizarListaCestas

        function toggleCampoAlterada() {
            const tipo = document.querySelector('input[name="tipo-cesta"]:checked').value;
            if (tipo === 'Alterada') {
                campoAlterada.classList.remove('hidden');
            } else {
                campoAlterada.classList.add('hidden');
                codigoAlteradaInput.value = '';
                document.querySelectorAll('input[name="partes_alteradas"]:checked').forEach(cb => {
                    cb.checked = false;
                });
            }
        }
        
        function toggleGerenciarRota() {
            const isOpen = contentGerenciarRota.classList.toggle('open');
            if (isOpen) {
                iconChevron.classList.remove('rotate-90');
                iconChevron.classList.add('rotate-180');
            } else {
                iconChevron.classList.remove('rotate-180');
                iconChevron.classList.add('rotate-90'); 
            }
        }
        
        function toggleLancamento() {
            const isOpen = contentLancamento.classList.toggle('open');
            if (isOpen) {
                iconChevronLancamento.classList.remove('rotate-90');
                iconChevronLancamento.classList.add('rotate-180');
            } else {
                iconChevronLancamento.classList.remove('rotate-180');
                iconChevronLancamento.classList.add('rotate-90'); 
            }
        }

        /**
         * NOVO: Move a entrega para o final da lista de entregas da rota.
         * @param {string} id - ID da entrega
         */
        function moverEntregaParaOFinal(id) {
            const entregas = getEntregasAtivas();
            const index = entregas.findIndex(e => e.id.toString() === id);
            
            if (index !== -1) {
                const [entrega] = entregas.splice(index, 1);
                entregas.push(entrega);
                salvarLocalStorage();
                renderizarEntregas();
            }
        }

        // --- Fun√ß√µes de Persist√™ncia (LocalStorage) ---

        function salvarTodasAsRotas() {
            const chavesRotas = Object.keys(todasAsRotas);
            if (chavesRotas.length > MAX_ROTAS) {
                const chavesOrdenadas = chavesRotas.sort((a, b) => parseInt(a, 10) - parseInt(b, 10));
                const chavesParaRemover = chavesOrdenadas.slice(0, chavesOrdenadas.length - MAX_ROTAS);
                
                chavesParaRemover.forEach(chave => {
                    delete todasAsRotas[chave];
                });
            }
            
            try {
                localStorage.setItem('gerenciadorDeRotas', JSON.stringify(todasAsRotas));
                if (rotaAtivaId) {
                    localStorage.setItem('rotaAtivaId', rotaAtivaId);
                }
            } catch (e) {
                console.error("Erro ao salvar no LocalStorage:", e);
                mostrarAviso("Erro ao salvar dados. Seu navegador pode estar sem espa√ßo ou configurado para bloquear o LocalStorage.");
            }
        }

        function salvarLocalStorage() {
            salvarTodasAsRotas();
        }
        
        function salvarDespesasDoModal() {
            const rota = todasAsRotas[rotaAtivaId];
            if (!rota) return;

            rota.despesas = {
                abastecimento: parseFloat(modalDespesaAbastecimento.value) || 0,
                alimentacao: parseFloat(modalDespesaAlimentacao.value) || 0,
                extra: parseFloat(modalDespesaExtra.value) || 0
            };

            salvarTodasAsRotas(); 
        }


        // --- Fun√ß√µes de Gerenciamento de Rota ---

        function iniciarAplicativo() {
            // 1. Carregar Clientes (do clientes.js)
            try {
                if (typeof CLIENTES_DB !== 'undefined' && Array.isArray(CLIENTES_DB)) {
                    datalistClientes.innerHTML = '';
                    CLIENTES_DB.forEach(cliente => {
                        const option = document.createElement('option');
                        option.value = cliente.nome;
                        datalistClientes.appendChild(option);
                        CLIENTES_CACHE[cliente.nome.toLowerCase()] = cliente;
                    });
                } else {
                    console.warn("CLIENTES_DB n√£o encontrado. O recurso de autocompletar cliente n√£o funcionar√°.");
                    datalistClientes.innerHTML = '<option value="Aviso: clientes.js n√£o carregado."></option>';
                }
            } catch (e) {
                console.error("Erro ao processar clientes:", e);
                datalistClientes.innerHTML = '<option value="Erro ao carregar clientes."></option>';
            }

            // 2. Carregar Rotas
            const dadosSalvos = localStorage.getItem('gerenciadorDeRotas');
            if (dadosSalvos) {
                try {
                    todasAsRotas = JSON.parse(dadosSalvos);
                } catch (e) {
                    console.error("Erro ao parsear rotas salvas. Resetando dados.", e);
                    todasAsRotas = {};
                }
            }

            // 3. Descobrir qual rota est√° ativa
            rotaAtivaId = localStorage.getItem('rotaAtivaId');

            // 4. Se n√£o houver rotas, ou a rota ativa n√£o existir, cria uma nova
            const chavesRotas = Object.keys(todasAsRotas);
            if (!rotaAtivaId || !todasAsRotas[rotaAtivaId]) {
                if (chavesRotas.length === 0) {
                    criarNovaRota(false);
                } else {
                    const chavesOrdenadas = chavesRotas.sort((a, b) => parseInt(b, 10) - parseInt(a, 10));
                    rotaAtivaId = chavesOrdenadas[0];
                    localStorage.setItem('rotaAtivaId', rotaAtivaId);
                }
            }
            
            // 5. Popular o <select> e carregar a rota ativa na tela
            popularSelectRotas();
            popularFiltrosRegiao();
            carregarRotaAtiva();
        }

        function getEntregasAtivas() {
            if (rotaAtivaId && todasAsRotas[rotaAtivaId]) {
                return todasAsRotas[rotaAtivaId].entregas;
            }
            return [];
        }
        
        function carregarDespesasNoModal() {
            const rota = todasAsRotas[rotaAtivaId];
            if (!rota) return;
            
            rota.despesas = rota.despesas || { abastecimento: 0, alimentacao: 0, extra: 0 };
            
            modalDespesaAbastecimento.value = (rota.despesas.abastecimento || 0).toFixed(2);
            modalDespesaAlimentacao.value = (rota.despesas.alimentacao || 0).toFixed(2);
            modalDespesaExtra.value = (rota.despesas.extra || 0).toFixed(2);
        }

        function popularSelectRotas() {
            selectRotaAtiva.innerHTML = '';
            
            const chavesOrdenadas = Object.keys(todasAsRotas).sort((a, b) => parseInt(b, 10) - parseInt(a, 10));

            if (chavesOrdenadas.length === 0) {
                selectRotaAtiva.disabled = true;
                selectRotaAtiva.innerHTML = '<option>Nenhuma rota salva</option>';
                return;
            }

            selectRotaAtiva.disabled = false;
            chavesOrdenadas.forEach(id => {
                const rota = todasAsRotas[id];
                const option = document.createElement('option');
                option.value = id;
                const dataFormatada = rota.data ? new Date(rota.data + 'T12:00:00').toLocaleDateString('pt-BR') : 'Sem Data';
                option.textContent = `${rota.nome} (${dataFormatada})`;
                
                if (id === rotaAtivaId) {
                    option.selected = true;
                }
                selectRotaAtiva.appendChild(option);
            });
        }

        /**
         * Popula os chips de filtro de regi√£o
         */
        function popularFiltrosRegiao() {
            filtrosRegiaoEl.innerHTML = '';
            
            REGIOES.forEach(regiao => {
                const button = document.createElement('button');
                button.type = 'button';
                button.dataset.regiao = regiao;
                button.textContent = regiao;
                button.className = `chip-regiao px-3 py-1 border rounded-full text-sm transition-colors ${regiao === regiaoAtiva ? 'active' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`;
                
                filtrosRegiaoEl.appendChild(button);
            });
        }

        /**
         * Filtra e renderiza as entregas com base na regi√£o ativa
         */
        function filtrarEntregas(novaRegiao) {
            if (novaRegiao) {
                regiaoAtiva = novaRegiao;
            }
            popularFiltrosRegiao();
            renderizarEntregas();
            atualizarPlacar();
        }


        function carregarRotaAtiva() {
            const rota = todasAsRotas[rotaAtivaId];
            if (!rota) {
                iniciarAplicativo(); 
                return;
            }

            inputNomeRota.value = rota.nome;
            inputDataRota.value = rota.data;
            displayDiaSemana.textContent = getDiaDaSemana(rota.data);

            selectRotaAtiva.value = rotaAtivaId;
            
            // NOVO: Garantir que a lista de cestas do formul√°rio esteja limpa
            cestasNoPedido = [];
            renderizarListaCestasPedido();

            filtrarEntregas(regiaoAtiva);
        }

        function criarNovaRota(atualizarTela = true) {
            let novoId = Date.now().toString(); 
            while(todasAsRotas[novoId]) {
                novoId = (parseInt(novoId, 10) + 1).toString();
            }
            
            const hoje = new Date().toISOString().split('T')[0];

            const novaRota = {
                id: novoId,
                nome: `Rota ${Object.keys(todasAsRotas).length + 1}`,
                data: hoje,
                entregas: [],
                despesas: { abastecimento: 0, alimentacao: 0, extra: 0 }
            };

            todasAsRotas[novoId] = novaRota;
            rotaAtivaId = novoId;

            salvarTodasAsRotas();
            
            if (atualizarTela) {
                popularSelectRotas();
                carregarRotaAtiva();
                mostrarAviso(`Nova Rota '${novaRota.nome}' criada e definida como ativa.`);
                
                if (!contentGerenciarRota.classList.contains('open')) {
                    toggleGerenciarRota();
                }
            }
        }

        function atualizarInfoRota() {
            const rota = todasAsRotas[rotaAtivaId];
            if (!rota) return;
            
            rota.nome = inputNomeRota.value.trim() || "Rota Sem Nome";
            rota.data = inputDataRota.value || new Date().toISOString().split('T')[0];
            
            displayDiaSemana.textContent = getDiaDaSemana(rota.data);

            salvarTodasAsRotas();
            popularSelectRotas();
        }

        function excluirRotaAtiva() {
            if (Object.keys(todasAsRotas).length <= 1) {
                mostrarAviso("Voc√™ n√£o pode excluir a √∫ltima rota. Crie uma nova antes de excluir esta.");
                return;
            }

            if (!confirm(`Tem certeza que deseja excluir a rota "${todasAsRotas[rotaAtivaId].nome}"? Esta a√ß√£o √© irrevers√≠vel.`)) {
                return;
            }
            
            delete todasAsRotas[rotaAtivaId];
            
            const chavesOrdenadas = Object.keys(todasAsRotas).sort((a, b) => parseInt(b, 10) - parseInt(a, 10));
            rotaAtivaId = chavesOrdenadas[0];
            
            salvarTodasAsRotas();
            
            popularSelectRotas();
            carregarRotaAtiva();
            mostrarAviso("Rota exclu√≠da com sucesso. Carregada a rota mais recente.");
        }
        
        // --- Fun√ß√µes de Placar e Gamifica√ß√£o ---

        function atualizarPlacar() {
            const entregas = getEntregasAtivas();
            const pendentes = entregas.filter(e => e.status === 'Pendente');
            
            const contagemPorRegiao = REGIOES.reduce((acc, regiao) => {
                acc[regiao] = pendentes.filter(e => e.regiao === regiao).length;
                return acc;
            }, {});

            const totalFaltam = pendentes.length;
            const resumoRegioes = REGIOES.map(regiao => 
                `${contagemPorRegiao[regiao]} ${regiao}`).join(' | ');

            const fraseMotivacional = FRASES_GAMIFICADAS[indiceFrase % FRASES_GAMIFICADAS.length];
            
            placarEntregasEl.innerHTML = `
                <p class="text-xl font-bold mb-2">Falta(m) ${totalFaltam} entrega(s) para o sucesso total! üéâ</p>
                <p class="text-3xl font-extrabold mb-3">${resumoRegioes}</p>
                <p class="text-sm italic text-blue-300">"${fraseMotivacional}"</p>
            `;
        }

        // --- Fun√ß√µes de Renderiza√ß√£o e Intera√ß√£o da Lista ---

        function renderizarEntregas() {
            listaEntregasEl.innerHTML = '';
            
            // 1. Separar pendentes (e ordenar), e finalizadas/canceladas (e ordenar)
            const todasEntregas = getEntregasAtivas();
            const pendentes = todasEntregas.filter(e => e.status === 'Pendente' && e.regiao === regiaoAtiva);
            const finalizadas = todasEntregas.filter(e => e.status !== 'Pendente' && e.regiao === regiaoAtiva)
                                            .sort((a, b) => new Date(b.horarioEntrega) - new Date(a.horarioEntrega));

            const entregasRenderizar = [...pendentes, ...finalizadas];


            if (entregasRenderizar.length === 0) {
                listaVaziaEl.classList.remove('hidden');
                listaVaziaEl.textContent = `Nenhuma entrega na regi√£o ${regiaoAtiva}.`;
                return;
            }
            
            listaVaziaEl.classList.add('hidden');

            entregasRenderizar.forEach((entrega, index) => {
                const card = document.createElement('div');
                card.dataset.id = entrega.id;
                const isFinalizada = entrega.status !== 'Pendente';
                const isPendente = entrega.status === 'Pendente';
                
                // NOVO: Destaque da pr√≥xima (primeira pendente)
                const isProxima = isPendente && index === 0; 

                // Estiliza√ß√£o base + status
                card.className = `p-4 bg-white rounded-lg shadow-md border flex flex-col sm:flex-row items-start sm:items-center justify-between transition-all relative overflow-hidden break-words 
                    ${entrega.status === 'Entregue' ? 'entregue' : (entrega.status === 'Cancelada' ? 'cancelada' : '')} 
                    ${isProxima ? 'border-4 border-yellow-500 shadow-xl' : ''}
                `;
                
                // --- Bloco de Informa√ß√µes ---
                
                // NOVO: Mostrar todas as cestas
                const listaCestasHtml = entrega.cestas.map(c => 
                    `<p class="text-lg font-bold text-gray-700 mt-1">${c.qtd}x ${c.nome} - <span class="font-extrabold text-blue-800">${formatarMoeda(c.valor * c.qtd)}</span></p>`
                ).join('');
                
                // NOVO: C√°lculo do Valor Total
                const valorTotalPedido = entrega.cestas.reduce((total, c) => total + (c.valor * c.qtd), 0);


                let infoBrinde = '';
                if (Array.isArray(entrega.brindes) && entrega.brindes.length > 0) {
                    infoBrinde = `<p class="card-info-item brinde">BRINDE(S): ${entrega.brindes.join(', ')}</p>`;
                }

                let infoAlteracao = '';
                if (entrega.tipo === 'Alterada') {
                    const detalhes = entrega.codigoAlterada.trim();
                    const itensAlterados = Array.isArray(entrega.partesAlteradas) && entrega.partesAlteradas.length > 0
                        ? `<p class="card-info-item alterada">Itens Alterados: ${entrega.partesAlteradas.join(', ')}</p>`
                        : '';
                    
                    if (detalhes || itensAlterados) {
                        infoAlteracao = `
                            <p class="card-info-item alterada">ALTERADA:</p>
                            ${detalhes ? `<pre class="card-multiline">${detalhes}</pre>` : ''}
                            ${itensAlterados}
                        `;
                    }
                }


                let statusInfo = '';
                if (entrega.status === 'Entregue') {
                    statusInfo = `
                        <div class="mt-2 text-sm font-semibold text-green-700">
                            Status: Entregue<br>
                            Pagamento: ${entrega.formaPagamento.join(', ')}<br>
                            Hora: ${formatarData(entrega.horarioEntrega)}
                        </div>
                    `;
                } else if (entrega.status === 'Cancelada') {
                    statusInfo = `
                        <div class="mt-2 text-sm font-semibold text-red-700">
                            Status: Cancelada<br>
                            Hora: ${formatarData(entrega.horarioEntrega)}
                        </div>
                    `;
                }
                
                // NOVO: Faixa de Status (para Entregue)
                let faixaStatusHtml = '';
                if (entrega.status === 'Entregue') {
                    faixaStatusHtml = `
                        <div class="absolute inset-0 bg-white/70 flex items-center justify-center pointer-events-none z-10">
                            <span class="text-7xl font-black text-green-500 opacity-80 transform -rotate-12 select-none">ENTREGUE</span>
                        </div>
                    `;
                }

                let obsInfo = '';
                if (entrega.observacao) {
                    obsInfo = `<p class="card-info-item text-red-600 font-bold break-words-mobile">OBS: ${entrega.observacao}</p>`;
                }

                // Layout de Informa√ß√µes Principais (Mobile e Desktop)
                let infoClienteHtml = `
                    <p class="text-lg font-bold text-gray-800 break-words-mobile" title="${entrega.cliente.nome}">${entrega.cliente.nome} <span class="text-sm font-extrabold text-blue-700 ml-1">(${entrega.regiao})</span></p>
                    <p class="text-base text-gray-600 break-words-mobile" title="${entrega.cliente.endereco || ''}">Endere√ßo: ${entrega.cliente.endereco || 'Sem endere√ßo'}</p>
                    <p class="text-base text-gray-500 break-words-mobile" title="${entrega.cliente.complemento || ''}">Complemento: ${entrega.cliente.complemento || '-'}</p>
                    <p class="text-base font-bold text-blue-600">Celular: ${entrega.cliente.celular || 'Sem celular'}</p>
                    
                    <div class="mt-2">
                        ${listaCestasHtml}
                    </div>
                    
                    <p class="text-xl font-extrabold text-green-700 mt-2">TOTAL PEDIDO: ${formatarMoeda(valorTotalPedido)}</p>
                `;
                
                const isPrimeiro = index === 0;
                const isUltimo = index === entregasRenderizar.length - 1;

                let whatsappHref = '#';
                let whatsappDisabled = true;
                let whatsappClass = 'bg-white text-gray-400 border border-gray-300 cursor-not-allowed';
                if (entrega.cliente.celular && !isFinalizada) {
                    const numeroLimpo = entrega.cliente.celular.replace(/\D/g, '');
                    const numeroFinal = numeroLimpo.startsWith('55') ? numeroLimpo : `55${numeroLimpo}`;
                    
                    if(numeroFinal.length >= 10) { 
                        whatsappHref = `javascript:void(0);`; 
                        whatsappDisabled = false;
                        whatsappClass = 'bg-green-600 text-white hover:bg-green-700'; 
                    }
                }
                
                // Defini√ß√£o dos bot√µes simples (texto)
                const btnClassesBase = "w-full text-sm font-medium shadow-sm py-3 rounded-md";
                
                // NOVO: Os bot√µes de a√ß√£o devem ser desabilitados se o status for finalizado/cancelado
                const desabilitarBotoes = isFinalizada ? 'disabled' : '';
                const desabilitarMover = isFinalizada ? 'disabled' : '';

                const btnWhatsapp = `<button data-id="${entrega.id}" class="btn-whatsapp-modal ${btnClassesBase} ${whatsappClass}" ${whatsappDisabled || isFinalizada ? 'disabled' : ''}>WHATSAPP</button>`;
                const btnMaps = `<button class="btn-card-maps ${btnClassesBase} bg-white text-gray-700 border border-gray-300 hover:bg-gray-50" ${desabilitarBotoes}>MAPA</button>`;
                
                const btnAcaoPrincipal = entrega.status === 'Pendente' ? `
                    <button class="btn-entregue ${btnClassesBase} bg-blue-600 text-white hover:bg-blue-700" data-id="${entrega.id}">ENTREGUE</button>
                ` : `<button class="btn-entregue ${btnClassesBase} bg-green-600 text-white cursor-not-allowed" disabled>ENTREGUE</button>`;
                
                const btnCancelar = entrega.status === 'Pendente' ? `
                    <button class="btn-cancelar-entrega ${btnClassesBase} bg-red-100 text-red-700 border border-red-300 hover:bg-red-200" data-id="${entrega.id}">CANCELAR</button>
                ` : `<button class="btn-cancelar-entrega ${btnClassesBase} bg-gray-300 text-gray-600 cursor-not-allowed" disabled>CANCELAR</button>`;


                card.innerHTML = `
                    ${faixaStatusHtml} 
                    <div class="flex-1 min-w-0 ${isFinalizada ? 'opacity-50' : ''}">
                        <div class="flex items-start">
                            <div class="flex flex-col items-center justify-center mr-3 pt-2 flex-shrink-0">
                                <button class="btn-mover-cima text-gray-400 ${isPrimeiro || isFinalizada || isUltimo ? 'opacity-25 cursor-not-allowed' : 'hover:text-blue-600'}" data-id="${entrega.id}" title="Mover Cima" ${isPrimeiro || isFinalizada || isUltimo ? 'disabled' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg>
                                </button>
                                <button class="btn-mover-baixo text-gray-400 ${isUltimo || isFinalizada ? 'opacity-25 cursor-not-allowed' : 'hover:text-blue-600'}" data-id="${entrega.id}" title="Mover Baixo" ${isUltimo || isFinalizada ? 'disabled' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                                </button>
                            </div>

                            <div class="w-full min-w-0 space-y-1">
                                ${infoClienteHtml}
                            </div>
                        </div>
                        
                        <div class="mt-4 sm:ml-12 w-full space-y-1">
                            ${obsInfo}
                            ${infoAlteracao}
                            ${infoBrinde}
                            ${statusInfo}
                        </div>
                    </div>
                    
                    <div class="mt-4 sm:mt-0 sm:ml-4 flex-shrink-0 w-full sm:w-auto ${isFinalizada ? 'opacity-50' : ''}">
                        <div class="grid grid-cols-2 gap-2 w-full sm:w-auto">
                            ${btnWhatsapp}
                            ${btnMaps}
                            ${btnCancelar}
                            ${btnAcaoPrincipal}
                        </div>
                    </div>
                `;
                listaEntregasEl.appendChild(card);
            });
            
            atualizarPlacar();
        }
        
        // --- Fun√ß√µes para M√∫ltiplas Cestas no Lan√ßamento ---

        /**
         * Adiciona uma cesta √† lista tempor√°ria do pedido.
         */
        function adicionarCestaAoPedido() {
            const selectedOption = selectCestaAdicionar.options[selectCestaAdicionar.selectedIndex];
            const nome = selectedOption.value;
            const valor = formatarValorFloat(selectedOption.dataset.valor);
            const qtd = parseInt(inputQtdCestaAdicionar.value) || 1;
            
            if (qtd < 1) {
                mostrarAviso("A quantidade deve ser de no m√≠nimo 1.");
                return;
            }
            
            // Adiciona/Atualiza a cesta
            const cestaExistente = cestasNoPedido.find(c => c.nome === nome);
            if (cestaExistente) {
                cestaExistente.qtd += qtd;
            } else {
                cestasNoPedido.push({ nome, valor, qtd });
            }
            
            // Reseta a quantidade para 1 para a pr√≥xima
            inputQtdCestaAdicionar.value = 1;
            
            renderizarListaCestasPedido();
        }

        /**
         * Remove uma cesta da lista tempor√°ria do pedido.
         * @param {string} nomeCesta - Nome da cesta a ser removida
         */
        function removerCestaDoPedido(nomeCesta) {
            cestasNoPedido = cestasNoPedido.filter(c => c.nome !== nomeCesta);
            renderizarListaCestasPedido();
        }

        /**
         * Renderiza a lista de cestas tempor√°rias e atualiza o total.
         */
        function renderizarListaCestasPedido() {
            listaCestasPedidoEl.innerHTML = '';
            let total = 0;
            
            if (cestasNoPedido.length === 0) {
                listaCestasPedidoEl.innerHTML = '<p class="text-sm text-gray-500">Nenhuma cesta adicionada.</p>';
                inputValorTotalPedidoEl.value = '0.00';
                displayTotalPedidoEl.textContent = 'R$ 0,00';
                return;
            }
            
            cestasNoPedido.forEach(cesta => {
                const itemTotal = cesta.valor * cesta.qtd;
                total += itemTotal;
                
                const itemEl = document.createElement('div');
                itemEl.className = 'flex justify-between items-center bg-white p-2 rounded-md border border-blue-200';
                itemEl.innerHTML = `
                    <span class="text-sm font-medium text-gray-700">${cesta.qtd}x ${cesta.nome}</span>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-bold text-blue-600">${formatarMoeda(itemTotal)}</span>
                        <button type="button" data-nome="${cesta.nome}" class="btn-remover-cesta text-red-500 hover:text-red-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                `;
                listaCestasPedidoEl.appendChild(itemEl);
            });
            
            inputValorTotalPedidoEl.value = total.toFixed(2);
            displayTotalPedidoEl.textContent = formatarMoeda(total);
        }

        // --- Fun√ß√µes Espec√≠ficas do WhatsApp ---

        function abrirModalWhatsapp(id) {
            const entregas = getEntregasAtivas();
            const entrega = entregas.find(e => e.id.toString() === id);
            if (!entrega) return;

            entregaParaWhatsappId = id;

            modalWhatsappClienteNome.textContent = entrega.cliente.nome;
            
            // NOVO: Info de Cesta no Modal WhatsApp
            const totalPedido = entrega.cestas.reduce((total, c) => total + (c.valor * c.qtd), 0);
            let cestaInfo = `TOTAL: ${formatarMoeda(totalPedido)}. ${entrega.cestas.map(c => `${c.qtd}x ${c.nome}`).join(' | ')}`;

            if (entrega.tipo === 'Alterada') {
                cestaInfo += ' - ALTERADA';
            }
            if (Array.isArray(entrega.brindes) && entrega.brindes.length > 0) {
                 cestaInfo += ` + BRINDE (${entrega.brindes.join(', ')}`;
            }
            modalWhatsappCestaInfo.textContent = cestaInfo;
            
            modalWhatsappOpcoes.classList.remove('hidden');
        }

        function fecharModalWhatsapp() {
            modalWhatsappOpcoes.classList.add('hidden');
            entregaParaWhatsappId = null;
        }

        /**
         * NOVO: Gera um relat√≥rio r√°pido e abre o WhatsApp (para o n√∫mero de Pagamento)
         * @param {Object} entrega - O objeto da entrega.
         * @param {Array} formasPagamento - Array de strings com as formas de pagamento.
         */
        function gerarRelatorioRapidoWhatsapp(entrega, formasPagamento) {
             const numeroDestino = `55${PIX_CELULAR}`; // Sempre para o n√∫mero de pagamento
             
             // NOVO: Calcula o valor total do pedido
             const totalPedido = entrega.cestas.reduce((total, c) => total + (c.valor * c.qtd), 0);
             const cestaValor = formatarMoeda(totalPedido);
             
             const horaEntrega = formatarData(entrega.horarioEntrega).split(' ')[1]; // Pega apenas a hora

             let mensagem = `*‚úÖ ENTREGA CONCLU√çDA - Relat√≥rio R√°pido*\n\n`;
             mensagem += `*Cliente:* ${entrega.cliente.nome}\n`;
             mensagem += `*Regi√£o:* ${entrega.regiao}\n`;
             
             // NOVO: Detalhe das cestas
             mensagem += `*Cestas:* ${entrega.cestas.map(c => `${c.qtd}x ${c.nome}`).join(', ')}\n`;
             mensagem += `*Valor:* ${cestaValor}\n`;
             
             mensagem += `*Formas de Pagamento:* ${formasPagamento.join(', ')}\n`;
             mensagem += `*Hora:* ${horaEntrega}\n\n`;
             
             // Incluir observa√ß√µes, se houver, para contexto do financeiro
             if (entrega.observacao || entrega.tipo === 'Alterada') {
                 mensagem += `--- Detalhes da Cesta ---\n`;
                 if (entrega.tipo === 'Alterada' && entrega.codigoAlterada.trim()) {
                     // Adiciona o detalhe multi-linha de forma limpa
                     mensagem += `*Altera√ß√£o Detalhe:*\n${entrega.codigoAlterada.trim()}\n`;
                 }
                 if (entrega.observacao) {
                    mensagem += `*Obs Cliente:* ${entrega.observacao}\n`;
                 }
             }

             const url = `https://api.whatsapp.com/send?phone=${numeroDestino}&text=${encodeURIComponent(mensagem)}`;
             window.open(url, '_blank');
        }


        function gerarMensagem(msgId, entrega) {
            const clienteNome = entrega.cliente.nome;
            
            // NOVO: Calcula o valor total do pedido
            const totalPedido = entrega.cestas.reduce((total, c) => total + (c.valor * c.qtd), 0);
            const cestaValor = formatarMoeda(totalPedido);
            
            const numeroCliente = entrega.cliente.celular ? entrega.cliente.celular.replace(/\D/g, '') : '';
            const numeroClienteFinal = numeroCliente.length > 0 && !numeroCliente.startsWith('55') ? `55${numeroCliente}` : numeroCliente;
            
            let mensagem = "";
            let numeroDestino = numeroClienteFinal;
            let targetBlank = true;

            if (!numeroClienteFinal && msgId !== 4) {
                 mostrarAviso("O cliente n√£o tem um n√∫mero de celular cadastrado para enviar esta mensagem.");
                 return;
            }

            switch(msgId) {
                case 1: 
                    mensagem = `Ol√°, aqui √© o entregador da ${NOME_EMPRESA}. A sua cesta b√°sica chegar√° em 10 minutos.`;
                    break;
                case 2: 
                    mensagem = `Ol√°, cheguei, j√° pode sair para receber a cesta.`;
                    break;
                case 3: 
                    mensagem = `Dados do pix para pagamento:\n*PIX*: ${PIX_CELULAR} (celular)\n*Nome*: ${PIX_NOME}\n*Valor Total*: ${cestaValor}`;
                    break;
                case 4: 
                    numeroDestino = NUMERO_GERENTE;
                    targetBlank = true; 

                    let detalhesAlterada = '';
                    if (entrega.tipo === 'Alterada') {
                        
                        detalhesAlterada += "\n*ALTERADA:*";
                        
                        const detalhes = entrega.codigoAlterada.trim();
                        if (detalhes.length > 0) {
                            const detalhesFormatados = detalhes.split('\n').map(line => `   ${line}`).join('\n');
                            detalhesAlterada += `\n${detalhesFormatados}`; 
                        }

                        if (Array.isArray(entrega.partesAlteradas) && entrega.partesAlteradas.length > 0) {
                            detalhesAlterada += `\n\n*Itens Alterados*: ${entrega.partesAlteradas.join(', ')}`;
                        }
                    }
                    
                    let cestasInfo = entrega.cestas.map(c => `${c.qtd}x ${c.nome} (${formatarMoeda(c.valor * c.qtd)})`).join(' | ');

                    let brindes = Array.isArray(entrega.brindes) && entrega.brindes.length > 0 ? `\n*Brindes*: ${entrega.brindes.join(', ')}` : "";
                    let obsCliente = entrega.observacao ? `\n*Obs Cliente*: ${entrega.observacao}` : "";

                    mensagem = `*NOVO PEDIDO (ENTREGA)*\n\n*Cliente*: ${clienteNome}\n*Cestas*: ${cestasInfo}${detalhesAlterada}${brindes}${obsCliente}\n*Valor Total*: ${cestaValor}\n*Celular Cliente*: ${entrega.cliente.celular}`;
                    break;
                default:
                    return;
            }

            const url = `https://api.whatsapp.com/send?phone=${numeroDestino}&text=${encodeURIComponent(mensagem)}`;
            
            fecharModalWhatsapp();
            window.open(url, targetBlank ? '_blank' : '_self');
        }

        // --- Fun√ß√µes de Lan√ßamento e Status ---

        function adicionarEntrega(e) {
            e.preventDefault();
            
            if (cestasNoPedido.length === 0) {
                 mostrarAviso('Por favor, adicione ao menos uma cesta ao pedido.');
                 return;
            }
            
            const rotaAtiva = todasAsRotas[rotaAtivaId];
            if (!rotaAtiva) {
                mostrarAviso("Nenhuma rota ativa selecionada. Crie uma nova rota.");
                return;
            }
            const entregas = rotaAtiva.entregas;

            const nomeClienteSelecionado = inputCliente.value.trim();
            const clienteSelecionado = CLIENTES_CACHE[nomeClienteSelecionado.toLowerCase()];

            let clienteData;
            if (clienteSelecionado) {
                clienteData = { ...clienteSelecionado };
            } else {
                clienteData = {
                    nome: nomeClienteSelecionado,
                    celular: '',
                    endereco: nomeClienteSelecionado,
                    complemento: ''
                };
            }

            if (!clienteData.nome) {
                mostrarAviso('Por favor, selecione ou digite um nome de cliente.');
                return;
            }
            
            // Coleta Regi√£o
            const regiaoSelecionadaEl = document.querySelector('input[name="regiao-entrega"]:checked');
            if (!regiaoSelecionadaEl) {
                mostrarAviso('Por favor, selecione a Regi√£o da Entrega.');
                return;
            }
            const regiaoSelecionada = regiaoSelecionadaEl.value;

            const partesAlteradasSelecionadas = 
                Array.from(formEntrega.querySelectorAll('input[name="partes_alteradas"]:checked'))
                     .map(input => input.value);
            
            const brindesSelecionados = Array.from(formEntrega.querySelectorAll('input[name="brindes_opcoes"]:checked')).map(input => input.value);
            
            const novaEntrega = {
                id: Date.now(),
                cliente: clienteData,
                observacao: obsClienteInput.value.trim(),
                regiao: regiaoSelecionada, 
                // NOVO: Agora √© um array de cestas
                cestas: [...cestasNoPedido], 
                // Valor total n√£o √© mais necess√°rio aqui, ser√° calculado na renderiza√ß√£o/exporta√ß√£o
                tipo: document.querySelector('input[name="tipo-cesta"]:checked').value,
                codigoAlterada: codigoAlteradaInput.value.trim(),
                partesAlteradas: partesAlteradasSelecionadas,
                brindes: brindesSelecionados, 
                status: "Pendente",
                formaPagamento: [],
                horarioEntrega: null
            };

            entregas.push(novaEntrega);
            salvarLocalStorage();
            
            filtrarEntregas(regiaoAtiva); 

            // NOVO: Resetar o formul√°rio de cestas
            cestasNoPedido = [];
            renderizarListaCestasPedido();

            formEntrega.reset();
            inputCliente.value = '';
            infoClienteSelecionado.classList.add('hidden');
            toggleCampoAlterada();
            
            // Aumenta o √≠ndice da frase motivacional
            indiceFrase = (indiceFrase + 1) % FRASES_GAMIFICADAS.length;
            
            if (!contentLancamento.classList.contains('open')) {
                toggleLancamento();
            }
        }

        function abrirGoogleMaps(query) {
            const enderecoFormatado = query.trim();
            if (!enderecoFormatado) {
                mostrarAviso('O cliente n√£o possui um endere√ßo cadastrado para abrir no mapa.');
                return;
            }
            const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(enderecoFormatado)}`;
            window.open(url, '_blank');
        }

        function abrirModalPagamento(id) {
            const entregas = getEntregasAtivas();
            const entrega = entregas.find(e => e.id.toString() === id);
            if (!entrega) return;
            
            // NOVO: C√°lculo do valor total
            const totalPedido = entrega.cestas.reduce((total, c) => total + (c.valor * c.qtd), 0);

            entregaParaPagarId = id;
            
            modalClienteNome.textContent = entrega.cliente.nome;
            modalClienteValor.textContent = formatarMoeda(totalPedido);
            
            formPagamento.reset();
            modalErrorPagamento.classList.add('hidden');

            modalPagamento.classList.remove('hidden');
        }

        function fecharModalPagamento() {
            modalPagamento.classList.add('hidden');
            entregaParaPagarId = null;
        }

        function cancelarEntrega(id) {
            if (!confirm("Tem certeza que deseja MARCAR ESTA ENTREGA COMO CANCELADA?")) return;

            const entregas = getEntregasAtivas();
            const index = entregas.findIndex(e => e.id.toString() === id);
            if (index !== -1) {
                entregas[index].status = "Cancelada";
                entregas[index].formaPagamento = [];
                entregas[index].horarioEntrega = new Date().toISOString();
                
                // NOVO: Mover para o final ap√≥s o cancelamento
                moverEntregaParaOFinal(id); 
            }
            salvarLocalStorage();
            renderizarEntregas();
        }

        function moverEntrega(id, direcao) {
            const entregas = getEntregasAtivas().filter(e => e.status === 'Pendente' && e.regiao === regiaoAtiva); // Apenas pendentes na regi√£o ativa
            const todasEntregas = getEntregasAtivas();
            const index = entregas.findIndex(e => e.id.toString() === id);
            if (index === -1) return;

            const entregaA = entregas[index];
            let indexNaRotaA = todasEntregas.findIndex(e => e.id.toString() === entregaA.id.toString());

            let indexNaRotaB = -1;
            
            if (direcao === 'cima' && index > 0) {
                const entregaB = entregas[index - 1];
                indexNaRotaB = todasEntregas.findIndex(e => e.id.toString() === entregaB.id.toString());
                
            } else if (direcao === 'baixo' && index < entregas.length - 1) {
                const entregaB = entregas[index + 1];
                indexNaRotaB = todasEntregas.findIndex(e => e.id.toString() === entregaB.id.toString());

            } else {
                return;
            }
            
            // Troca de posi√ß√£o na lista GERAL
            if (indexNaRotaA !== -1 && indexNaRotaB !== -1) {
                [todasEntregas[indexNaRotaA], todasEntregas[indexNaRotaB]] = [todasEntregas[indexNaRotaB], todasEntregas[indexNaRotaA]];
            } else {
                return;
            }
            
            salvarLocalStorage();
            renderizarEntregas();
        }

        function handleCardClick(e) {
            // Verifica se o card n√£o est√° em modo desabilitado (cancelada ou entregue)
            const cardEl = e.target.closest('[data-id]');
            if (cardEl && cardEl.classList.contains('cancelada')) return;
            // Se for entregue, apenas o mover-cima/baixo est√° desabilitado, os outros n√£o.
            // if (cardEl && cardEl.classList.contains('entregue')) return;

            const btnCima = e.target.closest('.btn-mover-cima');
            if (btnCima && !btnCima.disabled) {
                moverEntrega(btnCima.dataset.id, 'cima');
                return;
            }

            const btnBaixo = e.target.closest('.btn-mover-baixo');
            if (btnBaixo && !btnBaixo.disabled) {
                moverEntrega(btnBaixo.dataset.id, 'baixo');
                return;
            }

            const btnCancelar = e.target.closest('.btn-cancelar-entrega');
            if (btnCancelar && !btnCancelar.disabled) {
                cancelarEntrega(btnCancelar.dataset.id);
                return;
            }

            const btnMaps = e.target.closest('.btn-card-maps');
            if (btnMaps && !btnMaps.disabled) {
                const cardId = btnMaps.closest('[data-id]').dataset.id;
                const entregas = getEntregasAtivas();
                const entrega = entregas.find(e => e.id.toString() === cardId);
                if (entrega) {
                    abrirGoogleMaps(entrega.cliente.endereco);
                }
                return;
            }
            
            // Checa clique no bot√£o ENTREGUE
            const target = e.target.closest('.btn-entregue');
            const isMarcarEntrega = target && target.textContent.trim().toUpperCase().includes('ENTREGUE') && !target.disabled;
            
            if (isMarcarEntrega) {
                const cardId = target.dataset.id;
                abrirModalPagamento(cardId);
                return;
            }

            // A√ß√£o WhatsApp
            const btnWhatsapp = e.target.closest('.btn-whatsapp-modal');
            if (btnWhatsapp && !btnWhatsapp.disabled) {
                abrirModalWhatsapp(btnWhatsapp.dataset.id); 
                return;
            }
        }

        /**
         * MODIFICADO: Salva a entrega, move para o final e redireciona para o WhatsApp com relat√≥rio r√°pido.
         */
        function salvarPagamento(e) {
            e.preventDefault();
            
            const formasPagamentoSelecionadas = 
                Array.from(formPagamento.querySelectorAll('input[name="forma_pagamento"]:checked'))
                     .map(input => input.value);
            
            if (formasPagamentoSelecionadas.length === 0) {
                modalErrorPagamento.classList.remove('hidden');
                return;
            }
            
            const entregas = getEntregasAtivas();
            const index = entregas.findIndex(e => e.id.toString() === entregaParaPagarId);
            
            if (index !== -1) {
                const entrega = entregas[index];

                // 1. Atualiza o status e salva
                entrega.status = "Entregue";
                entrega.formaPagamento = formasPagamentoSelecionadas;
                entrega.horarioEntrega = new Date().toISOString();
                
                moverEntregaParaOFinal(entregaParaPagarId); // Move para o final antes de renderizar
                
                salvarLocalStorage();
                renderizarEntregas();
                fecharModalPagamento();

                // Aumenta o √≠ndice da frase motivacional
                indiceFrase = (indiceFrase + 1) % FRASES_GAMIFICADAS.length;

                // 2. Gera e envia o relat√≥rio r√°pido via WhatsApp
                gerarRelatorioRapidoWhatsapp(entrega, formasPagamentoSelecionadas);

            } else {
                fecharModalPagamento();
            }
        }
        
        // --- Fun√ß√µes de Exporta√ß√£o/Relat√≥rio ---

        function downloadArquivo(data, filename) {
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function fecharModalExportar() {
            modalExportar.classList.add('hidden');
        }

        function exportarDados() {
            const rotaAtiva = todasAsRotas[rotaAtivaId];
            if (!rotaAtiva) {
                mostrarAviso("Nenhuma rota ativa para exportar.");
                return;
            }
            
            salvarDespesasDoModal(); 
            
            // NOVO: Obter regi√µes selecionadas para filtro
            const regioesSelecionadas = 
                Array.from(document.querySelectorAll('input[name="regiao-exportar"]:checked'))
                     .map(input => input.value);
            
            const entregas = rotaAtiva.entregas.filter(e => regioesSelecionadas.includes(e.regiao));
            
            if (regioesSelecionadas.length === 0) {
                mostrarAviso("Selecione pelo menos uma regi√£o para exportar o relat√≥rio.");
                return;
            }


            const entregasConcluidas = entregas.filter(e => e.status === 'Entregue');
            const entregasCanceladas = entregas.filter(e => e.status === 'Cancelada');
            
            let relatorioTexto = "";
            let whatsappTexto = `*Resumo da Rota: ${rotaAtiva.nome}* (${new Date(rotaAtiva.data + 'T12:00:00').toLocaleDateString('pt-BR')})\n`;
            whatsappTexto += `*Regi√µes no Relat√≥rio: ${regioesSelecionadas.join(', ')}*\n\n`;

            if (entregasConcluidas.length === 0 && entregasCanceladas.length === 0) {
                relatorioTexto = "Nenhuma entrega finalizada nas regi√µes selecionadas.";
            }

            if (entregasConcluidas.length > 0) {
                relatorioTexto += "--- RELAT√ìRIO DE ENTREGAS ---\n\n";
                entregasConcluidas.forEach(e => {
                    // NOVO: C√°lculo do valor total
                    const totalPedido = e.cestas.reduce((total, c) => total + (c.valor * c.qtd), 0);
                    
                    relatorioTexto += `Cliente: ${e.cliente.nome}\n`;
                    relatorioTexto += `Valor: ${formatarMoeda(totalPedido)}\n`;
                    relatorioTexto += `Pagamento: ${e.formaPagamento.join(', ')}\n`;
                    relatorioTexto += `Hor√°rio: ${formatarData(e.horarioEntrega)}\n`;
                    relatorioTexto += `-----------------------------\n`;
                });
            }

            if (entregasCanceladas.length > 0) {
                relatorioTexto += "\n--- ENTREGAS CANCELADAS ---\n\n";
                entregasCanceladas.forEach(e => {
                    relatorioTexto += `Cliente: ${e.cliente.nome}\n`;
                    relatorioTexto += `Hor√°rio: ${formatarData(e.horarioEntrega)}\n`;
                    relatorioTexto += `-----------------------------\n`;
                });
            }
            
            const entregasPendentes = entregas.filter(e => e.status === 'Pendente');
            whatsappTexto += `*Entregas Pendentes (${entregasPendentes.length})*:\n`;
            if(entregasPendentes.length > 0) {
                entregasPendentes.forEach((e, index) => {
                    whatsappTexto += `${index + 1}. *${e.cliente.nome}* (${e.cliente.celular || 'Sem Celular'}) - Regi√£o: ${e.regiao}\n`;
                    if (e.cliente.endereco) { whatsappTexto += `   End: ${e.cliente.endereco}\n`; }
                    if (e.cliente.complemento) { whatsappTexto += `   Comp: ${e.cliente.complemento}\n`; }
                    // NOVO: Detalhe das cestas
                    const totalPedido = e.cestas.reduce((total, c) => total + (c.valor * c.qtd), 0);
                    whatsappTexto += `   Cestas: ${e.cestas.map(c => `${c.qtd}x ${c.nome}`).join(' | ')} (${formatarMoeda(totalPedido)})\n`;
                    
                    if (Array.isArray(e.brindes) && e.brindes.length > 0) { whatsappTexto += `   BRINDE(S): ${e.brindes.join(', ')}\n`; }
                    if (e.observacao) { whatsappTexto += `   OBS (Cliente): ${e.observacao}\n`; }
                    if(e.tipo === 'Alterada') {
                        // Formata√ß√£o para o gerente: preservando TIRA/POR e itens alterados
                        const detalhes = e.codigoAlterada.trim();

                        whatsappTexto += `\n   *Cesta Alterada:*`;
                        
                        if (detalhes.length > 0) {
                            const detalhesFormatados = detalhes.split('\n').map(line => `   ${line}`).join('\n');
                            whatsappTexto += `\n${detalhesFormatados}`; 
                        }
                        
                        if (Array.isArray(e.partesAlteradas) && e.partesAlteradas.length > 0) { 
                            whatsappTexto += `\n   *Itens Alterados*: ${e.partesAlteradas.join(', ')}`;
                        }
                        whatsappTexto += '\n'; // Adiciona uma quebra de linha ap√≥s o bloco alterado
                    }
                });
            } else {
                whatsappTexto += `Nenhuma entrega pendente nas regi√µes selecionadas.\n`;
            }
            
            // Se√ß√£o Relat√≥rio Financeiro
            whatsappTexto += `\n\n--- RELAT√ìRIO FINANCEIRO ---\n`;
            
            let totalVendido = 0;
            let totalPorCesta = {};
            let totalPorPagamento = {};

            entregasConcluidas.forEach(e => {
                const valorTotalPedido = e.cestas.reduce((total, c) => total + (c.valor * c.qtd), 0);
                totalVendido += valorTotalPedido;
                
                e.cestas.forEach(c => {
                    totalPorCesta[c.nome] = (totalPorCesta[c.nome] || 0) + (c.valor * c.qtd);
                });

                if (e.formaPagamento.length === 0) {
                    totalPorPagamento['N/A'] = (totalPorPagamento['N/A'] || 0) + valorTotalPedido;
                } else {
                    const valorDividido = valorTotalPedido / e.formaPagamento.length;
                    e.formaPagamento.forEach(forma => {
                        totalPorPagamento[forma] = (totalPorPagamento[forma] || 0) + valorDividido;
                    });
                }
            });

            whatsappTexto += `\n*Vendas Conclu√≠das:*\n`;
            whatsappTexto += `Total Vendido: *${formatarMoeda(totalVendido)}*\n`;

            whatsappTexto += `\n*Detalhado por Cesta:*\n`;
            if (Object.keys(totalPorCesta).length > 0) {
                Object.keys(totalPorCesta).forEach(nomeCesta => {
                    whatsappTexto += `   ${nomeCesta}: ${formatarMoeda(totalPorCesta[nomeCesta])}\n`;
                });
            } else {
                whatsappTexto += `   Nenhuma.\n`;
            }

            whatsappTexto += `\n*Recebimentos por Forma:*\n`;
            if (Object.keys(totalPorPagamento).length > 0) {
                Object.keys(totalPorPagamento).forEach(forma => {
                    whatsappTexto += `   ${forma}: ${formatarMoeda(formatarValorFloat(totalPorPagamento[forma]))}\n`;
                });
            } else {
                 whatsappTexto += `   Nenhum.\n`;
            }

            // Despesas (Lendo do objeto da rota que foi ATUALIZADO)
            const despesas = rotaAtiva.despesas;
            const totalDespesas = (despesas.abastecimento || 0) + (despesas.alimentacao || 0) + (despesas.extra || 0);
            
            // Inclus√£o das despesas no relat√≥rio do WhatsApp
            whatsappTexto += `\n*Despesas da Rota:*\n`;
            whatsappTexto += `   Abastecimento: ${formatarMoeda(despesas.abastecimento || 0)}\n`;
            whatsappTexto += `   Alimenta√ß√£o: ${formatarMoeda(despesas.alimentacao || 0)}\n`;
            whatsappTexto += `   Extras: ${formatarMoeda(despesas.extra || 0)}\n`;
            whatsappTexto += `*Total Despesas:* ${formatarMoeda(totalDespesas)}\n`;

            const balanco = totalVendido - totalDespesas;
            whatsappTexto += `\n*BALAN√áO FINAL (Vendido - Despesas):*\n`;
            whatsappTexto += `*${formatarMoeda(balanco)}*\n`;

            exportRelatorioEl.querySelector('pre').textContent = relatorioTexto;
            
            // Bot√£o de Exporta√ß√£o para o WhatsApp (Garante que o bot√£o √© recriado)
            const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(whatsappTexto)}`;
            exportWhatsappLinkEl.innerHTML = `
                <a href="${whatsappUrl}" target="_blank" class="inline-flex items-center justify-center w-full rounded-md border border-transparent bg-green-500 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-green-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM5.5 8.5A1.5 1.5 0 017 7h6a1.5 1.5 0 011.5 1.5v3A1.5 1.5 0 0113 13H7a1.5 1.5 0 01-1.5-1.5v-3z" /></svg>
                    Enviar Resumo no WhatsApp
                </a>`;

            modalExportar.classList.remove('hidden');
        }

        function carregarDados(jsonDados) {
            if (!jsonDados) {
                mostrarAviso("O arquivo est√° vazio ou n√£o p√¥de ser lido.");
                return;
            }
            
            try {
                const dadosCarregados = JSON.parse(jsonDados);
                
                // Fun√ß√£o auxiliar para padronizar cestas
                const padronizarCestas = (entrega) => {
                    // Se j√° for a nova estrutura (array de cestas), usa
                    if (entrega.cestas && Array.isArray(entrega.cestas)) {
                        return entrega.cestas;
                    }
                    // Se for a estrutura antiga (cesta √∫nica), converte
                    if (entrega.cesta && typeof entrega.cesta === 'object') {
                        return [{
                            nome: entrega.cesta.nome || 'Cesta Padr√£o',
                            valor: parseFloat(entrega.cesta.valor) || 0,
                            qtd: 1
                        }];
                    }
                    // Caso contr√°rio, retorna um array vazio (erro de dados)
                    return [];
                };

                const padronizarCliente = (e) => {
                    return typeof e.cliente === 'object' ? e.cliente : {
                        nome: e.codigoCliente || 'Cliente Antigo',
                        celular: e.celular || '',
                        endereco: e.endereco || e.codigoCliente || 'Sem Endere√ßo',
                        complemento: e.complemento || ''
                    };
                };
                
                // CARREGAMENTO DE ROTA COMPLETA (NOVA ESTRUTURA)
                if (typeof dadosCarregados === 'object' && !Array.isArray(dadosCarregados) && dadosCarregados.entregas) {
                    
                    if (!dadosCarregados.id || !dadosCarregados.nome || !dadosCarregados.data) {
                        throw new Error('Objeto de rota inv√°lido. Faltando id, nome ou data.');
                    }

                    let novoId = dadosCarregados.id;
                    if (todasAsRotas[novoId]) {
                        novoId = `import-${Date.now()}`;
                    }
                    dadosCarregados.id = novoId;

                    dadosCarregados.despesas = dadosCarregados.despesas || { abastecimento: 0, alimentacao: 0, extra: 0 };
                    
                    dadosCarregados.entregas = dadosCarregados.entregas.map(e => ({
                        regiao: e.regiao || 'CUIABA', 
                        brindes: (e.brindes && Array.isArray(e.brindes)) ? e.brindes : (e.brinde === 'Sim' ? ['Brinde Padr√£o'] : []), 
                        partesAlteradas: e.partesAlteradas || [],
                        observacao: e.observacao || '',
                        ...e,
                        cliente: padronizarCliente(e),
                        cestas: padronizarCestas(e), // Converte ou usa o array
                    }));

                    todasAsRotas[novoId] = dadosCarregados;
                    rotaAtivaId = novoId;
                    
                    salvarTodasAsRotas();
                    popularSelectRotas();
                    carregarRotaAtiva();
                    mostrarAviso(`Rota "${dadosCarregados.nome}" importada com sucesso e definida como ativa!`);

                } 
                // CARREGAMENTO DE LISTA SIMPLES (ANTIGA ESTRUTURA)
                else if (Array.isArray(dadosCarregados) && dadosCarregados.length > 0) {
                    const rotaAtiva = todasAsRotas[rotaAtivaId];
                    if (!rotaAtiva) {
                        mostrarAviso("Nenhuma rota ativa. Crie uma nova rota antes de carregar um arquivo antigo.");
                        return;
                    }

                    rotaAtiva.entregas = dadosCarregados.map(e => ({
                        regiao: e.regiao || 'CUIABA', 
                        brindes: (e.brindes && Array.isArray(e.brindes)) ? e.brindes : (e.brinde === 'Sim' ? ['Brinde Padr√£o'] : []), 
                        partesAlteradas: e.partesAlteradas || [],
                        observacao: e.observacao || '',
                        status: e.status || "Pendente",
                        formaPagamento: e.formaPagamento || [],
                        horarioEntrega: e.horarioEntrega || null,
                        ...e,
                        cliente: padronizarCliente(e),
                        cestas: padronizarCestas(e), // Converte ou usa o array
                    }));
                    
                    rotaAtiva.despesas = { abastecimento: 0, alimentacao: 0, extra: 0 }; 

                    salvarTodasAsRotas();
                    carregarRotaAtiva();
                    mostrarAviso(`Lista de ${dadosCarregados.length} entregas carregada na rota ativa!`);

                } else {
                    throw new Error('Formato de arquivo JSON desconhecido ou lista vazia.');
                }

            } catch (error) {
                console.error("Erro ao carregar JSON:", error);
                mostrarAviso(`Dados inv√°lidos. Verifique o arquivo. (Erro: ${error.message})`);
            }
        }

        function handleArquivoCarregado(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    carregarDados(event.target.result);
                } catch (error) {
                    mostrarAviso(`Erro ao processar o arquivo: ${error.message}`);
                }
            };
            reader.onerror = () => {
                mostrarAviso('N√£o foi poss√≠vel ler o arquivo.');
            };
            reader.readAsText(file);
            
            e.target.value = null;
        }


        // --- Inicializa√ß√£o e Event Listeners ---

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Inicializa todos os seletores
            inicializarSeletores();
            
            // 2. Associa Event Listeners

            // Gerenciamento de Rota Retr√°til
            btnToggleGerenciarRota.addEventListener('click', toggleGerenciarRota);
            
            // Lan√ßamento Retr√°til (Inicia fechado, ajustando o estado inicial)
            if (contentLancamento) {
                contentLancamento.classList.remove('open');
                iconChevronLancamento.classList.add('rotate-90');
                btnToggleLancamento.addEventListener('click', toggleLancamento);
            }
            
            // Rota
            selectRotaAtiva.addEventListener('change', (e) => {
                atualizarInfoRota(); 
                rotaAtivaId = e.target.value;
                localStorage.setItem('rotaAtivaId', rotaAtivaId);
                carregarRotaAtiva();
            });
            btnNovaRota.addEventListener('click', () => criarNovaRota(true));
            inputNomeRota.addEventListener('change', atualizarInfoRota);
            inputDataRota.addEventListener('change', atualizarInfoRota);
            btnExcluirRota.addEventListener('click', excluirRotaAtiva);

            // Despesas (Agora no Modal de Exporta√ß√£o)
            modalDespesaAbastecimento.addEventListener('change', salvarDespesasDoModal);
            modalDespesaAlimentacao.addEventListener('change', salvarDespesasDoModal);
            modalDespesaExtra.addEventListener('change', salvarDespesasDoModal);


            // Cliente e Lan√ßamento
            inputCliente.addEventListener('input', (e) => {
                const nome = e.target.value.toLowerCase().trim();
                const cliente = CLIENTES_CACHE[nome];
                if (cliente) {
                    displayClienteEndereco.textContent = cliente.endereco || '-';
                    displayClienteComplemento.textContent = cliente.complemento || '-';
                    displayClienteCelular.textContent = cliente.celular || '-';
                    infoClienteSelecionado.classList.remove('hidden');
                } else {
                    infoClienteSelecionado.classList.add('hidden');
                }
            });

            // NOVO: Eventos para M√∫ltiplas Cestas
            btnAdicionarCesta.addEventListener('click', adicionarCestaAoPedido);
            listaCestasPedidoEl.addEventListener('click', (e) => {
                const btnRemover = e.target.closest('.btn-remover-cesta');
                if (btnRemover) {
                    removerCestaDoPedido(btnRemover.dataset.nome);
                }
            });

            document.querySelectorAll('input[name="tipo-cesta"]').forEach(radio => {
                radio.addEventListener('change', toggleCampoAlterada);
            });
            
            // NOVO: Listener para o campo de Valor Final (ajuste manual)
            inputValorTotalPedidoEl.addEventListener('change', (e) => {
                displayTotalPedidoEl.textContent = formatarMoeda(e.target.value);
            });
            
            formEntrega.addEventListener('submit', adicionarEntrega);
            
            // Listener para filtros de regi√£o
            filtrosRegiaoEl.addEventListener('click', (e) => {
                const chip = e.target.closest('.chip-regiao');
                if (chip && chip.dataset.regiao !== regiaoAtiva) {
                    filtrarEntregas(chip.dataset.regiao);
                }
            });


            // Lista de Entregas (Delega√ß√£o de Evento)
            listaEntregasEl.addEventListener('click', handleCardClick);
            
            // A√ß√£o espec√≠fica para abrir o Modal de WhatsApp
            listaEntregasEl.addEventListener('click', (e) => {
                const btnWhatsapp = e.target.closest('.btn-whatsapp-modal');
                if (btnWhatsapp && !btnWhatsapp.disabled) {
                    abrirModalWhatsapp(btnWhatsapp.dataset.id); 
                    return;
                }
            });

            // Modal de Pagamento
            btnCancelarPagamento.addEventListener('click', fecharModalPagamento);
            formPagamento.addEventListener('submit', salvarPagamento);
            
            // Modal de WhatsApp Op√ß√µes
            btnFecharWhatsappOpcoes.addEventListener('click', fecharModalWhatsapp);
            modalWhatsappOpcoes.addEventListener('click', (e) => {
                const btnMsg = e.target.closest('[data-msg-id]');
                if (btnMsg) {
                    const idEntrega = entregaParaWhatsappId;
                    const entregas = getEntregasAtivas();
                    const entrega = entregas.find(e => e.id.toString() === idEntrega);
                    if (entrega) {
                        gerarMensagem(parseInt(btnMsg.dataset.msgId), entrega);
                    }
                }
            });


            // A√ß√µes Globais (Exportar/Carregar)
            // Bot√£o Exportar: Carrega despesas e abre o modal
            btnExportar.addEventListener('click', () => {
                carregarDespesasNoModal();
                // A exportarDados() ser√° chamada quando o usu√°rio interagir com o modal, 
                // mas precisamos abri-lo primeiro.
                modalExportar.classList.remove('hidden');
            });
            
            // Fechar Modal Exportar (Desktop e Mobile)
            btnFecharExportar.addEventListener('click', fecharModalExportar);
            btnFecharExportarTop.addEventListener('click', fecharModalExportar);

            document.getElementById('btn-baixar-json').addEventListener('click', () => {
                const rotaAtiva = todasAsRotas[rotaAtivaId];
                if (!rotaAtiva) return;
                
                salvarDespesasDoModal(); 
                
                const jsonDados = JSON.stringify(rotaAtiva, null, 2);
                
                const nomeArquivo = `rota_${rotaAtiva.nome.replace(/[^a-z0-9]/gi, '_')}_${rotaAtiva.data}.json`;
                
                downloadArquivo(jsonDados, nomeArquivo);
            });

            btnCarregar.addEventListener('click', () => {
                inputCarregarArquivo.click();
            });

            inputCarregarArquivo.addEventListener('change', handleArquivoCarregado);
            
            // NOVO: Adiciona listener para recalcular o relat√≥rio/link do WhatsApp ao abrir/usar o modal
            modalExportar.addEventListener('click', (e) => {
                 if (e.target.closest('input[name="regiao-exportar"]') || e.target.id === 'btn-exportar' || e.target.id === 'modal-exportar') {
                    exportarDados();
                 }
            });

            btnFecharAviso.addEventListener('click', fecharAviso);

            // 3. Inicia o app
            iniciarAplicativo();
            toggleCampoAlterada();
            renderizarListaCestasPedido(); // Inicia com o display do total correto
        });
    </script>
</body>
</html>
