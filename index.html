<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Rota de Entrega Profissional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="clientes.js"></script>
    
    <style>
        /* Estilos de Status de Entrega */
        .entregue {
            background-color: #f0fdf4; /* green-50 */
            border-left-width: 4px;
            border-left-color: #22c55e; /* green-500 */
        }
        .entregue .btn-entregue {
            background-color: #22c55e; /* green-500 */
            color: white;
        }

        .cancelada {
            background-color: #f3f4f6; /* gray-100 */
            border-left-width: 4px;
            border-left-color: #6b7280; /* gray-500 */
            opacity: 0.7;
        }
        /* Desabilita bot√µes em itens cancelados */
        .cancelada .btn-entregue,
        .cancelada .btn-card-maps,
        .cancelada .btn-card-whatsapp,
        .cancelada .btn-mover-cima,
        .cancelada .btn-mover-baixo,
        .cancelada .btn-cancelar-entrega {
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Estiliza√ß√£o do <select> de rotas */
        #select-rota-ativa {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
        }
        /* Classe para transi√ß√£o suave de elementos retr√°teis */
        .collapse-content {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
        }
        .collapse-content.open {
            max-height: 1000px; /* Valor grande para cobrir todo o conte√∫do */
            opacity: 1;
        }
        /* Ajuste do modal de exportar para mobile (para n√£o sair da tela) */
        @media (max-width: 640px) {
            #modal-exportar > div {
                max-width: 100%;
                width: 100%;
                margin: 0;
                border-radius: 0;
                max-height: 100vh;
                overflow-y: auto;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <div class="container mx-auto max-w-5xl p-4 sm:p-6 lg:p-8">

        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Gerenciador de Rotas de Entrega</h1>
        </header>

        <section class="bg-white p-6 rounded-lg shadow-md mb-8">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-2xl font-semibold text-gray-700">Gerenciar Rota</h2>
                <button id="btn-toggle-gerenciar-rota" class="text-gray-500 hover:text-gray-700 p-2 rounded-full">
                    <svg id="icon-chevron" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                </button>
            </div>
            
            <div id="content-gerenciar-rota" class="collapse-content">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div class="md:col-span-2">
                        <label for="select-rota-ativa" class="block text-sm font-medium text-gray-700">Rota Ativa</label>
                        <select id="select-rota-ativa" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base">
                            </select>
                    </div>
                    <div class="md:col-span-1">
                        <button id="btn-nova-rota" class="w-full flex justify-center items-center rounded-md border border-transparent bg-green-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-green-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            Nova Rota
                        </button>
                    </div>
                    <div class="md:col-span-1">
                        <button id="btn-excluir-rota" class="w-full flex justify-center items-center rounded-md border border-gray-300 bg-red-100 px-4 py-3 text-sm font-medium text-red-700 shadow-sm hover:bg-red-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm2 3a1 1 0 100 2h2a1 1 0 100-2H9z" clip-rule="evenodd" /></svg>
                            Excluir Rota
                        </button>
                    </div>

                    <div class="md:col-span-2">
                        <label for="input-nome-rota" class="block text-sm font-medium text-gray-700">Nome da Rota</label>
                        <input type="text" id="input-nome-rota" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Ex: Entregas Manh√£">
                    </div>
                    <div class="md:col-span-2">
                        <label for="input-data-rota" class="block text-sm font-medium text-gray-700">Data da Rota</label>
                        <div class="flex items-center">
                            <input type="date" id="input-data-rota" class="mt-1 block w-full rounded-l-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base">
                            <span id="display-dia-semana" class="mt-1 inline-flex items-center px-3 py-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-base min-w-[120px] justify-center">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="bg-white p-6 rounded-lg shadow-md mb-8">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-2xl font-semibold text-gray-700">Lan√ßar Nova Entrega</h2>
                 <button id="btn-toggle-lancamento" class="text-gray-500 hover:text-gray-700 p-2 rounded-full">
                    <svg id="icon-chevron-lancamento" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                </button>
            </div>

            <div id="content-lancamento" class="collapse-content">
                <form id="form-entrega" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    
                    <div class="md:col-span-1 space-y-4">
                        <div>
                            <label for="input-cliente" class="block text-sm font-medium text-gray-700">Cliente</label>
                            <input type="text" id="input-cliente" list="lista-clientes" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Digite ou selecione um cliente...">
                            <datalist id="lista-clientes">
                                <option value="Carregando clientes..."></option> 
                            </datalist>
                        </div>

                        <div id="info-cliente-selecionado" class="hidden space-y-2 text-sm text-gray-600 border-l-4 border-blue-200 pl-3 py-2 bg-blue-50 rounded-r-md">
                            <p><strong>Endere√ßo:</strong> <span id="display-cliente-endereco">-</span></p>
                            <p><strong>Complemento:</strong> <span id="display-cliente-complemento">-</span></p>
                            <p><strong>Celular:</strong> <span id="display-cliente-celular">-</span></p>
                        </div>

                        <div>
                            <label for="obs-cliente" class="block text-sm font-medium text-gray-700">Observa√ß√£o (Opcional)</label>
                            <input type="text" id="obs-cliente" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Ex: Casa azul, port√£o branco">
                        </div>
                        
                        <div>
                            <label for="select-cesta" class="block text-sm font-medium text-gray-700">Cesta B√°sica</label>
                            <select id="select-cesta" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base">
                                <option value="Mini Bonini" data-valor="165.00">Mini Bonini</option>
                                <option value="Mini Koblenz" data-valor="170.00">Mini Koblenz</option>
                                <option value="Pequena Bonini" data-valor="215.00">Pequena Bonini</option>
                                <option value="Pequena Koblenz" data-valor="220.00">Pequena Kolenz</option>
                                <option value="M√©dia Bonini" data-valor="320.00">M√©dia Bonini</option>
                                <option value="M√©dia Koblenz" data-valor="325.00">M√©dia Koblenz</option>
                                <option value="Grande Bonini" data-valor="380.00">Grande Bonini</option>
                                <option value="Grande Koblenz" data-valor="390.00">Grande Koblenz</option>
                            </select>
                        </div>
                    </div>

                    <div class="md:col-span-1 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Tipo da Cesta</label>
                            <div class="mt-2 flex space-x-4">
                                <label class="flex items-center">
                                    <input type="radio" name="tipo-cesta" value="Normal" checked class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">Normal</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="tipo-cesta" value="Alterada" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">Alterada</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Brinde (Opcional)</label>
                            <div class="mt-2 space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" name="brindes_opcoes" value="Ovo" class="h-4 w-4 border-gray-300 text-pink-600 focus:ring-pink-500 rounded">
                                    <span class="ml-2 text-sm text-gray-700">Ovo</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="brindes_opcoes" value="Amaciante" class="h-4 w-4 border-gray-300 text-pink-600 focus:ring-pink-500 rounded">
                                    <span class="ml-2 text-sm text-gray-700">Amaciante</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="brindes_opcoes" value="Cafe 250g" class="h-4 w-4 border-gray-300 text-pink-600 focus:ring-pink-500 rounded">
                                    <span class="ml-2 text-sm text-gray-700">Caf√© 250g</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label for="input-valor-cesta" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                            <input type="number" id="input-valor-cesta" step="0.01" min="0" value="165.00" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="0.00">
                        </div>
                    </div>
                    
                    <div class="md:col-span-1 space-y-4">
                        <div id="campo-alterada" class="hidden space-y-4">
                            <div>
                                <label for="codigo-alterada" class="block text-sm font-medium text-gray-700">Detalhe (Cesta Alterada)</label>
                                <input type="text" id="codigo-alterada" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="Ex: Sem arroz, +1 feij√£o">
                            </div>

                            <div id="campo-partes-alteradas">
                                <label class="block text-sm font-medium text-gray-700">Itens Alterados</label>
                                <div class="mt-2 space-y-2">
                                    <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                                        <input type="checkbox" name="partes_alteradas" value="Arroz" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                                        <span class="ml-3 text-sm font-medium text-gray-700">Arroz</span>
                                    </label>
                                    <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                                        <input type="checkbox" name="partes_alteradas" value="Alimento" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                                        <span class="ml-3 text-sm font-medium text-gray-700">Alimento (Geral)</span>
                                    </label>
                                    <label class="flex items-center p-2 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                                        <input type="checkbox" name="partes_alteradas" value="Limpeza" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                                        <span class="ml-3 text-sm font-medium text-gray-700">Limpeza</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="pt-6 flex flex-col">
                            <button type="submit" class="w-full flex justify-center items-center rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                Lan√ßar Entrega
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </section>

        <section>
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-700">Entregas na Rota</h2>
                <div class="flex space-x-2 mt-4 sm:mt-0">
                    <button id="btn-exportar" class="rounded-md bg-green-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-green-700">Exportar Rota</button>
                    <button id="btn-carregar" class="rounded-md bg-gray-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-gray-700">Carregar Rota</button>
                </div>
            </div>
            
            <div id="lista-entregas" class="space-y-3 min-h-[100px]">
                </div>
            <p id="lista-vazia" class="text-center text-gray-500 py-6">Nenhuma entrega na rota.</p>
        </section>
    </div>

    <div id="modal-pagamento" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <form id="form-pagamento">
                <div class="p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Confirmar Entrega e Pagamento</h3>
                    <p class="text-sm text-gray-600 mb-1">Cliente: <strong id="modal-cliente-nome"></strong></p>
                    <p class="text-sm text-gray-600 mb-4">Valor: <strong id="modal-cliente-valor"></strong></p>
                    
                    <label class="block text-sm font-medium text-gray-700 mb-2">Forma(s) de Pagamento (Selecione ao menos uma):</label>
                    <div id="modal-error-pagamento" class="text-red-600 text-sm mb-2 hidden">√â obrigat√≥rio selecionar ao menos uma forma de pagamento.</div>
                    <div class="space-y-2">
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                            <input type="checkbox" name="forma_pagamento" value="Dinheiro" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">Dinheiro</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                            <input type="checkbox" name="forma_pagamento" value="Pix" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">Pix</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                            <input type="checkbox" name="forma_pagamento" value="Cart√£o" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">Cart√£o</span>
                        </label>
                        <label class="flex items-center p-3 bg-gray-50 rounded-md border border-gray-200 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300">
                            <input type="checkbox" name="forma_pagamento" value="Fiado" class="h-4 w-4 border-gray-300 text-blue-600 focus:ring-blue-500 rounded">
                            <span class="ml-3 text-sm font-medium text-gray-700">Fiado</span>
                        </label>
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3 rounded-b-lg">
                    <button type="button" id="btn-cancelar-pagamento" class="rounded-md border border-gray-300 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Cancelar</button>
                    <button type="submit" id="btn-confirmar-pagamento" class="rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700">Confirmar Entrega</button>
                </div>
            </form>
        </div>
        
    </div>
    
    <div id="modal-whatsapp-opcoes" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4">
            <div class="p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Mensagens R√°pidas para <span id="modal-whatsapp-cliente-nome"></span></h3>
                <p class="text-sm text-gray-600 mb-6">Cesta: <strong id="modal-whatsapp-cesta-info"></strong></p>
                
                <div class="space-y-3">
                    <button id="btn-msg-chegando" data-msg-id="1" class="w-full text-left rounded-md border border-blue-300 bg-blue-50 px-4 py-3 text-sm font-medium text-blue-700 shadow-sm hover:bg-blue-100">
                        1. üöó Aviso de Chegada (10 minutos)
                    </button>
                    
                    <button id="btn-msg-cheguei" data-msg-id="2" class="w-full text-left rounded-md border border-blue-300 bg-blue-50 px-4 py-3 text-sm font-medium text-blue-700 shadow-sm hover:bg-blue-100">
                        2. üö™ Cheguei no local
                    </button>
                    
                    <button id="btn-msg-pix" data-msg-id="3" class="w-full text-left rounded-md border border-blue-300 bg-blue-50 px-4 py-3 text-sm font-medium text-blue-700 shadow-sm hover:bg-blue-100">
                        3. üí∞ Dados PIX para Pagamento
                    </button>

                    <button id="btn-msg-pedido" data-msg-id="4" class="w-full text-left rounded-md border border-red-300 bg-red-50 px-4 py-3 text-sm font-medium text-red-700 shadow-sm hover:bg-red-100">
                        4. üö® Enviar Pedido para Gerente (65996884599)
                    </button>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end rounded-b-lg">
                <button type="button" id="btn-fechar-whatsapp-opcoes" class="rounded-md border border-gray-300 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Fechar</button>
            </div>
        </div>
    </div>


    <div id="modal-exportar" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl m-4 overflow-hidden sm:m-8 sm:rounded-lg">
            <div class="p-6">
                 <div class="flex justify-between items-center mb-4 sm:hidden">
                    <h3 class="text-xl font-semibold text-gray-800">Exportar Rota</h3>
                    <button type="button" id="btn-fechar-exportar-top" class="text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-4 hidden sm:block">Exportar Rota e Despesas</h3>

                <h4 class="text-lg font-semibold text-gray-700 mt-2 mb-3 border-b pb-1">Despesas da Rota</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end mb-6">
                    <div>
                        <label for="input-despesa-abastecimento" class="block text-sm font-medium text-gray-700">Abastecimento (R$)</label>
                        <input type="number" id="modal-despesa-abastecimento" step="0.01" min="0" value="0.00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="0.00">
                    </div>
                    <div>
                        <label for="input-despesa-alimentacao" class="block text-sm font-medium text-gray-700">Alimenta√ß√£o (R$)</label>
                        <input type="number" id="modal-despesa-alimentacao" step="0.01" min="0" value="0.00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="0.00">
                    </div>
                    <div>
                        <label for="input-despesa-extra" class="block text-sm font-medium text-gray-700">Extras (R$)</label>
                        <input type="number" id="modal-despesa-extra" step="0.01" min="0" value="0.00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-3 px-4 text-base" placeholder="0.00">
                    </div>
                </div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Backup da Rota (Arquivo)</label>
                <button type="button" id="btn-baixar-json" class="w-full flex justify-center items-center rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Baixar Arquivo da Rota (.json)
                </button>

                <h4 class="text-lg font-semibold text-gray-700 mt-6 mb-2">Relat√≥rio de Entregas Conclu√≠das</h4>
                <div id="export-relatorio" class="w-full max-h-48 overflow-y-auto p-2 border border-gray-300 rounded-md bg-gray-50">
                    <pre class="text-xs text-gray-700">Nenhuma entrega conclu√≠da.</pre>
                </div>

                <div id="export-whatsapp-link" class="mt-4">
                    </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end rounded-b-lg hidden sm:flex">
                <button type="button" id="btn-fechar-exportar" class="rounded-md border border-gray-300 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Fechar</button>
            </div>
        </div>
    </div>

    <div id="modal-aviso" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm m-4">
            <div class="p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Aten√ß√£o</h3>
                <p id="modal-aviso-texto" class="text-gray-600 mb-6">Mensagem de aviso.</p>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end rounded-b-lg">
                <button type="button" id="btn-fechar-aviso" class="rounded-md border border-transparent bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-blue-700">OK</button>
            </div>
        </div>
    </div>

    <input type="file" id="input-carregar-arquivo" class="hidden" accept=".json,application/json">


    <script>
        /**
         * =================================================================
         * BLOCO DE C√ìDIGO JS PRINCIPAL (Revisado, Corrigido e Otimizado para Mobile)
         * =================================================================
         */

        // --- Constantes Globais ---
        const PIX_NOME = "Osvaldo Sereia Junior";
        const PIX_CELULAR = "65984491018";
        const NUMERO_GERENTE = "5565996884599"; 
        const NOME_EMPRESA = "Cesta B√°sica Dona Ant√¥nia";
        const MAX_ROTAS = 30;

        // --- Estado da Aplica√ß√£o ---
        let todasAsRotas = {};
        let rotaAtivaId = null;
        let CLIENTES_CACHE = {}; 
        let entregaParaPagarId = null;
        let entregaParaWhatsappId = null; 

        // --- Seletores de Elementos (Inicializados no DOMContentLoaded) ---
        let btnNovaRota, selectRotaAtiva, inputNomeRota, inputDataRota, displayDiaSemana, btnExcluirRota;
        let modalDespesaAbastecimento, modalDespesaAlimentacao, modalDespesaExtra; 
        let btnToggleGerenciarRota, contentGerenciarRota, iconChevron; 
        let btnToggleLancamento, contentLancamento, iconChevronLancamento; // NOVO: Lan√ßamento Retr√°til
        let formEntrega, inputCliente, datalistClientes, infoClienteSelecionado, displayClienteEndereco, displayClienteComplemento, displayClienteCelular, obsClienteInput, selectCesta, inputValorCesta, campoAlterada, codigoAlteradaInput, listaEntregasEl, listaVaziaEl;
        let modalPagamento, formPagamento, btnCancelarPagamento, modalClienteNome, modalClienteValor, modalErrorPagamento, btnExportar, btnCarregar, modalExportar, exportRelatorioEl, exportWhatsappLinkEl, btnFecharExportar, btnFecharExportarTop, modalAviso, modalAvisoTexto, btnFecharAviso, inputCarregarArquivo;
        let modalWhatsappOpcoes, modalWhatsappClienteNome, modalWhatsappCestaInfo, btnFecharWhatsappOpcoes;


        function inicializarSeletores() {
            // Se√ß√£o Retr√°til - Gerenciar Rota
            btnToggleGerenciarRota = document.getElementById('btn-toggle-gerenciar-rota');
            contentGerenciarRota = document.getElementById('content-gerenciar-rota');
            iconChevron = document.getElementById('icon-chevron');

            // Se√ß√£o Retr√°til - Lan√ßamento
            btnToggleLancamento = document.getElementById('btn-toggle-lancamento');
            contentLancamento = document.getElementById('content-lancamento');
            iconChevronLancamento = document.getElementById('icon-chevron-lancamento');

            // Gerenciamento de Rota
            btnNovaRota = document.getElementById('btn-nova-rota');
            selectRotaAtiva = document.getElementById('select-rota-ativa');
            inputNomeRota = document.getElementById('input-nome-rota');
            inputDataRota = document.getElementById('input-data-rota');
            displayDiaSemana = document.getElementById('display-dia-semana');
            btnExcluirRota = document.getElementById('btn-excluir-rota');

            // Despesas no Modal
            modalDespesaAbastecimento = document.getElementById('modal-despesa-abastecimento');
            modalDespesaAlimentacao = document.getElementById('modal-despesa-alimentacao');
            modalDespesaExtra = document.getElementById('modal-despesa-extra');

            // Lan√ßamento de Entrega
            formEntrega = document.getElementById('form-entrega');
            inputCliente = document.getElementById('input-cliente');
            datalistClientes = document.getElementById('lista-clientes');
            infoClienteSelecionado = document.getElementById('info-cliente-selecionado');
            displayClienteEndereco = document.getElementById('display-cliente-endereco');
            displayClienteComplemento = document.getElementById('display-cliente-complemento');
            displayClienteCelular = document.getElementById('display-cliente-celular');
            obsClienteInput = document.getElementById('obs-cliente');
            selectCesta = document.getElementById('select-cesta');
            inputValorCesta = document.getElementById('input-valor-cesta');
            campoAlterada = document.getElementById('campo-alterada');
            codigoAlteradaInput = document.getElementById('codigo-alterada');
            listaEntregasEl = document.getElementById('lista-entregas');
            listaVaziaEl = document.getElementById('lista-vazia');

            // Modais
            modalPagamento = document.getElementById('modal-pagamento');
            formPagamento = document.getElementById('form-pagamento');
            btnCancelarPagamento = document.getElementById('btn-cancelar-pagamento');
            modalClienteNome = document.getElementById('modal-cliente-nome');
            modalClienteValor = document.getElementById('modal-cliente-valor');
            modalErrorPagamento = document.getElementById('modal-error-pagamento');
            btnExportar = document.getElementById('btn-exportar');
            btnCarregar = document.getElementById('btn-carregar');
            modalExportar = document.getElementById('modal-exportar');
            exportRelatorioEl = document.getElementById('export-relatorio');
            exportWhatsappLinkEl = document.getElementById('export-whatsapp-link');
            btnFecharExportar = document.getElementById('btn-fechar-exportar');
            btnFecharExportarTop = document.getElementById('btn-fechar-exportar-top'); // NOVO: Bot√£o fechar mobile
            modalAviso = document.getElementById('modal-aviso');
            modalAvisoTexto = document.getElementById('modal-aviso-texto');
            btnFecharAviso = document.getElementById('btn-fechar-aviso');
            inputCarregarArquivo = document.getElementById('input-carregar-arquivo');
            
            // Modal WhatsApp Op√ß√µes
            modalWhatsappOpcoes = document.getElementById('modal-whatsapp-opcoes');
            modalWhatsappClienteNome = document.getElementById('modal-whatsapp-cliente-nome');
            modalWhatsappCestaInfo = document.getElementById('modal-whatsapp-cesta-info');
            btnFecharWhatsappOpcoes = document.getElementById('btn-fechar-whatsapp-opcoes');
        }

        // --- Fun√ß√µes de Utilit√°rios ---
        function mostrarAviso(mensagem) {
            modalAvisoTexto.textContent = mensagem;
            modalAviso.classList.remove('hidden');
        }

        function fecharAviso() {
            modalAviso.classList.add('hidden');
        }

        function formatarMoeda(valor) {
            const num = parseFloat(valor);
            if (isNaN(num)) return 'R$ 0,00';
            return num.toLocaleString('pt-br', { style: 'currency', currency: 'BRL' });
        }

        function formatarData(isoString) {
            if (!isoString) return '';
            const data = new Date(isoString);
            if (isNaN(data)) return '';
            return data.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getDiaDaSemana(dataString) {
            if (!dataString) return '-';
            const data = new Date(dataString + 'T12:00:00');
            if (isNaN(data)) return '-';
            const dia = data.toLocaleDateString('pt-BR', { weekday: 'long' });
            return dia.charAt(0).toUpperCase() + dia.slice(1);
        }

        function atualizarValorCesta() {
            const selectedOption = selectCesta.options[selectCesta.selectedIndex];
            const valor = selectedOption ? selectedOption.dataset.valor || "165.00" : "165.00"; 
            inputValorCesta.value = parseFloat(valor).toFixed(2);
        }

        function toggleCampoAlterada() {
            const tipo = document.querySelector('input[name="tipo-cesta"]:checked').value;
            if (tipo === 'Alterada') {
                campoAlterada.classList.remove('hidden');
                codigoAlteradaInput.required = true;
            } else {
                campoAlterada.classList.add('hidden');
                codigoAlteradaInput.required = false;
                codigoAlteradaInput.value = '';
                document.querySelectorAll('input[name="partes_alteradas"]:checked').forEach(cb => {
                    cb.checked = false;
                });
            }
        }
        
        /**
         * Fun√ß√£o para alternar o estado de visibilidade da se√ß√£o Gerenciar Rota.
         */
        function toggleGerenciarRota() {
            const isOpen = contentGerenciarRota.classList.toggle('open');
            if (isOpen) {
                iconChevron.classList.remove('rotate-90');
                iconChevron.classList.add('rotate-180');
            } else {
                iconChevron.classList.remove('rotate-180');
                iconChevron.classList.add('rotate-90'); 
            }
        }
        
        /**
         * NOVO: Fun√ß√£o para alternar o estado de visibilidade da se√ß√£o Lan√ßamento.
         */
        function toggleLancamento() {
            const isOpen = contentLancamento.classList.toggle('open');
            if (isOpen) {
                iconChevronLancamento.classList.remove('rotate-90');
                iconChevronLancamento.classList.add('rotate-180');
            } else {
                iconChevronLancamento.classList.remove('rotate-180');
                iconChevronLancamento.classList.add('rotate-90'); 
            }
        }


        // --- Fun√ß√µes de Persist√™ncia (LocalStorage) ---

        function salvarTodasAsRotas() {
            const chavesRotas = Object.keys(todasAsRotas);
            if (chavesRotas.length > MAX_ROTAS) {
                const chavesOrdenadas = chavesRotas.sort((a, b) => parseInt(a, 10) - parseInt(b, 10));
                const chavesParaRemover = chavesOrdenadas.slice(0, chavesOrdenadas.length - MAX_ROTAS);
                
                chavesParaRemover.forEach(chave => {
                    delete todasAsRotas[chave];
                });
            }
            
            try {
                localStorage.setItem('gerenciadorDeRotas', JSON.stringify(todasAsRotas));
                if (rotaAtivaId) {
                    localStorage.setItem('rotaAtivaId', rotaAtivaId);
                }
            } catch (e) {
                console.error("Erro ao salvar no LocalStorage:", e);
                mostrarAviso("Erro ao salvar dados. Seu navegador pode estar sem espa√ßo ou configurado para bloquear o LocalStorage.");
            }
        }

        function salvarLocalStorage() {
            salvarTodasAsRotas();
        }
        
        /**
         * Salva os valores de despesa APENAS no objeto da rota (lendo do modal de exporta√ß√£o)
         */
        function salvarDespesasDoModal() {
            const rota = todasAsRotas[rotaAtivaId];
            if (!rota) return;

            // Lendo os valores dos inputs DENTRO DO MODAL
            rota.despesas = {
                abastecimento: parseFloat(modalDespesaAbastecimento.value) || 0,
                alimentacao: parseFloat(modalDespesaAlimentacao.value) || 0,
                extra: parseFloat(modalDespesaExtra.value) || 0
            };

            salvarTodasAsRotas(); 
        }


        // --- Fun√ß√µes de Gerenciamento de Rota ---

        function iniciarAplicativo() {
            // 1. Carregar Clientes (do clientes.js)
            try {
                if (typeof CLIENTES_DB !== 'undefined' && Array.isArray(CLIENTES_DB)) {
                    datalistClientes.innerHTML = '';
                    CLIENTES_DB.forEach(cliente => {
                        const option = document.createElement('option');
                        option.value = cliente.nome;
                        datalistClientes.appendChild(option);
                        CLIENTES_CACHE[cliente.nome.toLowerCase()] = cliente;
                    });
                } else {
                    console.warn("CLIENTES_DB n√£o encontrado. O recurso de autocompletar cliente n√£o funcionar√°.");
                    datalistClientes.innerHTML = '<option value="Aviso: clientes.js n√£o carregado."></option>';
                }
            } catch (e) {
                console.error("Erro ao processar clientes:", e);
                datalistClientes.innerHTML = '<option value="Erro ao carregar clientes."></option>';
            }

            // 2. Carregar Rotas
            const dadosSalvos = localStorage.getItem('gerenciadorDeRotas');
            if (dadosSalvos) {
                try {
                    todasAsRotas = JSON.parse(dadosSalvos);
                } catch (e) {
                    console.error("Erro ao parsear rotas salvas. Resetando dados.", e);
                    todasAsRotas = {};
                }
            }

            // 3. Descobrir qual rota est√° ativa
            rotaAtivaId = localStorage.getItem('rotaAtivaId');

            // 4. Se n√£o houver rotas, ou a rota ativa n√£o existir, cria uma nova
            const chavesRotas = Object.keys(todasAsRotas);
            if (!rotaAtivaId || !todasAsRotas[rotaAtivaId]) {
                if (chavesRotas.length === 0) {
                    criarNovaRota(false);
                } else {
                    const chavesOrdenadas = chavesRotas.sort((a, b) => parseInt(b, 10) - parseInt(a, 10));
                    rotaAtivaId = chavesOrdenadas[0];
                    localStorage.setItem('rotaAtivaId', rotaAtivaId);
                }
            }
            
            // 5. Popular o <select> e carregar a rota ativa na tela
            popularSelectRotas();
            carregarRotaAtiva();
        }

        function getEntregasAtivas() {
            if (rotaAtivaId && todasAsRotas[rotaAtivaId]) {
                return todasAsRotas[rotaAtivaId].entregas;
            }
            return [];
        }
        
        /**
         * Carrega as despesas da rota ativa nos inputs do Modal de Exporta√ß√£o.
         */
        function carregarDespesasNoModal() {
            const rota = todasAsRotas[rotaAtivaId];
            if (!rota) return;
            
            rota.despesas = rota.despesas || { abastecimento: 0, alimentacao: 0, extra: 0 };
            
            modalDespesaAbastecimento.value = (rota.despesas.abastecimento || 0).toFixed(2);
            modalDespesaAlimentacao.value = (rota.despesas.alimentacao || 0).toFixed(2);
            modalDespesaExtra.value = (rota.despesas.extra || 0).toFixed(2);
        }

        function popularSelectRotas() {
            selectRotaAtiva.innerHTML = '';
            
            const chavesOrdenadas = Object.keys(todasAsRotas).sort((a, b) => parseInt(b, 10) - parseInt(a, 10));

            if (chavesOrdenadas.length === 0) {
                selectRotaAtiva.disabled = true;
                selectRotaAtiva.innerHTML = '<option>Nenhuma rota salva</option>';
                return;
            }

            selectRotaAtiva.disabled = false;
            chavesOrdenadas.forEach(id => {
                const rota = todasAsRotas[id];
                const option = document.createElement('option');
                option.value = id;
                const dataFormatada = rota.data ? new Date(rota.data + 'T12:00:00').toLocaleDateString('pt-BR') : 'Sem Data';
                option.textContent = `${rota.nome} (${dataFormatada})`;
                
                if (id === rotaAtivaId) {
                    option.selected = true;
                }
                selectRotaAtiva.appendChild(option);
            });
        }

        function carregarRotaAtiva() {
            const rota = todasAsRotas[rotaAtivaId];
            if (!rota) {
                iniciarAplicativo(); 
                return;
            }

            inputNomeRota.value = rota.nome;
            inputDataRota.value = rota.data;
            displayDiaSemana.textContent = getDiaDaSemana(rota.data);

            selectRotaAtiva.value = rotaAtivaId;
            
            renderizarEntregas();
        }

        function criarNovaRota(atualizarTela = true) {
            let novoId = Date.now().toString(); 
            while(todasAsRotas[novoId]) {
                novoId = (parseInt(novoId, 10) + 1).toString();
            }
            
            const hoje = new Date().toISOString().split('T')[0];

            const novaRota = {
                id: novoId,
                nome: `Rota ${Object.keys(todasAsRotas).length + 1}`,
                data: hoje,
                entregas: [],
                despesas: { abastecimento: 0, alimentacao: 0, extra: 0 }
            };

            todasAsRotas[novoId] = novaRota;
            rotaAtivaId = novoId;

            salvarTodasAsRotas();
            
            if (atualizarTela) {
                popularSelectRotas();
                carregarRotaAtiva();
                mostrarAviso(`Nova Rota '${novaRota.nome}' criada e definida como ativa.`);
                
                // Abre a se√ß√£o "Gerenciar Rota" ao criar uma nova
                if (!contentGerenciarRota.classList.contains('open')) {
                    toggleGerenciarRota();
                }
            }
        }

        function atualizarInfoRota() {
            const rota = todasAsRotas[rotaAtivaId];
            if (!rota) return;
            
            rota.nome = inputNomeRota.value.trim() || "Rota Sem Nome";
            rota.data = inputDataRota.value || new Date().toISOString().split('T')[0];
            
            displayDiaSemana.textContent = getDiaDaSemana(rota.data);

            salvarTodasAsRotas();
            popularSelectRotas();
        }

        function excluirRotaAtiva() {
            if (Object.keys(todasAsRotas).length <= 1) {
                mostrarAviso("Voc√™ n√£o pode excluir a √∫ltima rota. Crie uma nova antes de excluir esta.");
                return;
            }

            if (!confirm(`Tem certeza que deseja excluir a rota "${todasAsRotas[rotaAtivaId].nome}"? Esta a√ß√£o √© irrevers√≠vel.`)) {
                return;
            }
            
            delete todasAsRotas[rotaAtivaId];
            
            const chavesOrdenadas = Object.keys(todasAsRotas).sort((a, b) => parseInt(b, 10) - parseInt(a, 10));
            rotaAtivaId = chavesOrdenadas[0];
            
            salvarTodasAsRotas();
            
            popularSelectRotas();
            carregarRotaAtiva();
            mostrarAviso("Rota exclu√≠da com sucesso. Carregada a rota mais recente.");
        }

        // --- Fun√ß√µes de Renderiza√ß√£o e Intera√ß√£o da Lista ---

        function renderizarEntregas() {
            listaEntregasEl.innerHTML = '';
            const entregas = getEntregasAtivas();

            if (entregas.length === 0) {
                listaVaziaEl.classList.remove('hidden');
                return;
            }
            
            listaVaziaEl.classList.add('hidden');

            entregas.forEach((entrega, index) => {
                const card = document.createElement('div');
                card.dataset.id = entrega.id;
                const isFinalizada = entrega.status === 'Entregue' || entrega.status === 'Cancelada';
                
                card.className = `p-4 bg-white rounded-lg shadow-sm border flex flex-col sm:flex-row items-start sm:items-center justify-between transition-all ${entrega.status === 'Entregue' ? 'entregue' : (entrega.status === 'Cancelada' ? 'cancelada' : '')} break-words`;
                
                // NOVO: Coleta info de Brinde
                let infoBrinde = '';
                if (Array.isArray(entrega.brindes) && entrega.brindes.length > 0) {
                    infoBrinde = `<p class="text-sm font-semibold text-pink-600">BRINDE(S): ${entrega.brindes.join(', ')}</p>`;
                }

                // NOVO: Coleta info de Altera√ß√£o
                let infoAlteracao = '';
                if (entrega.tipo === 'Alterada') {
                    const alteracoes = [];
                    if (entrega.codigoAlterada) alteracoes.push(`Det: ${entrega.codigoAlterada}`);
                    if (Array.isArray(entrega.partesAlteradas) && entrega.partesAlteradas.length > 0) alteracoes.push(`Itens: ${entrega.partesAlteradas.join(', ')}`);
                    
                    if (alteracoes.length > 0) {
                         infoAlteracao = `<p class="text-sm font-semibold text-yellow-700">ALTERADA: ${alteracoes.join(' | ')}</p>`;
                    }
                }


                let statusInfo = '';
                if (entrega.status === 'Entregue') {
                    statusInfo = `
                        <div class="text-xs text-green-700 mt-1 sm:ml-4 font-medium">
                            <span class="font-bold">Pgto:</span> ${entrega.formaPagamento.join(', ')} |
                            <span class="font-bold">Hora:</span> ${formatarData(entrega.horarioEntrega)}
                        </div>
                    `;
                } else if (entrega.status === 'Cancelada') {
                    statusInfo = `
                        <div class="text-xs text-red-700 mt-1 sm:ml-4 font-medium">
                            <span class="font-bold">Status:</span> CANCELADA | 
                            <span class="font-bold">Hora:</span> ${formatarData(entrega.horarioEntrega)}
                        </div>
                    `;
                }

                let obsInfo = '';
                if (entrega.observacao) {
                    obsInfo = `<p class="text-base text-red-600 font-bold mt-1">OBS: ${entrega.observacao}</p>`;
                }

                // NOVO: Aumentado o tamanho da fonte (text-base -> text-lg, text-sm -> text-base, etc.)
                let infoClienteHtml = `
                    <p class="text-lg font-bold text-gray-800 truncate" title="${entrega.cliente.nome}">${entrega.cliente.nome}</p>
                    <p class="text-base text-gray-600 truncate" title="${entrega.cliente.endereco || ''}">${entrega.cliente.endereco || 'Sem endere√ßo'}</p>
                    <p class="text-base text-gray-500 truncate" title="${entrega.cliente.complemento || ''}">${entrega.cliente.complemento || 'Sem complemento'}</p>
                    <p class="text-base font-bold text-blue-600">${entrega.cliente.celular || 'Sem celular'}</p>
                    <p class="text-lg font-bold text-gray-700 mt-2">${entrega.cesta.nome} - <span class="font-extrabold text-blue-800">${formatarMoeda(entrega.cesta.valor)}</span></p>
                `;
                
                const isPrimeiro = index === 0;
                const isUltimo = index === entregas.length - 1;

                let whatsappHref = '#';
                let whatsappDisabled = true;
                let whatsappClass = 'bg-white text-gray-400 border border-gray-300 cursor-not-allowed';
                if (entrega.cliente.celular && !isFinalizada) {
                    const numeroLimpo = entrega.cliente.celular.replace(/\D/g, '');
                    const numeroFinal = numeroLimpo.startsWith('55') ? numeroLimpo : `55${numeroLimpo}`;
                    
                    if(numeroFinal.length >= 10) { 
                        whatsappHref = `javascript:void(0);`; 
                        whatsappDisabled = false;
                        whatsappClass = 'bg-green-100 text-green-700 border border-green-300 hover:bg-green-200';
                    }
                }
                
                // NOVO: Defini√ß√£o dos bot√µes simples (texto) e classes de alinhamento
                const btnClassesBase = "w-full text-sm font-medium shadow-sm py-3 rounded-md";
                const btnMaps = `<button class="btn-card-maps ${btnClassesBase} bg-white text-gray-700 border border-gray-300 hover:bg-gray-50" ${isFinalizada ? 'disabled' : ''}>MAPA</button>`;
                const btnWhatsapp = `<button data-id="${entrega.id}" class="btn-whatsapp-modal ${btnClassesBase} ${whatsappClass}" ${whatsappDisabled || isFinalizada ? 'disabled' : ''}>WHATSAPP</button>`;
                
                const btnAcaoPrincipal = entrega.status === 'Pendente' ? `
                    <button class="btn-entregue ${btnClassesBase} bg-blue-600 text-white hover:bg-blue-700" data-id="${entrega.id}">ENTREGUE</button>
                ` : `<button class="btn-entregue ${btnClassesBase} bg-green-600 text-white cursor-not-allowed" disabled>${entrega.status.toUpperCase()}</button>`;
                
                const btnCancelar = entrega.status === 'Pendente' ? `
                    <button class="btn-cancelar-entrega ${btnClassesBase} bg-red-100 text-red-700 border border-red-300 hover:bg-red-200" data-id="${entrega.id}">CANCELAR</button>
                ` : `<button class="btn-cancelar-entrega ${btnClassesBase} bg-gray-300 text-gray-600 cursor-not-allowed" disabled>CANCELAR</button>`;


                card.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <div class="flex items-start">
                            <div class="flex flex-col items-center justify-center mr-3 pt-2 flex-shrink-0">
                                <button class="btn-mover-cima text-gray-400 ${isPrimeiro || isFinalizada ? 'opacity-25 cursor-not-allowed' : 'hover:text-blue-600'}" data-id="${entrega.id}" title="Mover Cima" ${isPrimeiro || isFinalizada ? 'disabled' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg>
                                </button>
                                <button class="btn-mover-baixo text-gray-400 ${isUltimo || isFinalizada ? 'opacity-25 cursor-not-allowed' : 'hover:text-blue-600'}" data-id="${entrega.id}" title="Mover Baixo" ${isUltimo || isFinalizada ? 'disabled' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                                </button>
                            </div>

                            <div class="truncate w-full min-w-0">
                                ${infoClienteHtml}
                            </div>
                        </div>
                        
                        <div class="mt-2 sm:ml-12 w-full space-y-1 text-sm">
                            ${infoAlteracao}
                            ${infoBrinde}
                            ${obsInfo}
                            ${statusInfo}
                        </div>
                    </div>
                    
                    <div class="mt-4 sm:mt-0 sm:ml-4 flex-shrink-0 w-full sm:w-auto">
                        <div class="grid grid-cols-2 gap-2 w-full sm:w-auto">
                            ${btnWhatsapp}
                            ${btnMaps}
                            ${btnCancelar}
                            ${btnAcaoPrincipal}
                        </div>
                    </div>
                `;
                listaEntregasEl.appendChild(card);
            });
        }
        
        // --- Fun√ß√µes Espec√≠ficas do WhatsApp ---

        function abrirModalWhatsapp(id) {
            const entregas = getEntregasAtivas();
            const entrega = entregas.find(e => e.id.toString() === id);
            if (!entrega) return;

            entregaParaWhatsappId = id;

            modalWhatsappClienteNome.textContent = entrega.cliente.nome;
            let cestaInfo = `${entrega.cesta.nome} (${formatarMoeda(entrega.cesta.valor)})`;
            if (entrega.tipo === 'Alterada') {
                cestaInfo += ' - ALTERADA';
            }
            if (Array.isArray(entrega.brindes) && entrega.brindes.length > 0) {
                 cestaInfo += ` + BRINDE (${entrega.brindes.join(', ')})`;
            }
            modalWhatsappCestaInfo.textContent = cestaInfo;
            
            modalWhatsappOpcoes.classList.remove('hidden');
        }

        function fecharModalWhatsapp() {
            modalWhatsappOpcoes.classList.add('hidden');
            entregaParaWhatsappId = null;
        }

        function gerarMensagem(msgId, entrega) {
            const clienteNome = entrega.cliente.nome;
            const cestaValor = formatarMoeda(entrega.cesta.valor);
            
            const numeroCliente = entrega.cliente.celular ? entrega.cliente.celular.replace(/\D/g, '') : '';
            const numeroClienteFinal = numeroCliente.length > 0 && !numeroCliente.startsWith('55') ? `55${numeroCliente}` : numeroCliente;
            
            let mensagem = "";
            let numeroDestino = numeroClienteFinal;
            let targetBlank = true;

            if (!numeroClienteFinal && msgId !== 4) {
                 mostrarAviso("O cliente n√£o tem um n√∫mero de celular cadastrado para enviar esta mensagem.");
                 return;
            }

            switch(msgId) {
                case 1: 
                    mensagem = `Ol√°, aqui √© o entregador da ${NOME_EMPRESA}. A sua cesta b√°sica chegar√° em 10 minutos.`;
                    break;
                case 2: 
                    mensagem = `Ol√°, cheguei, j√° pode sair para receber a cesta.`;
                    break;
                case 3: 
                    mensagem = `Dados do pix para pagamento:\n*PIX*: ${PIX_CELULAR} (celular)\n*Nome*: ${PIX_NOME}\n*Valor Total*: ${cestaValor}`;
                    break;
                case 4: 
                    numeroDestino = NUMERO_GERENTE;
                    targetBlank = true; 

                    let detalhesAlterada = '';
                    if (entrega.tipo === 'Alterada') {
                        detalhesAlterada = ` - *Alterada: ${entrega.codigoAlterada || 'Detalhes a verificar'}*`;
                        if (Array.isArray(entrega.partesAlteradas) && entrega.partesAlteradas.length > 0) {
                            detalhesAlterada += ` (Itens: ${entrega.partesAlteradas.join(', ')})`;
                        }
                    }
                    
                    let brindes = Array.isArray(entrega.brindes) && entrega.brindes.length > 0 ? ` (Brindes: ${entrega.brindes.join(', ')})` : "";

                    mensagem = `*NOVO PEDIDO (ENTREGA)*\n\nCliente: ${clienteNome}\nCesta: ${entrega.cesta.nome}${detalhesAlterada}${brindes}\nValor: ${cestaValor}\nCelular Cliente: ${entrega.cliente.celular}`;
                    break;
                default:
                    return;
            }

            const url = `https://api.whatsapp.com/send?phone=${numeroDestino}&text=${encodeURIComponent(mensagem)}`;
            
            fecharModalWhatsapp();
            window.open(url, targetBlank ? '_blank' : '_self');
        }

        // --- Fun√ß√µes de Lan√ßamento e Status ---

        function adicionarEntrega(e) {
            e.preventDefault();
            
            const rotaAtiva = todasAsRotas[rotaAtivaId];
            if (!rotaAtiva) {
                mostrarAviso("Nenhuma rota ativa selecionada. Crie uma nova rota.");
                return;
            }
            const entregas = rotaAtiva.entregas;

            const selectedOption = selectCesta.options[selectCesta.selectedIndex];
            
            const nomeClienteSelecionado = inputCliente.value.trim();
            const clienteSelecionado = CLIENTES_CACHE[nomeClienteSelecionado.toLowerCase()];

            let clienteData;
            if (clienteSelecionado) {
                clienteData = { ...clienteSelecionado };
            } else {
                clienteData = {
                    nome: nomeClienteSelecionado,
                    celular: '',
                    endereco: nomeClienteSelecionado,
                    complemento: ''
                };
            }

            if (!clienteData.nome) {
                mostrarAviso('Por favor, selecione ou digite um nome de cliente.');
                return;
            }
            
            const partesAlteradasSelecionadas = 
                Array.from(formEntrega.querySelectorAll('input[name="partes_alteradas"]:checked'))
                     .map(input => input.value);
            
            // NOVO: Coleta Brindes (Checkboxes)
            const brindesSelecionados = Array.from(formEntrega.querySelectorAll('input[name="brindes_opcoes"]:checked')).map(input => input.value);
            
            const novaEntrega = {
                id: Date.now(),
                cliente: clienteData,
                observacao: obsClienteInput.value.trim(),
                cesta: {
                    nome: selectedOption.value,
                    valor: parseFloat(inputValorCesta.value)
                },
                tipo: document.querySelector('input[name="tipo-cesta"]:checked').value,
                codigoAlterada: codigoAlteradaInput.value.trim(),
                partesAlteradas: partesAlteradasSelecionadas,
                brindes: brindesSelecionados, // NOVO CAMPO DE BRINDES
                status: "Pendente",
                formaPagamento: [],
                horarioEntrega: null
            };

            entregas.push(novaEntrega);
            salvarLocalStorage();
            renderizarEntregas();

            formEntrega.reset();
            inputCliente.value = '';
            infoClienteSelecionado.classList.add('hidden');
            atualizarValorCesta();
            toggleCampoAlterada();
            
            // Abre a se√ß√£o Lan√ßamento automaticamente ap√≥s lan√ßar uma entrega
            if (!contentLancamento.classList.contains('open')) {
                toggleLancamento();
            }
        }

        function abrirGoogleMaps(query) {
            const enderecoFormatado = query.trim();
            if (!enderecoFormatado) {
                mostrarAviso('O cliente n√£o possui um endere√ßo cadastrado para abrir no mapa.');
                return;
            }
            // CORRE√á√ÉO: Sintaxe correta para o Google Maps
            const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(enderecoFormatado)}`;
            window.open(url, '_blank');
        }

        function abrirModalPagamento(id) {
            const entregas = getEntregasAtivas();
            const entrega = entregas.find(e => e.id.toString() === id);
            if (!entrega) return;

            entregaParaPagarId = id;
            
            modalClienteNome.textContent = entrega.cliente.nome;
            modalClienteValor.textContent = formatarMoeda(entrega.cesta.valor);
            
            formPagamento.reset();
            modalErrorPagamento.classList.add('hidden');

            modalPagamento.classList.remove('hidden');
        }

        function fecharModalPagamento() {
            modalPagamento.classList.add('hidden');
            entregaParaPagarId = null;
        }

        function cancelarEntrega(id) {
            if (!confirm("Tem certeza que deseja MARCAR ESTA ENTREGA COMO CANCELADA?")) return;

            const entregas = getEntregasAtivas();
            const index = entregas.findIndex(e => e.id.toString() === id);
            if (index !== -1) {
                entregas[index].status = "Cancelada";
                entregas[index].formaPagamento = [];
                entregas[index].horarioEntrega = new Date().toISOString();
            }
            salvarLocalStorage();
            renderizarEntregas();
        }

        function moverEntrega(id, direcao) {
            const entregas = getEntregasAtivas();
            const index = entregas.findIndex(e => e.id.toString() === id);
            if (index === -1) return;

            if (entregas[index].status !== 'Pendente') return;

            if (direcao === 'cima' && index > 0) {
                [entregas[index - 1], entregas[index]] = [entregas[index], entregas[index - 1]];
            } else if (direcao === 'baixo' && index < entregas.length - 1) {
                [entregas[index + 1], entregas[index]] = [entregas[index], entregas[index + 1]];
            } else {
                return;
            }

            salvarLocalStorage();
            renderizarEntregas();
        }

        function handleCardClick(e) {
            const btnCima = e.target.closest('.btn-mover-cima');
            if (btnCima && !btnCima.disabled) {
                moverEntrega(btnCima.dataset.id, 'cima');
                return;
            }

            const btnBaixo = e.target.closest('.btn-mover-baixo');
            if (btnBaixo && !btnBaixo.disabled) {
                moverEntrega(btnBaixo.dataset.id, 'baixo');
                return;
            }

            const btnCancelar = e.target.closest('.btn-cancelar-entrega');
            if (btnCancelar && !btnCancelar.disabled) {
                cancelarEntrega(btnCancelar.dataset.id);
                return;
            }

            const btnMaps = e.target.closest('.btn-card-maps');
            if (btnMaps && !btnMaps.disabled) {
                const cardId = btnMaps.closest('[data-id]').dataset.id;
                const entregas = getEntregasAtivas();
                const entrega = entregas.find(e => e.id.toString() === cardId);
                if (entrega) {
                    abrirGoogleMaps(entrega.cliente.endereco);
                }
                return;
            }
            
            // A√ß√£o espec√≠fica para abrir o modal do WhatsApp
            const btnWhatsapp = e.target.closest('.btn-whatsapp-modal');
            if (btnWhatsapp && !btnWhatsapp.disabled) {
                abrirModalWhatsapp(btnWhatsapp.dataset.id); 
                return;
            }

            const target = e.target.closest('.btn-entregue');
            if (target && !target.disabled && target.textContent.trim() === 'Marcar Entrega') {
                abrirModalPagamento(target.dataset.id);
            }
        }

        function salvarPagamento(e) {
            e.preventDefault();
            
            const formasPagamentoSelecionadas = 
                Array.from(formPagamento.querySelectorAll('input[name="forma_pagamento"]:checked'))
                     .map(input => input.value);
            
            if (formasPagamentoSelecionadas.length === 0) {
                modalErrorPagamento.classList.remove('hidden');
                return;
            }
            
            const entregas = getEntregasAtivas();
            const index = entregas.findIndex(e => e.id.toString() === entregaParaPagarId);
            if (index !== -1) {
                entregas[index].status = "Entregue";
                entregas[index].formaPagamento = formasPagamentoSelecionadas;
                entregas[index].horarioEntrega = new Date().toISOString();
            }
            
            salvarLocalStorage();
            renderizarEntregas();
            fecharModalPagamento();
        }
        
        // --- Fun√ß√µes de Exporta√ß√£o/Relat√≥rio ---

        function downloadArquivo(data, filename) {
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function fecharModalExportar() {
            modalExportar.classList.add('hidden');
        }

        function exportarDados() {
            const rotaAtiva = todasAsRotas[rotaAtivaId];
            if (!rotaAtiva) {
                mostrarAviso("Nenhuma rota ativa para exportar.");
                return;
            }
            
            // 1. Garante que as despesas digitadas no modal est√£o salvas antes de gerar o relat√≥rio
            salvarDespesasDoModal(); 
            
            const entregas = rotaAtiva.entregas;

            const entregasConcluidas = entregas.filter(e => e.status === 'Entregue');
            const entregasCanceladas = entregas.filter(e => e.status === 'Cancelada');
            
            let relatorioTexto = "";
            let whatsappTexto = `*Resumo da Rota: ${rotaAtiva.nome}* (${new Date(rotaAtiva.data + 'T12:00:00').toLocaleDateString('pt-BR')})\n\n`;

            if (entregasConcluidas.length === 0 && entregasCanceladas.length === 0) {
                relatorioTexto = "Nenhuma entrega finalizada.";
            }

            if (entregasConcluidas.length > 0) {
                relatorioTexto += "--- RELAT√ìRIO DE ENTREGAS ---\n\n";
                entregasConcluidas.forEach(e => {
                    relatorioTexto += `Cliente: ${e.cliente.nome}\n`;
                    relatorioTexto += `Valor: ${formatarMoeda(e.cesta.valor)}\n`;
                    relatorioTexto += `Pagamento: ${e.formaPagamento.join(', ')}\n`;
                    relatorioTexto += `Hor√°rio: ${formatarData(e.horarioEntrega)}\n`;
                    relatorioTexto += `-----------------------------\n`;
                });
            }

            if (entregasCanceladas.length > 0) {
                relatorioTexto += "\n--- ENTREGAS CANCELADAS ---\n\n";
                entregasCanceladas.forEach(e => {
                    relatorioTexto += `Cliente: ${e.cliente.nome}\n`;
                    relatorioTexto += `Hor√°rio: ${formatarData(e.horarioEntrega)}\n`;
                    relatorioTexto += `-----------------------------\n`;
                });
            }
            
            const entregasPendentes = entregas.filter(e => e.status === 'Pendente');
            whatsappTexto += `*Entregas Pendentes (${entregasPendentes.length})*:\n`;
            if(entregasPendentes.length > 0) {
                entregasPendentes.forEach((e, index) => {
                    whatsappTexto += `${index + 1}. *${e.cliente.nome}* (${e.cliente.celular || 'Sem Celular'})\n`;
                    if (e.cliente.endereco) { whatsappTexto += `   End: ${e.cliente.endereco}\n`; }
                    if (e.cliente.complemento) { whatsappTexto += `   Comp: ${e.cliente.complemento}\n`; }
                    whatsappTexto += `   Cesta: ${e.cesta.nome} (${formatarMoeda(e.cesta.valor)})\n`;
                    
                    if (Array.isArray(e.brindes) && e.brindes.length > 0) { whatsappTexto += `   BRINDE(S): ${e.brindes.join(', ')}\n`; }
                    if (e.observacao) { whatsappTexto += `   OBS (Cliente): ${e.observacao}\n`; }
                    if(e.tipo === 'Alterada') {
                        if (e.codigoAlterada) { whatsappTexto += `   OBS (Cesta): ${e.codigoAlterada}\n`; }
                        if (Array.isArray(e.partesAlteradas) && e.partesAlteradas.length > 0) { whatsappTexto += `   Partes Alteradas: ${e.partesAlteradas.join(', ')}\n`; }
                    }
                });
            } else {
                whatsappTexto += `Nenhuma entrega pendente.\n`;
            }
            
            // Se√ß√£o Relat√≥rio Financeiro
            whatsappTexto += `\n\n--- RELAT√ìRIO FINANCEIRO ---\n`;
            
            let totalVendido = 0;
            let totalPorCesta = {};
            let totalPorPagamento = {};

            entregasConcluidas.forEach(e => {
                const valor = e.cesta.valor;
                totalVendido += valor;
                
                totalPorCesta[e.cesta.nome] = (totalPorCesta[e.cesta.nome] || 0) + valor;

                if (e.formaPagamento.length === 0) {
                    totalPorPagamento['N/A'] = (totalPorPagamento['N/A'] || 0) + valor;
                } else {
                    const valorDividido = valor / e.formaPagamento.length;
                    e.formaPagamento.forEach(forma => {
                        totalPorPagamento[forma] = (totalPorPagamento[forma] || 0) + valorDividido;
                    });
                }
            });

            whatsappTexto += `\n*Vendas Conclu√≠das:*\n`;
            whatsappTexto += `Total Vendido: *${formatarMoeda(totalVendido)}*\n`;

            whatsappTexto += `\n*Detalhado por Cesta:*\n`;
            if (Object.keys(totalPorCesta).length > 0) {
                Object.keys(totalPorCesta).forEach(nomeCesta => {
                    whatsappTexto += `   ${nomeCesta}: ${formatarMoeda(totalPorCesta[nomeCesta])}\n`;
                });
            } else {
                whatsappTexto += `   Nenhuma.\n`;
            }

            whatsappTexto += `\n*Recebimentos por Forma:*\n`;
            if (Object.keys(totalPorPagamento).length > 0) {
                Object.keys(totalPorPagamento).forEach(forma => {
                    whatsappTexto += `   ${forma}: ${formatarMoeda(totalPorPagamento[forma].toFixed(2))}\n`;
                });
            } else {
                 whatsappTexto += `   Nenhum.\n`;
            }

            // Despesas (Lendo do objeto da rota que foi ATUALIZADO)
            const despesas = rotaAtiva.despesas;
            const totalDespesas = (despesas.abastecimento || 0) + (despesas.alimentacao || 0) + (despesas.extra || 0);
            
            whatsappTexto += `\n*Despesas da Rota:*\n`;
            whatsappTexto += `   Abastecimento: ${formatarMoeda(despesas.abastecimento || 0)}\n`;
            whatsappTexto += `   Alimenta√ß√£o: ${formatarMoeda(despesas.alimentacao || 0)}\n`;
            whatsappTexto += `   Extras: ${formatarMoeda(despesas.extra || 0)}\n`;
            whatsappTexto += `Total Despesas: *${formatarMoeda(totalDespesas)}*\n`;

            const balanco = totalVendido - totalDespesas;
            whatsappTexto += `\n*BALAN√áO FINAL (Vendido - Despesas):*\n`;
            whatsappTexto += `*${formatarMoeda(balanco)}*\n`;

            exportRelatorioEl.querySelector('pre').textContent = relatorioTexto;
            
            const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(whatsappTexto)}`;
            exportWhatsappLinkEl.innerHTML = `
                <a href="${whatsappUrl}" target="_blank" class="inline-flex items-center justify-center w-full rounded-md border border-transparent bg-green-500 px-4 py-3 text-sm font-medium text-white shadow-sm hover:bg-green-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM5.5 8.5A1.5 1.5 0 017 7h6a1.5 1.5 0 011.5 1.5v3A1.5 1.5 0 0113 13H7a1.5 1.5 0 01-1.5-1.5v-3z" /></svg>
                    Enviar Resumo no WhatsApp
                </a>`;

            modalExportar.classList.remove('hidden');
        }

        function carregarDados(jsonDados) {
            if (!jsonDados) {
                mostrarAviso("O arquivo est√° vazio ou n√£o p√¥de ser lido.");
                return;
            }
            
            try {
                const dadosCarregados = JSON.parse(jsonDados);
                
                if (typeof dadosCarregados === 'object' && !Array.isArray(dadosCarregados) && dadosCarregados.entregas) {
                    
                    if (!dadosCarregados.id || !dadosCarregados.nome || !dadosCarregados.data) {
                        throw new Error('Objeto de rota inv√°lido. Faltando id, nome ou data.');
                    }

                    let novoId = dadosCarregados.id;
                    if (todasAsRotas[novoId]) {
                        novoId = `import-${Date.now()}`;
                    }
                    dadosCarregados.id = novoId;

                    dadosCarregados.despesas = dadosCarregados.despesas || { abastecimento: 0, alimentacao: 0, extra: 0 };
                    dadosCarregados.entregas = dadosCarregados.entregas.map(e => ({
                        // Migra brinde de string para array se for o formato antigo, sen√£o usa o novo campo
                        brindes: (e.brindes && Array.isArray(e.brindes)) ? e.brindes : (e.brinde === 'Sim' ? ['Brinde Padr√£o'] : []), 
                        partesAlteradas: e.partesAlteradas || [],
                        observacao: e.observacao || '',
                        ...e,
                        cliente: typeof e.cliente === 'object' ? e.cliente : {
                            nome: e.codigoCliente || 'Cliente Antigo',
                            celular: e.celular || '',
                            endereco: e.endereco || e.codigoCliente || 'Sem Endere√ßo',
                            complemento: e.complemento || ''
                        }
                    }));

                    todasAsRotas[novoId] = dadosCarregados;
                    rotaAtivaId = novoId;
                    
                    salvarTodasAsRotas();
                    popularSelectRotas();
                    carregarRotaAtiva();
                    mostrarAviso(`Rota "${dadosCarregados.nome}" importada com sucesso e definida como ativa!`);

                } 
                else if (Array.isArray(dadosCarregados) && dadosCarregados.length > 0) {
                    const rotaAtiva = todasAsRotas[rotaAtivaId];
                    if (!rotaAtiva) {
                        mostrarAviso("Nenhuma rota ativa. Crie uma nova rota antes de carregar um arquivo antigo.");
                        return;
                    }

                    rotaAtiva.entregas = dadosCarregados.map(e => ({
                         brindes: (e.brindes && Array.isArray(e.brindes)) ? e.brindes : (e.brinde === 'Sim' ? ['Brinde Padr√£o'] : []), 
                        partesAlteradas: e.partesAlteradas || [],
                        observacao: e.observacao || '',
                        ...e,
                        cliente: typeof e.cliente === 'object' ? e.cliente : {
                            nome: e.codigoCliente || 'Cliente Antigo',
                            celular: e.celular || '',
                            endereco: e.endereco || e.codigoCliente || 'Sem Endere√ßo',
                            complemento: e.complemento || ''
                        }
                    }));
                    
                    rotaAtiva.despesas = { abastecimento: 0, alimentacao: 0, extra: 0 }; 

                    salvarTodasAsRotas();
                    carregarRotaAtiva();
                    mostrarAviso(`Lista de ${dadosCarregados.length} entregas carregada na rota ativa!`);

                } else {
                    throw new Error('Formato de arquivo JSON desconhecido ou lista vazia.');
                }

            } catch (error) {
                console.error("Erro ao carregar JSON:", error);
                mostrarAviso(`Dados inv√°lidos. Verifique o arquivo. (Erro: ${error.message})`);
            }
        }

        function handleArquivoCarregado(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    carregarDados(event.target.result);
                } catch (error) {
                    mostrarAviso(`Erro ao processar o arquivo: ${error.message}`);
                }
            };
            reader.onerror = () => {
                mostrarAviso('N√£o foi poss√≠vel ler o arquivo.');
            };
            reader.readAsText(file);
            
            e.target.value = null;
        }


        // --- Inicializa√ß√£o e Event Listeners ---

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Inicializa todos os seletores
            inicializarSeletores();
            
            // 2. Associa Event Listeners

            // Gerenciamento de Rota Retr√°til
            btnToggleGerenciarRota.addEventListener('click', toggleGerenciarRota);
            
            // Lan√ßamento Retr√°til (Inicia fechado, ent√£o a classe 'open' √© removida no in√≠cio)
            if (contentLancamento) {
                contentLancamento.classList.remove('open');
                iconChevronLancamento.classList.add('rotate-90');
                btnToggleLancamento.addEventListener('click', toggleLancamento);
            }
            
            // Rota
            selectRotaAtiva.addEventListener('change', (e) => {
                atualizarInfoRota(); 
                rotaAtivaId = e.target.value;
                localStorage.setItem('rotaAtivaId', rotaAtivaId);
                carregarRotaAtiva();
            });
            btnNovaRota.addEventListener('click', () => criarNovaRota(true));
            inputNomeRota.addEventListener('change', atualizarInfoRota);
            inputDataRota.addEventListener('change', atualizarInfoRota);
            btnExcluirRota.addEventListener('click', excluirRotaAtiva);

            // Despesas (Agora no Modal de Exporta√ß√£o)
            modalDespesaAbastecimento.addEventListener('change', salvarDespesasDoModal);
            modalDespesaAlimentacao.addEventListener('change', salvarDespesasDoModal);
            modalDespesaExtra.addEventListener('change', salvarDespesasDoModal);


            // Cliente e Lan√ßamento
            inputCliente.addEventListener('input', (e) => {
                const nome = e.target.value.toLowerCase().trim();
                const cliente = CLIENTES_CACHE[nome];
                if (cliente) {
                    displayClienteEndereco.textContent = cliente.endereco || '-';
                    displayClienteComplemento.textContent = cliente.complemento || '-';
                    displayClienteCelular.textContent = cliente.celular || '-';
                    infoClienteSelecionado.classList.remove('hidden');
                } else {
                    infoClienteSelecionado.classList.add('hidden');
                }
            });

            selectCesta.addEventListener('change', atualizarValorCesta);
            document.querySelectorAll('input[name="tipo-cesta"]').forEach(radio => {
                radio.addEventListener('change', toggleCampoAlterada);
            });
            formEntrega.addEventListener('submit', adicionarEntrega);

            // Lista de Entregas (Delega√ß√£o de Evento)
            listaEntregasEl.addEventListener('click', handleCardClick);
            
            // A√ß√£o espec√≠fica para abrir o Modal de WhatsApp
            listaEntregasEl.addEventListener('click', (e) => {
                const btnWhatsapp = e.target.closest('.btn-whatsapp-modal');
                if (btnWhatsapp && !btnWhatsapp.disabled) {
                    abrirModalWhatsapp(btnWhatsapp.dataset.id); 
                    return;
                }
            });

            // Modal de Pagamento
            btnCancelarPagamento.addEventListener('click', fecharModalPagamento);
            formPagamento.addEventListener('submit', salvarPagamento);
            
            // Modal de WhatsApp Op√ß√µes
            btnFecharWhatsappOpcoes.addEventListener('click', fecharModalWhatsapp);
            modalWhatsappOpcoes.addEventListener('click', (e) => {
                const btnMsg = e.target.closest('[data-msg-id]');
                if (btnMsg) {
                    const idEntrega = entregaParaWhatsappId;
                    const entregas = getEntregasAtivas();
                    const entrega = entregas.find(e => e.id.toString() === idEntrega);
                    if (entrega) {
                        gerarMensagem(parseInt(btnMsg.dataset.msgId), entrega);
                    }
                }
            });


            // A√ß√µes Globais (Exportar/Carregar)
            // Bot√£o Exportar: Carrega despesas e abre o modal
            btnExportar.addEventListener('click', () => {
                carregarDespesasNoModal();
                modalExportar.classList.remove('hidden');
            });
            
            // Fechar Modal Exportar (Desktop e Mobile)
            btnFecharExportar.addEventListener('click', fecharModalExportar);
            btnFecharExportarTop.addEventListener('click', fecharModalExportar);

            document.getElementById('btn-baixar-json').addEventListener('click', () => {
                const rotaAtiva = todasAsRotas[rotaAtivaId];
                if (!rotaAtiva) return;
                
                salvarDespesasDoModal(); 
                
                const jsonDados = JSON.stringify(rotaAtiva, null, 2);
                
                const nomeArquivo = `rota_${rotaAtiva.nome.replace(/[^a-z0-9]/gi, '_')}_${rotaAtiva.data}.json`;
                
                downloadArquivo(jsonDados, nomeArquivo);
            });

            btnCarregar.addEventListener('click', () => {
                inputCarregarArquivo.click();
            });

            inputCarregarArquivo.addEventListener('change', handleArquivoCarregado);

            btnFecharAviso.addEventListener('click', fecharAviso);

            // 3. Inicia o app
            iniciarAplicativo();
            atualizarValorCesta();
        });
    </script>
</body>
</html>
